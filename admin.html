<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت پشتیبانی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f7f9fc; }
        .ticket-list-item.active { background-color: #eef2ff; border-right: 4px solid #4f46e5; }
        #messages-container { background-color: #f0f2f5; }
    </style>
</head>
<body class="h-screen overflow-hidden">

    <div id="error-view" class="hidden flex-col items-center justify-center h-full text-center p-4">
        <h1 class="text-2xl font-bold text-red-500">خطا</h1>
        <p id="error-message" class="mt-4 text-gray-700"></p>
    </div>
    
    <div id="loading-view" class="flex flex-col items-center justify-center h-full">
        <svg class="animate-spin h-10 w-10 text-indigo-600" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <p class="mt-4 text-gray-600">در حال بارگذاری پنل مدیریت...</p>
    </div>

    <main id="main-app-container" class="hidden h-full flex overflow-hidden">
        <!-- Tickets List Panel -->
        <div id="tickets-list-panel" class="w-full md:w-2/5 lg:w-1/3 flex-shrink-0 bg-white border-l border-gray-200 flex flex-col">
            <div class="p-3 border-b"><input type="text" id="search-box" placeholder="جستجوی تیکت..." class="w-full p-2 border border-gray-300 rounded-lg"></div>
            <div id="tickets-list-container" class="flex-grow overflow-y-auto"></div>
        </div>

        <!-- Conversation Panel -->
        <div id="conversation-panel" class="w-full md:w-3/5 lg:w-2/3 flex flex-col bg-gray-50">
            <div id="welcome-message" class="flex flex-col items-center justify-center h-full text-gray-400"><svg class="w-28 h-28" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg><p class="mt-4 text-lg">برای مشاهده گفتگو، یک تیکت را انتخاب کنید.</p></div>
            <div id="conversation-content" class="hidden flex-1 flex flex-col overflow-hidden">
                <header class="p-3 border-b bg-white z-10 flex justify-between items-center"><h2 id="ticket-subject" class="font-bold text-lg"></h2><select id="ticket-status" class="border rounded-lg p-2 text-sm"><option value="open">باز</option><option value="pending_user_reply">در انتظار پاسخ کاربر</option><option value="closed">بسته شده</option></select></header>
                <div id="messages-container" class="flex-1 p-6 overflow-y-auto space-y-6"></div>
                <footer class="p-3 bg-white border-t"><form id="reply-form" class="flex items-center space-x-2 space-x-reverse"><textarea id="reply-message" rows="1" class="flex-grow p-3 border rounded-lg resize-none" placeholder="پاسخ خود را بنویسید..."></textarea><button type="submit" class="bg-indigo-600 text-white w-12 h-12 rounded-lg flex items-center justify-center"><svg class="w-6 h-6 transform -rotate-45" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg></button></form></footer>
            </div>
        </div>
    </main>
    
<script>
    // --- GLOBAL STATE & CONFIG ---
    let platformId = null;
    let WORKER_URL = null;
    let currentTicketId = null;
    let allTicketsData = [];
    let pollingInterval = null;

    const WORKER_URL_BASE = "https://ticketing-maker-api.amiruserbot7.workers.dev";

    // --- DOM ELEMENTS ---
    const loadingView = document.getElementById('loading-view');
    const errorView = document.getElementById('error-view');
    const mainAppContainer = document.getElementById('main-app-container');
    const ticketsListContainer = document.getElementById('tickets-list-container');
    const welcomeMessage = document.getElementById('welcome-message');
    const conversationContent = document.getElementById('conversation-content');
    const ticketSubjectHeader = document.getElementById('ticket-subject');
    const ticketStatusSelect = document.getElementById('ticket-status');
    const messagesContainer = document.getElementById('messages-container');
    const replyForm = document.getElementById('reply-form');
    const searchBox = document.getElementById('search-box');

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            platformId = urlParams.get('pid');

            if (!platformId) {
                showError("خطای پیکربندی: شناسه پلتفرم (pid) در آدرس URL یافت نشد.");
                return;
            }

            WORKER_URL = `${WORKER_URL_BASE}/api/${platformId}`;
            startApp();
        } catch (error) {
            console.error("Initialization failed:", error);
            showError("خطایی در راه‌اندازی پنل رخ داد.");
        }
    });

    function showError(message) {
        loadingView.classList.add('hidden');
        mainAppContainer.classList.add('hidden');
        document.getElementById('error-message').textContent = message;
        errorView.classList.remove('hidden');
        errorView.classList.add('flex');
    }

    function startApp() {
        loadingView.classList.add('hidden');
        mainAppContainer.classList.remove('hidden');
        mainAppContainer.classList.add('flex');
        fetchAndRenderTickets();
        if (pollingInterval) clearInterval(pollingInterval);
        pollingInterval = setInterval(fetchAndRenderTickets, 5000); // Poll for new tickets/messages
    }

    // --- API CALLS ---
    async function apiRequest(endpoint, options = {}) {
        try {
            const response = await fetch(`${WORKER_URL}${endpoint}`, options);
            if (!response.ok) {
                const errorResult = await response.json().catch(() => ({ error: 'خطای ناشناخته' }));
                throw new Error(errorResult.error || 'خطای سرور');
            }
            return response.json();
        } catch (error) {
            console.error(`API request to ${endpoint} failed:`, error);
            throw error;
        }
    }
    
    // --- TICKET LOGIC ---
    async function fetchAndRenderTickets() {
        try {
            const result = await apiRequest(`/tickets`); // No user ID needed for admin
            if (result.success) {
                const tickets = result.data ? Object.keys(result.data).map(key => ({ id: key, ...result.data[key] })) : [];
                allTicketsData = tickets;
                renderTicketsList();
                // If a conversation is open, refresh it
                if (currentTicketId) {
                    openConversation(currentTicketId, true);
                }
            }
        } catch (error) {
            // Handle fetch error
        }
    }

    function renderTicketsList() {
        const searchTerm = searchBox.value.toLowerCase();
        const filteredTickets = allTicketsData.filter(ticket => 
            ticket.subject.toLowerCase().includes(searchTerm) ||
            (ticket.user_name || '').toLowerCase().includes(searchTerm) ||
            ticket.telegram_id.toString().includes(searchTerm)
        );

        const sortedTickets = filteredTickets.sort((a, b) => new Date(b.last_updated_at || b.created_at) - new Date(a.last_updated_at || a.created_at));
        
        ticketsListContainer.innerHTML = sortedTickets.map(ticket => {
             const statusMap = {
                open: { text: 'باز', color: 'bg-green-500' },
                pending_user_reply: { text: 'پاسخ داده شده', color: 'bg-blue-500' },
                closed: { text: 'بسته شده', color: 'bg-red-500' }
            };
            const status = statusMap[ticket.status] || { text: 'نامشخص', color: 'bg-gray-500' };
            const unreadClass = ticket.admin_unread ? 'font-bold' : '';
            return `
                <div class="ticket-list-item flex justify-between items-center p-4 border-b cursor-pointer hover:bg-gray-50 ${ticket.id === currentTicketId ? 'active' : ''}" data-ticket-id="${ticket.id}">
                    <div class="truncate pr-2">
                        <p class="text-sm ${unreadClass} text-gray-800">${ticket.subject}</p>
                        <p class="text-xs text-gray-500">${ticket.user_name || ticket.telegram_id}</p>
                    </div>
                    <span class="text-xs text-white px-2 py-1 rounded-full flex-shrink-0 ${status.color}">${status.text}</span>
                </div>
            `;
        }).join('');

        document.querySelectorAll('.ticket-list-item').forEach(el => {
            el.addEventListener('click', () => openConversation(el.dataset.ticketId));
        });
    }

    // --- CONVERSATION LOGIC ---
    async function openConversation(ticketId, isRefresh = false) {
        currentTicketId = ticketId;
        if (!isRefresh) {
            welcomeMessage.style.display = 'none';
            conversationContent.style.display = 'flex';
        }
        
        document.querySelectorAll('.ticket-list-item').forEach(el => el.classList.toggle('active', el.dataset.ticketId === ticketId));

        const ticketData = allTicketsData.find(t => t.id === ticketId);
        if (!ticketData) return;
        
        ticketSubjectHeader.textContent = ticketData.subject;
        ticketStatusSelect.value = ticketData.status;

        try {
            if (ticketData.admin_unread) {
                // Mark as read via API
                await apiRequest(`/tickets/${ticketId}/read`, { method: 'POST' });
            }
            const result = await apiRequest(`/messages?ticket_id=${ticketId}`);
            if (result.success) {
                const messagesData = result.data ? Object.values(result.data) : [];
                renderMessages(messagesData);
            }
        } catch (error) {
           console.error("Error opening conversation", error);
        }
    }

    function renderMessages(messages) {
        messagesContainer.innerHTML = messages.sort((a,b) => new Date(a.created_at) - new Date(b.created_at)).map(msg => {
            const isUser = msg.sender === 'user';
            const bubbleClass = isUser ? 'bg-white self-start' : 'bg-indigo-100 self-end';
            return `<div class="flex flex-col ${isUser ? 'items-start' : 'items-end'}">
                        <div class="p-3 rounded-lg max-w-lg ${bubbleClass}">
                            <p class="text-sm text-gray-800">${msg.text.replace(/\n/g, '<br>')}</p>
                        </div>
                        <span class="text-xs text-gray-400 mt-1">${new Date(msg.created_at).toLocaleTimeString('fa-IR')}</span>
                    </div>`;
        }).join('');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    replyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('reply-message');
        const text = input.value.trim();
        if (!text || !currentTicketId) return;
        
        const messagePayload = { ticket_id: currentTicketId, sender: 'admin', text: text };
        input.value = '';

        try {
            await apiRequest('/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(messagePayload)
            });
            // The polling will automatically refresh the conversation
        } catch (error) {
            alert(`خطا در ارسال پاسخ: ${error.message}`);
        }
    });

    ticketStatusSelect.addEventListener('change', async () => {
        if (!currentTicketId) return;
        try {
            await apiRequest(`/tickets/${currentTicketId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: ticketStatusSelect.value })
            });
        } catch(error) {
            alert('خطا در تغییر وضعیت تیکت.');
        }
    });

    searchBox.addEventListener('input', renderTicketsList);

</script>
</body>
</html>

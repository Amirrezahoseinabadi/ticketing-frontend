<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت پشتیبانی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f7f9fc; color: #1a202c; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 6px; }
        .status-badge { padding: 0.2rem 0.6rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .status-open { background-color: #fef9c3; color: #a16207; }
        .status-pending_user_reply { background-color: #dcfce7; color: #166534; }
        .status-closed { background-color: #fee2e2; color: #991b1b; }
        .message-user { background-color: #ffffff; border-radius: 1.25rem 1.25rem 1.25rem 0.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .message-admin { background-color: #e0e7ff; color: #312e81; border-radius: 1.25rem 1.25rem 0.25rem 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .ticket-list-item.active { background-color: #eef2ff; border-right: 4px solid #4f46e5; }
        .unread-dot { width: 10px; height: 10px; background-color: #4f46e5; border-radius: 9999px; }
    </style>
</head>
<body class="h-screen overflow-hidden">

    <div id="loading-view" class="flex items-center justify-center h-full">
        <p class="text-lg text-gray-600">در حال بارگذاری پنل مدیریت...</p>
    </div>

    <div id="error-view" class="hidden flex-col items-center justify-center h-full text-center p-4 text-gray-800">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <h2 class="mt-4 text-xl font-bold">خطا در بارگذاری</h2>
        <p id="error-message" class="mt-2 text-gray-600"></p>
    </div>

    <div id="main-panel" class="hidden flex flex-col h-full w-full">
        <main class="flex-1 flex flex-col h-full overflow-hidden">
            <header class="flex items-center justify-between h-16 px-6 bg-white border-b border-gray-200 flex-shrink-0">
                 <h1 id="panel-title" class="text-xl font-bold text-gray-800">پنل مدیریت تیکت‌ها</h1>
            </header>
            <div class="flex-1 flex overflow-hidden">
                <div id="tickets-list-panel" class="w-full md:w-2/5 lg:w-1/3 flex-shrink-0 bg-white border-l border-gray-200 flex flex-col">
                    <div class="p-3 border-b">
                        <input type="text" id="search-box" placeholder="جستجوی تیکت..." class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div id="tickets-list-container" class="flex-grow overflow-y-auto"></div>
                </div>
                <div id="conversation-panel" class="w-full md:w-3/5 lg:w-2/3 flex flex-col bg-gray-50">
                    <div id="welcome-message" class="flex flex-col items-center justify-center h-full text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                        <p class="mt-4 text-lg">برای مشاهده گفتگو، یک تیکت را انتخاب کنید.</p>
                    </div>
                    <div id="conversation-content" class="hidden flex-1 flex flex-col overflow-hidden">
                        <header class="p-3 border-b bg-white z-10 flex justify-between items-center flex-shrink-0">
                            <div>
                                <h2 id="ticket-subject" class="font-bold text-lg text-gray-800"></h2>
                                <p id="ticket-user-id" class="text-sm text-gray-500"></p>
                            </div>
                            <select id="ticket-status" class="border border-gray-300 rounded-lg p-2 text-sm">
                                <option value="open">باز (در حال بررسی)</option>
                                <option value="pending_user_reply">پاسخ داده شد</option>
                                <option value="closed">بسته شده</option>
                            </select>
                        </header>
                        <div id="messages-container" class="flex-1 p-6 overflow-y-auto space-y-6 bg-gray-100"></div>
                        <footer class="p-3 bg-white border-t flex-shrink-0">
                            <form id="reply-form" class="flex items-center space-x-2 space-x-reverse">
                                <textarea id="reply-message" rows="1" class="flex-grow p-3 border rounded-lg resize-none" placeholder="پاسخ..."></textarea>
                                <button type="submit" class="bg-indigo-600 text-white font-semibold px-4 py-3 rounded-lg">ارسال</button>
                            </form>
                        </footer>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        const WORKER_URL = "https://ticketing.amiruserbot7.workers.dev/api"; 

        // --- GLOBAL STATE ---
        let storeHandle = null;
        let currentTicketId = null;
        let allTickets = {};
        let ticketsPollingInterval = null;
        let messagesPollingInterval = null;
        
        // --- DOM ELEMENTS ---
        const DOMElements = {
            mainPanel: document.getElementById('main-panel'),
            loadingView: document.getElementById('loading-view'),
            errorView: document.getElementById('error-view'),
            errorMessage: document.getElementById('error-message'),
            panelTitle: document.getElementById('panel-title'),
            ticketsListContainer: document.getElementById('tickets-list-container'),
            conversationPanel: document.getElementById('conversation-panel'),
            welcomeMessage: document.getElementById('welcome-message'),
            conversationContent: document.getElementById('conversation-content'),
            ticketSubject: document.getElementById('ticket-subject'),
            ticketUserId: document.getElementById('ticket-user-id'),
            messagesContainer: document.getElementById('messages-container'),
            replyForm: document.getElementById('reply-form'),
            replyInput: document.getElementById('reply-message'),
            statusSelect: document.getElementById('ticket-status'),
            searchBox: document.getElementById('search-box'),
        };

        const departmentMap = { general: 'سوالات متفرقه', technical: 'پشتیبانی فنی', sales: 'بخش فروش', marketing: 'بازاریابی', ideas: 'ایده ها و پیشنهادات' };
        const statusMap = {
            open: { text: 'باز', className: 'status-open' },
            pending_user_reply: { text: 'پاسخ داده شد', className: 'status-pending_user_reply' },
            closed: { text: 'بسته شده', className: 'status-closed' }
        };

        function showError(message) {
            DOMElements.loadingView.style.display = 'none';
            DOMElements.mainPanel.classList.add('hidden');
            DOMElements.errorView.classList.remove('hidden');
            DOMElements.errorView.classList.add('flex');
            DOMElements.errorMessage.textContent = message;
        }

        async function apiFetch(endpoint, options = {}) {
            const url = `${WORKER_URL}/${storeHandle}${endpoint}`;
            const response = await fetch(url, options);
            const result = await response.json();

            if (!response.ok || !result.success) {
                throw new Error(result.error || `HTTP Error: ${response.status}`);
            }
            return result.data;
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            storeHandle = urlParams.get('storeHandle');
            
            if (!storeHandle) {
                showError('شناسه فروشگاه (storeHandle) در آدرس پنل وجود ندارد. لطفا از لینکی که ربات به شما داده است استفاده کنید.');
                return;
            }
            
            initializeApp();
        });

        function initializeApp() {
            DOMElements.loadingView.style.display = 'none';
            DOMElements.mainPanel.classList.remove('hidden');
            DOMElements.mainPanel.classList.add('flex');
            DOMElements.panelTitle.textContent = `پنل مدیریت: ${storeHandle}`;

            startPollingTickets();

            DOMElements.replyForm.addEventListener('submit', handleReplySubmit);
            DOMElements.statusSelect.addEventListener('change', handleStatusChange);
            DOMElements.searchBox.addEventListener('input', () => renderTicketsList(allTickets));
        }

        async function fetchAdminTickets() {
            try {
                const ticketsData = await apiFetch('/admin/tickets');
                allTickets = ticketsData;
                renderTicketsList(allTickets);
            } catch (error) {
                console.error("Error fetching tickets:", error);
                showError(`خطا در دریافت تیکت‌ها از سرور: ${error.message}`);
                stopPollingTickets();
            }
        }

        function startPollingTickets() {
            fetchAdminTickets();
            if (ticketsPollingInterval) clearInterval(ticketsPollingInterval);
            ticketsPollingInterval = setInterval(fetchAdminTickets, 5000); // Poll every 5 seconds
        }

        function stopPollingTickets() {
            if (ticketsPollingInterval) clearInterval(ticketsPollingInterval);
        }
        
        function renderTicketsList(tickets) {
            const searchTerm = DOMElements.searchBox.value.toLowerCase();
            const filteredTickets = Object.keys(tickets).filter(key => {
                const ticket = tickets[key];
                return (ticket.subject && ticket.subject.toLowerCase().includes(searchTerm)) || 
                       (ticket.user_name && ticket.user_name.toLowerCase().includes(searchTerm)) || 
                       (ticket.telegram_id && ticket.telegram_id.toString().includes(searchTerm));
            }).reduce((obj, key) => { obj[key] = { id: key, ...tickets[key] }; return obj; }, {});

            DOMElements.ticketsListContainer.innerHTML = '';
            if (Object.keys(filteredTickets).length === 0) {
                 DOMElements.ticketsListContainer.innerHTML = `<p class="p-4 text-center text-gray-500">هیچ تیکتی یافت نشد.</p>`;
                 return;
            }

            const sorted = Object.values(filteredTickets).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            sorted.forEach(ticket => {
                const statusInfo = statusMap[ticket.status] || {text: ticket.status, className: 'bg-gray-200'};
                const el = document.createElement('div');
                el.className = `ticket-list-item flex flex-col p-4 border-b cursor-pointer hover:bg-gray-50 ${ticket.id === currentTicketId ? 'active' : ''}`;
                el.dataset.ticketId = ticket.id;
                el.innerHTML = `
                    <div class="flex justify-between items-start">
                        <p class="font-bold text-sm truncate pr-2">${ticket.subject}</p>
                        <span class="status-badge flex-shrink-0 ${statusInfo.className}">${statusInfo.text}</span>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-xs text-gray-500">${departmentMap[ticket.department] || ticket.department}</p>
                        ${ticket.admin_unread ? '<div class="unread-dot"></div>' : ''}
                    </div>
                `;
                el.addEventListener('click', () => openConversation(ticket.id));
                DOMElements.ticketsListContainer.appendChild(el);
            });
        }

        async function openConversation(ticketId) {
            if (currentTicketId === ticketId) return;
            currentTicketId = ticketId;
            
            if(allTickets[ticketId]?.admin_unread) {
                 apiFetch(`/admin/tickets/${ticketId}`, { 
                    method: 'PATCH', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ admin_unread: false }) 
                }).catch(err => console.error("Failed to mark as read:", err));
            }

            document.querySelectorAll('.ticket-list-item').forEach(el => el.classList.toggle('active', el.dataset.ticketId === ticketId));
            DOMElements.welcomeMessage.style.display = 'none';
            DOMElements.conversationContent.style.display = 'flex';
            
            const ticketData = allTickets[ticketId];
            DOMElements.ticketSubject.textContent = ticketData.subject;
            DOMElements.ticketUserId.textContent = `کاربر: ${ticketData.user_name || ticketData.telegram_id}`;
            DOMElements.statusSelect.value = ticketData.status;

            startPollingMessages(ticketId);
        }

        async function fetchAdminMessages(ticketId) {
            if (currentTicketId !== ticketId) return; // Stop polling if conversation changed
            try {
                const messagesData = await apiFetch(`/admin/messages/${ticketId}`);
                renderMessages(messagesData);
            } catch (error) {
                console.error(`Error fetching messages for ticket ${ticketId}:`, error);
                stopPollingMessages();
            }
        }

        function renderMessages(messagesData) {
            DOMElements.messagesContainer.innerHTML = '';
            if (messagesData) {
                const sortedMessages = Object.values(messagesData).sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
                sortedMessages.forEach(msg => {
                    const isUser = msg.sender === 'user';
                    const el = document.createElement('div');
                    el.className = `flex items-start gap-3 ${isUser ? 'justify-start' : 'justify-end'}`;
                    el.innerHTML = `<div class="p-3 max-w-md ${isUser ? 'message-user' : 'message-admin'}"><p class="text-sm">${msg.text}</p></div>`;
                    DOMElements.messagesContainer.appendChild(el);
                });
            }
            DOMElements.messagesContainer.scrollTop = DOMElements.messagesContainer.scrollHeight;
        }

        function startPollingMessages(ticketId) {
            fetchAdminMessages(ticketId);
            if (messagesPollingInterval) clearInterval(messagesPollingInterval);
            messagesPollingInterval = setInterval(() => fetchAdminMessages(ticketId), 3000);
        }

        function stopPollingMessages() {
             if (messagesPollingInterval) clearInterval(messagesPollingInterval);
        }
        
        async function handleReplySubmit(e) {
            e.preventDefault();
            if (!currentTicketId) return;
            const text = DOMElements.replyInput.value.trim();
            if (text === '') return;

            DOMElements.replyInput.value = '';
            
            try {
                await apiFetch('/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticket_id: currentTicketId, sender: 'admin', text: text, source: 'human' }),
                });
                fetchAdminMessages(currentTicketId); // Fetch immediately after sending
            } catch (error) {
                showError(`خطا در ارسال پاسخ: ${error.message}`);
            }
        }
        
        async function handleStatusChange() {
            if (!currentTicketId) return;
            try {
                await apiFetch(`/tickets/${currentTicketId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: DOMElements.statusSelect.value }),
                });
            } catch (error) {
                showError(`خطا در تغییر وضعیت: ${error.message}`);
            }
        }
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª ØªÛŒÚ©Øª ØªÙ„ (Mini App)</title>
    <!-- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Tailwind CSS Ùˆ Lucide Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* ØªÙ†Ø¸ÛŒÙ… ÙÙˆÙ†Øª Ùˆ ØªÙ… Ø§ØµÙ„ÛŒ */
        body {
            font-family: 'Inter', Tahoma, sans-serif;
            background-color: #f3ffef; /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ú©Ù…ÛŒ Ø±ÙˆØ´Ù†â€ŒØªØ± Ùˆ Ù…Ø§ÛŒÙ„ Ø¨Ù‡ Ø³Ø¨Ø²/Ø¢Ø¨ÛŒ */
        }
        /* Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ØµÙØ­Ù‡ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        #app-screen {
            min-height: 700px;
            max-width: 420px;
            margin: 2rem auto;
            background-color: #ffffff;
            /* Ø³Ø§ÛŒÙ‡ Ù†Ø±Ù…â€ŒØªØ± Ùˆ Ø¹Ù…ÛŒÙ‚â€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ø­Ø³ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
            border-radius: 28px; /* Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ú¯Ø±Ø¯ØªØ± */
            overflow: hidden;
            position: relative;
            transition: all 0.4s ease-in-out;
            border: 1px solid #e0e0e0;
        }
        /* Ø³Ø¨Ú© Ø¨Ø±Ø§ÛŒ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ùˆ */
        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.1rem 1.5rem; /* Ú©Ù…ÛŒ Ù¾Ø¯ÛŒÙ†Ú¯ Ø¨ÛŒØ´ØªØ± */
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background-color 0.15s ease, transform 0.1s, box-shadow 0.1s;
        }
        .menu-item:hover {
            background-color: #fcfcfd;
            transform: translateY(-2px); /* Ø­Ø±Ú©Øª Ø¸Ø±ÛŒÙ Ø¨Ù‡ Ø¨Ø§Ù„Ø§ */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .menu-item:last-child {
            border-bottom: none;
        }
        /* Ø³Ø¨Ú© Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ */
        .metric-card {
            background-color: #ffffff;
            padding: 1.25rem;
            border-radius: 18px; /* Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ú¯Ø±Ø¯ØªØ± Ø§Ø² Ù‚Ø¨Ù„ */
            /* Ø³Ø§ÛŒÙ‡ Ù†Ø±Ù… Ùˆ Ø¬Ø°Ø§Ø¨ */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
            border: 1px solid #f0f0f0;
            transition: all 0.3s;
        }
        .metric-card:hover {
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -4px rgba(0, 0, 0, 0.05);
            border-color: #a5b4fc; /* Ø±Ù†Ú¯ Ø¢Ø¨ÛŒ Ù…Ù„Ø§ÛŒÙ…â€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ù‡Ø§ÙˆØ± */
        }
        /* Ø³Ø¨Ú© Ø¨Ø±Ø§ÛŒ textarea Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ø²Ø±Ú¯ Ø´Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø± */
        .auto-resize-textarea {
            overflow: hidden; 
            resize: none; 
            min-height: 120px;
            height: auto;
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø³ÙØ§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ú¯Ø±Ø§Ø¯ÛŒØ§Ù†Øª Ù‡Ø¯Ø± */
        .header-gradient {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
    </style>
</head>
<body>

    <div id="app-screen">
        <!-- Ù‡Ø¯Ø± Ø«Ø§Ø¨Øª Ø¨Ø§ Ú¯Ø±Ø§Ø¯ÛŒØ§Ù†Øª -->
        <header class="header-gradient text-white p-4 flex items-center shadow-2xl">
            <!-- Ø¢ÛŒÚ©ÙˆÙ† Ø¨Ø§Ø²Ú¯Ø´Øª -->
            <button id="back-button" class="text-white p-2 hover:bg-white/20 rounded-full transition duration-150 hidden">
                <i data-lucide="chevron-right" class="h-6 w-6"></i>
            </button>
            <h1 id="header-title" class="text-xl font-extrabold mr-4 flex-grow truncate">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø¨Ø§Øª</h1>
        </header>

        <!-- Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ Ù…Ø­ØªÙˆØ§ -->
        <div id="content" class="p-4 space-y-4">
            <div id="loading-spinner" class="text-center p-8">
                <i data-lucide="loader-circle" class="animate-spin h-10 w-10 text-indigo-600 inline"></i>
                <p class="mt-4 text-gray-600 font-semibold">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡...</p>
            </div>
        </div>

        <!-- Ù¾ÛŒØ§Ù… Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ -->
        <div id="message-box" class="fixed bottom-0 left-0 right-0 p-4 text-white text-center rounded-t-xl shadow-2xl z-20 hidden">
            Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!
        </div>
    </div>

    <script>
        // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ù‡Ù… (WORKER & STORE) ---

        // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ STORE_HANDLE Ø§Ø² Ù¾Ø§Ø±Ø§Ù…ØªØ± URL
        const urlParams = new URLSearchParams(window.location.search);
        const STORE_HANDLE = urlParams.get('storeHandle'); 
        
        // --- MOCK DATA FOR TESTING IN CANVAS ---
        const MOCK_STORE_HANDLE = 'test-store-mock-dfdfdfd'; 
        
        const mockAppTexts = {
            greetingTitle: "Ø³Ù„Ø§Ù… Ù…Ø¯ÛŒØ± Ø¹Ø²ÛŒØ²! ğŸ‘‹ (Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ)",
            quickTipMessage: "ğŸ’¡ Ù†Ú©ØªÙ‡: Ø§ÛŒÙ† Ù…ØªÙˆÙ† Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¯Ø± Ø­Ø§Ù„Øª Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯.",
            faqButtonText: "Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„",
            faqUrl: "https://mock.faq.com/",
            navTickets: "ØªÛŒÚ©Øªâ€ŒÙ‡Ø§",
            navNewTicket: "ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯",
            infoModalTitle: "Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ ØªÛŒÚ©Øª",
            infoModalTip: "Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ ØµÙØ­Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.",
            closedTicketBanner: "Ø§ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ ØªÙˆØ³Ø· Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.",
            submitNewTicketBtn: "Ø§Ø±Ø³Ø§Ù„",
            modalCloseBtn: "Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…",
            userReplyNotification: "âœ… *Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ÙÙ†ÛŒ* Ø¨Ù‡ ØªÛŒÚ©Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆØ¶ÙˆØ¹ *Ù…Ø´Ú©Ù„ Ø§ØªØµØ§Ù„* Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯.\\n\\nØ¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø§Ø³Ø® Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.",
            ticketClosedNotification: "ğŸ« ØªÛŒÚ©Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆØ¶ÙˆØ¹ *Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚* Ø¨Ø³ØªÙ‡ Ø´Ø¯.\\n\\nÙ„Ø·ÙØ§ Ø§Ù…ØªÛŒØ§Ø² Ø¯Ù‡ÛŒØ¯.",
        };
        
        const mockAppStats = {
            totalCount: '145',
            totalActive: '4',
            openCount: '3',
            pendingCount: '1',
            avgRating: '4.92',
            ratingPercentage: '88.5',
            ratedTicketsCount: 120,
            avgFirstResponseTime: '3 Ø³Ø§Ø¹Øª Ùˆ 15 Ø¯Ù‚ÛŒÙ‚Ù‡',
            avgTimeToResolution: '1 Ø±ÙˆØ² Ùˆ 5 Ø³Ø§Ø¹Øª',
        };

        // 2. Ø¢Ø¯Ø±Ø³ Ù¾Ø§ÛŒÙ‡ Worker API
        const WORKER_API_BASE_URL = 'https://ticketing.amiruserbot7.workers.dev'; 

        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ø¹Ù†ÙˆØ§Ù† Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
        const getDashboardTitle = (handle) => `Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª (${handle || 'Ù†Ø§Ø´Ù†Ø§Ø³'})`;


        // --- Ù¾Ø§ÛŒØ§Ù† ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---

        const content = document.getElementById('content');
        const backButton = document.getElementById('back-button');
        const headerTitle = document.getElementById('header-title');
        const messageBox = document.getElementById('message-box');

        // ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ: Dashboard, MainMenu, SubMenu_MINIAPPUI, SubMenu_USERNOTIFICATIONS, EditScreen
        let currentState = 'Loading';
        const history = [];
        let appTexts = {}; // Ø°Ø®ÛŒØ±Ù‡ Ù…ØªÙˆÙ† Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø§Ø² Worker
        let appStats = {}; // Ø°Ø®ÛŒØ±Ù‡ Ø¢Ù…Ø§Ø± Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø§Ø² Worker
        let currentEditKey = null; // Ú©Ù„ÛŒØ¯ Ù…ØªÙ†ÛŒ Ú©Ù‡ Ø¯Ø± Ø­Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø³Øª
        let successMessage = null; // Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ù†Ø§ÙˆØ¨Ø±ÛŒ

        // Ø³Ø§Ø®ØªØ§Ø± Ø«Ø§Ø¨Øª Ù…ØªÙˆÙ† Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ù…Ù†ÙˆÙ‡Ø§ (Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Worker Ù‡Ù…Ú¯Ø§Ù… Ø¨Ø§Ø´Ø¯)
        const CUSTOM_TEXT_KEYS = {
            MINI_APP_UI: {
                greetingTitle: { name: "Ø¹Ù†ÙˆØ§Ù† Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ", icon: "user-check", desc: `Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ú©Ø§Ø±Øª Ø±Ø§Ù‡Ù†Ù…Ø§ (Ù…Ø«Ù„Ø§Ù‹: Ø³Ù„Ø§Ù… Ù…Ø´ØªØ±ÛŒ Ø¹Ø²ÛŒØ²!)` },
                quickTipMessage: { name: "Ù¾ÛŒØ§Ù… Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹", icon: "lightbulb", desc: `Ù…ØªÙ† Ú©ÙˆÚ†Ú© Ø²ÛŒØ± Ø¹Ù†ÙˆØ§Ù† Ø¯Ø± Ú©Ø§Ø±Øª Ø±Ø§Ù‡Ù†Ù…Ø§ (Ù…Ø«Ù„Ø§Ù‹: Ù„Ø·ÙØ§ Ù…Ø´Ú©Ù„ Ø±Ø§ Ø¨Ø§ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯)` },
                faqButtonText: { name: "Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§", icon: "help-circle", desc: `Ù…ØªÙ†ÛŒ Ú©Ù‡ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.` },
                faqUrl: { name: "Ù„ÛŒÙ†Ú© Ø¯Ú©Ù…Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§", icon: "link", desc: `Ø¢Ø¯Ø±Ø³ URL Ú©Ø§Ù…Ù„ (Ø¨Ø§ÛŒØ¯ Ø¨Ø§ https:// Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯).`, isUrl: true }, // Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† isUrl
                navTickets: { name: "Ù…Ù†ÙˆÛŒ: ØªÛŒÚ©Øªâ€ŒÙ‡Ø§", icon: "ticket", desc: `Ù…ØªÙ† Ø¢ÛŒÚ©ÙˆÙ† ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ù†ÙˆØ§Ø± Ù¾Ø§ÛŒÛŒÙ† Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾.` },
                navNewTicket: { name: "Ù…Ù†ÙˆÛŒ: ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯", icon: "file-plus", desc: `Ù…ØªÙ† Ø¢ÛŒÚ©ÙˆÙ† Ø§ÛŒØ¬Ø§Ø¯ ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ù†ÙˆØ§Ø± Ù¾Ø§ÛŒÛŒÙ† Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾.` },
                infoModalTitle: { name: "Ø¹Ù†ÙˆØ§Ù† Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ ØªÛŒÚ©Øª", icon: "info", desc: `Ø¹Ù†ÙˆØ§Ù† Ù¾Ù†Ø¬Ø±Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ù‚Ø¨Ù„ Ø§Ø² Ø«Ø¨Øª ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.` },
                infoModalTip: { name: "Ù¾ÛŒØ§Ù… Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„", icon: "message-square-text", desc: `Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ø¯Ø§Ø®Ù„ Ù¾Ù†Ø¬Ø±Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ø² Ø«Ø¨Øª ØªÛŒÚ©Øª.` },
                closedTicketBanner: { name: "Ø¨Ù†Ø± ØªÛŒÚ©Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡", icon: "lock", desc: `Ù…ØªÙ†ÛŒ Ú©Ù‡ Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† ÛŒÚ© ØªÛŒÚ©Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.` },
                submitNewTicketBtn: { name: "Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„", icon: "send", desc: `Ù…ØªÙ†ÛŒ Ú©Ù‡ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ 'Ø§Ø±Ø³Ø§Ù„' ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.` },
                modalCloseBtn: { name: "Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…", icon: "x-circle", desc: `Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ Ø¨Ø³ØªÙ† Ù¾Ù†Ø¬Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„.` },
            },
            USER_NOTIFICATIONS: {
                userReplyNotification: { name: "Ø§Ø¹Ù„Ø§Ù† Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†", icon: "bell-plus", desc: `Ù…ØªÙ†ÛŒ Ú©Ù‡ Ù¾Ø³ Ø§Ø² Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†ØŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø§ÛŒÙ† Ù…ØªÙ† Ø§Ø² Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù¾ÙˆÛŒØ§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.` },
                ticketClosedNotification: { name: "Ø§Ø¹Ù„Ø§Ù† Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØªÛŒÚ©Øª", icon: "bell-off", desc: `Ù…ØªÙ†ÛŒ Ú©Ù‡ Ù¾Ø³ Ø§Ø² Ø¨Ø³ØªÙ† ØªÛŒÚ©ØªØŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø§ÛŒÙ† Ù…ØªÙ† Ø§Ø² Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù¾ÙˆÛŒØ§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.` },
            }
        };


        // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ø§Ø±ØªÙØ§Ø¹ textarea Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø­ØªÙˆØ§
        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight) + 'px';
        }

        function getFullKeyData(key) {
            for (const menuType in CUSTOM_TEXT_KEYS) {
                if (CUSTOM_TEXT_KEYS[menuType][key]) {
                    return { type: menuType, key, ...CUSTOM_TEXT_KEYS[menuType][key] };
                }
            }
            return null;
        }

        function showMessage(text, type = 'success', duration = 4000) {
            messageBox.textContent = text;
            // Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚ÛŒØª/Ø®Ø·Ø§
            messageBox.className = `fixed bottom-0 left-0 right-0 p-4 text-white text-center rounded-t-2xl shadow-2xl z-20 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, duration);
        }

        function navigateTo(newState, title = null, pushHistory = true) {
            if (pushHistory && currentState !== 'Loading') {
                history.push(currentState);
            }
            currentState = newState;
            
            const currentHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            const dashboardTitle = getDashboardTitle(currentHandle);
            
            headerTitle.textContent = title || dashboardTitle;
            render();
        }

        function handleBack() {
            if (currentState.startsWith('EditScreen_')) {
                // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ù„ÛŒØ¯ ÙˆÛŒØ±Ø§ÛŒØ´ ÙØ¹Ù„ÛŒ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø² ØµÙØ­Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´
                currentEditKey = null;
            }

            if (history.length > 0) {
                const previousState = history.pop();
                
                const currentHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
                const dashboardTitle = getDashboardTitle(currentHandle);
                
                // ØªØ¹ÛŒÛŒÙ† Ø¹Ù†ÙˆØ§Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ø­Ø§Ù„Øª Ù‚Ø¨Ù„ÛŒ
                let title = dashboardTitle;
                if (previousState === 'MainMenu') {
                    title = 'Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªÙˆÙ†';
                } else if (previousState.startsWith('SubMenu_')) {
                    const menuType = previousState.replace('SubMenu_', '');
                    // Ø§ØµÙ„Ø§Ø­ Ù†Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ùˆ Ø¨Ø±Ø§ÛŒ Ù…Ø·Ø§Ø¨Ù‚Øª Ø¨Ø§ CUSTOM_TEXT_KEYS
                    title = menuType === 'MINI_APP_UI' ? 'Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾' : 'Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ø¹Ù„Ø§Ù† Ø±Ø¨Ø§Øª';
                }
                
                currentState = previousState;
                headerTitle.textContent = title;
                render(false);
            } else {
                navigateTo('Dashboard', getDashboardTitle(STORE_HANDLE || MOCK_STORE_HANDLE), false); // Ø§Ú¯Ø± Ù‡ÛŒØ³ØªÙˆØ±ÛŒ Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø±Ú¯Ø±Ø¯
            }
        }

        // --- Data Fetching (Ø§Ø² Worker API) ---

        async function fetchStats() {
            const currentStoreHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            if (currentStoreHandle === MOCK_STORE_HANDLE) return mockAppStats; // MOCK MODE

            const url = `${WORKER_API_BASE_URL}/api/${currentStoreHandle}/stats`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch stats from Worker.');
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Worker stats returned error.');
            return result.data;
        }

        async function fetchAppTexts() {
            const currentStoreHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            if (currentStoreHandle === MOCK_STORE_HANDLE) return mockAppTexts; // MOCK MODE

            const url = `${WORKER_API_BASE_URL}/api/${currentStoreHandle}/texts`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Worker failed to fetch texts.');
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Worker texts returned error.');
            return result.data;
        }

        async function fetchInitialData() {
            try {
                // Ø§Ú¯Ø± STORE_HANDLE ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ù‡ Ø­Ø§Ù„Øª Mock Ù…ÛŒ Ø±ÙˆØ¯
                if (!STORE_HANDLE) {
                    throw new Error("Missing STORE_HANDLE, loading mock data.");
                }

                const [textsData, statsData] = await Promise.all([
                    fetchAppTexts(),
                    fetchStats()
                ]);

                appTexts = textsData;
                appStats = statsData;

            } catch (error) {
                console.warn(`Error in fetchInitialData: ${error.message}. Loading mock data...`);
                appTexts = mockAppTexts;
                appStats = mockAppStats;
                if(error.message !== "Missing STORE_HANDLE, loading mock data."){
                    showMessage(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ API: ${error.message.substring(0, 50)}... Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ.`, 'error');
                }
            }
            currentState = 'Dashboard';
            render();
        }

        // --- Data Persistence (Ø§Ø² Ø·Ø±ÛŒÙ‚ Worker API) ---
        async function handleSave() {
            const saveButton = document.getElementById('save-button');
            const editElement = document.getElementById('edit-area');
            const newText = editElement.value;

            if (!currentEditKey) return;
            const keyData = getFullKeyData(currentEditKey);

            // Validation for URL fields
            if (keyData.isUrl) {
                if (!newText.startsWith('https://')) {
                    showMessage('âŒ Ù„ÛŒÙ†Ú© Ø¨Ø§ÛŒØ¯ Ø¨Ø§ https:// Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯.', 'error', 5000);
                    return;
                }
            }

            saveButton.disabled = true;
            saveButton.innerHTML = '<i data-lucide="loader-circle" class="animate-spin h-5 w-5 inline mr-2"></i> Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';
            lucide.createIcons(); 

            const currentStoreHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            
            // Ø§Ú¯Ø± Ø¯Ø± Ø­Ø§Ù„Øª Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø¨Ø§Ø´ÛŒÙ…ØŒ ÙÙ‚Ø· Ø¯Ø§Ø¯Ù‡ Ù…Ø­Ù„ÛŒ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒ Ú©Ù†ÛŒÙ…
            if (currentStoreHandle === MOCK_STORE_HANDLE) {
                appTexts[currentEditKey] = newText;
                successMessage = `âœ… Ù…ØªÙ† "${keyData.name}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø­Ø§Ù„Øª Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!`;
                
                navigateTo(`SubMenu_${keyData.type}`, 'Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªÙˆÙ†');
                return;
            }

            // Ø¹Ù…Ù„ÛŒØ§Øª ÙˆØ§Ù‚Ø¹ÛŒ Ø°Ø®ÛŒØ±Ù‡
            const url = `${WORKER_API_BASE_URL}/api/${currentStoreHandle}/texts`;
            const payload = { [currentEditKey]: newText };

            try {
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                if (response.ok && result.success) {
                    appTexts[currentEditKey] = newText; 
                    successMessage = `âœ… Ù…ØªÙ† "${keyData.name}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯!`;
                    
                    navigateTo(`SubMenu_${keyData.type}`, 'Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªÙˆÙ†');
                } else {
                    throw new Error(result.error || 'Ø®Ø·Ø§ Ø¯Ø± Worker API Ù‡Ù†Ú¯Ø§Ù… Ø°Ø®ÛŒØ±Ù‡.');
                }
            } catch (error) {
                console.error("Error saving text via Worker:", error);
                showMessage(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ØªÙ†: ${error.message}`, 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = '<i data-lucide="save" class="h-5 w-5 inline ml-1"></i> Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª';
                lucide.createIcons();
            }
        }


        // =================================================================
        // RENDER FUNCTIONS (UI)
        // =================================================================

        function renderDashboard() {
            backButton.classList.add('hidden');
            const currentHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            headerTitle.textContent = getDashboardTitle(currentHandle);
            const stats = appStats;

            if (successMessage) {
                showMessage(successMessage);
                successMessage = null;
            }
            
            const ratingPercent = parseFloat(stats.ratingPercentage || '0');
            const progressBarColor = ratingPercent >= 90 ? 'bg-green-500' : 
                                     ratingPercent >= 75 ? 'bg-yellow-500' : 'bg-red-500';

            const metricCards = [
                { title: "Ú©Ù„ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§", value: stats.totalCount || '0', icon: "ticket", color: "text-indigo-600", desc: "ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡." },
                { title: "ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„", value: stats.totalActive || '0', icon: "inbox", color: "text-red-600", desc: "Ø¨Ø§Ø² Ùˆ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†." },
                { title: "Ø§Ù…ØªÛŒØ§Ø² Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†", value: `${stats.avgRating || 'N/A'} / 5.00`, icon: "star", color: "text-yellow-600", desc: `Ø¨Ø± Ø§Ø³Ø§Ø³ ${stats.ratedTicketsCount || 0} Ø§Ù…ØªÛŒØ§Ø² Ø«Ø¨Øª Ø´Ø¯Ù‡.` },
                { title: "Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù¾Ø§Ø³Ø®", value: stats.avgFirstResponseTime || 'N/A', icon: "clock-3", color: "text-green-600", desc: "Ø²Ù…Ø§Ù† Ù…ØªÙˆØ³Ø· Ø§ÙˆÙ„ÛŒÙ† Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ." },
            ];

            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Ú©Ø§Ø±Øª Ø§ØµÙ„ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ùˆ Ø³Ø±Ø¹Øª -->
                    <div class="text-sm text-center text-gray-500 bg-gray-100 p-2 rounded-lg mb-4">
                        <i data-lucide="store" class="h-4 w-4 inline mr-1 text-indigo-500"></i>
                        Ø´Ù†Ø§Ø³Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ (Store Handle): <span class="font-bold text-gray-700">${currentHandle}</span>
                    </div>

                    <h2 class="text-2xl font-extrabold text-gray-800 border-b pb-3 mb-4">Ú¯Ø²Ø§Ø±Ø´ Ø¹Ù…Ù„Ú©Ø±Ø¯ ÙØ±ÙˆØ´Ú¯Ø§Ù‡</h2>
                    
                    <div class="grid grid-cols-2 gap-4">
                        ${metricCards.map(card => `
                            <div class="metric-card hover:shadow-indigo-100/50">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-semibold text-gray-500">${card.title}</h3>
                                    <i data-lucide="${card.icon}" class="${card.color} h-6 w-6"></i>
                                </div>
                                <!-- Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø§Ø¹Ø¯Ø§Ø¯ Ø§Ø² text-3xl Ø¨Ù‡ text-2xl Ú©Ø§Ù‡Ø´ ÛŒØ§ÙØª -->
                                <p class="text-2xl font-extrabold text-gray-900">${card.value}</p>
                                <p class="text-xs text-gray-400 mt-1 truncate">${card.desc}</p>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Ø¨Ø®Ø´ Ø³Ø±Ø¹Øª Ùˆ Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª Ø¬Ø¯ÛŒØ¯ -->
                    <div class="metric-card bg-purple-50 border-purple-200 border-dashed hover:shadow-purple-100/50">
                        <h3 class="text-lg font-bold text-purple-700 mb-4 flex items-center">
                            <i data-lucide="zap" class="h-5 w-5 ml-2"></i> Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ (KPI)
                        </h3>
                        
                        <div class="space-y-3">
                            <p class="flex justify-between text-sm">
                                <span class="text-gray-600">Ø²Ù…Ø§Ù† Ø­Ù„ Ù†Ù‡Ø§ÛŒÛŒ ØªÛŒÚ©Øª:</span>
                                <span class="font-bold text-gray-800">${stats.avgTimeToResolution || 'N/A'}</span>
                            </p>

                            <!-- Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª ÙˆÛŒÚ˜ÙˆØ§Ù„Ø§ÛŒØ²Ø± Ø§Ù…ØªÛŒØ§Ø² -->
                            <div>
                                <p class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">Ø¯Ø±ØµØ¯ Ø±Ø¶Ø§ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ):</span>
                                    <span class="font-bold text-gray-800">${stats.ratingPercentage || '0.0'}%</span>
                                </p>
                                <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                    <div class="${progressBarColor} h-2.5 rounded-full transition-all duration-500" style="width: ${ratingPercent > 100 ? 100 : ratingPercent}%;"></div>
                                </div>
                            </div>

                        </div>
                    </div>
                    
                    <!-- Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø§ Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø¬Ø³ØªÙ‡ -->
                    <button onclick="navigateTo('MainMenu', 'Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªÙˆÙ†')" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 mt-6 rounded-2xl shadow-xl shadow-indigo-400/50 hover:from-indigo-700 hover:to-purple-700 transition duration-300 font-bold flex items-center justify-center text-lg">
                        <i data-lucide="settings" class="h-6 w-6 ml-2"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªÙˆÙ† Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                    </button>
                </div>
            `;
            lucide.createIcons();
        }

        function renderMainMenu() {
            backButton.classList.remove('hidden');
            headerTitle.textContent = 'Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªÙˆÙ†';
            
            if (successMessage) {
                showMessage(successMessage);
                successMessage = null;
            }

            content.innerHTML = `
                <h2 class="text-2xl font-extrabold text-gray-800 mb-2">Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ù…Ø­ØªÙˆØ§</h2>
                <p class="text-sm text-gray-500 mb-6">Ù…ØªÙˆÙ† Ú©Ù„ÛŒØ¯ÛŒ Ù…ÛŒÙ†ÛŒ Ø§Ù¾ Ùˆ Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯.</p>
                <!-- Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² bg-white/90 Ø¨Ø±Ø§ÛŒ Ø­Ø³ Ø´ÛŒØ´Ù‡â€ŒØ§ÛŒ Ù…Ù„Ø§ÛŒÙ… -->
                <div class="bg-white/90 border border-gray-100 rounded-2xl divide-y divide-gray-100 shadow-xl">
                    <div class="menu-item" onclick="navigateTo('SubMenu_MINI_APP_UI', 'Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾')">
                        <span class="flex items-center font-medium text-gray-800">
                            <i data-lucide="smartphone" class="h-5 w-5 ml-3 text-indigo-600"></i>
                            Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾ (Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ)
                        </span>
                        <i data-lucide="chevron-left" class="h-5 w-5 text-gray-400"></i>
                    </div>
                    <div class="menu-item" onclick="navigateTo('SubMenu_USER_NOTIFICATIONS', 'Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ø¹Ù„Ø§Ù† Ø±Ø¨Ø§Øª')">
                        <span class="flex items-center font-medium text-gray-800">
                            <i data-lucide="bell" class="h-5 w-5 ml-3 text-orange-600"></i>
                            Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ø¹Ù„Ø§Ù† Ú©Ø§Ø±Ø¨Ø± (Ø±Ø¨Ø§Øª)
                        </span>
                        <i data-lucide="chevron-left" class="h-5 w-5 text-gray-400"></i>
                    </div>
                    <div class="menu-item font-bold text-gray-600 hover:bg-transparent" onclick="navigateTo('Dashboard', getDashboardTitle(STORE_HANDLE || MOCK_STORE_HANDLE))">
                        <span class="flex items-center">
                            <i data-lucide="layout-dashboard" class="h-5 w-5 ml-3 text-gray-400"></i>
                            Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                        </span>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderSubMenu_Texts(state) {
            backButton.classList.remove('hidden');
            const menuType = state.replace('SubMenu_', ''); // MINI_APP_UI or USER_NOTIFICATIONS
            const keys = CUSTOM_TEXT_KEYS[menuType];
            const menuTitle = menuType === 'MINI_APP_UI' ? "Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾" : "Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ø¹Ù„Ø§Ù† Ø±Ø¨Ø§Øª Ú©Ø§Ø±Ø¨Ø±";
            
            headerTitle.textContent = menuTitle;

            if (successMessage) {
                showMessage(successMessage);
                successMessage = null;
            }

            content.innerHTML = `
                <h2 class="text-2xl font-extrabold text-gray-800 mb-2">${menuTitle}</h2>
                <p class="text-sm text-gray-500 mb-6">Ù…ØªÙ† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p>
                <div class="bg-white border border-gray-100 rounded-2xl divide-y divide-gray-100 shadow-xl">
                    ${Object.entries(keys).map(([key, data]) => {
                        const menuIcon = data.icon || 'file-text';
                        const iconColor = menuType === 'MINI_APP_UI' ? 'text-indigo-500' : 'text-orange-500';
                        return `
                            <div class="menu-item" onclick="navigateTo('EditScreen_${key}', 'ÙˆÛŒØ±Ø§ÛŒØ´: ${data.name}')">
                                <span class="flex items-center text-gray-800">
                                    <i data-lucide="${menuIcon}" class="h-5 w-5 ml-3 ${iconColor}"></i>
                                    ${data.name}
                                </span>
                                <i data-lucide="chevron-left" class="h-5 w-5 text-gray-400"></i>
                            </div>
                        `;
                    }).join('')}
                    <div class="menu-item font-bold text-indigo-600 hover:bg-transparent" onclick="navigateTo('MainMenu', 'Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªÙˆÙ†')">
                        <span class="flex items-center">
                            <i data-lucide="undo-2" class="h-5 w-5 ml-3"></i>
                            Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ
                        </span>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderEditScreen(state) {
            backButton.classList.remove('hidden');
            currentEditKey = state.replace('EditScreen_', '');
            const keyData = getFullKeyData(currentEditKey);

            if (!keyData) {
                content.innerHTML = `<p class="text-red-600 p-4 font-bold">Ø®Ø·Ø§: Ú©Ù„ÛŒØ¯ Ù…ØªÙ†ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.</p>`;
                return;
            }

            headerTitle.textContent = `ÙˆÛŒØ±Ø§ÛŒØ´: ${keyData.name}`;

            const isNotification = keyData.type === 'USER_NOTIFICATIONS';
            const isUrlField = keyData.isUrl;

            // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ \n Ø¨Ø§ Ø¯Ùˆ ÙØ§ØµÙ„Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ± Ø¯Ø± textarea
            const currentText = (appTexts[currentEditKey] || keyData.defaultText || "Ù…ØªÙ† Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.").replace(/\\n/g, '\n');
            
            let markdownGuideHTML = '';
            let inputElement;

            if (isNotification) {
                // Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ Notification Texts
                markdownGuideHTML = `
                    <div class="bg-blue-50 border-r-4 border-blue-400 p-4 mb-4 rounded-xl text-sm text-gray-700 shadow-inner">
                        <p class="font-bold text-blue-700 flex items-center mb-2"><i data-lucide="code" class="h-5 w-5 ml-2"></i> Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Markdown Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§</p>
                        
                        <!-- Ø¬Ø¯ÙˆÙ„ Markdown -->
                        <div class="bg-white border rounded-lg overflow-hidden mt-3">
                            <table class="w-full text-right text-xs">
                                <thead class="bg-gray-100 font-semibold text-gray-600">
                                    <tr>
                                        <th class="p-2 border-b">Ø³ÛŒÙ†ØªÚ©Ø³</th>
                                        <th class="p-2 border-b">ØªÙˆØ¶ÛŒØ­</th>
                                        <th class="p-2 border-b">Ù†Ù…ÙˆÙ†Ù‡ Ø®Ø±ÙˆØ¬ÛŒ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-2 border-b font-mono">**Ù…ØªÙ†**</td>
                                        <td class="p-2 border-b">Ù…ØªÙ† Ø¨ÙˆÙ„Ø¯</td>
                                        <td class="p-2 border-b font-bold">Ù…ØªÙ† Ø¶Ø®ÛŒÙ…</td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-2 border-b font-mono">*Ù…ØªÙ†*</td>
                                        <td class="p-2 border-b">Ù…ØªÙ† Ú©Ø¬</td>
                                        <td class="p-2 border-b italic">Ù…ØªÙ† Ú©Ø¬</td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-2 border-b font-mono">\`Ú©Ø¯\`</td>
                                        <td class="p-2 border-b">Ù†ÙˆØ´ØªÙ† Ú©Ø¯ ÛŒØ§ ID</td>
                                        <td class="p-2 border-b font-mono text-sm bg-gray-100 rounded">Ú©Ø¯</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù¾ÙˆÛŒØ§ -->
                        <p class="font-bold text-blue-700 mt-4 mb-1 flex items-center"><i data-lucide="variable" class="h-5 w-5 ml-2"></i> Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù¾ÙˆÛŒØ§ (Dynamic Variables)</p>
                        <p class="mb-2">Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ØªØºÛŒØ± ØªÛŒÚ©ØªØŒ **Ø¯Ù‚ÛŒÙ‚Ø§Ù‹** Ø§Ø² Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ (Ø­Ø³Ø§Ø³ Ø¨Ù‡ Ø­Ø±ÙˆÙ Ø¨Ø²Ø±Ú¯ Ùˆ Ú©ÙˆÚ†Ú©):</p>
                        <ul class="list-disc pr-5 space-y-1 font-mono text-xs">
                            <li><code>{Subject}</code>: Ù…ÙˆØ¶ÙˆØ¹ ØªÛŒÚ©Øª</li>
                            <li><code>{Department}</code>: Ù†Ø§Ù… Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†</li>
                        </ul>
                    </div>
                `;
            } else {
                 // Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ UI Texts - ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¨Ù‡ Ø¯Ø§Ø®Ù„ Ú©Ø§Ø¯Ø± Ø²Ø±Ø¯ Ø±Ù†Ú¯ Ù…Ù†ØªÙ‚Ù„ Ø´Ø¯.
                 // keyData.desc Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ù…Ø§Ù† Ù…ØªÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø³Øª.
                 const description = keyData.desc || 'ØªÙˆØ¶ÛŒØ­Ø§Øª Ø®Ø§ØµÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…ØªÙ† Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¢Ù† Ø±Ø§ Ø³Ø§Ø¯Ù‡ Ùˆ Ù…Ø®ØªØµØ± Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯.';
                 markdownGuideHTML = `
                     <div class="bg-yellow-50 border-r-4 border-yellow-400 p-3 mb-4 rounded-xl text-sm text-gray-700 flex items-start shadow-inner">
                         <i data-lucide="alert-triangle" class="h-5 w-5 ml-2 text-yellow-700 flex-shrink-0 mt-0.5"></i>
                         <div>
                             <span class="font-bold text-yellow-700 ml-1">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…ØªÙ†:</span>
                             <span>${description}</span>
                         </div>
                     </div>
                   `;
            }

            if (isUrlField) {
                // ÙÛŒÙ„Ø¯ ØªÚ©â€ŒØ®Ø·ÛŒ Ø¨Ø±Ø§ÛŒ URL
                inputElement = `
                    <!-- Ø§Ù†Ø¯Ø§Ø²Ù‡ ÙÙˆÙ†Øª ÙˆØ±ÙˆØ¯ÛŒ Ø¨Ù‡ text-sm Ú©Ø§Ù‡Ø´ ÛŒØ§ÙØª -->
                    <input id="edit-area" type="url" value="${currentText.replace(/\n/g, '')}" class="w-full p-4 border border-gray-300 rounded-xl shadow-inner focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition duration-150 text-gray-800 text-sm" placeholder="Ù…Ø«Ù„Ø§Ù‹: https://yourdomain.com/faq">
                `;
            } else {
                // ÙÛŒÙ„Ø¯ Ú†Ù†Ø¯Ø®Ø·ÛŒ Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ø²Ø±Ú¯ Ø´Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø±
                inputElement = `
                    <!-- Ø§Ù†Ø¯Ø§Ø²Ù‡ ÙÙˆÙ†Øª ÙˆØ±ÙˆØ¯ÛŒ Ø¨Ù‡ text-sm Ú©Ø§Ù‡Ø´ ÛŒØ§ÙØª -->
                    <textarea id="edit-area" rows="4" class="auto-resize-textarea w-full p-4 border border-gray-300 rounded-xl shadow-inner focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition duration-150 text-gray-800 text-sm" placeholder="Ù…ØªÙ† Ø¬Ø¯ÛŒØ¯ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...">${currentText}</textarea>
                `;
            }

            content.innerHTML = `
                <h2 class="text-2xl font-extrabold text-gray-800 mb-2">ÙˆÛŒØ±Ø§ÛŒØ´: ${keyData.name}</h2>

                ${markdownGuideHTML}

                <!-- Ù†Ø§Ø­ÛŒÙ‡ ÙˆÛŒØ±Ø§ÛŒØ´ Ù…ØªÙ†/ÙˆØ±ÙˆØ¯ÛŒ -->
                ${inputElement}

                <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª -->
                <div class="flex justify-end space-x-3 mt-4" dir="ltr">
                    <button onclick="handleBack()" class="px-5 py-3 bg-gray-200 text-gray-800 rounded-xl hover:bg-gray-300 transition duration-150 font-semibold shadow-md hover:shadow-lg">
                        <i data-lucide="x-circle" class="h-5 w-5 inline ml-1"></i> Ù„ØºÙˆ (Ø¨Ø§Ø²Ú¯Ø´Øª)
                    </button>
                    <!-- Ø¯Ú©Ù…Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø¨Ø§ Ú¯Ø±Ø§Ø¯ÛŒØ§Ù†Øª Ùˆ Ø³Ø§ÛŒÙ‡ Ù‚ÙˆÛŒâ€ŒØªØ± -->
                    <button id="save-button" onclick="handleSave()" class="px-5 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl hover:from-indigo-700 hover:to-purple-700 transition duration-150 font-semibold shadow-lg shadow-indigo-400/50">
                        <i data-lucide="save" class="h-5 w-5 inline ml-1"></i> Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª
                    </button>
                </div>
            `;
            lucide.createIcons();
            
            // Ø§Ú¯Ø± ÙÛŒÙ„Ø¯ textarea Ø§Ø³ØªØŒ Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ø²Ø±Ú¯ Ø´Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø± Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
            const editArea = document.getElementById('edit-area');
            if (editArea && !isUrlField) {
                // Ø§Ø¹Ù…Ø§Ù„ resize Ø§ÙˆÙ„ÛŒÙ‡
                autoResize(editArea); 
                // Ø§ÙØ²ÙˆØ¯Ù† event listener Ø¨Ø±Ø§ÛŒ resize Ù‡Ù†Ú¯Ø§Ù… ØªØ§ÛŒÙ¾
                editArea.addEventListener('input', () => autoResize(editArea));
            }
        }


        // --- ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø±Ù†Ø¯Ø± ---

        function render() {
            if (currentState === 'Loading') {
                content.innerHTML = document.getElementById('loading-spinner').outerHTML;
                lucide.createIcons(); // Ø­ØªÙ…Ø§Ù‹ Ø¢ÛŒÚ©ÙˆÙ† Ù„ÙˆØ¯Ø± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†Ø¯
                return;
            }

            content.classList.add('transition', 'duration-300', 'opacity-0');
            setTimeout(() => {
                
                if (currentState === 'Dashboard') {
                    renderDashboard();
                } else if (currentState === 'MainMenu') {
                    renderMainMenu();
                } else if (currentState.startsWith('SubMenu_')) {
                    renderSubMenu_Texts(currentState);
                } else if (currentState.startsWith('EditScreen_')) {
                    renderEditScreen(currentState);
                } else {
                    renderDashboard();
                }
                
                backButton.classList[history.length > 0 ? 'remove' : 'add']('hidden');
                
                content.classList.remove('opacity-0');
            }, 50);
        }

        // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
        backButton.addEventListener('click', handleBack);

        // Ø´Ø±ÙˆØ¹ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†: Ø§Ø¨ØªØ¯Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² Worker Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†
        fetchInitialData();
    </script>
    <script>
        // Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        window.onload = function() {
            lucide.createIcons();
        }
    </script>
</body>
</html>

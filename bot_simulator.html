<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت تیکت تل (Mini App)</title>
    <!-- بارگذاری Tailwind CSS و Lucide Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- فونت‌های جدید: Vazirmatn برای فارسی و Inter برای انگلیسی -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* تنظیم فونت و تم اصلی - شبیه به ویدیو */
        body {
            font-family: 'Vazirmatn', 'Inter', Tahoma, sans-serif;
            background-color: #f7f8fa; /* پس‌زمینه خاکستری بسیار روشن */
            /* padding-bottom برای ایجاد فضا برای نوار ناوبری پایین */
            padding-bottom: 100px;
        }
        
        /* سبک برای کارت‌های داشبورد - شبیه‌سازی سبک ویدیو */
        .metric-card {
            background-color: #ffffff;
            padding: 1.25rem;
            border-radius: 20px; /* گوشه‌های بسیار گرد */
            /* سایه نرم و عمیق‌تر شبیه ویدیو */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.07);
            border: none;
            transition: all 0.3s;
        }
        .metric-card:hover {
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }
        
        /* سبک برای textarea با قابلیت بزرگ شدن خودکار */
        .auto-resize-textarea {
            overflow: hidden; 
            resize: none; 
            min-height: 120px;
            height: auto;
        }

        /* سبک برای آیتم فعال در نوار ناوبری پایین */
        .nav-item.active {
            color: #4f46e5; /* رنگ اصلی اپ (Indigo) */
        }
        .nav-item.active span {
             font-weight: 700;
        }
    </style>
</head>
<body class="antialiased">

    <!-- کانتینر اصلی اپلیکیشن -->
    <div id="app-container">
        <!-- هدر ثابت، ساده و سفید - شبیه به ویدیو -->
        <header class="bg-white text-gray-900 p-4 flex items-center shadow-sm sticky top-0 z-10">
            <!-- آیکون بازگشت -->
            <button id="back-button" class="text-gray-700 p-2 hover:bg-gray-100 rounded-full transition duration-150 hidden">
                <i data-lucide="chevron-right" class="h-6 w-6"></i>
            </button>
            <h1 id="header-title" class="text-lg font-extrabold mr-4 flex-grow truncate">پنل مدیریت ربات</h1>
            <!-- می‌توانید آیکون‌هایی مثل خورشید (تم) در اینجا اضافه کنید -->
            <!-- <i data-lucide="sun" class="h-6 w-6 text-gray-600"></i> -->
        </header>

        <!-- کانتینر اصلی محتوا (padding بیشتر برای فضای باز) -->
        <div id="content" class="p-6 space-y-5">
            <div id="loading-spinner" class="text-center p-8 mt-10">
                <i data-lucide="loader-circle" class="animate-spin h-10 w-10 text-indigo-600 inline"></i>
                <p class="mt-4 text-gray-600 font-semibold">در حال بارگذاری داده‌های اولیه...</p>
            </div>
        </div>
    </div>

    <!-- نوار ناوبری پایین صفحه - شبیه به ویدیو -->
    <nav id="footer-nav" class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-5px_20px_rgba(0,0,0,0.05)] rounded-t-3xl h-20 flex justify-around items-center z-10">
        <button onclick="navigateTo('Dashboard', getDashboardTitle(STORE_HANDLE || MOCK_STORE_HANDLE))" id="nav-dashboard" class="nav-item flex flex-col items-center justify-center text-gray-500 w-full" data-page="Dashboard">
            <i data-lucide="layout-dashboard" class="h-6 w-6"></i>
            <span class="text-xs font-semibold mt-1">داشبورد</span>
        </button>
        <button onclick="navigateTo('MainMenu', 'مدیریت متون')" id="nav-settings" class="nav-item flex flex-col items-center justify-center text-gray-500 w-full" data-page="MainMenu">
            <i data-lucide="settings" class="h-6 w-6"></i>
            <span class="text-xs font-semibold mt-1">تنظیمات</span>
        </button>
    </nav>


    <!-- پیام نمایش داده شده در پایین صفحه -->
    <div id="message-box" class="fixed bottom-24 left-4 right-4 p-4 text-white text-center rounded-2xl shadow-2xl z-20 hidden transform transition-all duration-300 translate-y-10 opacity-0">
        عملیات با موفقیت انجام شد!
    </div>

    <script>
        // --- تنظیمات مهم (WORKER & STORE) ---

        // 1. استخراج STORE_HANDLE از پارامتر URL
        const urlParams = new URLSearchParams(window.location.search);
        const STORE_HANDLE = urlParams.get('storeHandle'); 
        
        // --- MOCK DATA FOR TESTING IN CANVAS ---
        const MOCK_STORE_HANDLE = 'test-store-mock-dfdfdfd'; 
        
        const mockAppTexts = {
            greetingTitle: "سلام مدیر عزیز! 👋 (آزمایشی)",
            quickTipMessage: "💡 نکته: این متون برای تست در حالت آزمایشی بارگذاری شده‌اند.",
            faqButtonEnabled: "true", 
            faqButtonText: "مشاهده سوالات متداول",
            faqUrl: "https://mock.faq.com/",
            navTickets: "تیکت‌ها",
            navNewTicket: "تیکت جدید",
            infoModalTitle: "راهنمای ارسال تیکت",
            infoModalTip: "لطفا ابتدا صفحه سوالات متداول را بررسی کنید.",
            closedTicketBanner: "این گفتگو توسط پشتیبانی بسته شده است.",
            submitNewTicketBtn: "ارسال",
            modalCloseBtn: "متوجه شدم",
            userReplyNotification: "✅ *پشتیبانی فنی* به تیکت شما با موضوع *مشکل اتصال* پاسخ داد.\\n\\nبرای مشاهده پاسخ کلیک کنید.",
            ticketClosedNotification: "🎫 تیکت شما با موضوع *پرداخت ناموفق* بسته شد.\\n\\nلطفا امتیاز دهید.",
        };
        
        const mockAppStats = {
            totalCount: '145',
            totalActive: '4',
            openCount: '3',
            pendingCount: '1',
            avgRating: '4.92',
            ratingPercentage: '88.5',
            ratedTicketsCount: 120,
            avgFirstResponseTime: '3 ساعت و 15 دقیقه',
            avgTimeToResolution: '1 روز و 5 ساعت',
        };

        // 2. آدرس پایه Worker API
        const WORKER_API_BASE_URL = 'https://ticketing.amiruserbot7.workers.dev'; 

        // تابع برای ساخت عنوان داشبورد
        const getDashboardTitle = (handle) => `داشبورد (${handle || 'ناشناس'})`;


        // --- پایان تنظیمات ---

        const content = document.getElementById('content');
        const backButton = document.getElementById('back-button');
        const headerTitle = document.getElementById('header-title');
        const messageBox = document.getElementById('message-box');

        // وضعیت‌های اصلی: Dashboard, MainMenu, SubMenu_MINIAPPUI, SubMenu_USERNOTIFICATIONS, EditScreen
        let currentState = 'Loading';
        const history = [];
        let appTexts = {}; // ذخیره متون دریافتی از Worker
        let appStats = {}; // ذخیره آمار دریافتی از Worker
        let currentEditKey = null; // کلید متنی که در حال ویرایش است
        let successMessage = null; // برای نمایش پیام موفقیت در ناوبری

        // ساختار ثابت متون برای استفاده در منوها (باید با Worker همگام باشد)
        const CUSTOM_TEXT_KEYS = {
            MINI_APP_UI: {
                greetingTitle: { name: "عنوان خوش‌آمدگویی", icon: "user-check", desc: `متن اصلی کارت راهنما (مثلاً: سلام مشتری عزیز!)` },
                quickTipMessage: { name: "پیام راهنمای سریع", icon: "lightbulb", desc: `متن کوچک زیر عنوان در کارت راهنما (مثلاً: لطفا مشکل را با جزئیات بنویسید)` },
                faqButtonEnabled: { name: "وضعیت دکمه راهنما", icon: "toggle-right", desc: `دکمه سوالات متداول را در مینی‌اپ فعال یا غیرفعال کنید.`, isBoolean: true },
                faqButtonText: { name: "متن دکمه راهنما", icon: "help-circle", desc: `متنی که روی دکمه مشاهده سوالات متداول نمایش داده می‌شود.` },
                faqUrl: { name: "لینک دکمه راهنما", icon: "link", desc: `آدرس URL کامل (باید با https:// شروع شود).`, isUrl: true }, 
                navTickets: { name: "منوی: تیکت‌ها", icon: "ticket", desc: `متن آیکون تیکت‌ها در نوار پایین مینی‌اپ.` },
                navNewTicket: { name: "منوی: تیکت جدید", icon: "file-plus", desc: `متن آیکون ایجاد تیکت جدید در نوار پایین مینی‌اپ.` },
                infoModalTitle: { name: "عنوان راهنمای تیکت", icon: "info", desc: `عنوان پنجره‌ای که قبل از ثبت تیکت جدید نمایش داده می‌شود.` },
                infoModalTip: { name: "پیام راهنمای مودال", icon: "message-square-text", desc: `متن اصلی داخل پنجره راهنما قبل از ثبت تیکت.` },
                closedTicketBanner: { name: "بنر تیکت بسته شده", icon: "lock", desc: `متنی که در پایین یک تیکت بسته شده نمایش داده می‌شود.` },
                submitNewTicketBtn: { name: "متن دکمه ارسال", icon: "send", desc: `متنی که روی دکمه 'ارسال' تیکت جدید نمایش داده می‌شود.` },
                modalCloseBtn: { name: "متن دکمه متوجه شدم", icon: "x-circle", desc: `متن دکمه بستن پنجره‌های مودال.` },
            },
            USER_NOTIFICATIONS: {
                userReplyNotification: { name: "اعلان پاسخ ادمین", icon: "bell-plus", desc: `متنی که پس از پاسخ ادمین، برای کاربر ارسال می‌شود. این متن از متغیرهای پویا پشتیبانی می‌کند.` },
                ticketClosedNotification: { name: "اعلان بسته شدن تیکت", icon: "bell-off", desc: `متنی که پس از بستن تیکت، برای کاربر ارسال می‌شود. این متن از متغیرهای پویا پشتیبانی می‌کند.` },
            }
        };


        // --- توابع کمکی ---
        
        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight) + 'px';
        }

        function getFullKeyData(key) {
            for (const menuType in CUSTOM_TEXT_KEYS) {
                if (CUSTOM_TEXT_KEYS[menuType][key]) {
                    return { type: menuType, key, ...CUSTOM_TEXT_KEYS[menuType][key] };
                }
            }
            return null;
        }

        function showMessage(text, type = 'success', duration = 4000) {
            messageBox.textContent = text;
            messageBox.className = `fixed bottom-24 left-4 right-4 p-4 text-white text-center rounded-2xl shadow-2xl z-20 transform transition-all duration-300 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            
            // Animate in
            setTimeout(() => {
                messageBox.classList.remove('hidden', 'translate-y-10', 'opacity-0');
            }, 10);
            
            // Animate out
            setTimeout(() => {
                messageBox.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, duration);
        }

        // [جدید] تابع برای به‌روزرسانی نوار ناوبری پایین
        function updateFooterNav(state) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active', 'text-indigo-600');
                item.classList.add('text-gray-500');
            });
            
            let activeItem;
            if (state === 'Dashboard') {
                activeItem = document.getElementById('nav-dashboard');
            } else if (state === 'MainMenu' || state.startsWith('SubMenu_') || state.startsWith('EditScreen_')) {
                // تمام صفحات مربوط به تنظیمات، آیکون تنظیمات را فعال می‌کنند
                activeItem = document.getElementById('nav-settings');
            }
            
            if (activeItem) {
                activeItem.classList.add('active', 'text-indigo-600');
                activeItem.classList.remove('text-gray-500');
            }
        }


        function navigateTo(newState, title = null, pushHistory = true) {
            if (pushHistory && currentState !== 'Loading') {
                history.push(currentState);
            }
            currentState = newState;
            
            const currentHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            const dashboardTitle = getDashboardTitle(currentHandle);
            
            headerTitle.textContent = title || dashboardTitle;
            updateFooterNav(newState); // [جدید] به‌روزرسانی نوار پایین
            render();
            window.scrollTo(0, 0); // اسکرول به بالای صفحه در هر ناوبری
        }

        function handleBack() {
            if (currentState.startsWith('EditScreen_')) {
                currentEditKey = null;
            }

            if (history.length > 0) {
                const previousState = history.pop();
                
                const currentHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
                const dashboardTitle = getDashboardTitle(currentHandle);
                
                let title = dashboardTitle;
                if (previousState === 'MainMenu') {
                    title = 'مدیریت متون';
                } else if (previousState.startsWith('SubMenu_')) {
                    const menuType = previousState.replace('SubMenu_', '');
                    title = menuType === 'MINI_APP_UI' ? 'متن‌های مینی‌اپ' : 'متن‌های اعلان ربات';
                }
                
                currentState = previousState;
                headerTitle.textContent = title;
                updateFooterNav(previousState); // [جدید] به‌روزرسانی نوار پایین
                render(false);
                window.scrollTo(0, 0);
            } else {
                // اگر هیستوری خالی بود به داشبورد برگرد
                navigateTo('Dashboard', getDashboardTitle(STORE_HANDLE || MOCK_STORE_HANDLE), false);
            }
        }

        // --- Data Fetching (از Worker API) ---

        async function fetchStats() {
            const currentStoreHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            if (currentStoreHandle === MOCK_STORE_HANDLE) return mockAppStats; 

            const url = `${WORKER_API_BASE_URL}/api/${currentStoreHandle}/stats`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch stats from Worker.');
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Worker stats returned error.');
            return result.data;
        }

        async function fetchAppTexts() {
            const currentStoreHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            if (currentStoreHandle === MOCK_STORE_HANDLE) return mockAppTexts; 

            const url = `${WORKER_API_BASE_URL}/api/${currentStoreHandle}/texts`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Worker failed to fetch texts.');
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Worker texts returned error.');
            return result.data;
        }

        async function fetchInitialData() {
            try {
                if (!STORE_HANDLE) {
                    throw new Error("Missing STORE_HANDLE, loading mock data.");
                }

                const [textsData, statsData] = await Promise.all([
                    fetchAppTexts(),
                    fetchStats()
                ]);

                appTexts = textsData;
                appStats = statsData;

            } catch (error) {
                console.warn(`Error in fetchInitialData: ${error.message}. Loading mock data...`);
                appTexts = mockAppTexts;
                appStats = mockAppStats;
                if(error.message !== "Missing STORE_HANDLE, loading mock data."){
                    showMessage(`❌ خطا در اتصال به API: ${error.message.substring(0, 50)}... بارگذاری داده آزمایشی.`, 'error');
                }
            }
            currentState = 'Dashboard';
            updateFooterNav('Dashboard'); // [جدید] تنظیم حالت اولیه نوار پایین
            render();
        }

        // --- Data Persistence (از طریق Worker API) ---
        async function handleSave() {
            const saveButton = document.getElementById('save-button');
            const editElement = document.getElementById('edit-area');
            const newText = editElement.value; 

            if (!currentEditKey) return;
            const keyData = getFullKeyData(currentEditKey);

            if (keyData.isUrl) {
                if (!newText.startsWith('https://')) {
                    showMessage('❌ لینک باید با https:// شروع شود.', 'error', 5000);
                    return;
                }
            }

            saveButton.disabled = true;
            saveButton.innerHTML = '<i data-lucide="loader-circle" class="animate-spin h-5 w-5 inline mr-2"></i> در حال ذخیره...';
            lucide.createIcons(); 

            const currentStoreHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            
            if (currentStoreHandle === MOCK_STORE_HANDLE) {
                appTexts[currentEditKey] = newText;
                successMessage = `✅ تنظیم "${keyData.name}" با موفقیت در حالت آزمایشی ذخیره شد!`;
                
                navigateTo(`SubMenu_${keyData.type}`, 'مدیریت متون');
                return;
            }

            const url = `${WORKER_API_BASE_URL}/api/${currentStoreHandle}/texts`;
            const payload = { [currentEditKey]: newText };

            try {
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                if (response.ok && result.success) {
                    appTexts[currentEditKey] = newText; 
                    successMessage = `✅ تنظیم "${keyData.name}" با موفقیت ذخیره و اعمال شد!`;
                    
                    navigateTo(`SubMenu_${keyData.type}`, 'مدیریت متون');
                } else {
                    throw new Error(result.error || 'خطا در Worker API هنگام ذخیره.');
                }
            } catch (error) {
                console.error("Error saving text via Worker:", error);
                showMessage(`❌ خطا در ذخیره تنظیم: ${error.message}`, 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = '<i data-lucide="save" class="h-5 w-5 inline ml-1"></i> ذخیره تغییرات';
                lucide.createIcons();
            }
        }


        // =================================================================
        // RENDER FUNCTIONS (UI) - بازطراحی شده
        // =================================================================

        function renderDashboard() {
            backButton.classList.add('hidden');
            const currentHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            headerTitle.textContent = getDashboardTitle(currentHandle);
            const stats = appStats;

            if (successMessage) {
                showMessage(successMessage);
                successMessage = null;
            }
            
            const ratingPercent = parseFloat(stats.ratingPercentage || '0');
            const progressBarColor = ratingPercent >= 90 ? 'bg-green-500' : 
                                     ratingPercent >= 75 ? 'bg-yellow-500' : 'bg-red-500';

            const metricCards = [
                { title: "کل تیکت‌ها", value: stats.totalCount || '0', icon: "ticket", color: "text-indigo-600", desc: "تعداد کل تیکت‌های ثبت شده." },
                { title: "تیکت‌های فعال", value: stats.totalActive || '0', icon: "inbox", color: "text-red-600", desc: "باز و در انتظار پاسخ ادمین." },
                { title: "امتیاز میانگین", value: `${stats.avgRating || 'N/A'} / 5.00`, icon: "star", color: "text-yellow-600", desc: `بر اساس ${stats.ratedTicketsCount || 0} امتیاز.` },
                { title: "میانگین پاسخ", value: stats.avgFirstResponseTime || 'N/A', icon: "clock-3", color: "text-green-600", desc: "زمان متوسط اولین پاسخ." },
            ];

            content.innerHTML = `
                <div class="space-y-6">
                    
                    <h2 class="text-2xl font-extrabold text-gray-800 border-b pb-3 mb-4">گزارش عملکرد</h2>
                    
                    <div class="grid grid-cols-2 gap-4">
                        ${metricCards.map(card => `
                            <div class="metric-card">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-semibold text-gray-500">${card.title}</h3>
                                    <i data-lucide="${card.icon}" class="${card.color} h-6 w-6"></i>
                                </div>
                                <p class="text-2xl font-extrabold text-gray-900">${card.value}</p>
                                <p class="text-xs text-gray-400 mt-1 truncate">${card.desc}</p>
                            </div>
                        `).join('')}
                    </div>

                    <!-- بخش سرعت و نوار پیشرفت - در یک کارت شیک -->
                    <div class="metric-card bg-white">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="zap" class="h-5 w-5 ml-2 text-purple-600"></i> شاخص‌های کلیدی (KPI)
                        </h3>
                        
                        <div class="space-y-4">
                            <p class="flex justify-between text-sm">
                                <span class="text-gray-600">زمان حل نهایی تیکت:</span>
                                <span class="font-bold text-gray-800">${stats.avgTimeToResolution || 'N/A'}</span>
                            </p>

                            <!-- نوار پیشرفت ویژوالایزر امتیاز -->
                            <div>
                                <p class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">درصد رضایت کاربران:</span>
                                    <span class="font-bold text-gray-800">${stats.ratingPercentage || '0.0'}%</span>
                                </p>
                                <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                    <div class="${progressBarColor} h-2.5 rounded-full transition-all duration-500" style="width: ${ratingPercent > 100 ? 100 : ratingPercent}%;"></div>
                                </div>
                            </div>

                        </div>
                    </div>
                    
                    <!-- دکمه مدیریت متون - بازطراحی شده شبیه دکمه‌های ویدیو -->
                    <button onclick="navigateTo('MainMenu', 'مدیریت متون')" class="w-full bg-white text-gray-900 py-5 mt-4 rounded-2xl shadow-lg hover:shadow-xl transition duration-300 font-bold flex items-center justify-center text-base">
                        <i data-lucide="settings" class="h-6 w-6 ml-2 text-indigo-600"></i>
                        مدیریت متون و تنظیمات
                    </button>
                </div>
            `;
            lucide.createIcons();
        }

        function renderMainMenu() {
            backButton.classList.remove('hidden');
            headerTitle.textContent = 'مدیریت متون';
            
            if (successMessage) {
                showMessage(successMessage);
                successMessage = null;
            }

            content.innerHTML = `
                <h2 class="text-2xl font-extrabold text-gray-800 mb-2">شخصی‌سازی محتوا</h2>
                <p class="text-sm text-gray-500 mb-6">متون کلیدی مینی اپ و اعلان‌های ربات را ویرایش کنید.</p>
                
                <!-- منوی جدید کارتی - شبیه ویدیو -->
                <div class="space-y-4">
                    <div class="bg-white rounded-2xl shadow-lg p-5 cursor-pointer transition duration-200 hover:shadow-xl" onclick="navigateTo('SubMenu_MINI_APP_UI', 'متن‌های مینی‌اپ')">
                        <div class="flex items-center justify-between">
                            <span class="flex items-center font-bold text-gray-800 text-base">
                                <i data-lucide="smartphone" class="h-6 w-6 ml-3 text-indigo-600"></i>
                                متن‌های مینی‌اپ
                            </span>
                            <i data-lucide="chevron-left" class="h-5 w-5 text-gray-400"></i>
                        </div>
                        <p class="text-sm text-gray-500 mt-2 pr-9">ویرایش رابط کاربری و پیام‌های داخل مینی‌اپ.</p>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-5 cursor-pointer transition duration-200 hover:shadow-xl" onclick="navigateTo('SubMenu_USER_NOTIFICATIONS', 'متن‌های اعلان ربات')">
                        <div class="flex items-center justify-between">
                            <span class="flex items-center font-bold text-gray-800 text-base">
                                <i data-lucide="bell" class="h-6 w-6 ml-3 text-orange-600"></i>
                                متن‌های اعلان کاربر
                            </span>
                            <i data-lucide="chevron-left" class="h-5 w-5 text-gray-400"></i>
                        </div>
                        <p class="text-sm text-gray-500 mt-2 pr-9">ویرایش پیام‌هایی که ربات برای کاربران ارسال می‌کند.</p>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderSubMenu_Texts(state) {
            backButton.classList.remove('hidden');
            const menuType = state.replace('SubMenu_', ''); // MINI_APP_UI or USER_NOTIFICATIONS
            const keys = CUSTOM_TEXT_KEYS[menuType];
            const menuTitle = menuType === 'MINI_APP_UI' ? "متن‌های مینی‌اپ" : "متن‌های اعلان ربات";
            
            headerTitle.textContent = menuTitle;

            if (successMessage) {
                showMessage(successMessage);
                successMessage = null;
            }

            content.innerHTML = `
                <h2 class="text-2xl font-extrabold text-gray-800 mb-2">${menuTitle}</h2>
                <p class="text-sm text-gray-500 mb-6">متن مورد نظر برای ویرایش را انتخاب کنید:</p>
                
                <!-- لیست کارتی گزینه‌ها - شبیه ویدیو -->
                <div class="space-y-4">
                    ${Object.entries(keys).map(([key, data]) => {
                        const menuIcon = data.icon || 'file-text';
                        const iconColor = menuType === 'MINI_APP_UI' ? 'text-indigo-500' : 'text-orange-500';
                        
                        let additionalInfo = '';
                        if (data.isBoolean) {
                            const currentValue = (appTexts[key] === "true" || typeof appTexts[key] === 'undefined');
                            additionalInfo = currentValue
                                ? `<span class="text-xs font-semibold bg-green-100 text-green-700 px-2 py-0.5 rounded-full">فعال</span>`
                                : `<span class="text-xs font-semibold bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">غیرفعال</span>`;
                        }

                        return `
                            <div class="bg-white rounded-2xl shadow-lg p-5 cursor-pointer transition duration-200 hover:shadow-xl" onclick="navigateTo('EditScreen_${key}', 'ویرایش: ${data.name}')">
                                <div class="flex items-center justify-between">
                                    <span class="flex items-center font-bold text-gray-800 text-base">
                                        <i data-lucide="${menuIcon}" class="h-6 w-6 ml-3 ${iconColor}"></i>
                                        ${data.name}
                                    </span>
                                    <div class="flex items-center">
                                        ${additionalInfo}
                                        <i data-lucide="chevron-left" class="h-5 w-5 text-gray-400 ml-2"></i>
                                    </div>
                                </div>
                                <!-- اضافه کردن توضیحات به کارت -->
                                <p class="text-sm text-gray-500 mt-2 pr-9">${data.desc}</p>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            lucide.createIcons();
        }

        function renderEditScreen(state) {
            backButton.classList.remove('hidden');
            currentEditKey = state.replace('EditScreen_', '');
            const keyData = getFullKeyData(currentEditKey);

            if (!keyData) {
                content.innerHTML = `<p class="text-red-600 p-4 font-bold">خطا: کلید متنی نامعتبر است.</p>`;
                return;
            }

            headerTitle.textContent = `ویرایش: ${keyData.name}`;

            const isNotification = keyData.type === 'USER_NOTIFICATIONS';
            const isUrlField = keyData.isUrl;
            const isBooleanField = keyData.isBoolean; 

            const currentText = (appTexts[currentEditKey] || keyData.defaultText || "متن پیش‌فرض موجود نیست.").replace(/\\n/g, '\n');
            
            let markdownGuideHTML = '';
            let inputElement;

            if (isNotification) {
                markdownGuideHTML = `
                    <div class="bg-blue-50 border border-blue-200 p-4 mb-5 rounded-2xl text-sm text-gray-700 shadow-md">
                        <p class="font-bold text-blue-700 flex items-center mb-2"><i data-lucide="code" class="h-5 w-5 ml-2"></i> راهنمای Markdown و متغیرها</p>
                        
                        <div class="bg-white border rounded-lg overflow-hidden mt-3">
                            <table class="w-full text-right text-xs">
                                <thead class="bg-gray-100 font-semibold text-gray-600">
                                    <tr>
                                        <th class="p-2 border-b">سینتکس</th>
                                        <th class="p-2 border-b">توضیح</th>
                                        <th class="p-2 border-b">نمونه</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="hover:bg-gray-50"><td class="p-2 border-b font-mono">**متن**</td><td class="p-2 border-b">بولد</td><td class="p-2 border-b font-bold">متن</td></tr>
                                    <tr class="hover:bg-gray-50"><td class="p-2 border-b font-mono">*متن*</td><td class="p-2 border-b">کج</td><td class="p-2 border-b italic">متن</td></tr>
                                    <tr class="hover:bg-gray-50"><td class="p-2 border-b font-mono">\`کد\`</td><td class="p-2 border-b">کد</td><td class="p-2 border-b font-mono text-sm bg-gray-100 rounded">کد</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <p class="font-bold text-blue-700 mt-4 mb-1 flex items-center"><i data-lucide="variable" class="h-5 w-5 ml-2"></i> متغیرهای پویا</p>
                        <ul class="list-disc pr-5 space-y-1 font-mono text-xs">
                            <li><code>{Subject}</code>: موضوع تیکت</li>
                            <li><code>{Department}</code>: نام دپارتمان</li>
                        </ul>
                    </div>
                `;
            } else {
                 const description = keyData.desc || 'توضیحات خاصی برای این متن موجود نیست.';
                 markdownGuideHTML = `
                     <div class="bg-yellow-50 border border-yellow-200 p-4 mb-5 rounded-2xl text-sm text-gray-700 flex items-start shadow-md">
                         <i data-lucide="alert-triangle" class="h-5 w-5 ml-2 text-yellow-700 flex-shrink-0 mt-0.5"></i>
                         <div>
                             <span class="font-bold text-yellow-700 ml-1">راهنما:</span>
                             <span>${description}</span>
                         </div>
                     </div>
                   `;
            }

            if (isUrlField) {
                inputElement = `
                    <input id="edit-area" type="url" value="${currentText.replace(/\n/g, '')}" class="w-full p-4 border border-gray-300 rounded-2xl shadow-md focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition duration-150 text-gray-800 text-sm" placeholder="مثلاً: https://yourdomain.com/faq">
                `;
            } else if (isBooleanField) {
                const currentValue = (appTexts[currentEditKey] || "true"); 
                inputElement = `
                    <select id="edit-area" class="w-full p-4 border border-gray-300 rounded-2xl shadow-md focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition duration-150 text-gray-800 text-sm bg-white">
                        <option value="true" ${currentValue === "true" ? 'selected' : ''}>فعال (نمایش داده شود)</option>
                        <option value="false" ${currentValue === "false" ? 'selected' : ''}>غیرفعال (مخفی شود)</option>
                    </select>
                `;
            } else {
                inputElement = `
                    <textarea id="edit-area" rows="4" class="auto-resize-textarea w-full p-4 border border-gray-300 rounded-2xl shadow-md focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition duration-150 text-gray-800 text-sm" placeholder="متن جدید خود را اینجا وارد کنید...">${currentText}</textarea>
                `;
            }

            content.innerHTML = `
                <h2 class="text-2xl font-extrabold text-gray-800 mb-2">ویرایش: ${keyData.name}</h2>

                ${markdownGuideHTML}

                <!-- ناحیه ویرایش -->
                ${inputElement}

                <!-- دکمه‌های عملیات - بازطراحی شده -->
                <div class="flex justify-end space-x-3 mt-6" dir="ltr">
                    <button onclick="handleBack()" class="px-6 py-3 bg-white text-gray-800 rounded-2xl hover:bg-gray-50 transition duration-150 font-semibold shadow-lg">
                        <i data-lucide="x" class="h-5 w-5 inline ml-1"></i> لغو
                    </button>
                    <button id="save-button" onclick="handleSave()" class="px-6 py-3 bg-indigo-600 text-white rounded-2xl hover:bg-indigo-700 transition duration-150 font-semibold shadow-lg shadow-indigo-400/50">
                        <i data-lucide="save" class="h-5 w-5 inline ml-1"></i> ذخیره تغییرات
                    </button>
                </div>
            `;
            lucide.createIcons();
            
            const editArea = document.getElementById('edit-area');
            if (editArea && !isUrlField && !isBooleanField) { 
                autoResize(editArea); 
                editArea.addEventListener('input', () => autoResize(editArea));
            }
        }


        // --- تابع اصلی رندر ---

        function render() {
            if (currentState === 'Loading') {
                content.innerHTML = document.getElementById('loading-spinner').outerHTML;
                lucide.createIcons();
                return;
            }

            content.classList.add('transition', 'duration-300', 'opacity-0');
            setTimeout(() => {
                
                if (currentState === 'Dashboard') {
                    renderDashboard();
                } else if (currentState === 'MainMenu') {
                    renderMainMenu();
                } else if (currentState.startsWith('SubMenu_')) {
                    renderSubMenu_Texts(currentState);
                } else if (currentState.startsWith('EditScreen_')) {
                    renderEditScreen(currentState);
                } else {
                    renderDashboard();
                }
                
                // دکمه بازگشت هدر بر اساس تاریخچه نمایش داده می‌شود
                backButton.classList[history.length > 0 ? 'remove' : 'add']('hidden');
                
                // نوار ناوبری پایین صفحه همیشه نمایش داده می‌شود
                updateFooterNav(currentState);

                content.classList.remove('opacity-0');
                lucide.createIcons();
            }, 50); // انیمیشن محو شدن ملایم
        }

        // رویدادهای اصلی
        backButton.addEventListener('click', handleBack);

        // شروع اپلیکیشن: ابتدا داده‌ها را از Worker دریافت کن
        fetchInitialData();

        // آیکون‌ها را در بارگذاری اولیه (مخصوصا برای نوار پایین) ایجاد می‌کند
        lucide.createIcons();
    </script>
</body>
</html>

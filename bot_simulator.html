<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت تیکت تل (Mini App)</title>
    <!-- بارگذاری Tailwind CSS و Lucide Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* تنظیم فونت و تم اصلی */
        body {
            font-family: 'Inter', Tahoma, sans-serif;
            background-color: #f3ffef; /* پس‌زمینه کمی روشن‌تر و مایل به سبز/آبی */
        }
        /* شبیه‌سازی صفحه اپلیکیشن موبایل */
        #app-screen {
            min-height: 700px;
            max-width: 420px;
            margin: 2rem auto;
            background-color: #ffffff;
            /* سایه نرم‌تر و عمیق‌تر برای حس موبایل */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
            border-radius: 28px; /* گوشه‌های گردتر */
            overflow: hidden;
            position: relative;
            transition: all 0.4s ease-in-out;
            border: 1px solid #e0e0e0;
        }
        /* سبک برای آیتم‌های منو */
        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.1rem 1.5rem; /* کمی پدینگ بیشتر */
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background-color 0.15s ease, transform 0.1s, box-shadow 0.1s;
        }
        .menu-item:hover {
            background-color: #fcfcfd;
            transform: translateY(-2px); /* حرکت ظریف به بالا */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .menu-item:last-child {
            border-bottom: none;
        }
        /* سبک برای کارت‌های داشبورد */
        .metric-card {
            background-color: #ffffff;
            padding: 1.25rem;
            border-radius: 18px; /* گوشه‌های گردتر از قبل */
            /* سایه نرم و جذاب */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
            border: 1px solid #f0f0f0;
            transition: all 0.3s;
        }
        .metric-card:hover {
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -4px rgba(0, 0, 0, 0.05);
            border-color: #a5b4fc; /* رنگ آبی ملایم‌تر برای هاور */
        }
        /* سبک برای textarea با قابلیت بزرگ شدن خودکار */
        .auto-resize-textarea {
            overflow: hidden; 
            resize: none; 
            min-height: 120px;
            height: auto;
        }

        /* استایل سفارشی برای گرادیانت هدر */
        .header-gradient {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
    </style>
</head>
<body>

    <div id="app-screen">
        <!-- هدر ثابت با گرادیانت -->
        <header class="header-gradient text-white p-4 flex items-center shadow-2xl">
            <!-- آیکون بازگشت -->
            <button id="back-button" class="text-white p-2 hover:bg-white/20 rounded-full transition duration-150 hidden">
                <i data-lucide="chevron-right" class="h-6 w-6"></i>
            </button>
            <h1 id="header-title" class="text-xl font-extrabold mr-4 flex-grow truncate">پنل مدیریت ربات</h1>
        </header>

        <!-- کانتینر اصلی محتوا (padding از p-4 به p-5 افزایش یافت) -->
        <div id="content" class="p-5 space-y-5">
            <div id="loading-spinner" class="text-center p-8">
                <i data-lucide="loader-circle" class="animate-spin h-10 w-10 text-indigo-600 inline"></i>
                <p class="mt-4 text-gray-600 font-semibold">در حال بارگذاری داده‌های اولیه...</p>
            </div>
        </div>

        <!-- پیام نمایش داده شده در پایین صفحه -->
        <div id="message-box" class="fixed bottom-0 left-0 right-0 p-4 text-white text-center rounded-t-xl shadow-2xl z-20 hidden">
            عملیات با موفقیت انجام شد!
        </div>
    </div>

    <script>
        // --- تنظیمات مهم (WORKER & STORE) ---

        // 1. استخراج STORE_HANDLE از پارامتر URL
        const urlParams = new URLSearchParams(window.location.search);
        const STORE_HANDLE = urlParams.get('storeHandle'); 
        
        // --- MOCK DATA FOR TESTING IN CANVAS ---
        const MOCK_STORE_HANDLE = 'test-store-mock-dfdfdfd'; 
        
        const mockAppTexts = {
            greetingTitle: "سلام مدیر عزیز! 👋 (آزمایشی)",
            quickTipMessage: "💡 نکته: این متون برای تست در حالت آزمایشی بارگذاری شده‌اند.",
            // MODIFIED: Use quickButtons array
            quickButtons: [
                { text: "سوالات متداول (آزمایشی)", url: "https://mock.faq.com/", id: "mock_1" }
            ],
            navTickets: "تیکت‌ها",
            navNewTicket: "تیکت جدید",
            infoModalTitle: "راهنمای ارسال تیکت",
            infoModalTip: "لطفا ابتدا صفحه سوالات متداول را بررسی کنید.",
            closedTicketBanner: "این گفتگو توسط پشتیبانی بسته شده است.",
            submitNewTicketBtn: "ارسال",
            modalCloseBtn: "متوجه شدم",
            userReplyNotification: "✅ *پشتیبانی فنی* به تیکت شما با موضوع *مشکل اتصال* پاسخ داد.\\n\\nبرای مشاهده پاسخ کلیک کنید.",
            ticketClosedNotification: "🎫 تیکت شما با موضوع *پرداخت ناموفق* بسته شد.\\n\\nلطفا امتیاز دهید.",
        };
        
        const mockAppStats = {
            totalCount: '145',
            totalActive: '4',
            openCount: '3',
            pendingCount: '1',
            avgRating: '4.92',
            ratingPercentage: '88.5',
            ratedTicketsCount: 120,
            avgFirstResponseTime: '3 ساعت و 15 دقیقه',
            avgTimeToResolution: '1 روز و 5 ساعت',
        };

        // 2. آدرس پایه Worker API
        const WORKER_API_BASE_URL = 'https://ticketing.amiruserbot7.workers.dev'; 

        // تابع برای ساخت عنوان داشبورد
        const getDashboardTitle = (handle) => `داشبورد مدیریت (${handle || 'ناشناس'})`;


        // --- پایان تنظیمات ---

        const content = document.getElementById('content');
        const backButton = document.getElementById('back-button');
        const headerTitle = document.getElementById('header-title');
        const messageBox = document.getElementById('message-box');

        // وضعیت‌های اصلی: Dashboard, MainMenu, SubMenu_MINIAPPUI, SubMenu_USERNOTIFICATIONS, EditScreen, QuickButtonsMenu, EditQuickButton
        let currentState = 'Loading';
        const history = [];
        let appTexts = {}; // ذخیره متون دریافتی از Worker
        let appStats = {}; // ذخیره آمار دریافتی از Worker
        let currentEditKey = null; // کلید متنی که در حال ویرایش است
        let currentEditButtonIndex = null; // NEW: Index of the button being edited
        let successMessage = null; // برای نمایش پیام موفقیت در ناوبری

        // ساختار ثابت متون برای استفاده در منوها (باید با Worker همگام باشد)
        const CUSTOM_TEXT_KEYS = {
            MINI_APP_UI: {
                greetingTitle: { name: "عنوان خوش‌آمدگویی", icon: "user-check", desc: `متن اصلی کارت راهنما (مثلاً: سلام مشتری عزیز!)` },
                quickTipMessage: { name: "پیام راهنمای سریع", icon: "lightbulb", desc: `متن کوچک زیر عنوان در کارت راهنما (مثلاً: لطفا مشکل را با جزئیات بنویسید)` },
                // REMOVED: faqButtonText and faqUrl
                navTickets: { name: "منوی: تیکت‌ها", icon: "ticket", desc: `متن آیکون تیکت‌ها در نوار پایین مینی‌اپ.` },
                navNewTicket: { name: "منوی: تیکت جدید", icon: "file-plus", desc: `متن آیکون ایجاد تیکت جدید در نوار پایین مینی‌اپ.` },
                infoModalTitle: { name: "عنوان راهنمای تیکت", icon: "info", desc: `عنوان پنجره‌ای که قبل از ثبت تیکت جدید نمایش داده می‌شود.` },
                infoModalTip: { name: "پیام راهنمای مودال", icon: "message-square-text", desc: `متن اصلی داخل پنجره راهنما قبل از ثبت تیکت.` },
                closedTicketBanner: { name: "بنر تیکت بسته شده", icon: "lock", desc: `متنی که در پایین یک تیکت بسته شده نمایش داده می‌شود.` },
                submitNewTicketBtn: { name: "متن دکمه ارسال", icon: "send", desc: `متنی که روی دکمه 'ارسال' تیکت جدید نمایش داده می‌شود.` },
                modalCloseBtn: { name: "متن دکمه متوجه شدم", icon: "x-circle", desc: `متن دکمه بستن پنجره‌های مودال.` },
            },
            USER_NOTIFICATIONS: {
                userReplyNotification: { name: "اعلان پاسخ ادمین", icon: "bell-plus", desc: `متنی که پس از پاسخ ادمین، برای کاربر ارسال می‌شود. این متن از متغیرهای پویا پشتیبانی می‌کند.` },
                ticketClosedNotification: { name: "اعلان بسته شدن تیکت", icon: "bell-off", desc: `متنی که پس از بستن تیکت، برای کاربر ارسال می‌شود. این متن از متغیرهای پویا پشتیبانی می‌کند.` },
            }
        };


        // --- توابع کمکی ---
        
        // تابع برای تنظیم ارتفاع textarea بر اساس محتوا
        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight) + 'px';
        }

        function getFullKeyData(key) {
            for (const menuType in CUSTOM_TEXT_KEYS) {
                if (CUSTOM_TEXT_KEYS[menuType][key]) {
                    return { type: menuType, key, ...CUSTOM_TEXT_KEYS[menuType][key] };
                }
            }
            return null;
        }

        function showMessage(text, type = 'success', duration = 4000) {
            messageBox.textContent = text;
            // رنگ‌بندی پیام‌های موفقیت/خطا
            messageBox.className = `fixed bottom-0 left-0 right-0 p-4 text-white text-center rounded-t-2xl shadow-2xl z-20 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, duration);
        }

        function navigateTo(newState, title = null, pushHistory = true) {
            if (pushHistory && currentState !== 'Loading') {
                history.push(currentState);
            }
            currentState = newState;
            
            const currentHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            const dashboardTitle = getDashboardTitle(currentHandle);
            
            headerTitle.textContent = title || dashboardTitle;
            render();
        }

        function handleBack() {
            if (currentState.startsWith('EditScreen_')) {
                currentEditKey = null;
            }
            // NEW: Clear edit button index on back
            if (currentState.startsWith('EditQuickButton_')) {
                currentEditButtonIndex = null;
            }

            if (history.length > 0) {
                const previousState = history.pop();
                
                const currentHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
                const dashboardTitle = getDashboardTitle(currentHandle);
                
                // تعیین عنوان بر اساس حالت قبلی
                let title = dashboardTitle;
                if (previousState === 'MainMenu') {
                    title = 'مدیریت متون';
                } else if (previousState.startsWith('SubMenu_')) {
                    const menuType = previousState.replace('SubMenu_', '');
                    title = menuType === 'MINI_APP_UI' ? 'متن‌های مینی‌اپ' : 'متن‌های اعلان ربات';
                } else if (previousState === 'QuickButtonsMenu') {
                    title = 'مدیریت دکمه‌های راهنما';
                }
                
                currentState = previousState;
                headerTitle.textContent = title;
                render(false);
            } else {
                navigateTo('Dashboard', getDashboardTitle(STORE_HANDLE || MOCK_STORE_HANDLE), false); // اگر هیستوری خالی بود به داشبورد برگرد
            }
        }

        // --- Data Fetching (از Worker API) ---

        async function fetchStats() {
            const currentStoreHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            if (currentStoreHandle === MOCK_STORE_HANDLE) return mockAppStats; // MOCK MODE

            const url = `${WORKER_API_BASE_URL}/api/${currentStoreHandle}/stats`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch stats from Worker.');
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Worker stats returned error.');
            return result.data;
        }

        async function fetchAppTexts() {
            const currentStoreHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            if (currentStoreHandle === MOCK_STORE_HANDLE) return mockAppTexts; // MOCK MODE

            const url = `${WORKER_API_BASE_URL}/api/${currentStoreHandle}/texts`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Worker failed to fetch texts.');
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Worker texts returned error.');
            return result.data;
        }

        async function fetchInitialData() {
            try {
                // اگر STORE_HANDLE وجود نداشته باشد، به حالت Mock می رود
                if (!STORE_HANDLE) {
                    throw new Error("Missing STORE_HANDLE, loading mock data.");
                }

                const [textsData, statsData] = await Promise.all([
                    fetchAppTexts(),
                    fetchStats()
                ]);

                appTexts = textsData;
                appStats = statsData;

            } catch (error) {
                console.warn(`Error in fetchInitialData: ${error.message}. Loading mock data...`);
                appTexts = mockAppTexts;
                appStats = mockAppStats;
                if(error.message !== "Missing STORE_HANDLE, loading mock data."){
                    showMessage(`❌ خطا در اتصال به API: ${error.message.substring(0, 50)}... بارگذاری داده آزمایشی.`, 'error');
                }
            }
            
            // NEW: Ensure quickButtons is an array
            if (!Array.isArray(appTexts.quickButtons)) {
                appTexts.quickButtons = [];
            }

            currentState = 'Dashboard';
            render();
        }

        // --- Data Persistence (از طریق Worker API) ---
        
        // NEW: Generalized function to save any part of the texts object
        async function saveTextsPayload(payload, successNavState, successTitle, successMessageText) {
            const saveButton = document.getElementById('save-button');
            saveButton.disabled = true;
            saveButton.innerHTML = '<i data-lucide="loader-circle" class="animate-spin h-5 w-5 inline mr-2"></i> در حال ذخیره...';
            lucide.createIcons(); 

            const currentStoreHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            
            // Mock mode
            if (currentStoreHandle === MOCK_STORE_HANDLE) {
                Object.assign(appTexts, payload); // Merge payload into appTexts
                successMessage = `✅ ${successMessageText} (آزمایشی)`;
                navigateTo(successNavState, successTitle);
                return;
            }

            // Real save operation
            const url = `${WORKER_API_BASE_URL}/api/${currentStoreHandle}/texts`;
            try {
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                if (response.ok && result.success) {
                    Object.assign(appTexts, payload); // Merge payload into appTexts
                    successMessage = `✅ ${successMessageText}`;
                    navigateTo(successNavState, successTitle);
                } else {
                    throw new Error(result.error || 'خطا در Worker API هنگام ذخیره.');
                }
            } catch (error) {
                console.error("Error saving text via Worker:", error);
                showMessage(`❌ خطا در ذخیره: ${error.message}`, 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = '<i data-lucide="save" class="h-5 w-5 inline ml-1"></i> ذخیره و اعمال تغییرات';
                lucide.createIcons();
            }
        }


        async function handleSave() {
            const editElement = document.getElementById('edit-area');
            const newText = editElement.value;

            if (!currentEditKey) return;
            const keyData = getFullKeyData(currentEditKey);

            // Validation for URL fields
            if (keyData.isUrl) {
                if (!newText.startsWith('https://')) {
                    showMessage('❌ لینک باید با https:// شروع شود.', 'error', 5000);
                    return;
                }
            }
            
            const payload = { [currentEditKey]: newText };
            await saveTextsPayload(
                payload, 
                `SubMenu_${keyData.type}`, 
                'مدیریت متون', 
                `متن "${keyData.name}" با موفقیت ذخیره شد!`
            );
        }
        
        // NEW: Handle saving the quick button (add/edit)
        async function handleSaveQuickButton() {
            const text = document.getElementById('edit-button-text').value;
            const url = document.getElementById('edit-button-url').value;
            
            if (!text || !url) {
                showMessage('❌ متن دکمه و لینک (URL) هر دو الزامی هستند.', 'error');
                return;
            }
            if (!url.startsWith('https://')) {
                showMessage('❌ لینک باید با https:// شروع شود.', 'error', 5000);
                return;
            }

            // Create a copy of the array to modify
            let updatedButtons = [...(appTexts.quickButtons || [])];
            let successText = '';

            const newButtonData = { text, url, id: `btn_${Date.now()}` };

            if (currentEditButtonIndex !== null && updatedButtons[currentEditButtonIndex]) {
                // Editing existing button
                const oldButton = updatedButtons[currentEditButtonIndex];
                updatedButtons[currentEditButtonIndex] = { ...oldButton, ...newButtonData, id: oldButton.id }; // Preserve original ID
                successText = `دکمه "${text}" با موفقیت ویرایش شد!`;
            } else {
                // Adding new button
                updatedButtons.push(newButtonData);
                successText = `دکمه "${text}" با موفقیت اضافه شد!`;
            }

            // Save the entire updated array
            await saveTextsPayload(
                { quickButtons: updatedButtons },
                'QuickButtonsMenu',
                'مدیریت دکمه‌های راهنما',
                successText
            );
            
            currentEditButtonIndex = null; // Clear state
        }
        
        // NEW: Handle deleting a quick button
        async function handleDeleteQuickButton(index) {
            if (confirm('آیا از حذف این دکمه مطمئن هستید؟')) {
                let updatedButtons = [...(appTexts.quickButtons || [])];
                const removedButton = updatedButtons.splice(index, 1);
                
                if (removedButton.length > 0) {
                     await saveTextsPayload(
                        { quickButtons: updatedButtons },
                        'QuickButtonsMenu',
                        'مدیریت دکمه‌های راهنما',
                        `دکمه "${removedButton[0].text}" با موفقیت حذف شد.`
                    );
                }
            }
        }


        // =================================================================
        // RENDER FUNCTIONS (UI)
        // =================================================================

        function renderDashboard() {
            backButton.classList.add('hidden');
            const currentHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            headerTitle.textContent = getDashboardTitle(currentHandle);
            const stats = appStats;

            if (successMessage) {
                showMessage(successMessage);
                successMessage = null;
            }
            
            const ratingPercent = parseFloat(stats.ratingPercentage || '0');
            const progressBarColor = ratingPercent >= 90 ? 'bg-green-500' : 
                                     ratingPercent >= 75 ? 'bg-yellow-500' : 'bg-red-500';

            const metricCards = [
                { title: "کل تیکت‌ها", value: stats.totalCount || '0', icon: "ticket", color: "text-indigo-600", desc: "تعداد کل تیکت‌های ثبت شده." },
                { title: "تیکت‌های فعال", value: stats.totalActive || '0', icon: "inbox", color: "text-red-600", desc: "باز و در انتظار پاسخ ادمین." },
                { title: "امتیاز میانگین", value: `${stats.avgRating || 'N/A'} / 5.00`, icon: "star", color: "text-yellow-600", desc: `بر اساس ${stats.ratedTicketsCount || 0} امتیاز ثبت شده.` },
                { title: "میانگین پاسخ", value: stats.avgFirstResponseTime || 'N/A', icon: "clock-3", color: "text-green-600", desc: "زمان متوسط اولین پاسخگویی." },
            ];

            content.innerHTML = `
                <div class="space-y-6">
                    
                    <!-- کاهش اندازه فونت از text-2xl به text-xl -->
                    <h2 class="text-xl font-extrabold text-gray-800 border-b pb-3 mb-4">گزارش عملکرد فروشگاه</h2>
                    
                    <div class="grid grid-cols-2 gap-4">
                        ${metricCards.map(card => `
                            <div class="metric-card hover:shadow-indigo-100/50">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-semibold text-gray-500">${card.title}</h3>
                                    <i data-lucide="${card.icon}" class="${card.color} h-6 w-6"></i>
                                </div>
                                <!-- اندازه اعداد در text-2xl باقی ماند -->
                                <p class="text-2xl font-extrabold text-gray-900">${card.value}</p>
                                <p class="text-xs text-gray-400 mt-1 truncate">${card.desc}</p>
                            </div>
                        `).join('')}
                    </div>

                    <!-- بخش سرعت و نوار پیشرفت جدید -->
                    <div class="metric-card bg-purple-50 border-purple-200 border-dashed hover:shadow-purple-100/50">
                        <h3 class="text-lg font-bold text-purple-700 mb-4 flex items-center">
                            <i data-lucide="zap" class="h-5 w-5 ml-2"></i> شاخص‌های کلیدی عملکرد (KPI)
                        </h3>
                        
                        <div class="space-y-3">
                            <p class="flex justify-between text-sm">
                                <span class="text-gray-600">زمان حل نهایی تیکت:</span>
                                <span class="font-bold text-gray-800">${stats.avgTimeToResolution || 'N/A'}</span>
                            </p>

                            <!-- نوار پیشرفت ویژوالایزر امتیاز -->
                            <div>
                                <p class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">درصد رضایت کاربران (امتیازدهی):</span>
                                    <span class="font-bold text-gray-800">${stats.ratingPercentage || '0.0'}%</span>
                                </p>
                                <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                    <div class="${progressBarColor} h-2.5 rounded-full transition-all duration-500" style="width: ${ratingPercent > 100 ? 100 : ratingPercent}%;"></div>
                                </div>
                            </div>

                        </div>
                    </div>
                    
                    <!-- دکمه اصلی با استایل برجسته -->
                    <button onclick="navigateTo('MainMenu', 'مدیریت متون')" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 mt-6 rounded-2xl shadow-xl shadow-indigo-400/50 hover:from-indigo-700 hover:to-purple-700 transition duration-300 font-bold flex items-center justify-center text-lg">
                        <i data-lucide="settings" class="h-6 w-6 ml-2"></i> مدیریت متون و تنظیمات
                    </button>
                </div>
            `;
            lucide.createIcons();
        }

        function renderMainMenu() {
            backButton.classList.remove('hidden');
            headerTitle.textContent = 'مدیریت متون';
            
            if (successMessage) {
                showMessage(successMessage);
                successMessage = null;
            }

            content.innerHTML = `
                <!-- کاهش اندازه فونت از text-2xl به text-xl -->
                <h2 class="text-xl font-extrabold text-gray-800 mb-2">شخصی‌سازی محتوا</h2>
                <p class="text-sm text-gray-500 mb-6">متون کلیدی مینی اپ و اعلان‌های ارسال شده به کاربران را ویرایش کنید.</p>
                <!-- استفاده از bg-white/90 برای حس شیشه‌ای ملایم -->
                <div class="bg-white/90 border border-gray-100 rounded-2xl divide-y divide-gray-100 shadow-xl">
                    <div class="menu-item" onclick="navigateTo('SubMenu_MINI_APP_UI', 'متن‌های مینی‌اپ')">
                        <span class="flex items-center font-medium text-gray-800">
                            <i data-lucide="smartphone" class="h-5 w-5 ml-3 text-indigo-600"></i>
                            متن‌های مینی‌اپ (رابط کاربری)
                        </span>
                        <i data-lucide="chevron-left" class="h-5 w-5 text-gray-400"></i>
                    </div>
                    <!-- NEW: Quick Buttons Management -->
                    <div class="menu-item" onclick="navigateTo('QuickButtonsMenu', 'مدیریت دکمه‌های راهنما')">
                        <span class="flex items-center font-medium text-gray-800">
                            <i data-lucide="help-circle" class="h-5 w-5 ml-3 text-green-600"></i>
                            مدیریت دکمه‌های راهنما (FAQ)
                        </span>
                        <i data-lucide="chevron-left" class="h-5 w-5 text-gray-400"></i>
                    </div>
                    <div class="menu-item" onclick="navigateTo('SubMenu_USER_NOTIFICATIONS', 'متن‌های اعلان ربات')">
                        <span class="flex items-center font-medium text-gray-800">
                            <i data-lucide="bell" class="h-5 w-5 ml-3 text-orange-600"></i>
                            متن‌های اعلان کاربر (ربات)
                        </span>
                        <i data-lucide="chevron-left" class="h-5 w-5 text-gray-400"></i>
                    </div>
                    <div class="menu-item font-bold text-gray-600 hover:bg-transparent" onclick="navigateTo('Dashboard', getDashboardTitle(STORE_HANDLE || MOCK_STORE_HANDLE))">
                        <span class="flex items-center">
                            <i data-lucide="layout-dashboard" class="h-5 w-5 ml-3 text-gray-400"></i>
                            بازگشت به داشبورد
                        </span>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderSubMenu_Texts(state) {
            backButton.classList.remove('hidden');
            const menuType = state.replace('SubMenu_', ''); // MINI_APP_UI or USER_NOTIFICATIONS
            const keys = CUSTOM_TEXT_KEYS[menuType];
            const menuTitle = menuType === 'MINI_APP_UI' ? "متن‌های رابط کاربری مینی‌اپ" : "متن‌های اعلان ربات کاربر";
            
            headerTitle.textContent = menuTitle;

            if (successMessage) {
                showMessage(successMessage);
                successMessage = null;
            }

            content.innerHTML = `
                <!-- کاهش اندازه فونت از text-2xl به text-xl -->
                <h2 class="text-xl font-extrabold text-gray-800 mb-2">${menuTitle}</h2>
                <p class="text-sm text-gray-500 mb-6">متن مورد نظر برای ویرایش را انتخاب کنید:</p>
                <div class="bg-white border border-gray-100 rounded-2xl divide-y divide-gray-100 shadow-xl">
                    ${Object.entries(keys).map(([key, data]) => {
                        const menuIcon = data.icon || 'file-text';
                        const iconColor = menuType === 'MINI_APP_UI' ? 'text-indigo-500' : 'text-orange-500';
                        return `
                            <div class="menu-item" onclick="navigateTo('EditScreen_${key}', 'ویرایش: ${data.name}')">
                                <span class="flex items-center text-gray-800">
                                    <i data-lucide="${menuIcon}" class="h-5 w-5 ml-3 ${iconColor}"></i>
                                    ${data.name}
                                </span>
                                <i data-lucide="chevron-left" class="h-5 w-5 text-gray-400"></i>
                            </div>
                        `;
                    }).join('')}
                    <div class="menu-item font-bold text-indigo-600 hover:bg-transparent" onclick="navigateTo('MainMenu', 'مدیریت متون')">
                        <span class="flex items-center">
                            <i data-lucide="undo-2" class="h-5 w-5 ml-3"></i>
                            بازگشت به منوی اصلی
                        </span>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // NEW: Render function for managing quick buttons
        function renderQuickButtonsMenu() {
            backButton.classList.remove('hidden');
            headerTitle.textContent = 'مدیریت دکمه‌های راهنما';
            
            if (successMessage) {
                showMessage(successMessage);
                successMessage = null;
            }

            const buttons = appTexts.quickButtons || [];

            content.innerHTML = `
                <h2 class="text-xl font-extrabold text-gray-800 mb-2">مدیریت دکمه‌های راهنما</h2>
                <p class="text-sm text-gray-500 mb-6">دکمه‌های لینک‌دار زیر کارت هوشمند در صفحه اصلی مینی‌اپ کاربر را مدیریت کنید.</p>
                
                <div class="bg-white border border-gray-100 rounded-2xl divide-y divide-gray-100 shadow-xl mb-6">
                    ${buttons.length > 0 ? buttons.map((btn, index) => `
                        <div class="menu-item">
                            <span class="flex flex-col text-gray-800">
                                <span class="font-medium">${btn.text}</span>
                                <span class="text-xs text-indigo-500 truncate max-w-[200px]">${btn.url}</span>
                            </span>
                            <div class="flex space-x-2" dir="ltr">
                                <button onclick="navigateTo('EditQuickButton_${index}', 'ویرایش دکمه')" class="p-2 text-blue-600 hover:bg-blue-100 rounded-full">
                                    <i data-lucide="edit" class="h-5 w-5"></i>
                                </button>
                                <button onclick="handleDeleteQuickButton(${index})" class="p-2 text-red-600 hover:bg-red-100 rounded-full">
                                    <i data-lucide="trash-2" class="h-5 w-5"></i>
                                </button>
                            </div>
                        </div>
                    `).join('') : `
                        <p class="p-4 text-center text-gray-500">هیچ دکمه‌ای یافت نشد.</p>
                    `}
                </div>
                
                <button onclick="navigateTo('EditQuickButton_new', 'افزودن دکمه جدید')" class="w-full bg-green-600 text-white py-3 rounded-xl shadow-lg shadow-green-400/50 hover:bg-green-700 transition duration-300 font-bold flex items-center justify-center text-md">
                    <i data-lucide="plus" class="h-5 w-5 ml-2"></i> افزودن دکمه جدید
                </button>
            `;
            lucide.createIcons();
        }
        
        // NEW: Render function for editing/adding a quick button
        function renderEditButtonScreen(state) {
            backButton.classList.remove('hidden');
            const indexStr = state.replace('EditQuickButton_', '');
            
            let button = { text: '', url: '' }; // Default for new button
            let title = 'افزودن دکمه جدید';
            
            if (indexStr !== 'new') {
                currentEditButtonIndex = parseInt(indexStr, 10);
                if (appTexts.quickButtons && appTexts.quickButtons[currentEditButtonIndex]) {
                    button = appTexts.quickButtons[currentEditButtonIndex];
                    title = 'ویرایش دکمه';
                } else {
                    currentEditButtonIndex = null; // Invalid index
                }
            } else {
                currentEditButtonIndex = null; // Explicitly null for 'new'
            }
            
            headerTitle.textContent = title;
            
            content.innerHTML = `
                <h2 class="text-xl font-extrabold text-gray-800 mb-2">${title}</h2>
                <p class="text-sm text-gray-500 mb-6">متن دکمه و لینک (URL) کامل آن را وارد کنید.</p>
                
                <div class="space-y-4">
                    <div>
                        <label for="edit-button-text" class="block text-sm font-medium text-gray-700 mb-1">متن دکمه</label>
                        <input id="edit-button-text" type="text" value="${button.text}" class="w-full p-3 border border-gray-300 rounded-xl shadow-inner focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="مثلاً: سوالات متداول">
                    </div>
                    <div>
                        <label for="edit-button-url" class="block text-sm font-medium text-gray-700 mb-1">لینک (URL)</label>
                        <input id="edit-button-url" type="url" value="${button.url}" class="w-full p-3 border border-gray-300 rounded-xl shadow-inner focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="https://example.com/faq">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6" dir="ltr">
                    <button onclick="handleBack()" class="px-5 py-3 bg-gray-200 text-gray-800 rounded-xl hover:bg-gray-300 transition duration-150 font-semibold shadow-md hover:shadow-lg">
                        <i data-lucide="x-circle" class="h-5 w-5 inline ml-1"></i> لغو (بازگشت)
                    </button>
                    <button id="save-button" onclick="handleSaveQuickButton()" class="px-5 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl hover:from-indigo-700 hover:to-purple-700 transition duration-150 font-semibold shadow-lg shadow-indigo-400/50">
                        <i data-lucide="save" class="h-5 w-5 inline ml-1"></i> ذخیره تغییرات
                    </button>
                </div>
            `;
            lucide.createIcons();
        }


        function renderEditScreen(state) {
            backButton.classList.remove('hidden');
            currentEditKey = state.replace('EditScreen_', '');
            const keyData = getFullKeyData(currentEditKey);

            if (!keyData) {
                content.innerHTML = `<p class="text-red-600 p-4 font-bold">خطا: کلید متنی نامعتبر است.</p>`;
                return;
            }

            headerTitle.textContent = `ویرایش: ${keyData.name}`;

            const isNotification = keyData.type === 'USER_NOTIFICATIONS';
            const isUrlField = keyData.isUrl; // This property no longer exists on the keys we loop

            // جایگزینی \n با دو فاصله برای نمایش بهتر در textarea
            const currentText = (appTexts[currentEditKey] || "متن پیش‌فرض موجود نیست.").replace(/\\n/g, '\n');
            
            let markdownGuideHTML = '';
            let inputElement;

            if (isNotification) {
                // راهنمای پیشرفته برای Notification Texts
                markdownGuideHTML = `
                    <div class="bg-blue-50 border-r-4 border-blue-400 p-4 mb-4 rounded-xl text-sm text-gray-700 shadow-inner">
                        <p class="font-bold text-blue-700 flex items-center mb-2"><i data-lucide="code" class="h-5 w-5 ml-2"></i> راهنمای حرفه‌ای Markdown و متغیرها</p>
                        
                        <!-- جدول Markdown -->
                        <div class="bg-white border rounded-lg overflow-hidden mt-3">
                            <table class="w-full text-right text-xs">
                                <thead class="bg-gray-100 font-semibold text-gray-600">
                                    <tr>
                                        <th class="p-2 border-b">سینتکس</th>
                                        <th class="p-2 border-b">توضیح</th>
                                        <th class="p-2 border-b">نمونه خروجی</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-2 border-b font-mono">**متن**</td>
                                        <td class="p-2 border-b">متن بولد</td>
                                        <td class="p-2 border-b font-bold">متن ضخیم</td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-2 border-b font-mono">*متن*</td>
                                        <td class="p-2 border-b">متن کج</td>
                                        <td class="p-2 border-b italic">متن کج</td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-2 border-b font-mono">\`کد\`</td>
                                        <td class="p-2 border-b">نوشتن کد یا ID</td>
                                        <td class="p-2 border-b font-mono text-sm bg-gray-100 rounded">کد</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- متغیرهای پویا -->
                        <p class="font-bold text-blue-700 mt-4 mb-1 flex items-center"><i data-lucide="variable" class="h-5 w-5 ml-2"></i> متغیرهای پویا (Dynamic Variables)</p>
                        <p class="mb-2">برای نمایش اطلاعات متغیر تیکت، **دقیقاً** از متغیرهای زیر استفاده کنید (حساس به حروف بزرگ و کوچک):</p>
                        <ul class="list-disc pr-5 space-y-1 font-mono text-xs">
                            <li><code>{Subject}</code>: موضوع تیکت</li>
                            <li><code>{Department}</code>: نام دپارتمان</li>
                        </ul>
                    </div>
                `;
            } else {
                 // راهنمای ساده برای UI Texts
                 const description = keyData.desc || 'توضیحات خاصی برای این متن موجود نیست. لطفاً آن را ساده و مختصر نگه دارید.';
                 markdownGuideHTML = `
                     <div class="bg-yellow-50 border-r-4 border-yellow-400 p-3 mb-4 rounded-xl text-sm text-gray-700 flex items-start shadow-inner">
                         <i data-lucide="alert-triangle" class="h-5 w-5 ml-2 text-yellow-700 flex-shrink-0 mt-0.5"></i>
                         <div>
                             <span class="font-bold text-yellow-700 ml-1">راهنمای متن:</span>
                             <span>${description}</span>
                         </div>
                     </div>
                   `;
            }

            if (isUrlField) {
                // فیلد تک‌خطی برای URL
                inputElement = `
                    <input id="edit-area" type="url" value="${currentText.replace(/\n/g, '')}" class="w-full p-4 border border-gray-300 rounded-xl shadow-inner focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition duration-150 text-gray-800 text-sm" placeholder="مثلاً: https://yourdomain.com/faq">
                `;
            } else {
                // فیلد چندخطی با قابلیت بزرگ شدن خودکار
                inputElement = `
                    <textarea id="edit-area" rows="4" class="auto-resize-textarea w-full p-4 border border-gray-300 rounded-xl shadow-inner focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition duration-150 text-gray-800 text-sm" placeholder="متن جدید خود را اینجا وارد کنید...">${currentText}</textarea>
                `;
            }

            content.innerHTML = `
                <h2 class="text-xl font-extrabold text-gray-800 mb-2">ویرایش: ${keyData.name}</h2>

                ${markdownGuideHTML}

                <!-- ناحیه ویرایش متن/ورودی -->
                ${inputElement}

                <!-- دکمه‌های عملیات -->
                <div class="flex justify-end space-x-3 mt-4" dir="ltr">
                    <button onclick="handleBack()" class="px-5 py-3 bg-gray-200 text-gray-800 rounded-xl hover:bg-gray-300 transition duration-150 font-semibold shadow-md hover:shadow-lg">
                        <i data-lucide="x-circle" class="h-5 w-5 inline ml-1"></i> لغو (بازگشت)
                    </button>
                    <button id="save-button" onclick="handleSave()" class="px-5 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl hover:from-indigo-700 hover:to-purple-700 transition duration-150 font-semibold shadow-lg shadow-indigo-400/50">
                        <i data-lucide="save" class="h-5 w-5 inline ml-1"></i> ذخیره و اعمال تغییرات
                    </button>
                </div>
            `;
            lucide.createIcons();
            
            const editArea = document.getElementById('edit-area');
            if (editArea && !isUrlField) {
                autoResize(editArea); 
                editArea.addEventListener('input', () => autoResize(editArea));
            }
        }


        // --- تابع اصلی رندر ---

        function render() {
            if (currentState === 'Loading') {
                content.innerHTML = document.getElementById('loading-spinner').outerHTML;
                lucide.createIcons();
                return;
            }

            content.classList.add('transition', 'duration-300', 'opacity-0');
            setTimeout(() => {
                
                if (currentState === 'Dashboard') {
                    renderDashboard();
                } else if (currentState === 'MainMenu') {
                    renderMainMenu();
                } else if (currentState.startsWith('SubMenu_')) {
                    renderSubMenu_Texts(currentState);
                } else if (currentState.startsWith('EditScreen_')) {
                    renderEditScreen(currentState);
                } else if (currentState === 'QuickButtonsMenu') { // NEW
                    renderQuickButtonsMenu();
                } else if (currentState.startsWith('EditQuickButton_')) { // NEW
                    renderEditButtonScreen(currentState);
                } else {
                    renderDashboard();
                }
                
                backButton.classList[history.length > 0 ? 'remove' : 'add']('hidden');
                
                content.classList.remove('opacity-0');
            }, 50);
        }

        // رویدادهای اصلی
        backButton.addEventListener('click', handleBack);

        // شروع اپلیکیشن: ابتدا داده‌ها را از Worker دریافت کن
        fetchInitialData();
    </script>
    <script>
        // آیکون‌ها را در بارگذاری اولیه ایجاد می‌کند
        window.onload = function() {
            lucide.createIcons();
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª ØªÛŒÚ©Øª ØªÙ„ (Mini App)</title>
    <!-- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Tailwind CSS Ùˆ Lucide Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- [Ø¬Ø¯ÛŒØ¯] Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù†Ù…ÙˆØ¯Ø§Ø± Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯: Vazirmatn Ø¨Ø±Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ùˆ Inter Ø¨Ø±Ø§ÛŒ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* ... (Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ... */
        body {
            font-family: 'Vazirmatn', 'Inter', Tahoma, sans-serif;
            background-color: #f7f8fa; /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ø¨Ø³ÛŒØ§Ø± Ø±ÙˆØ´Ù† */
            padding-bottom: 100px;
            overflow-x: hidden; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„ Ø§ÙÙ‚ÛŒ */
        }
        
        .metric-card {
            background-color: #ffffff;
            padding: 1rem; /* Ø§Ø² 1.25rem Ú©Ø§Ù‡Ø´ ÛŒØ§ÙØª */
            border-radius: 20px; /* Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø³ÛŒØ§Ø± Ú¯Ø±Ø¯ */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.07);
            border: none;
            transition: all 0.3s;
        }
        .metric-card:hover {
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }
        
        .auto-resize-textarea {
            overflow: hidden; 
            resize: none; 
            min-height: 120px;
            height: auto;
        }

        .nav-item.active {
            color: #4f46e5; /* Ø±Ù†Ú¯ Ø§ØµÙ„ÛŒ Ø§Ù¾ (Indigo) */
        }
        .nav-item.active span {
             font-weight: 700;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0; 
        }

        @keyframes skeleton-pulse {
            0% { background-color: #f0f2f5; }
            50% { background-color: #e6e8eb; }
            100% { background-color: #f0f2f5; }
        }
        .skeleton-pulse {
            animation: skeleton-pulse 1.5s ease-in-out infinite;
            border-radius: 16px;
        }

        .btn-press {
            transition: transform 0.1s ease;
        }
        .btn-press:active {
            transform: scale(0.96); 
        }

        /* [Ø¬Ø¯ÛŒØ¯] Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ ØªØ¨â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„ Ø¯Ø± ØµÙØ­Ù‡ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ */
        .ticket-tab.active {
            background-color: #4f46e5;
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        }

        /* [Ø¬Ø¯ÛŒØ¯] Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø­Ø¨Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ú†Øª */
        .chat-bubble {
            padding: 0.75rem 1rem;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word; /* Ensure long words break */
            overflow-wrap: break-word; /* Alternative for word-wrap */
            white-space: pre-wrap; /* Preserve whitespace and wrap */
        }
        .chat-bubble.user {
            background-color: #f0f2f5;
            color: #1f2937;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble.admin {
            background-color: #4f46e5;
            color: #ffffff;
            border-bottom-left-radius: 4px;
        }

    </style>
</head>
<body class="antialiased">

    <!-- Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† -->
    <div id="app-container">
        <!-- Ù‡Ø¯Ø± Ø«Ø§Ø¨ØªØŒ Ø³Ø§Ø¯Ù‡ Ùˆ Ø³ÙÛŒØ¯ - Ø´Ø¨ÛŒÙ‡ Ø¨Ù‡ ÙˆÛŒØ¯ÛŒÙˆ -->
        <header class="bg-white text-gray-900 p-4 flex items-center shadow-sm sticky top-0 z-10">
            <!-- Ø¢ÛŒÚ©ÙˆÙ† Ø¨Ø§Ø²Ú¯Ø´Øª -->
            <button id="back-button" class="text-gray-700 p-2 hover:bg-gray-100 rounded-full transition duration-150 hidden btn-press">
                <i data-lucide="chevron-right" class="h-6 w-6"></i>
            </button>
            <h1 id="header-title" class="text-lg font-extrabold mr-4 flex-grow truncate">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø¨Ø§Øª</h1>
        </header>

        <!-- Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ Ù…Ø­ØªÙˆØ§ (padding Ùˆ space-y Ú©Ø§Ù‡Ø´ ÛŒØ§ÙØª) -->
        <div id="content" class="p-4 space-y-4">
            <!-- Ù„ÙˆØ¯Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ -->
            <div id="loading-spinner" class="text-center p-8 mt-10">
                 <!-- Ø§ÛŒÙ† Ù…Ø­ØªÙˆØ§ ØªÙˆØ³Ø· render() ÛŒØ§ renderDashboardSkeleton() Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯ -->
            </div>
        </div>

        <!-- [Ø¬Ø¯ÛŒØ¯] ÙÛŒÙ„Ø¯ Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø® Ø¯Ø± ØµÙØ­Ù‡ ØªÛŒÚ©Øª (Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­ØªÙˆØ§ Ø¨Ø±Ø§ÛŒ Ú†Ø³Ø¨ÛŒØ¯Ù† Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†) -->
        <div id="reply-container" class="fixed bottom-0 left-0 right-0 bg-white p-4 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-20 transform translate-y-full transition-transform duration-300">
            <div class="flex items-center space-x-3" dir="ltr">
                <button id="send-reply-btn" class="bg-indigo-600 text-white p-3 rounded-full btn-press shadow-lg shadow-indigo-300">
                    <i data-lucide="send" class="h-6 w-6"></i>
                </button>
                <textarea id="reply-textarea" rows="1" class="w-full p-3 border border-gray-300 rounded-2xl shadow-inner focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition duration-150 text-gray-800 text-sm" placeholder="Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." style="resize: none;"></textarea>
            </div>
        </div>

    </div>

    <!-- [Ø¬Ø¯ÛŒØ¯] Ù†ÙˆØ§Ø± Ù†Ø§ÙˆØ¨Ø±ÛŒ Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ - Ø³Ù‡â€ŒØ¨Ø®Ø´ÛŒ -->
    <nav id="footer-nav" class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-5px_20px_rgba(0,0,0,0.05)] rounded-t-3xl h-20 flex justify-around items-center z-10">
        <button onclick="navigateTo('Dashboard', getDashboardTitle(STORE_HANDLE || MOCK_STORE_HANDLE))" id="nav-dashboard" class="nav-item btn-press flex flex-col items-center justify-center text-gray-500 w-1/3" data-page="Dashboard">
            <i data-lucide="layout-dashboard" class="h-6 w-6"></i>
            <span class="text-xs font-semibold mt-1">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
        </button>
        <button onclick="navigateTo('TicketsList', 'Ù„ÛŒØ³Øª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§')" id="nav-tickets" class="nav-item btn-press flex flex-col items-center justify-center text-gray-500 w-1/3" data-page="TicketsList">
            <i data-lucide="inbox" class="h-6 w-6"></i>
            <span class="text-xs font-semibold mt-1">ØªÛŒÚ©Øªâ€ŒÙ‡Ø§</span>
        </button>
        <button onclick="navigateTo('MainMenu', 'Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªÙˆÙ†')" id="nav-settings" class="nav-item btn-press flex flex-col items-center justify-center text-gray-500 w-1/3" data-page="MainMenu">
            <i data-lucide="settings" class="h-6 w-6"></i>
            <span class="text-xs font-semibold mt-1">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</span>
        </button>
    </nav>


    <!-- Ù¾ÛŒØ§Ù… Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ -->
    <div id="message-box" class="fixed bottom-24 left-4 right-4 p-4 text-white text-center rounded-2xl shadow-2xl z-20 hidden transform transition-all duration-300 translate-y-10 opacity-0">
        Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!
    </div>

    <script>
        // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ù‡Ù… (WORKER & STORE) ---
        // ... (Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ) ...
        const urlParams = new URLSearchParams(window.location.search);
        const STORE_HANDLE = urlParams.get('storeHandle');
        const MOCK_STORE_HANDLE = 'test-store-mock-dfdfdfd';

        // [Ø¬Ø¯ÛŒØ¯] Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† departmentMap Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§
        const departmentMap = {
            general: 'Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªÙØ±Ù‚Ù‡',
            technical: 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ÙÙ†ÛŒ',
            sales: 'Ø¨Ø®Ø´ ÙØ±ÙˆØ´',
            marketing: 'Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ',
            ideas: 'Ø§ÛŒØ¯Ù‡ Ù‡Ø§ Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª',
        };
        // [Ø¬Ø¯ÛŒØ¯] Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† statusMap Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ (Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ø¯Ø± Ø¢ÛŒÙ†Ø¯Ù‡)
        const statusMap = {
            open: 'Ø¨Ø§Ø² (Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ)',
            closed: 'Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡',
            pending_user_reply: 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø§Ø³Ø® Ø´Ù…Ø§',
        };


        // --- MOCK DATA ---
        const mockAppTexts = {
            greetingTitle: "Ø³Ù„Ø§Ù… Ù…Ø¯ÛŒØ± Ø¹Ø²ÛŒØ²! ğŸ‘‹ (Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ)",
            quickTipMessage: "ğŸ’¡ Ù†Ú©ØªÙ‡: Ø§ÛŒÙ† Ù…ØªÙˆÙ† Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¯Ø± Ø­Ø§Ù„Øª Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯.",
            faqButtonEnabled: "true",
            faqButtonText: "Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„",
            faqUrl: "https://mock.faq.com/",
            navTickets: "ØªÛŒÚ©Øªâ€ŒÙ‡Ø§",
            navNewTicket: "ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯",
            infoModalTitle: "Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ ØªÛŒÚ©Øª",
            infoModalTip: "Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ ØµÙØ­Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.",
            closedTicketBanner: "Ø§ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ ØªÙˆØ³Ø· Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.",
            submitNewTicketBtn: "Ø§Ø±Ø³Ø§Ù„",
            modalCloseBtn: "Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…",
            userReplyNotification: "âœ… *Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ÙÙ†ÛŒ* Ø¨Ù‡ ØªÛŒÚ©Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆØ¶ÙˆØ¹ *Ù…Ø´Ú©Ù„ Ø§ØªØµØ§Ù„* Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯.\\n\\nØ¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø§Ø³Ø® Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.",
            ticketClosedNotification: "ğŸ« ØªÛŒÚ©Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆØ¶ÙˆØ¹ *Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚* Ø¨Ø³ØªÙ‡ Ø´Ø¯.\\n\\nÙ„Ø·ÙØ§ Ø§Ù…ØªÛŒØ§Ø² Ø¯Ù‡ÛŒØ¯.",
        };
        const mockAppStats = {
            totalCount: '145',
            totalActive: '4',
            openCount: '3',
            pendingCount: '1',
            avgRating: '4.92',
            ratingPercentage: '88.5',
            ratedTicketsCount: 120,
            avgFirstResponseTime: '3 Ø³Ø§Ø¹Øª Ùˆ 15 Ø¯Ù‚ÛŒÙ‚Ù‡',
            avgTimeToResolution: '1 Ø±ÙˆØ² Ùˆ 5 Ø³Ø§Ø¹Øª',
        };

        // [Ø¬Ø¯ÛŒØ¯] Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ³Øª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§
        const mockAppTickets = [
            { id: 'T1001', subject: 'Ù…Ø´Ú©Ù„ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±', user_name: 'Ú©Ø§Ø±Ø¨Ø± Û±Û²Û³', status: 'open', department: 'technical', created_at: new Date(Date.now() - 5 * 60 * 1000).toISOString(), messages: [ // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² user_name Ùˆ technical
                { sender: 'user', text: 'Ø³Ù„Ø§Ù…ØŒ Ù…Ù† Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ø¨Ù‡ Ø³Ø±ÙˆØ± Ù…ØªØµÙ„ Ø´ÙˆÙ….', created_at: new Date(Date.now() - 5 * 60 * 1000).toISOString() },
                { sender: 'admin', text: 'Ø³Ù„Ø§Ù…ØŒ Ù„Ø·ÙØ§Ù‹ Ù„Ø­Ø¸Ø§ØªÛŒ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒÙ….', created_at: new Date(Date.now() - 4 * 60 * 1000).toISOString() },
                { sender: 'user', text: 'Ù‡Ù†ÙˆØ² Ù…Ù†ØªØ¸Ø±Ù….\n Ù„Ø·ÙØ§Ù‹ Ø³Ø±ÛŒØ¹â€ŒØªØ±.', created_at: new Date(Date.now() - 3 * 60 * 1000).toISOString() }, // Added newline for testing
            ]},
            { id: 'T1002', subject: 'Ø³ÙˆØ§Ù„ Ø¯Ø± Ù…ÙˆØ±Ø¯ ØªØ¹Ø±ÙÙ‡', user_name: 'Ú©Ø§Ø±Ø¨Ø± Û´ÛµÛ¶', status: 'open', department: 'sales', created_at: new Date(Date.now() - 60 * 60 * 1000).toISOString(), messages: [ // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² user_name Ùˆ sales
                { sender: 'user', text: 'Ø³Ù„Ø§Ù…ØŒ ØªØ¹Ø±ÙÙ‡ Ù¾Ù„Ù† Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ú†Ù‚Ø¯Ø± Ø§Ø³ØªØŸ', created_at: new Date(Date.now() - 60 * 60 * 1000).toISOString() },
            ]},
            { id: 'T1003', subject: 'Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§Ú¯', user_name: 'Ú©Ø§Ø±Ø¨Ø± Û·Û¸Û¹', status: 'closed', department: 'technical', created_at: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(), messages: [ // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² user_name Ùˆ technical
                { sender: 'user', text: 'Ø¯Ú©Ù…Ù‡ Ø®Ø±ÙˆØ¬ Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.', created_at: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString() },
                { sender: 'admin', text: 'Ù…Ù…Ù†ÙˆÙ† Ø§Ø² Ú¯Ø²Ø§Ø±Ø´ Ø´Ù…Ø§ØŒ Ø¯Ø± Ù†Ø³Ø®Ù‡ Ø¨Ø¹Ø¯ÛŒ Ø±ÙØ¹ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯. ØªÛŒÚ©Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯.', created_at: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString() },
            ]},
        ];

        // [Ø¬Ø¯ÛŒØ¯] Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§
        const mockChartData = {
            ratings: {
                labels: ['Ûµ Ø³ØªØ§Ø±Ù‡', 'Û´ Ø³ØªØ§Ø±Ù‡', 'Û³ Ø³ØªØ§Ø±Ù‡', 'Û² Ø³ØªØ§Ø±Ù‡', 'Û± Ø³ØªØ§Ø±Ù‡'],
                data: [100, 15, 3, 1, 1], // 120 Ø§Ù…ØªÛŒØ§Ø²
            },
            volume: {
                labels: ['Ø´Ù†Ø¨Ù‡', 'Û±Ø´Ù†Ø¨Ù‡', 'Û²Ø´Ù†Ø¨Ù‡', 'Û³Ø´Ù†Ø¨Ù‡', 'Û´Ø´Ù†Ø¨Ù‡', 'ÛµØ´Ù†Ø¨Ù‡', 'Ø¬Ù…Ø¹Ù‡'],
                data: [5, 8, 3, 12, 10, 15, 7],
            }
        };

        const WORKER_API_BASE_URL = 'https://ticketing.amiruserbot7.workers.dev';
        const getDashboardTitle = (handle) => `Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ (${handle || 'Ù†Ø§Ø´Ù†Ø§Ø³'})`;

        // --- Ù¾Ø§ÛŒØ§Ù† ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---

        const content = document.getElementById('content');
        const backButton = document.getElementById('back-button');
        const headerTitle = document.getElementById('header-title');
        const messageBox = document.getElementById('message-box');
        // [Ø¬Ø¯ÛŒØ¯] Ú©Ø§Ù†ØªÛŒÙ†Ø± Ùˆ ÙÛŒÙ„Ø¯ Ù¾Ø§Ø³Ø®
        const replyContainer = document.getElementById('reply-container');
        const replyTextarea = document.getElementById('reply-textarea');

        let currentState = 'Dashboard-Loading';
        const history = [];
        let appTexts = {};
        let appStats = {};
        let appTickets = []; // [Ø¬Ø¯ÛŒØ¯] Ø§Ú©Ù†ÙˆÙ† Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ÛŒÚ© Ø¢Ø±Ø§ÛŒÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯
        let chartData = {};  // [Ø¬Ø¯ÛŒØ¯]
        let currentTicketListFilter = 'open'; // [Ø¬Ø¯ÛŒØ¯]
        let currentEditKey = null;
        let successMessage = null;

        // [Ø¬Ø¯ÛŒØ¯] Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ú†Ø§Ø±Øªâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø±Ù†Ø¯Ø± ØªÚ©Ø±Ø§Ø±ÛŒ
        let ratingChartInstance = null;
        let volumeChartInstance = null;

        const CUSTOM_TEXT_KEYS = {
            MINI_APP_UI: {
                greetingTitle: { name: "Ø¹Ù†ÙˆØ§Ù† Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ", icon: "user-check", desc: `Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ú©Ø§Ø±Øª Ø±Ø§Ù‡Ù†Ù…Ø§ (Ù…Ø«Ù„Ø§Ù‹: Ø³Ù„Ø§Ù… Ù…Ø´ØªØ±ÛŒ Ø¹Ø²ÛŒØ²!)` },
                quickTipMessage: { name: "Ù¾ÛŒØ§Ù… Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹", icon: "lightbulb", desc: `Ù…ØªÙ† Ú©ÙˆÚ†Ú© Ø²ÛŒØ± Ø¹Ù†ÙˆØ§Ù† Ø¯Ø± Ú©Ø§Ø±Øª Ø±Ø§Ù‡Ù†Ù…Ø§ (Ù…Ø«Ù„Ø§Ù‹: Ù„Ø·ÙØ§ Ù…Ø´Ú©Ù„ Ø±Ø§ Ø¨Ø§ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯)` },
                faqButtonEnabled: { name: "ÙˆØ¶Ø¹ÛŒØª Ø¯Ú©Ù…Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§", icon: "toggle-right", desc: `Ø¯Ú©Ù…Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„ Ø±Ø§ Ø¯Ø± Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾ ÙØ¹Ø§Ù„ ÛŒØ§ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.`, isBoolean: true },
                faqButtonText: { name: "Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§", icon: "help-circle", desc: `Ù…ØªÙ†ÛŒ Ú©Ù‡ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.` },
                faqUrl: { name: "Ù„ÛŒÙ†Ú© Ø¯Ú©Ù…Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§", icon: "link", desc: `Ø¢Ø¯Ø±Ø³ URL Ú©Ø§Ù…Ù„ (Ø¨Ø§ÛŒØ¯ Ø¨Ø§ https:// Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯).`, isUrl: true },
                navTickets: { name: "Ù…Ù†ÙˆÛŒ: ØªÛŒÚ©Øªâ€ŒÙ‡Ø§", icon: "ticket", desc: `Ù…ØªÙ† Ø¢ÛŒÚ©ÙˆÙ† ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ù†ÙˆØ§Ø± Ù¾Ø§ÛŒÛŒÙ† Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾.` },
                navNewTicket: { name: "Ù…Ù†ÙˆÛŒ: ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯", icon: "file-plus", desc: `Ù…ØªÙ† Ø¢ÛŒÚ©ÙˆÙ† Ø§ÛŒØ¬Ø§Ø¯ ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ù†ÙˆØ§Ø± Ù¾Ø§ÛŒÛŒÙ† Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾.` },
                infoModalTitle: { name: "Ø¹Ù†ÙˆØ§Ù† Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ ØªÛŒÚ©Øª", icon: "info", desc: `Ø¹Ù†ÙˆØ§Ù† Ù¾Ù†Ø¬Ø±Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ù‚Ø¨Ù„ Ø§Ø² Ø«Ø¨Øª ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.` },
                infoModalTip: { name: "Ù¾ÛŒØ§Ù… Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„", icon: "message-square-text", desc: `Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ø¯Ø§Ø®Ù„ Ù¾Ù†Ø¬Ø±Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ø² Ø«Ø¨Øª ØªÛŒÚ©Øª.` },
                closedTicketBanner: { name: "Ø¨Ù†Ø± ØªÛŒÚ©Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡", icon: "lock", desc: `Ù…ØªÙ†ÛŒ Ú©Ù‡ Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† ÛŒÚ© ØªÛŒÚ©Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.` },
                submitNewTicketBtn: { name: "Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„", icon: "send", desc: `Ù…ØªÙ†ÛŒ Ú©Ù‡ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ 'Ø§Ø±Ø³Ø§Ù„' ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.` },
                modalCloseBtn: { name: "Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…", icon: "x-circle", desc: `Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ Ø¨Ø³ØªÙ† Ù¾Ù†Ø¬Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„.` },
            },
            USER_NOTIFICATIONS: {
                userReplyNotification: { name: "Ø§Ø¹Ù„Ø§Ù† Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†", icon: "bell-plus", desc: `Ù…ØªÙ†ÛŒ Ú©Ù‡ Ù¾Ø³ Ø§Ø² Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†ØŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø§ÛŒÙ† Ù…ØªÙ† Ø§Ø² Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù¾ÙˆÛŒØ§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.` },
                ticketClosedNotification: { name: "Ø§Ø¹Ù„Ø§Ù† Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØªÛŒÚ©Øª", icon: "bell-off", desc: `Ù…ØªÙ†ÛŒ Ú©Ù‡ Ù¾Ø³ Ø§Ø² Ø¨Ø³ØªÙ† ØªÛŒÚ©ØªØŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø§ÛŒÙ† Ù…ØªÙ† Ø§Ø² Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù¾ÙˆÛŒØ§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.` },
            }
        };

        // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight) + 'px';
        }

        function getFullKeyData(key) {
            for (const menuType in CUSTOM_TEXT_KEYS) {
                if (CUSTOM_TEXT_KEYS[menuType][key]) {
                    return { type: menuType, key, ...CUSTOM_TEXT_KEYS[menuType][key] };
                }
            }
            return null;
        }
        function showMessage(text, type = 'success', duration = 4000) {
            messageBox.textContent = text;
            messageBox.className = `fixed bottom-24 left-4 right-4 p-4 text-white text-center rounded-2xl shadow-2xl z-20 transform transition-all duration-300 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;

            setTimeout(() => {
                messageBox.classList.remove('hidden', 'translate-y-10', 'opacity-0');
            }, 10);

            setTimeout(() => {
                messageBox.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, duration);
        }

        // [Ø¬Ø¯ÛŒØ¯] Ù†Ù…Ø§ÛŒØ´ ÛŒØ§ Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯ Ù¾Ø§Ø³Ø®
        function showReplyContainer(show) {
            const bodyPadding = show ? '180px' : '100px'; // ÙØ¶Ø§ Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ§Ø± Ù¾Ø§ÛŒÛŒÙ† + ÙÛŒÙ„Ø¯ Ù¾Ø§Ø³Ø®
            document.body.style.paddingBottom = bodyPadding;

            if(show) {
                replyContainer.classList.remove('translate-y-full');
            } else {
                replyContainer.classList.add('translate-y-full');
            }
        }


        // [Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ] ØªØ§Ø¨Ø¹ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†ÙˆØ§Ø± Ù†Ø§ÙˆØ¨Ø±ÛŒ Ù¾Ø§ÛŒÛŒÙ†
        function updateFooterNav(state) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active', 'text-indigo-600');
                item.classList.add('text-gray-500');
            });

            let activeItem;
            if (state === 'Dashboard' || state === 'Dashboard-Loading') {
                activeItem = document.getElementById('nav-dashboard');
            } else if (state === 'TicketsList' || state.startsWith('TicketView_')) { // [Ø¬Ø¯ÛŒØ¯]
                activeItem = document.getElementById('nav-tickets');
            } else if (state === 'MainMenu' || state.startsWith('SubMenu_') || state.startsWith('EditScreen_')) {
                activeItem = document.getElementById('nav-settings');
            }

            if (activeItem) {
                activeItem.classList.add('active', 'text-indigo-600');
                activeItem.classList.remove('text-gray-500');
            }
        }

        // [Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ] ØªØ§Ø¨Ø¹ Ù†Ø§ÙˆØ¨Ø±ÛŒ
        function navigateTo(newState, title = null, pushHistory = true) {
            if (pushHistory && currentState !== 'Dashboard-Loading') {
                history.push(currentState);
            }
            currentState = newState;

            const currentHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            const dashboardTitle = getDashboardTitle(currentHandle);

            headerTitle.textContent = title || dashboardTitle;
            updateFooterNav(newState);

            // [Ø¬Ø¯ÛŒØ¯] Ù†Ù…Ø§ÛŒØ´/Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯ Ù¾Ø§Ø³Ø® Ø¨Ø± Ø§Ø³Ø§Ø³ ØµÙØ­Ù‡
            if (currentState.startsWith('TicketView_')) {
                showReplyContainer(true);
            } else {
                showReplyContainer(false);
            }

            render();
            window.scrollTo(0, 0);
        }

        // [Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ] ØªØ§Ø¨Ø¹ Ø¨Ø§Ø²Ú¯Ø´Øª
        function handleBack() {
            if (currentState.startsWith('EditScreen_')) {
                currentEditKey = null;
            }
            // [Ø¬Ø¯ÛŒØ¯] Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯ Ù¾Ø§Ø³Ø® Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø²Ú¯Ø´Øª
            if (currentState.startsWith('TicketView_')) {
                 showReplyContainer(false);
            }

            if (history.length > 0) {
                const previousState = history.pop();

                const currentHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
                const dashboardTitle = getDashboardTitle(currentHandle);

                let title = dashboardTitle;
                if (previousState === 'MainMenu') title = 'Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªÙˆÙ†';
                if (previousState === 'TicketsList') title = 'Ù„ÛŒØ³Øª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§'; // [Ø¬Ø¯ÛŒØ¯]
                if (previousState.startsWith('SubMenu_')) {
                    const menuType = previousState.replace('SubMenu_', '');
                    title = menuType === 'MINI_APP_UI' ? 'Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾' : 'Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ø¹Ù„Ø§Ù† Ø±Ø¨Ø§Øª';
                }

                currentState = previousState;
                headerTitle.textContent = title;
                updateFooterNav(previousState);
                render(false);
                window.scrollTo(0, 0);
            } else {
                navigateTo('Dashboard', getDashboardTitle(STORE_HANDLE || MOCK_STORE_HANDLE), false);
            }
        }

        // --- Data Fetching (Ø§Ø² Worker API) ---
        async function fetchStats() {
            const currentStoreHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            if (currentStoreHandle === MOCK_STORE_HANDLE) return mockAppStats;

            const url = `${WORKER_API_BASE_URL}/api/${currentStoreHandle}/stats`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch stats from Worker.');
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Worker stats returned error.');
            return result.data;
        }
        async function fetchAppTexts() {
            const currentStoreHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            if (currentStoreHandle === MOCK_STORE_HANDLE) return mockAppTexts;

            const url = `${WORKER_API_BASE_URL}/api/${currentStoreHandle}/texts`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Worker failed to fetch texts.');
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Worker texts returned error.');
            return result.data;
        }

        // [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] ØªØ§Ø¨Ø¹ ÙˆØ§Ú©Ø´ÛŒ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ø¢Ø¨Ø¬Ú©Øª Ø¨Ù‡ Ø¢Ø±Ø§ÛŒÙ‡
        async function fetchTickets() {
            const currentStoreHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            if (currentStoreHandle === MOCK_STORE_HANDLE) {
                 console.log("Fetching mock tickets");
                 return mockAppTickets; // Ø¯Ø§Ø¯Ù‡ mock Ø§Ø² Ù‚Ø¨Ù„ Ø¢Ø±Ø§ÛŒÙ‡ Ø§Ø³Øª
            }

            const url = `${WORKER_API_BASE_URL}/api/${currentStoreHandle}/tickets`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to fetch tickets from Worker (${response.status})`);
                const result = await response.json();
                if (!result.success) throw new Error(result.error || 'Worker tickets returned error.');

                // -----------------------------------------------------------------
                // [Ø§ØµÙ„Ø§Ø­ Ø­ÛŒØ§ØªÛŒ] ØªØ¨Ø¯ÛŒÙ„ Ø¢Ø¨Ø¬Ú©Øª Ø¨Ù‡ Ø¢Ø±Ø§ÛŒÙ‡
                // -----------------------------------------------------------------
                const ticketsObject = result.data || {};
                const ticketsArray = Object.keys(ticketsObject).map(key => {
                    // Ø¢Ø¨Ø¬Ú©Øª ØªÛŒÚ©Øª Ø±Ø§ Ø¨Ø§ 'id' Ú©Ù‡ Ù‡Ù…Ø§Ù† Ú©Ù„ÛŒØ¯ ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ø§Ø³ØªØŒ ØªØ±Ú©ÛŒØ¨ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                    return {
                        id: key,
                        ...ticketsObject[key]
                    };
                });

                console.log("Fetched and converted tickets:", ticketsArray); // Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯
                return ticketsArray; // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¢Ø±Ø§ÛŒÙ‡ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
                // -----------------------------------------------------------------

            } catch (error) {
                console.error("Error fetching real tickets:", error.message);
                showMessage(`âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ú©Ø´ÛŒ Ù„ÛŒØ³Øª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§: ${error.message}.`, 'error');
                return []; // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¢Ø±Ø§ÛŒÙ‡ Ø®Ø§Ù„ÛŒ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
            }
        }

        // [Ø¬Ø¯ÛŒØ¯] ØªØ§Ø¨Ø¹ ÙˆØ§Ú©Ø´ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±
        async function fetchChartData() {
            // [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] Ø§Ú©Ù†ÙˆÙ† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ø±Ø§ ÙˆØ§Ú©Ø´ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
            const currentStoreHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
             if (currentStoreHandle === MOCK_STORE_HANDLE) {
                 console.log("Fetching mock chart data");
                 return mockChartData;
             }

            const url = `${WORKER_API_BASE_URL}/api/${currentStoreHandle}/chartdata`; // ÙØ±Ø¶ Ø¨Ø± Ø§ÛŒÙ† Ø§Ø³Øª Ú©Ù‡ Ø§ÛŒÙ† endpoint Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø± Ø§Ø³Øª
             try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch chart data from Worker.');
                const result = await response.json();
                if (!result.success) throw new Error(result.error || 'Worker chart data returned error.');
                // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø§Ø¯Ù‡ Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø±Ø¯
                return {
                    ratings: result.data.ratings || { labels: [], data: [] },
                    volume: result.data.volume || { labels: [], data: [] }
                };
            } catch (error) {
                console.error("Error fetching real chart data:", error.message);
                showMessage(`âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ú©Ø´ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±: ${error.message}.`, 'error');
                // Ø¨Ø§Ø²Ú¯Ø´Øª Ø³Ø§Ø®ØªØ§Ø± Ø®Ø§Ù„ÛŒ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
                return {
                    ratings: { labels: [], data: [] },
                    volume: { labels: [], data: [] }
                };
            }
        }


        // [Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ] ØªØ§Ø¨Ø¹ ÙˆØ§Ú©Ø´ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        async function fetchInitialData() {
            currentState = 'Dashboard-Loading';
            render();

            try {
                // [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] Ø¯ÛŒÚ¯Ø± Ø¯Ø± ØµÙˆØ±Øª Ù†Ø¨ÙˆØ¯Ù† STORE_HANDLE Ø®Ø·Ø§ Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ØŒ ÙÙ‚Ø· Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ù…ÛŒâ€ŒØ±ÙˆØ¯
                const isMockMode = !STORE_HANDLE;

                if (isMockMode) {
                    console.warn("Missing STORE_HANDLE, loading mock data.");
                    appTexts = mockAppTexts;
                    appStats = mockAppStats;
                    appTickets = mockAppTickets;
                    chartData = mockChartData;
                } else {
                     // [Ø¬Ø¯ÛŒØ¯] ÙˆØ§Ú©Ø´ÛŒ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ù…ÙˆØ§Ø²ÛŒ
                    const [textsData, statsData, ticketsData, chartApiData] = await Promise.all([
                        fetchAppTexts(),
                        fetchStats(),
                        fetchTickets(), // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø§Ú©Ù†ÙˆÙ† Ø¢Ø±Ø§ÛŒÙ‡ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯
                        fetchChartData()
                    ]);

                    appTexts = textsData;
                    appStats = statsData;
                    appTickets = ticketsData; // Ø§Ú©Ù†ÙˆÙ† ticketsData ÛŒÚ© Ø¢Ø±Ø§ÛŒÙ‡ Ø§Ø³Øª
                    chartData = chartApiData;
                }

            } catch (error) {
                console.error(`Error in fetchInitialData: ${error.message}. Loading mock data as fallback...`);
                appTexts = mockAppTexts;
                appStats = mockAppStats;
                appTickets = mockAppTickets;
                chartData = mockChartData;
                showMessage(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ API: ${error.message.substring(0, 50)}... Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ.`, 'error');
            }

            currentState = 'Dashboard';
            updateFooterNav('Dashboard');
            render();
        }

        // --- Data Persistence (Ø§Ø² Ø·Ø±ÛŒÙ‚ Worker API) ---
        async function handleSave() {
            const saveButton = document.getElementById('save-button');
            const editElement = document.getElementById('edit-area');
            const newText = editElement.value;

            if (!currentEditKey) return;
            const keyData = getFullKeyData(currentEditKey);

            if (keyData.isUrl) {
                if (!newText.startsWith('https://')) {
                    showMessage('âŒ Ù„ÛŒÙ†Ú© Ø¨Ø§ÛŒØ¯ Ø¨Ø§ https:// Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯.', 'error', 5000);
                    return;
                }
            }

            saveButton.disabled = true;
            saveButton.innerHTML = '<i data-lucide="loader-circle" class="animate-spin h-5 w-5 inline mr-2"></i> Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';
            lucide.createIcons();

            const currentStoreHandle = STORE_HANDLE || MOCK_STORE_HANDLE;

            if (currentStoreHandle === MOCK_STORE_HANDLE) {
                appTexts[currentEditKey] = newText;
                successMessage = `âœ… ØªÙ†Ø¸ÛŒÙ… "${keyData.name}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø­Ø§Ù„Øª Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!`;

                navigateTo(`SubMenu_${keyData.type}`, 'Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªÙˆÙ†');
                return;
            }

            const url = `${WORKER_API_BASE_URL}/api/${currentStoreHandle}/texts`;
            const payload = { [currentEditKey]: newText };

            try {
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    appTexts[currentEditKey] = newText;
                    successMessage = `âœ… ØªÙ†Ø¸ÛŒÙ… "${keyData.name}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯!`;

                    navigateTo(`SubMenu_${keyData.type}`, 'Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªÙˆÙ†');
                } else {
                    throw new Error(result.error || 'Ø®Ø·Ø§ Ø¯Ø± Worker API Ù‡Ù†Ú¯Ø§Ù… Ø°Ø®ÛŒØ±Ù‡.');
                }
            } catch (error) {
                console.error("Error saving text via Worker:", error);
                showMessage(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…: ${error.message}`, 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = '<i data-lucide="save" class="h-5 w-5 inline ml-1"></i> Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª';
                lucide.createIcons();
            }
        }

        // =================================================================
        // RENDER FUNCTIONS (UI) - Ø¨Ø§Ø²Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡
        // =================================================================

        // [Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ] ØªØ§Ø¨Ø¹ Ø±Ù†Ø¯Ø± Ù„ÙˆØ¯Ø± Ø§Ø³Ú©Ù„ØªÛŒ
        function renderDashboardSkeleton() {
            backButton.classList.add('hidden');
            const currentHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            headerTitle.textContent = getDashboardTitle(currentHandle);

            content.innerHTML = `
                <div class="space-y-4 animate-pulse">
                    <h2 class="text-2xl font-extrabold text-gray-800 border-b pb-2 mb-3">Ú¯Ø²Ø§Ø±Ø´ Ø¹Ù…Ù„Ú©Ø±Ø¯</h2>

                    <!-- Skeleton for Metric Cards -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="skeleton-pulse h-24"></div>
                        <div class="skeleton-pulse h-24"></div>
                        <div class="skeleton-pulse h-24"></div>
                        <div class="skeleton-pulse h-24"></div>
                    </div>

                    <!-- [Ø¬Ø¯ÛŒØ¯] Skeleton for KPI Card (Ø¨Ø²Ø±Ú¯ØªØ± Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§) -->
                    <div class="skeleton-pulse w-full h-80"></div>

                    <!-- Skeleton for Button -->
                    <div class="skeleton-pulse w-full h-16 mt-3"></div>
                </div>
            `;
        }


        // [Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ] ØªØ§Ø¨Ø¹ Ø±Ù†Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
        function renderDashboard() {
            backButton.classList.add('hidden');
            const currentHandle = STORE_HANDLE || MOCK_STORE_HANDLE;
            headerTitle.textContent = getDashboardTitle(currentHandle);
            const stats = appStats;

            // ... (Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª Ùˆ progressBarColor) ...
            if (successMessage) {
                showMessage(successMessage);
                successMessage = null;
            }
            const ratingPercent = parseFloat(stats.ratingPercentage || '0');
            const progressBarColor = ratingPercent >= 90 ? 'bg-green-500' :
                                       ratingPercent >= 75 ? 'bg-yellow-500' : 'bg-red-500';


            const metricCards = [
                { title: "Ú©Ù„ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§", value: stats.totalCount || '0', icon: "ticket", color: "text-indigo-600", desc: "ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡." },
                { title: "ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„", value: stats.totalActive || '0', icon: "inbox", color: "text-red-600", desc: "Ø¨Ø§Ø² Ùˆ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†." },
                { title: "Ø§Ù…ØªÛŒØ§Ø² Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†", value: `${stats.avgRating || 'N/A'} / 5.00`, icon: "star", color: "text-yellow-600", desc: `Ø¨Ø± Ø§Ø³Ø§Ø³ ${stats.ratedTicketsCount || 0} Ø§Ù…ØªÛŒØ§Ø².` },
                { title: "Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù¾Ø§Ø³Ø®", value: stats.avgFirstResponseTime || 'N/A', icon: "clock-3", color: "text-green-600", desc: "Ø²Ù…Ø§Ù† Ù…ØªÙˆØ³Ø· Ø§ÙˆÙ„ÛŒÙ† Ù¾Ø§Ø³Ø®." },
            ];

            content.innerHTML = `
                <div class="space-y-4">

                    <h2 class="text-2xl font-extrabold text-gray-800 border-b pb-2 mb-3 fade-in-up" style="animation-delay: 100ms;">Ú¯Ø²Ø§Ø±Ø´ Ø¹Ù…Ù„Ú©Ø±Ø¯</h2>

                    <div class="grid grid-cols-2 gap-3">
                        ${metricCards.map((card, index) => `
                            <div class="metric-card fade-in-up" style="animation-delay: ${150 + index * 50}ms;">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-semibold text-gray-500">${card.title}</h3>
                                    <i data-lucide="${card.icon}" class="${card.color} h-6 w-6"></i>
                                </div>
                                <p class="text-2xl font-extrabold text-gray-900">${card.value}</p>
                                <p class="text-xs text-gray-400 mt-1 truncate">${card.desc}</p>
                            </div>
                        `).join('')}
                    </div>

                    <!-- [Ø¬Ø¯ÛŒØ¯] Ú©Ø§Ø±Øª KPI Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ -->
                    <div class="metric-card bg-white fade-in-up" style="animation-delay: 350ms;">
                        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                            <i data-lucide="zap" class="h-5 w-5 ml-2 text-purple-600"></i> Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ (KPI)
                        </h3>
                        <div class="space-y-3">
                            <p class="flex justify-between text-sm">
                                <span class="text-gray-600">Ø²Ù…Ø§Ù† Ø­Ù„ Ù†Ù‡Ø§ÛŒÛŒ ØªÛŒÚ©Øª:</span>
                                <span class="font-bold text-gray-800">${stats.avgTimeToResolution || 'N/A'}</span>
                            </p>
                            <div>
                                <p class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">Ø¯Ø±ØµØ¯ Ø±Ø¶Ø§ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:</span>
                                    <span class="font-bold text-gray-800">${stats.ratingPercentage || '0.0'}%</span>
                                </p>
                                <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                    <div class="${progressBarColor} h-2.5 rounded-full transition-all duration-500" style="width: ${ratingPercent > 100 ? 100 : ratingPercent}%;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- [Ø¬Ø¯ÛŒØ¯] Ø¨Ø®Ø´ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ -->
                        <div class="mt-6 border-t pt-4">
                            <!-- Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ø§ÛŒØ±Ù‡â€ŒØ§ÛŒ -->
                            <h4 class="text-base font-bold text-gray-700 mb-2">ØªÙÚ©ÛŒÚ© Ø§Ù…ØªÛŒØ§Ø²Ø§Øª</h4>
                            <div class="w-full max-w-xs mx-auto h-48">
                                <canvas id="ratingChart"></canvas>
                            </div>
                            <!-- Ù†Ù…ÙˆØ¯Ø§Ø± Ø®Ø·ÛŒ -->
                            <h4 class="text-base font-bold text-gray-700 mt-6 mb-2">Ø­Ø¬Ù… ØªÛŒÚ©Øª (Û· Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡)</h4>
                            <div class="w-full h-48">
                                <canvas id="volumeChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <button onclick="navigateTo('MainMenu', 'Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªÙˆÙ†')" class="w-full bg-white text-gray-900 py-4 mt-3 rounded-2xl shadow-lg hover:shadow-xl transition duration-300 font-bold flex items-center justify-center text-base btn-press fade-in-up" style="animation-delay: 400ms;">
                        <i data-lucide="settings" class="h-6 w-6 ml-2 text-indigo-600"></i>
                        Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªÙˆÙ† Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                    </button>
                </div>
            `;

            // [Ø¬Ø¯ÛŒØ¯] Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ Ù¾Ø³ Ø§Ø² Ø±Ù†Ø¯Ø± HTML
            // [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] ØªØ§Ø®ÛŒØ± Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø±Ù†Ø¯Ø± Ø´Ø¯Ù† canvas
            setTimeout(() => {
                initRatingChart();
                initVolumeChart();
            }, 100);
        }

        // [Ø¬Ø¯ÛŒØ¯] ØªØ§Ø¨Ø¹ Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§
        function renderTicketsList() {
            backButton.classList.add('hidden'); // ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ ØªØ¨ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†Ø¯Ø§Ø±Ø¯
            headerTitle.textContent = 'Ù„ÛŒØ³Øª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§';

            if (successMessage) {
                showMessage(successMessage);
                successMessage = null;
            }

            // [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] Ø§Ú©Ù†ÙˆÙ† appTickets ÛŒÚ© Ø¢Ø±Ø§ÛŒÙ‡ Ø§Ø³Øª Ùˆ Ø§ÛŒÙ† Ú©Ø¯ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯
            const filteredTickets = appTickets.filter(t => t.status === currentTicketListFilter);
            const openTicketsCount = appTickets.filter(t => t.status === 'open').length;
            const closedTicketsCount = appTickets.filter(t => t.status === 'closed').length;


            content.innerHTML = `
                <div class="fade-in-up">
                    <!-- [Ø¬Ø¯ÛŒØ¯] ØªØ¨â€ŒÙ‡Ø§ÛŒ ÙÛŒÙ„ØªØ± -->
                    <div class="flex items-center justify-center space-x-2 space-x-reverse bg-gray-200 p-1 rounded-full mb-5">
                        <button onclick="filterTickets('open')" class="ticket-tab w-full text-center px-4 py-2 rounded-full font-semibold transition-all duration-300 ${currentTicketListFilter === 'open' ? 'active' : 'text-gray-700'}">
                            Ø¨Ø§Ø² (${openTicketsCount})
                        </button>
                        <button onclick="filterTickets('closed')" class="ticket-tab w-full text-center px-4 py-2 rounded-full font-semibold transition-all duration-300 ${currentTicketListFilter === 'closed' ? 'active' : 'text-gray-700'}">
                            Ø¨Ø³ØªÙ‡ (${closedTicketsCount})
                        </button>
                    </div>

                    <!-- [Ø¬Ø¯ÛŒØ¯] Ù„ÛŒØ³Øª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ -->
                    <div class="space-y-4">
                        ${filteredTickets.length > 0 ? filteredTickets.map((ticket, index) => `
                            <div class="bg-white rounded-2xl shadow-lg p-4 cursor-pointer transition duration-200 hover:shadow-xl btn-press fade-in-up" style="animation-delay: ${50 + index * 50}ms;" onclick="navigateTo('TicketView_${ticket.id}', '${ticket.subject}')">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-bold text-gray-800 text-base truncate">${ticket.subject || 'Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¶ÙˆØ¹'}</span>
                                    <!-- [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] Ù†Ù…Ø§ÛŒØ´ Ø²Ù…Ø§Ù† Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø§ ÙØ±Ù…Øª Ø¨Ù‡ØªØ± -->
                                    <span class="text-xs font-semibold text-gray-500">${new Date(ticket.created_at).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' }) || ''}</span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                     <!-- [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] Ù†Ù…Ø§ÛŒØ´ user_name Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ -->
                                    <span class="text-gray-600">${ticket.user_name || 'Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³'}</span>
                                    <!-- [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² departmentMap ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø¯Ø± Ù‡Ù…ÛŒÙ† ÙØ§ÛŒÙ„ -->
                                     <span class="text-xs font-semibold ${
                                        ticket.department === 'technical' ? 'bg-blue-100 text-blue-700' :
                                        ticket.department === 'sales' ? 'bg-green-100 text-green-700' :
                                        ticket.department === 'marketing' ? 'bg-purple-100 text-purple-700' :
                                        ticket.department === 'ideas' ? 'bg-yellow-100 text-yellow-700' :
                                        'bg-gray-100 text-gray-700' // Default for general or unknown
                                    } px-2 py-0.5 rounded-full">${
                                        departmentMap[ticket.department] || ticket.department || 'Ø¹Ù…ÙˆÙ…ÛŒ' // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² departmentMap
                                    }</span>
                                </div>
                            </div>
                        `).join('') : `
                            <div class="text-center text-gray-500 pt-10 fade-in-up">
                                <i data-lucide="inbox" class="h-12 w-12 mx-auto text-gray-400"></i>
                                <p class="mt-2 font-semibold">Ù‡ÛŒÚ† ØªÛŒÚ©Øª ${currentTicketListFilter === 'open' ? 'Ø¨Ø§Ø²ÛŒ' : 'Ø¨Ø³ØªÙ‡â€ŒØ§ÛŒ'} ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // [Ø¬Ø¯ÛŒØ¯] ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± ÙÛŒÙ„ØªØ± ØªÛŒÚ©Øªâ€ŒÙ‡Ø§
        function filterTickets(status) {
            currentTicketListFilter = status;
            render(); // Ø±Ù†Ø¯Ø± Ù…Ø¬Ø¯Ø¯ ØµÙØ­Ù‡ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§
        }

        // [Ø¬Ø¯ÛŒØ¯] ØªØ§Ø¨Ø¹ Ø±Ù†Ø¯Ø± ØµÙØ­Ù‡ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÛŒÚ©Øª
        function renderTicketView(state) {
            backButton.classList.remove('hidden'); // Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª
            const ticketId = state.replace('TicketView_', '');
            // [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] Ø§Ú©Ù†ÙˆÙ† appTickets ÛŒÚ© Ø¢Ø±Ø§ÛŒÙ‡ Ø§Ø³Øª Ùˆ .find() Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯
            const ticket = appTickets.find(t => t.id === ticketId);

            if (!ticket) {
                content.innerHTML = `<p class="text-red-600 p-4 font-bold">Ø®Ø·Ø§: ØªÛŒÚ©Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>`;
                return;
            }

            headerTitle.textContent = ticket.subject;

             // [Ø§ØµÙ„Ø§Ø­ Ù…Ù‡Ù…] ÙˆØ§Ú©Ø´ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø±Ø§ÛŒ ØªÛŒÚ©Øª
             // Ù…Ø§ Ø¯ÛŒÚ¯Ø± Ø¨Ù‡ ticket.messages Ø¯Ø± Ø¢Ø¨Ø¬Ú©Øª Ø§ØµÙ„ÛŒ ØªÚ©ÛŒÙ‡ Ù†Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
             // ØªØ§Ø¨Ø¹ fetchMessagesForTicket Ù…Ø³Ø¦ÙˆÙ„ Ø¢Ù¾Ø¯ÛŒØª UI Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯
             fetchMessagesForTicket(ticketId);

             // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆÙ‚Øª Ù„ÙˆØ¯Ø± ÛŒØ§ Ù¾ÛŒØ§Ù… "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§..."
             // [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² departmentMap Ùˆ statusMap
             content.innerHTML = `
                 <div class="space-y-4 fade-in-up" style="padding-bottom: 80px;"> <!-- Add padding for reply box -->
                     <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÛŒÚ©Øª -->
                     <div class="bg-white rounded-2xl shadow-lg p-4 text-sm">
                          <p><strong>Ú©Ø§Ø±Ø¨Ø±:</strong> ${ticket.user_name || 'Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³'}</p>
                          <p><strong>Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†:</strong> ${departmentMap[ticket.department] || ticket.department || 'Ø¹Ù…ÙˆÙ…ÛŒ'}</p>
                          <p><strong>ÙˆØ¶Ø¹ÛŒØª:</strong> ${statusMap[ticket.status] || ticket.status || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                     </div>
                     <!-- Ú©Ø§Ù†ØªÛŒÙ†Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
                     <div id="messages-container" class="space-y-3">
                         <!-- Ù„ÙˆØ¯Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
                         <div class="text-center text-gray-500 pt-5">
                            <i data-lucide="loader-circle" class="animate-spin h-8 w-8 mx-auto text-indigo-600"></i>
                            <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§...</p>
                         </div>
                     </div>
                 </div>
             `;
             // Make sure icons render even in loading state
            lucide.createIcons();
        }

       // [Ø¬Ø¯ÛŒØ¯ Ùˆ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡] ØªØ§Ø¨Ø¹ ÙˆØ§Ú©Ø´ÛŒ Ùˆ Ø±Ù†Ø¯Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ ÛŒÚ© ØªÛŒÚ©Øª Ø®Ø§Øµ
       async function fetchMessagesForTicket(ticketId) {
            const messagesContainer = document.getElementById('messages-container');
            // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ Ø¯Ø± ØµÙØ­Ù‡ Ø¯Ø±Ø³Øª Ù‡Ø³ØªÛŒÙ… Ùˆ Ú©Ø§Ù†ØªÛŒÙ†Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
            if (!messagesContainer || currentState !== `TicketView_${ticketId}`) {
                console.log("Not rendering messages - wrong state or container not found");
                return;
            }

            const currentStoreHandle = STORE_HANDLE || MOCK_STORE_HANDLE;

            // --- Ø­Ø§Ù„Øª Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ ---
            if (currentStoreHandle === MOCK_STORE_HANDLE) {
                console.log("Mock mode: Loading messages from mock ticket object.");
                const ticket = mockAppTickets.find(t => t.id === ticketId);
                // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯ Ù‚Ø¨Ù„ Ø§Ø² Ø±Ù†Ø¯Ø±
                const messages = ticket?.messages?.sort((a, b) => new Date(a.created_at) - new Date(b.created_at)) || [];
                renderMessages(messages, messagesContainer); // Ø±Ù†Ø¯Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ mock
                lucide.createIcons(); // Ø±Ù†Ø¯Ø± Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ Ø§Ú¯Ø± Ø¯Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯
                // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ø¨Ø¹Ø¯ Ø§Ø² Ø±Ù†Ø¯Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ mock
                 setTimeout(() => {
                    if (messagesContainer) { // Double check container exists
                      messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                 }, 50); // Small delay to ensure DOM update
                return;
            }
            // --- Ù¾Ø§ÛŒØ§Ù† Ø­Ø§Ù„Øª Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ ---

            const url = `${WORKER_API_BASE_URL}/api/${currentStoreHandle}/messages?ticket_id=${ticketId}`;
            try {
                console.log(`Fetching messages from: ${url}`); // Log fetch attempt
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to fetch messages (${response.status})`);
                const result = await response.json();
                 console.log("Messages API response:", result); // Log API response
                if (!result.success) throw new Error(result.error || 'Worker messages returned error.');

                // ØªØ¨Ø¯ÛŒÙ„ Ø¢Ø¨Ø¬Ú©Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ù‡ Ø¢Ø±Ø§ÛŒÙ‡ Ùˆ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù†
                const messagesObject = result.data || {};
                const messagesArray = Object.values(messagesObject).sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                 console.log("Sorted messages array:", messagesArray); // Log sorted array

                // Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¯Ø± Ú©Ø§Ù†ØªÛŒÙ†Ø±
                renderMessages(messagesArray, messagesContainer);

            } catch (error) {
                console.error("Error fetching messages:", error.message);
                showMessage(`âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ú©Ø´ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§: ${error.message}.`, 'error');
                 if (messagesContainer) {
                    messagesContainer.innerHTML = `<p class="text-red-600 p-4 font-bold text-center">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§.</p>`;
                 }
            } finally {
                 // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø±Ù†Ø¯Ø± Ø´Ø¯Ù† Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ Ø­ØªÛŒ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
                 lucide.createIcons();
                 // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ø¨Ø¹Ø¯ Ø§Ø² Ø±Ù†Ø¯Ø± ÛŒØ§ Ø®Ø·Ø§
                 setTimeout(() => {
                    if (messagesContainer) {
                        console.log("Scrolling messages container to bottom"); // Log scroll attempt
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                 }, 50); // Small delay for DOM update
            }
        }

        // [Ø¬Ø¯ÛŒØ¯] ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† Ø¢Ø±Ø§ÛŒÙ‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¯Ø± DOM
        function renderMessages(messagesArray, containerElement) {
            console.log("Rendering messages:", messagesArray); // Log messages being rendered
            if (!containerElement) {
                 console.error("Cannot render messages: containerElement is null");
                 return;
            }

            if (messagesArray.length === 0) {
                 containerElement.innerHTML = `<p class="text-gray-500 text-center pt-5">Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ Ø±Ø¯ Ùˆ Ø¨Ø¯Ù„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>`;
                 return;
             }
             // Ensure text exists and replace newlines
            const sanitizeText = (text = '') => text.replace(/\n/g, '<br>');

            containerElement.innerHTML = messagesArray.map(msg => `
                <div class="flex ${msg.sender === 'admin' ? 'justify-start' : 'justify-end'} fade-in-up" style="animation-delay: ${messagesArray.indexOf(msg) * 30}ms"> <!-- Simple animation -->
                    <div class="chat-bubble ${msg.sender === 'admin' ? 'admin' : 'user'}">
                        ${
                            // Ù†Ù…Ø§ÛŒØ´ Placeholder Ø¨Ø±Ø§ÛŒ ØªØµØ§ÙˆÛŒØ±
                            msg.type === 'image_placeholder'
                            ? `<span class="italic text-gray-500">${sanitizeText(msg.text)}</span>`
                            : sanitizeText(msg.text) // Ù†Ù…Ø§ÛŒØ´ Ù…ØªÙ† Ù…Ø¹Ù…ÙˆÙ„ÛŒ
                         }
                         <!-- Ù†Ù…Ø§ÛŒØ´ Ø²Ù…Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… -->
                         <div class="text-xs ${msg.sender === 'admin' ? 'text-indigo-200' : 'text-gray-400'} mt-1 text-left">${new Date(msg.created_at).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' })}</div>
                    </div>
                </div>
            `).join('');
            console.log("Messages rendered to DOM"); // Confirm rendering
         }



        function renderMainMenu() {
            backButton.classList.remove('hidden');
            headerTitle.textContent = 'Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªÙˆÙ†';

            if (successMessage) {
                showMessage(successMessage);
                successMessage = null;
            }

            content.innerHTML = `
                <h2 class="text-2xl font-extrabold text-gray-800 mb-2 fade-in-up">Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ù…Ø­ØªÙˆØ§</h2>
                <p class="text-sm text-gray-500 mb-6 fade-in-up" style="animation-delay: 50ms;">Ù…ØªÙˆÙ† Ú©Ù„ÛŒØ¯ÛŒ Ù…ÛŒÙ†ÛŒ Ø§Ù¾ Ùˆ Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø±Ø¨Ø§Øª Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯.</p>

                <div class="space-y-4">
                    <div class="bg-white rounded-2xl shadow-lg p-5 cursor-pointer transition duration-200 hover:shadow-xl btn-press fade-in-up" style="animation-delay: 100ms;" onclick="navigateTo('SubMenu_MINI_APP_UI', 'Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾')">
                        <div class="flex items-center justify-between">
                            <span class="flex items-center font-bold text-gray-800 text-base">
                                <i data-lucide="smartphone" class="h-6 w-6 ml-3 text-indigo-600"></i>
                                Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾
                            </span>
                            <i data-lucide="chevron-left" class="h-5 w-5 text-gray-400"></i>
                        </div>
                        <p class="text-sm text-gray-500 mt-2 pr-9">ÙˆÛŒØ±Ø§ÛŒØ´ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾.</p>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-5 cursor-pointer transition duration-200 hover:shadow-xl btn-press fade-in-up" style="animation-delay: 150ms;" onclick="navigateTo('SubMenu_USER_NOTIFICATIONS', 'Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ø¹Ù„Ø§Ù† Ø±Ø¨Ø§Øª')">
                        <div class="flex items-center justify-between">
                            <span class="flex items-center font-bold text-gray-800 text-base">
                                <i data-lucide="bell" class="h-6 w-6 ml-3 text-orange-600"></i>
                                Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ø¹Ù„Ø§Ù† Ú©Ø§Ø±Ø¨Ø±
                            </span>
                            <i data-lucide="chevron-left" class="h-5 w-5 text-gray-400"></i>
                        </div>
                        <p class="text-sm text-gray-500 mt-2 pr-9">ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø±Ø¨Ø§Øª Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</p>
                    </div>
                </div>
            `;
        }
        function renderSubMenu_Texts(state) {
            backButton.classList.remove('hidden');
            const menuType = state.replace('SubMenu_', '');
            const keys = CUSTOM_TEXT_KEYS[menuType];
            const menuTitle = menuType === 'MINI_APP_UI' ? "Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾" : "Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ø¹Ù„Ø§Ù† Ø±Ø¨Ø§Øª";

            headerTitle.textContent = menuTitle;

            if (successMessage) {
                showMessage(successMessage);
                successMessage = null;
            }

            content.innerHTML = `
                <h2 class="text-2xl font-extrabold text-gray-800 mb-2 fade-in-up">${menuTitle}</h2>
                <p class="text-sm text-gray-500 mb-6 fade-in-up" style="animation-delay: 50ms;">Ù…ØªÙ† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p>

                <div class="space-y-4">
                    ${Object.entries(keys).map(([key, data], index) => {
                        const menuIcon = data.icon || 'file-text';
                        const iconColor = menuType === 'MINI_APP_UI' ? 'text-indigo-500' : 'text-orange-500';

                        let additionalInfo = '';
                        if (data.isBoolean) {
                            const currentValue = (appTexts[key] === "true" || typeof appTexts[key] === 'undefined'); // Default to true if undefined
                            additionalInfo = currentValue
                                ? `<span class="text-xs font-semibold bg-green-100 text-green-700 px-2 py-0.5 rounded-full">ÙØ¹Ø§Ù„</span>`
                                : `<span class="text-xs font-semibold bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">ØºÛŒØ±ÙØ¹Ø§Ù„</span>`;
                        }

                        return `
                            <div class="bg-white rounded-2xl shadow-lg p-5 cursor-pointer transition duration-200 hover:shadow-xl btn-press fade-in-up" style="animation-delay: ${100 + index * 50}ms;" onclick="navigateTo('EditScreen_${key}', 'ÙˆÛŒØ±Ø§ÛŒØ´: ${data.name}')">
                                <div class="flex items-center justify-between">
                                    <span class="flex items-center font-bold text-gray-800 text-base">
                                        <i data-lucide="${menuIcon}" class="h-6 w-6 ml-3 ${iconColor}"></i>
                                        ${data.name}
                                    </span>
                                    <div class="flex items-center">
                                        ${additionalInfo}
                                        <i data-lucide="chevron-left" class="h-5 w-5 text-gray-400 ml-2"></i>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-500 mt-2 pr-9">${data.desc}</p>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        function renderEditScreen(state) {
            backButton.classList.remove('hidden');
            currentEditKey = state.replace('EditScreen_', '');
            const keyData = getFullKeyData(currentEditKey);

            if (!keyData) {
                content.innerHTML = `<p class="text-red-600 p-4 font-bold">Ø®Ø·Ø§: Ú©Ù„ÛŒØ¯ Ù…ØªÙ†ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.</p>`;
                return;
            }

            headerTitle.textContent = `ÙˆÛŒØ±Ø§ÛŒØ´: ${keyData.name}`;

            const isNotification = keyData.type === 'USER_NOTIFICATIONS';
            const isUrlField = keyData.isUrl;
            const isBooleanField = keyData.isBoolean;

            // Default text handling improved: Use empty string if no default specified
            const currentText = (appTexts[currentEditKey] ?? keyData.defaultText ?? "").replace(/\\n/g, '\n');

            let markdownGuideHTML = '';
            let inputElement;

            if (isNotification) {
                markdownGuideHTML = `
                    <div class="bg-blue-50 border border-blue-200 p-4 mb-5 rounded-2xl text-sm text-gray-700 shadow-md fade-in-up" style="animation-delay: 50ms;">
                        <p class="font-bold text-blue-700 flex items-center mb-2"><i data-lucide="code" class="h-5 w-5 ml-2"></i> Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Markdown Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§</p>
                        <div class="bg-white border rounded-lg overflow-hidden mt-3">
                            <table class="w-full text-right text-xs">
                                <thead class="bg-gray-100 font-semibold text-gray-600"><tr><th class="p-2 border-b">Ø³ÛŒÙ†ØªÚ©Ø³</th><th class="p-2 border-b">ØªÙˆØ¶ÛŒØ­</th><th class="p-2 border-b">Ù†Ù…ÙˆÙ†Ù‡</th></tr></thead>
                                <tbody>
                                    <tr class="hover:bg-gray-50"><td class="p-2 border-b font-mono">**Ù…ØªÙ†**</td><td class="p-2 border-b">Ø¨ÙˆÙ„Ø¯</td><td class="p-2 border-b font-bold">Ù…ØªÙ†</td></tr>
                                    <tr class="hover:bg-gray-50"><td class="p-2 border-b font-mono">*Ù…ØªÙ†*</td><td class="p-2 border-b">Ú©Ø¬</td><td class="p-2 border-b italic">Ù…ØªÙ†</td></tr>
                                    <tr class="hover:bg-gray-50"><td class="p-2 border-b font-mono">\`Ú©Ø¯\`</td><td class="p-2 border-b">Ú©Ø¯</td><td class="p-2 border-b font-mono text-sm bg-gray-100 rounded">Ú©Ø¯</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <p class="font-bold text-blue-700 mt-4 mb-1 flex items-center"><i data-lucide="variable" class="h-5 w-5 ml-2"></i> Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù¾ÙˆÛŒØ§</p>
                        <ul class="list-disc pr-5 space-y-1 font-mono text-xs">
                            <li><code>{Subject}</code>: Ù…ÙˆØ¶ÙˆØ¹ ØªÛŒÚ©Øª</li>
                            <li><code>{Department}</code>: Ù†Ø§Ù… Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†</li>
                        </ul>
                    </div>
                `;
            } else {
                 const description = keyData.desc || 'ØªÙˆØ¶ÛŒØ­Ø§Øª Ø®Ø§ØµÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…ØªÙ† Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.';
                 markdownGuideHTML = `
                       <div class="bg-yellow-50 border border-yellow-200 p-4 mb-5 rounded-2xl text-sm text-gray-700 flex items-start shadow-md fade-in-up" style="animation-delay: 50ms;">
                            <i data-lucide="alert-triangle" class="h-5 w-5 ml-2 text-yellow-700 flex-shrink-0 mt-0.5"></i>
                            <div>
                                 <span class="font-bold text-yellow-700 ml-1">Ø±Ø§Ù‡Ù†Ù…Ø§:</span>
                                 <span>${description}</span>
                            </div>
                       </div>
                     `;
            }

            if (isUrlField) {
                inputElement = `
                    <input id="edit-area" type="url" value="${currentText.replace(/\n/g, '')}" class="w-full p-4 border border-gray-300 rounded-2xl shadow-md focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition duration-150 text-gray-800 text-sm" placeholder="Ù…Ø«Ù„Ø§Ù‹: https://yourdomain.com/faq">
                `;
            } else if (isBooleanField) {
                const currentValue = (appTexts[currentEditKey] || "true");
                inputElement = `
                    <select id="edit-area" class="w-full p-4 border border-gray-300 rounded-2xl shadow-md focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition duration-150 text-gray-800 text-sm bg-white">
                        <option value="true" ${currentValue === "true" ? 'selected' : ''}>ÙØ¹Ø§Ù„ (Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯)</option>
                        <option value="false" ${currentValue === "false" ? 'selected' : ''}>ØºÛŒØ±ÙØ¹Ø§Ù„ (Ù…Ø®ÙÛŒ Ø´ÙˆØ¯)</option>
                    </select>
                `;
            } else {
                inputElement = `
                    <textarea id="edit-area" rows="4" class="auto-resize-textarea w-full p-4 border border-gray-300 rounded-2xl shadow-md focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition duration-150 text-gray-800 text-sm" placeholder="Ù…ØªÙ† Ø¬Ø¯ÛŒØ¯ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...">${currentText}</textarea>
                `;
            }

            content.innerHTML = `
                <h2 class="text-2xl font-extrabold text-gray-800 mb-2 fade-in-up">${keyData.name}</h2>

                ${markdownGuideHTML}

                <!-- [Ø¬Ø¯ÛŒØ¯] Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¨Ù‡ Ù†Ø§Ø­ÛŒÙ‡ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ -->
                <div class="fade-in-up" style="animation-delay: 100ms;">
                    ${inputElement}
                </div>

                <div class="flex justify-end space-x-3 mt-6 fade-in-up" style="animation-delay: 150ms;" dir="ltr">
                    <button onclick="handleBack()" class="px-6 py-3 bg-white text-gray-800 rounded-2xl hover:bg-gray-50 transition duration-150 font-semibold shadow-lg btn-press">
                        <i data-lucide="x" class="h-5 w-5 inline ml-1"></i> Ù„ØºÙˆ
                    </button>
                    <button id="save-button" onclick="handleSave()" class="px-6 py-3 bg-indigo-600 text-white rounded-2xl hover:bg-indigo-700 transition duration-150 font-semibold shadow-lg shadow-indigo-400/50 btn-press">
                        <i data-lucide="save" class="h-5 w-5 inline ml-1"></i> Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
                    </button>
                </div>
            `;

            const editArea = document.getElementById('edit-area');
            if (editArea && !isUrlField && !isBooleanField) {
                autoResize(editArea);
                editArea.addEventListener('input', () => autoResize(editArea));
            }
        }

        // --- [Ø¬Ø¯ÛŒØ¯] ØªÙˆØ§Ø¨Ø¹ Ø±Ù†Ø¯Ø± Ù†Ù…ÙˆØ¯Ø§Ø± ---

        function initRatingChart() {
            const ctx = document.getElementById('ratingChart');
            // [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø¢ÛŒØ§ Ø¨ÙˆÙ… Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù‚Ø¨Ù„ Ø§Ø² Ø±Ù†Ø¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯ ÛŒØ§ Ø®ÛŒØ±
            if (!ctx || !chartData || !chartData.ratings) {
                console.warn('Rating chart canvas or data not ready.');
                return;
            }

            // Ø§Ø² Ø¨ÛŒÙ† Ø¨Ø±Ø¯Ù† Ù†Ù…ÙˆØ¯Ø§Ø± Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´Øª
            if (ratingChartInstance) {
                ratingChartInstance.destroy();
            }

            ratingChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartData.ratings.labels,
                    datasets: [{
                        label: 'ØªØ¹Ø¯Ø§Ø¯ Ø§Ù…ØªÛŒØ§Ø²',
                        data: chartData.ratings.data,
                        backgroundColor: [
                            '#16a34a', // 5 Ø³ØªØ§Ø±Ù‡ (Ø³Ø¨Ø²)
                            '#ca8a04', // 4 Ø³ØªØ§Ø±Ù‡ (Ø²Ø±Ø¯)
                            '#ea580c', // 3 Ø³ØªØ§Ø±Ù‡ (Ù†Ø§Ø±Ù†Ø¬ÛŒ)
                            '#dc2626', // 2 Ø³ØªØ§Ø±Ù‡ (Ù‚Ø±Ù…Ø²)
                            '#7f1d1d'  // 1 Ø³ØªØ§Ø±Ù‡ (Ù‚Ø±Ù…Ø² ØªÛŒØ±Ù‡)
                        ],
                        borderColor: '#ffffff',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                fontFamily: 'Vazirmatn',
                                boxWidth: 12,
                                padding: 15
                            }
                        }
                    }
                }
            });
        }

        function initVolumeChart() {
            const ctx = document.getElementById('volumeChart');
            // [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø¢ÛŒØ§ Ø¨ÙˆÙ… Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù‚Ø¨Ù„ Ø§Ø² Ø±Ù†Ø¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯ ÛŒØ§ Ø®ÛŒØ±
            if (!ctx || !chartData || !chartData.volume) {
                 console.warn('Volume chart canvas or data not ready.');
                return;
            }

            if (volumeChartInstance) {
                volumeChartInstance.destroy();
            }

            volumeChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.volume.labels,
                    datasets: [{
                        label: 'ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ',
                        data: chartData.volume.data,
                        fill: true,
                        backgroundColor: 'rgba(79, 70, 229, 0.1)', // Ø¢Ø¨ÛŒ Ù…Ù„Ø§ÛŒÙ…
                        borderColor: '#4f46e5', // Ø¢Ø¨ÛŒ
                        tension: 0.3, // Ù…Ù†Ø­Ù†ÛŒ Ù†Ø±Ù…
                        pointBackgroundColor: '#4f46e5',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù„Ø¬Ù†Ø¯
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#f0f2f5' // Ø®Ø·ÙˆØ· Ú¯Ø±ÛŒØ¯ Ú©Ù…Ø±Ù†Ú¯
                            },
                            ticks: {
                                stepSize: 1, // Ú¯Ø§Ù…â€ŒÙ‡Ø§ÛŒ Û± ÙˆØ§Ø­Ø¯ÛŒ
                                fontFamily: 'Vazirmatn'
                            }
                        },
                        x: {
                            grid: {
                                display: false // Ø­Ø°Ù Ú¯Ø±ÛŒØ¯ Ø¹Ù…ÙˆØ¯ÛŒ
                            },
                            ticks: {
                                fontFamily: 'Vazirmatn'
                            }
                        }
                    }
                }
            });
        }


        // --- [Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ] ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø±Ù†Ø¯Ø± ---

        function render() {
            content.classList.add('transition-all', 'duration-200', 'opacity-0');

            // [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù¾Ø§Ú© Ø´Ø¯Ù† Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
            if (currentState !== 'Dashboard') {
                 if (ratingChartInstance) {
                     ratingChartInstance.destroy();
                     ratingChartInstance = null;
                 }
                if (volumeChartInstance) {
                    volumeChartInstance.destroy();
                    volumeChartInstance = null;
                }
            }

            setTimeout(() => {

                if (currentState === 'Dashboard-Loading') {
                    renderDashboardSkeleton();
                } else if (currentState === 'Dashboard') {
                    renderDashboard();
                } else if (currentState === 'TicketsList') { // [Ø¬Ø¯ÛŒØ¯]
                    renderTicketsList();
                } else if (currentState.startsWith('TicketView_')) { // [Ø¬Ø¯ÛŒØ¯]
                    renderTicketView(currentState);
                } else if (currentState === 'MainMenu') {
                    renderMainMenu();
                } else if (currentState.startsWith('SubMenu_')) {
                    renderSubMenu_Texts(currentState);
                } else if (currentState.startsWith('EditScreen_')) {
                    renderEditScreen(currentState);
                } else {
                    renderDashboard(); // Fallback
                }

                backButton.classList[history.length > 0 ? 'remove' : 'add']('hidden');
                updateFooterNav(currentState);

                content.classList.remove('opacity-0');

                // [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ createIcons Ø¯Ø± Ù‡Ù…Ù‡ Ø±Ù†Ø¯Ø±Ù‡Ø§ Ø¨Ù‡ Ø¬Ø² Ù„ÙˆØ¯ÛŒÙ†Ú¯
                if (currentState !== 'Dashboard-Loading') {
                    lucide.createIcons();
                }

            }, 50);
        }

        // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
        backButton.addEventListener('click', handleBack);
        // [Ø¬Ø¯ÛŒØ¯] ØªÙ†Ø¸ÛŒÙ… Ø§Ø±ØªÙØ§Ø¹ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„Ø¯ Ù¾Ø§Ø³Ø®
        replyTextarea.addEventListener('input', () => {
            replyTextarea.style.height = 'auto';
            replyTextarea.style.height = (replyTextarea.scrollHeight) + 'px';
        });

        // Ø´Ø±ÙˆØ¹ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†
        fetchInitialData();

        // Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù†ÙˆØ§Ø± Ù¾Ø§ÛŒÛŒÙ† Ø±Ø§ Ø±Ù†Ø¯Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        lucide.createIcons();
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>ØªÛŒÚ©Øª ØªÙ„ â€” Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ùˆ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>	
	<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
	
	<!-- Telegram Mini App SDK -->
	<script src="https://telegram.org/js/telegram-web-app.js"></script>
	
	<!-- FIREBASE MODULES (Only Auth is required on the client) -->
	<script type="module">
		import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
		// Only Auth functions are needed client-side for this architecture
		import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
		
		// --- PROXY WORKER CONFIG & LOGIC ---
		// This URL points to your worker that acts as the database proxy.
		const FIREBASE_PROXY_URL = 'https://management-ticketing.amiruserbot7.workers.dev/firebase-proxy'; 
		
		/**
		 * Main interface for sending database requests to the Worker.
		 * @param {string} action - The type of operation (e.g., 'get', 'set').
		 * @param {string} path - The document path in Firestore (e.g., 'artifacts/.../profile/main').
		 * @param {object} [payload={}] - The data to be saved (for 'set' operations).
		 */
		async function proxyFirestore(action, path, payload = {}) {
			try {
				const firebaseUid = window.state?.user?.uid;
				if (!firebaseUid || firebaseUid === 'guest') {
					throw new Error('Authentication error: Firebase UID is not available.');
				}

				const res = await fetch(FIREBASE_PROXY_URL, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ action, path, payload, firebaseUid }),
				});

				const data = await res.json();
				if (!res.ok) throw new Error(data.error || `Worker responded with status ${res.status}.`);
				return data;
			} catch (err) {
				console.error(`Proxy Firestore ${action} failed:`, err);
				Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·', text: 'Ø¹Ø¯Ù… Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ø§Ø² Ø·Ø±ÛŒÙ‚ Worker.' });
				throw err;
			}
		}
		
		/** Helper to set/update a document via Worker. */
		async function saveDocToProxy(docPath, data) {
			return proxyFirestore('set', docPath, { ...data }); 
		}

		/** Helper to get a document via Worker. */
		async function getDocFromProxy(docPath) {
			const result = await proxyFirestore('get', docPath);
			// The worker is expected to return {data: null} if the document is not found
			return result.data || null;
		}
		
		/** * Simulates onSnapshot using Polling for Mini App environments.
		 * @param {string} docPath - The path of the document to monitor.
		 * @param {function} callback - The function to call when data changes.
		 */
		function onSnapshotProxy(docPath, callback) {
			const POLLING_INTERVAL = 5000; // Check every 5 seconds (adjustable)
			let lastData = null;

			const poll = async () => {
				try {
					const data = await getDocFromProxy(docPath);
					const currentData = data || {};
					
					// Deep comparison using JSON stringify
					if (JSON.stringify(currentData) !== JSON.stringify(lastData)) {
						// Invoke callback with a structure similar to Firestore's docSnap
						callback({
							exists: () => !!data,
							data: () => data,
						});
						lastData = currentData;
					}
				} catch (error) {
					console.error("Polling error for onSnapshotProxy:", error);
					// Error is ignored to prevent the polling loop from stopping.
				}
			};

			poll(); 
			const intervalId = setInterval(poll, POLLING_INTERVAL);
			// Return an unsubscribe function to stop polling
			return () => clearInterval(intervalId);
		}
		// --- END PROXY WORKER LOGIC ---
		
		// Expose helpers globally
		window.saveDocToProxy = saveDocToProxy;
		window.getDocFromProxy = getDocFromProxy;
		window.onSnapshotProxy = onSnapshotProxy;


		// Flag to track authentication readiness status
		window.isAuthReady = false; 

		// Global variables injected by Canvas environment
		const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
		const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
		const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
		
		// Global variable for Firebase instances
		window.auth = null;
		window.FIREBASE_DOC_PATH = null;

		function getTelegramUserInfo() {
			if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
				const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
				const fullName = tgUser.last_name ? `${tgUser.first_name} ${tgUser.last_name}` : tgUser.first_name;
				
				return {
					tgUserId: tgUser.id ? tgUser.id.toString() : null, 
					fullName: fullName, 
					username: tgUser.username || tgUser.first_name,
					first_name: tgUser.first_name,
					isAnonymous: false,
					isTelegramAuth: true,
					photo_url: tgUser.photo_url || null, 
				};
			}
			return {
				tgUserId: null, 
				fullName: 'Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒÙ‡Ù…Ø§Ù†',
				username: 'Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒÙ‡Ù…Ø§Ù†',
				first_name: 'Ú©Ø§Ø±Ø¨Ø±',
				isAnonymous: true,
				isTelegramAuth: false,
				photo_url: null,
			};
		}
		
		const initialTgInfo = getTelegramUserInfo();
		window.state.user = { 
			uid: 'guest', // Initial Firebase UID placeholder
			platform: { storeHandle: null, adminBotUsername: null, userBotUsername: null },
			...initialTgInfo, 
		};
		

		if (firebaseConfig) {
			window.firebaseApp = initializeApp(firebaseConfig);
			window.auth = getAuth(window.firebaseApp);

			onAuthStateChanged(window.auth, (user) => {
				if (user) {
					window.state.user = { 
						...window.state.user, 
						uid: user.uid, // This is the actual Firebase UID
						isAnonymous: user.isAnonymous
					};
					
					if (!window.state.user.isTelegramAuth) {
						window.state.user.username = user.email ? user.email.split('@')[0] : 'Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†';
						window.state.user.fullName = window.state.user.username;
					}
					
					// Set the Firestore path based on the real Firebase UID
					window.FIREBASE_DOC_PATH = `artifacts/${appId}/users/${user.uid}/profile/main`;
					
					// --- Set authentication ready flag ---
					window.isAuthReady = true;
					
					// Fetch user-specific and public platform data
					setupDataListeners(user.uid);
					
					// Update UI to show authenticated content
					renderApp(); 
				} else {
					// Attempt to sign in with Canvas token or anonymously
					if (initialAuthToken) {
						signInWithCustomToken(window.auth, initialAuthToken).catch(error => {
							console.error("Custom token sign-in failed:", error);
							signInAnonymously(window.auth).catch(console.error);
						});
					} else {
						signInAnonymously(window.auth).catch(console.error);
					}
				}
			});
		}
		
		function setupDataListeners(uid) {
			// Listen to the user's private document via the proxy
			window.onSnapshotProxy(window.FIREBASE_DOC_PATH, (docSnap) => {
				const oldHandle = window.state.platform.storeHandle;
				
				if (docSnap.exists()) {
					const data = docSnap.data();
					window.state.user = { ...window.state.user, ...data };
					if (data.platform) {
						window.state.platform = data.platform;
					}
				}
				
				if (window.state.platform.storeHandle && window.state.platform.storeHandle !== oldHandle) {
					if (window.state.currentView === 'success') {
						navigateTo('dashboard');
					}
				}
				
				renderProfile(); // Rerender profile on data change
				if (window.state.currentView === 'dashboard') {
					renderDashboard();
				}
			});

			// Try to sync if the user has an existing platform that wasn't found in their profile
			trySyncExistingPlatform(uid);
		}

		/**
		 * Searches the worker for a store linked to the admin's Firebase UID.
		 * @param {string} firebaseUid - The authenticated Firebase User ID.
		 * @param {boolean} [force=false] - If true, ignores the current storeHandle status and retries sync.
		 */
		async function trySyncExistingPlatform(firebaseUid, force = false) {
			const { storeHandle } = window.state.platform;
			const syncButton = document.getElementById('sync-platform-btn');
			
			// If we already have a handle in the local state and it's not a forced sync, do nothing.
			if (storeHandle && !force) return; 
			
			// CRITICAL: Ensure auth is ready before attempting to sync
			if (!window.isAuthReady || !firebaseUid || firebaseUid === 'guest') {
				if (force) {
					Swal.fire({ icon: 'warning', title: 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª', text: 'Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ ØªØ§ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ú©Ø§Ù…Ù„ Ø´ÙˆØ¯ ÛŒØ§ Mini App Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.' });
				}
				return;
			}

			const SYNC_WORKER_URL = "https://management-ticketing.amiruserbot7.workers.dev";
			const SYNC_ENDPOINT = `${SYNC_WORKER_URL}/get-store-by-admin-id`; 
			
			if (syncButton && force) toggleLoading(syncButton, true, 'Ø¯Ø± Ø­Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ...');

			console.log(`Attempting sync using Firebase UID: ${firebaseUid}`);
			
			try {
				const payload = {
					firebaseUid: firebaseUid,
					adminChatId: window.state.user.tgUserId || null, 
				};

				const res = await fetch(SYNC_ENDPOINT, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				});
				
				const data = await res.json();

				if (res.status === 200 && data.success && data.data) {
					// Store found! 
					const platformData = data.data;

					// 1. Update local state for immediate UI rendering
					window.state.platform = platformData; 
					renderProfile(); 
					renderDashboard(); 

					// 2. Show success message (if it was a manual sync)
					if (force) {
						Swal.fire({ icon: 'success', title: 'Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù…ÙˆÙÙ‚', text: 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.' });
					}
					
					// 3. Persist the found data to the user's Firestore profile via proxy
					await saveDocToProxy(window.FIREBASE_DOC_PATH, { platform: platformData });
					
					console.log(`Successfully synced and persisted existing platform: ${platformData.storeHandle}`);
					
				} else if (res.status === 404) {
					console.log(`No existing platform found for UID ${firebaseUid}.`);
					if (force) {
						Swal.fire({ icon: 'info', title: 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯', text: 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ù…Ø§ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.' });
					}
				} else {
					console.warn(`Sync failed for UID ${firebaseUid}:`, data.error || data.message || 'Worker error');
					if (force) {
						Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ', text: data.error || data.message || `Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø¯Ø± Worker (Status: ${res.status})` });
					}
				}

			} catch(error) {
				console.error("Error during platform sync attempt:", error);
				if (force) {
					Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡', text: 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ.' });
				}
			} finally {
				if (syncButton && force) toggleLoading(syncButton, false, 'Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª (Refresh)');
			}
		}

		// Expose manual sync function with an auth check
		window.manualSync = () => {
			if (!window.isAuthReady) {
				Swal.fire({ icon: 'warning', title: 'Ù„Ø·ÙØ§ ØµØ¨Ø± Ú©Ù†ÛŒØ¯', text: 'Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù‡Ù†ÙˆØ² Ú©Ø§Ù…Ù„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ Ø¯ÛŒÚ¯Ø± Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.' });
				return;
			}
			trySyncExistingPlatform(window.state.user.uid, true);
		};
	</script>
	<!-- END FIREBASE MODULES -->

	<style>
		:root{
			--bg-dark: #0f1724;
			--accent1: #00C6FF;
			--accent2: #0072FF;
			--muted: #9AA4B2;
			--text-light: #E6EEF5;
			--nav-height: 60px;
		}
		html,body{height:100%;}
		body{
			font-family: 'Vazirmatn', sans-serif;
			background: radial-gradient(1200px 600px at 10% 20%, rgba(0,114,255,0.07), transparent),
						radial-gradient(1000px 500px at 90% 80%, rgba(0,198,255,0.03), transparent),
						var(--bg-dark);
			color:var(--text-light);
			padding-bottom: var(--nav-height);
			display:flex;
			align-items:center;
			justify-content:center;
			overflow-x: hidden;	
			overflow-y: auto;
		}
		#app-container {
			width: 100%;
			height: 100%;
			display: flex;
			align-items: center;
			justify-content: center;
			position: relative;
			max-width: 1200px; 
			margin: auto;
		}
		#main-view {
			width: 100%;
			height: 100%;
			position: relative;
		}
		.stage-container {
			position: absolute;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 0.5rem;
			width: 100%; 
			height: 100%;
			transition: all 0.7s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
			will-change: opacity, transform;
			overflow-y: auto; 
		}
		.stage-active { opacity: 1; transform: scale(1); pointer-events: auto; position: relative; }
		.stage-hidden { opacity: 0; transform: scale(0.95); pointer-events: none; position: absolute; }
		.stage-exit { opacity: 0; transform: scale(0.85);	pointer-events: none; }
		.stage-enter { opacity: 1; transform: scale(1); pointer-events: auto; transition-delay: 0.1s; }

		.brand-card, .form-card, .content-card {
			max-width: 420px;
			width: 100%;
			background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
			border-radius:1rem;
			padding:1.5rem;
			box-shadow: 0 15px 45px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.08);
			border:1px solid rgba(255,255,255,0.06);
			backdrop-filter: blur(8px);
		}
		.brand-card { min-height: 480px; }
		.headline h1 { font-size:1.5rem; font-weight:700; color:var(--text-light) }
		.headline p { color:var(--muted); margin:0; font-size:0.9rem }
		.glass-input {
			background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
			border:1px solid rgba(255,255,255,0.05);
			padding:0.7rem 0.9rem; border-radius:0.6rem; font-weight:500; color:var(--text-light);
			box-shadow: 0 4px 12px rgba(2,6,23,0.5);
			transition: all 0.18s ease;
			font-size: 1rem;
		}
		.form-label{font-weight:600; color:var(--muted); font-size:0.85rem}
		.btn-cta{
			display:inline-flex; align-items:center; gap:0.5rem; justify-content:center;
			padding:0.8rem 1.2rem; border-radius:0.6rem; font-weight:700; cursor:pointer;
			background:linear-gradient(90deg,var(--accent2),var(--accent1)); color:#fff; border:none;
			box-shadow: 0 8px 20px rgba(0,114,255,0.25);
			transition: transform .18s ease, box-shadow .18s ease;
			font-size: 1rem;
		}
		.btn-cta:hover{transform:translateY(-3px); box-shadow: 0 12px 30px rgba(0,114,255,0.30)}
		.btn-cta:disabled{
			opacity: 0.6; pointer-events: none; transform: translateY(0); box-shadow: none;
			background: linear-gradient(90deg, #374151, #4b5563); 
		}
		.ltr{direction:ltr; text-align:left}
		input:focus, textarea:focus{outline:none; box-shadow:0 6px 20px rgba(0,114,255,0.12); border-color:var(--accent2)}
		.small-foot{font-size:0.8rem; color:var(--muted)}

		/* Navigation Bar */
		#nav-bar {
			position: fixed; bottom: 0; left: 0; right: 0;
			height: var(--nav-height);
			background: rgba(15, 23, 36, 0.9);
			backdrop-filter: blur(12px);
			border-top: 1px solid rgba(255, 255, 255, 0.08);
			display: flex; justify-content: space-around; align-items: center;
			z-index: 50;
		}
		.nav-item {
			display: flex; flex-direction: column; align-items: center; justify-content: center;
			width: 25%; height: 100%; color: var(--muted);
			font-size: 0.75rem; font-weight: 600; cursor: pointer;
			transition: color 0.2s ease;
		}
		.nav-item.active { color: var(--accent1); }
		.nav-item i { font-size: 1.25rem; margin-bottom: 2px; }
		
		/* Profile styles */
		.profile-pic-container {
			width: 96px; height: 96px; border-radius: 50%;
			overflow: hidden; margin: 0 auto 1rem;
			border: 4px solid var(--accent1);
			box-shadow: 0 0 10px rgba(0, 114, 255, 0.3);
			display: flex; align-items: center; justify-content: center;
			font-size: 2.5rem; font-weight: 700;
			background: linear-gradient(135deg, var(--accent2), var(--accent1));
		}
		.profile-pic-container img { width: 100%; height: 100%; object-fit: cover; }
	</style>
</head>
<body>
	<main id="app-container">
		<div id="main-view">
			
			<!-- Stage 1: Onboarding/Brand Card -->
			<div id="stage-onboarding" class="stage-container stage-active" data-view="home">
				<section class="brand-card">
					<div class="flex items-center gap-4">
						<div class="w-16 h-16 rounded-2xl flex items-center justify-center bg-gradient-to-br from-blue-500 to-cyan-400 shadow-lg">
							<i class="fas fa-headset text-3xl text-white"></i>
						</div>
						<div>
							<div class="text-2xl font-bold">ØªÛŒÚ©Øª ØªÙ„</div>
							<div class="text-sm text-gray-400">Ù¾Ù„ØªÙØ±Ù… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯</div>
						</div>
					</div>
					<p class="text-gray-400 mt-4 text-sm">
						Ù¾Ù„ØªÙØ±Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ú©Ù…ØªØ± Ø§Ø² ÛŒÚ© Ø¯Ù‚ÛŒÙ‚Ù‡ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯ Ùˆ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ù…Ø´ØªØ±ÛŒØ§Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø² Ø·Ø±ÛŒÙ‚ ØªÙ„Ú¯Ø±Ø§Ù… Ù…ØªØ­ÙˆÙ„ Ú©Ù†ÛŒØ¯.
					</p>
					<button class="btn-cta w-full mt-auto" onclick="navigateTo('setup')">
						<i class="fas fa-play"></i> Ø´Ø±ÙˆØ¹ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
					</button>
				</section>
			</div>

			<!-- Stage 2: Setup Form -->
			<div id="stage-setup" class="stage-container stage-hidden" data-view="setup">
				<section class="form-card">
					<div class="headline">
						<div>
							<h1>Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾Ù„ØªÙØ±Ù…</h1>
							<p>ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯ ØªØ§ Ù¾Ù„ØªÙØ±Ù… Ø´Ù…Ø§ Ø³Ø§Ø®ØªÙ‡ Ø´ÙˆØ¯.</p>
						</div>
					</div>
					<form id="setup-form" class="mt-6 space-y-4">
						<div>
							<label for="store-handle" class="form-label">Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§ÛŒ Ù¾Ù„ØªÙØ±Ù…</label>
							<input id="store-handle" class="glass-input ltr w-full mt-1" placeholder="Ù…Ø«Ø§Ù„: my-shop (ÙÙ‚Ø· Ø­Ø±ÙˆÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ùˆ Ø®Ø· ØªÛŒØ±Ù‡)" pattern="[a-zA-Z0-9-]+" required>
						</div>
						<div>
							<label for="admin-chat-id" class="form-label">Ø´Ù†Ø§Ø³Ù‡ Ø¹Ø¯Ø¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… Ù…Ø¯ÛŒØ±</label>
							<input id="admin-chat-id" class="glass-input ltr w-full mt-1" placeholder="Ø§Ø² @userinfobot Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯" pattern="[0-9]+" required>
						</div>
						<div>
							<label for="user-bot-token" class="form-label">ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</label>
							<input id="user-bot-token" class="glass-input ltr w-full mt-1" placeholder="ØªÙˆÚ©Ù† Ø±Ø¨Ø§ØªÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯" required>
						</div>
						<div>
							<label for="admin-bot-token" class="form-label">ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª Ø§Ø¯Ù…ÛŒÙ† (Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§)</label>
							<input id="admin-bot-token" class="glass-input ltr w-full mt-1" placeholder="ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª Ø¯Ø±ÛŒØ§ÙØª Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§" required>
						</div>
						<button id="create-platform-btn" class="btn-cta w-full !mt-6" type="submit" disabled>
							<i class="fas fa-spinner animate-spin"></i> Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...
						</button>
						<p class="small-foot text-center !mt-4">Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ <a href="#" class="text-cyan-400">Ù…Ø³ØªÙ†Ø¯Ø§Øª</a></p>
					</form>
				</section>
			</div>

			<!-- Stage 3: Success Message -->
			<div id="stage-success" class="stage-container stage-hidden" data-view="success">
				<section id="success-card" class="content-card">
					<p class="text-white">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†ØªØ§ÛŒØ¬...</p>
				</section>
			</div>
			
			<!-- Stage 4: Profile View -->
			<div id="stage-profile" class="stage-container stage-hidden" data-view="profile">
				<section id="profile-card" class="content-card">
					<p class="text-white text-center">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„...</p>
				</section>
			</div>

			<!-- Stage 5: Dashboard View -->
			<div id="stage-dashboard" class="stage-container stage-hidden" data-view="dashboard">
				<section id="dashboard-card" class="content-card">
					<h1 class="text-2xl font-extrabold text-white mb-4 border-b border-white/10 pb-3">ğŸ—‚ï¸ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù¾Ù„ØªÙØ±Ù…</h1>
					<div id="dashboard-content" class="space-y-3">
						<!-- Dynamic content will be rendered here -->
					</div>
				</section>
			</div>
		</div>
	</main>
	
	<nav id="nav-bar">
		<div class="nav-item active" data-target="home" onclick="navigateTo('home')"><i class="fas fa-home"></i><span>Ø®Ø§Ù†Ù‡</span></div>
		<div class="nav-item" data-target="dashboard" onclick="navigateTo('dashboard')"><i class="fas fa-layer-group"></i><span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span></div>
		<div class="nav-item" data-target="profile" onclick="navigateTo('profile')"><i class="fas fa-user-circle"></i><span>Ù¾Ø±ÙˆÙØ§ÛŒÙ„</span></div>
		<div class="nav-item" data-target="settings" onclick="alert('Not Implemented')"><i class="fas fa-cogs"></i><span>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</span></div>
	</nav>

	<script>
		// Global state object
		window.state = {
			currentView: 'home',
			user: { uid: 'guest', fullName: 'Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒÙ‡Ù…Ø§Ù†', isAnonymous: true }, 
			platform: { storeHandle: null }
		};

		const MANAGEMENT_WORKER_URL = "https://management-ticketing.amiruserbot7.workers.dev";
		
		function enablePlatformCreationButton() {
			const btn = document.getElementById('create-platform-btn');
			if (btn) {
				btn.disabled = false;
				btn.innerHTML = `<i class='fas fa-rocket'></i> Ø³Ø§Ø®Øª Ù¾Ù„ØªÙØ±Ù… Ø¬Ø¯ÛŒØ¯`;
			}
		}

		function copyToClipboard(elementId) {
			const el = document.getElementById(elementId);
			navigator.clipboard.writeText(el.value).then(() => {
				Swal.fire({ toast: true, position: 'top', icon: 'success', title: 'Ø¢Ø¯Ø±Ø³ Ú©Ù¾ÛŒ Ø´Ø¯', showConfirmButton: false, timer: 1500 });
			});
		}
		
		function navigateTo(targetView) {
			if (window.state.currentView === targetView) return;
			const currentStage = document.querySelector(`.stage-container[data-view="${window.state.currentView}"]`);
			const nextStage = document.querySelector(`.stage-container[data-view="${targetView}"]`);
			
			if (!currentStage || !nextStage) return;

			document.querySelectorAll('.nav-item').forEach(item => {
				item.classList.toggle('active', item.getAttribute('data-target') === targetView);
			});
			
			if (targetView === 'profile') renderProfile();
			if (targetView === 'dashboard') renderDashboard();

			currentStage.classList.remove('stage-active');
			currentStage.classList.add('stage-exit');
			
			setTimeout(() => {
				currentStage.classList.add('stage-hidden');
				nextStage.classList.remove('stage-hidden');
				nextStage.classList.add('stage-active', 'stage-enter');
				window.state.currentView = targetView;
				setTimeout(() => nextStage.classList.remove('stage-enter'), 500);
			}, 300); 
		}

		function renderApp() {
			if (window.state.platform.storeHandle && window.state.currentView === 'home') {
				navigateTo('dashboard');
			} else {
				navigateTo(window.state.currentView);
			}
			const adminChatIdInput = document.getElementById('admin-chat-id');
			if (adminChatIdInput && window.state.user.tgUserId) {
				adminChatIdInput.value = window.state.user.tgUserId;
			}
			enablePlatformCreationButton();
		}
		
		function renderProfile() {
			const profileCard = document.getElementById('profile-card');
			const { user, platform } = window.state;
			const displayUsername = user.isAnonymous ? 'Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒÙ‡Ù…Ø§Ù†' : user.fullName;
			const displayUID = user.tgUserId || user.uid || '---';
			const displayUIDLabel = user.tgUserId ? 'Ø´Ù†Ø§Ø³Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…' : 'Ø´Ù†Ø§Ø³Ù‡ ÙØ§ÛŒØ±Ø¨ÛŒØ³';
			const fallbackLetter = (user.first_name || 'U').substring(0, 1).toUpperCase();
			const profilePicHtml = user.photo_url 
				? `<div class="profile-pic-container"><img src="${user.photo_url}" alt="Avatar"></div>`
				: `<div class="profile-pic-container">${fallbackLetter}</div>`;

			profileCard.innerHTML = `
				<div class="text-center">
					${profilePicHtml}
					<h2 class="text-xl font-bold text-white mt-2">${displayUsername}</h2>
					<p class="text-xs text-gray-400 mt-1">${displayUIDLabel}: ${displayUID}</p>
				</div>
				<div class="space-y-3 pt-4 mt-4 border-t border-white/10">
					<h3 class="text-lg font-bold text-white">ÙˆØ¶Ø¹ÛŒØª Ù¾Ù„ØªÙØ±Ù…</h3>
					<div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
						<span class="font-bold text-gray-300">Ø´Ù†Ø§Ø³Ù‡:</span>
						${platform.storeHandle ? `<span class="ltr font-mono text-cyan-400">${platform.storeHandle}</span>` : `<span class="text-red-400">Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ù†Ø´Ø¯Ù‡</span>`}
					</div>
				</div>
			`;
		}

		function renderDashboard() {
			const dashboardContent = document.getElementById('dashboard-content');
			const { platform } = window.state;

			if (platform.storeHandle) {
				dashboardContent.innerHTML = `
					<div class="p-3 rounded-lg flex justify-between items-center bg-white/5"><span class="font-bold">ÙˆØ¶Ø¹ÛŒØª:</span> <span class="text-green-400">âœ… ÙØ¹Ø§Ù„</span></div>
					<div class="p-3 rounded-lg flex justify-between items-center bg-white/5"><span class="font-bold">Ø´Ù†Ø§Ø³Ù‡ Ù¾Ù„ØªÙØ±Ù…:</span> <span class="ltr text-cyan-400 font-mono">${platform.storeHandle}</span></div>
					<div class="p-3 rounded-lg flex justify-between items-center bg-white/5"><span class="font-bold">Ø±Ø¨Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:</span> <a href="https://t.me/${platform.userBotUsername}" target="_blank" class="ltr text-yellow-400 font-mono">@${platform.userBotUsername}</a></div>
					<button id="sync-platform-btn" class="btn-cta w-full !mt-6" onclick="window.manualSync()"><i class="fas fa-sync-alt"></i> Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
				`;
			} else {
				dashboardContent.innerHTML = `
					<p class="text-red-400 p-4 rounded-lg bg-red-500/10">â›” Ù¾Ù„ØªÙØ±Ù…ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø­Ø³Ø§Ø¨ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
					<button class="btn-cta w-full mt-4" onclick="navigateTo('setup')">Ø´Ø±ÙˆØ¹ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾Ù„ØªÙØ±Ù…</button>
				`;
			}
		}

		function finishSetup(result){
			if (!window.isAuthReady || !window.FIREBASE_DOC_PATH) {
				setTimeout(() => finishSetup(result), 200); // Poll until auth is ready
				return;
			}
			const dataToSave = { 
				platform: {
					storeHandle: result.storeHandle,
					adminBotUsername: result.adminBotUsername,
					userBotUsername: result.userBotUsername,
					setupDate: new Date().toISOString()
				}
			};
			
			window.saveDocToProxy(window.FIREBASE_DOC_PATH, dataToSave)
				.then(() => {
					console.log("Platform details saved to profile via proxy.");
					window.state.platform = dataToSave.platform; 
					showSuccess(result);
					renderDashboard();
				})
				.catch(error => {
					console.error("Error saving platform details via Proxy:", error);
					Swal.fire({icon:'error', title:'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡', text:`Ù¾Ù„ØªÙØ±Ù… Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯ØŒ Ø§Ù…Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø¢Ù† Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø´Ù…Ø§ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯: ${error.message}`});
					showSuccess(result); 
				});
		}

		function showSuccess(result){
			const { adminBotUsername, userBotUsername, storeHandle } = result;
			const miniAppUrl = `https://amirrezahoseinabadi.github.io/ticketing-frontend/index.html?storeHandle=${storeHandle}`;
			const successCard = document.getElementById('success-card');

			successCard.innerHTML = `
				<div class="text-center">
					<i class="fas fa-check-circle text-5xl text-green-400"></i>
					<h1 class="text-2xl font-extrabold mt-4">Ù¾Ù„ØªÙØ±Ù… Ø´Ù…Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª</h1>
				</div>
				<div class="mt-6 pt-4 border-t border-white/10 space-y-4">
					<p class="text-sm text-gray-300">Ø¢Ø¯Ø±Ø³ Ø²ÛŒØ± Ø±Ø§ Ø¯Ø± BotFather Ø¨Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª <b class="text-yellow-300">@${userBotUsername}</b> Ø¯Ø± Ø¨Ø®Ø´ Mini App URL Ø«Ø¨Øª Ú©Ù†ÛŒØ¯:</p>
					<div class="relative">
						<input id="mini-app-url-input" class="glass-input ltr w-full text-sm font-mono" readonly value="${miniAppUrl}">
						<button onclick="copyToClipboard('mini-app-url-input')" class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition"><i class="fas fa-copy"></i></button>
					</div>
				</div>
				<button class="btn-cta w-full mt-6" onclick="navigateTo('dashboard')">ØªÚ©Ù…ÛŒÙ„ Ùˆ Ø±ÙØªÙ† Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
			`;
			navigateTo('success');
		}
		
		document.getElementById('setup-form').addEventListener('submit', async (e)=>{
			e.preventDefault();
			if (!window.isAuthReady || !window.state.user.uid || window.state.user.uid === 'guest') {
				Swal.fire({icon:'error', title:'Ø®Ø·Ø§', text:'Ù„Ø·ÙØ§Ù‹ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯ ØªØ§ Ø§ØªØµØ§Ù„ Ø§Ù…Ù† (Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª) Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´ÙˆØ¯.'});
				return;
			}
			const btn = document.getElementById('create-platform-btn');
			toggleLoading(btn, true, 'Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª...');

			const payload = {
				storeHandle: document.getElementById('store-handle').value.trim().toLowerCase(),
				adminChatId: document.getElementById('admin-chat-id').value.trim(),
				userBotToken: document.getElementById('user-bot-token').value.trim(),
				adminBotToken: document.getElementById('admin-bot-token').value.trim(),
				miniAppUrl: `https://amirrezahoseinabadi.github.io/ticketing-frontend/index.html?storeHandle=${document.getElementById('store-handle').value.trim().toLowerCase()}`,
				firebaseUid: window.state.user.uid
			};

			try{
				const res = await fetch(`${MANAGEMENT_WORKER_URL}/setup`, {
					method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
				});
				const data = await res.json();
				if(!res.ok) throw new Error(data.error || `Ø®Ø·Ø§ Ø¯Ø± Ø³Ø±ÙˆØ± (${res.status})`);
				finishSetup(data.data);
			} catch(err){
				Swal.fire({icon:'error', title:'Ø¹Ù…Ù„ÛŒØ§Øª Ù†Ø§Ù…ÙˆÙÙ‚', text: err.message});
			} finally {
				toggleLoading(btn, false, 'Ø³Ø§Ø®Øª Ù¾Ù„ØªÙØ±Ù… Ø¬Ø¯ÛŒØ¯');
			}
		});

		function toggleLoading(button, isLoading, text){
			button.disabled = isLoading;
			if (isLoading) {
				button.innerHTML = `<i class="fas fa-spinner animate-spin"></i> ${text}`;
			} else {
				button.innerHTML = text;
			}
		}

		window.addEventListener('load', renderApp);
	</script>
</body>
</html>

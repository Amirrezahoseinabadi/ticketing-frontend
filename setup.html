<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
	<title>تیکت تل — راه‌اندازی پلتفرم</title>
	<!-- External Libraries -->
	<script src="https://telegram.org/js/telegram-web-app.js"></script>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

	<style>
		/* CSS Variables for a professional light theme */
		:root{
			--bg-light: #f7f8fc;
			--accent1: #0d94e4;
			--accent2: #0c64e0;
			--text-dark: #1e293b;
			--muted: #64748b;
			--border-color: #e2e8f0;
			--glow-color: rgba(13, 148, 228, 0.25);
			--gold: #f59e0b;
		}

		html, body {
            height: 100%;
			overflow: hidden; /* Hide scrollbars from aurora effect */
        }
		body {
			font-family: 'Vazirmatn', sans-serif;
			color: var(--text-dark);
			-webkit-font-smoothing:antialiased;
			-moz-osx-font-smoothing:grayscale;
			display:flex;
			flex-direction: column;
			min-height: 100vh;
            background-color: var(--bg-light);
            position: relative;
		}
        
        /* Professional Aurora Background Effect */
        body::before, body::after {
            content: '';
            position: absolute;
            z-index: -1;
            filter: blur(100px);
            opacity: 0.15;
            border-radius: 50%;
        }
        body::before {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, #67e8f9, transparent 60%);
            top: -200px;
            left: -200px;
            animation: move-aurora-1 20s infinite alternate ease-in-out;
        }
        body::after {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, #818cf8, transparent 60%);
            bottom: -150px;
            right: -150px;
            animation: move-aurora-2 25s infinite alternate ease-in-out;
        }

        @keyframes move-aurora-1 {
            from { transform: translate(0, 0) rotate(0deg); }
            to { transform: translate(100px, 50px) rotate(45deg); }
        }
        @keyframes move-aurora-2 {
            from { transform: translate(0, 0) rotate(0deg); }
            to { transform: translate(-50px, -100px) rotate(-30deg); }
        }

		.page-wrapper {
			display: flex;
			flex-direction: column;
			flex-grow: 1;
			padding: 1.5rem;
			width: 100%;
			max-width: 520px;
			margin: 0 auto;
            justify-content: center;
			position: relative;
			z-index: 1;
		}

		/* Form Card Styles */
		.form-card{
			background: rgba(255, 255, 255, 0.75);
			border-radius: 1.25rem;
			padding: 2.5rem;
			border: 1px solid rgba(255, 255, 255, 0.9);
			backdrop-filter: blur(12px) saturate(150%);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
		}

		.headline h1{font-size:1.5rem; font-weight:700; color:var(--text-dark); line-height: 1.6;}
		.headline h1 .gradient-text {
			background: linear-gradient(90deg, var(--accent1), var(--accent2));
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
			text-fill-color: transparent;
			display: inline-block;
		}

        /* Input Group with Icon */
        .input-group {
            position: relative;
        }
        .input-group .input-icon {
            position: absolute;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            color: var(--muted);
            font-size: 0.9rem;
            pointer-events: none;
            transition: color 0.2s ease;
        }

		.glass-input{
			background: #ffffff;
			border:1px solid var(--border-color);
			padding: 0.8rem 2.75rem 0.8rem 3rem;
			border-radius:0.6rem; 
            font-weight:500;
			font-size: 1rem;
            color:var(--text-dark);
			transition: all 0.2s ease;
            width: 100%;
			box-shadow: 0 1px 2px rgba(0,0,0,0.05) inset;
		}
        .glass-input::placeholder { color: #94a3b8; }
        
        .glass-input:focus {
            outline: none;
            border-color: var(--accent2);
            box-shadow: 0 0 0 3px var(--glow-color), 0 1px 2px rgba(0,0,0,0.05) inset;
        }
        .glass-input:focus + .input-icon {
            color: var(--accent1);
        }

		.auto-fill-btn {
			position: absolute;
			top: 50%;
			left: 0.5rem;
			transform: translateY(-50%);
			background: none;
			border: none;
			color: var(--muted);
			cursor: pointer;
			font-size: 1rem;
			padding: 0.5rem;
			transition: color 0.2s ease, transform 0.2s ease;
			z-index: 10;
		}
		.auto-fill-btn:hover {
			color: var(--accent1);
			transform: translateY(-50%) scale(1.1);
		}
		.auto-fill-btn.hidden { display: none; }

		.form-label{font-weight:600; color:var(--muted); font-size:0.85rem; display: block; margin-bottom: 0.5rem;}

		.btn-cta{
			display:inline-flex; align-items:center; gap:0.6rem; justify-content:center;
			padding:0.85rem 1.1rem; border-radius:0.75rem; font-weight:700; cursor:pointer;
			background:linear-gradient(90deg,var(--accent2),var(--accent1)); color:#fff; border:none;
			box-shadow: 0 8px 25px rgba(12, 100, 224, 0.25);
			transition: all .2s ease;
            width: 100%;
		}
		.btn-cta:hover{
            transform:translateY(-3px); 
            box-shadow: 0 12px 30px rgba(12, 100, 224, 0.35);
        }
		.btn-cta:disabled{
			opacity: 0.6; pointer-events: none; transform: translateY(0);
			box-shadow: none;
		}

		.ltr{direction:ltr; text-align:left}

		/* Page Footer */
		.page-footer { text-align: center; padding: 2rem 0 0; font-size: 0.8rem; color: var(--muted); }
		
		.form-footer {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-top: 1.5rem;
			font-size: 0.85rem;
			color: var(--muted);
		}
		.form-footer a {
			color: var(--accent2);
			font-weight: 600;
			text-decoration: none;
			transition: color 0.2s ease;
		}
		.form-footer a:hover {
			color: var(--accent1);
		}
		.form-footer .version {
			font-weight: 600;
		}
		.form-footer .version span {
			color: var(--gold);
			font-weight: 700;
		}

		/* Animation */
		.animate-fade-up{opacity:0; transform: translateY(15px); animation:fadeUp .7s ease-out forwards}
		@keyframes fadeUp{to{opacity:1; transform:none}}

		/* SweetAlert */
		.swal2-popup{font-family:'Vazirmatn',sans-serif !important; border-radius: 1rem !important;}
	</style>
</head>
<body>
	<div class="page-wrapper">
		<!-- Main Content -->
		<main class="content-main">
			<section class="form-card animate-fade-up">
				<div class="headline">
					<h1><strong class="gradient-text">تیکت تل</strong>؛ پلتفرم پشتیبانی هوشمند — سریع، امن و قابل توسعه</h1>
				</div>
	
				<form id="setup-form" class="mt-8 space-y-6">
					<div>
						<label for="store-handle" class="form-label">شناسه پلتفرم را انگلیسی وارد کنید - در URL پنل استفاده میشود</label>
                        <div class="input-group">
						    <input id="store-handle" class="glass-input ltr" placeholder="my-store" pattern="[a-zA-Z0-9-]+" required>
                            <i class="input-icon fas fa-store"></i>
                        </div>
					</div>
	
					<div>
						<label for="admin-chat-id" class="form-label">شناسه عددی تلگرام مدیر</label>
                        <div class="input-group">
						    <input id="admin-chat-id" class="glass-input ltr" placeholder="123456789" pattern="[0-9]+" required>
                            <i class="input-icon fas fa-user-shield"></i>
							<button type="button" id="use-my-id-btn" class="auto-fill-btn hidden" title="جایگذاری شناسه من">
								<i class="fas fa-magic-wand-sparkles"></i>
							</button>
                        </div>
					</div>
	
					<div>
						<label for="user-bot-token" class="form-label">توکن ربات کاربران</label>
                        <div class="input-group">
						    <input id="user-bot-token" class="glass-input ltr" placeholder="123:ABC..." required>
                            <i class="input-icon fas fa-robot"></i>
                        </div>
					</div>
	
					<div>
						<label for="admin-bot-token" class="form-label">توکن ربات ادمین (اعلان‌ها)</label>
                        <div class="input-group">
						    <input id="admin-bot-token" class="glass-input ltr" placeholder="456:XYZ..." required>
                            <i class="input-icon fas fa-bell"></i>
                        </div>
					</div>
	
					<div class="pt-2">
						<button id="create-platform-btn" class="btn-cta" type="submit"><i class="fas fa-rocket" style="margin-left: 0.5rem;"></i> ساخت پلتفرم جدید</button>
					</div>

					<div class="form-footer">
						<div>
							نیاز به کمک؟ <a href="https://amirrezahoseinabadi.github.io/support" target="_blank">پشتیبانی</a>
						</div>
						<div class="version">
							نسخه <span>1.0.0</span>
						</div>
					</div>
				</form>
			</section>
		</main>

		<!-- Page Footer -->
		<footer class="page-footer">
			<p>&copy; 2025 TicketTel. All Rights Reserved.</p>
		</footer>
	</div>

	<script>
		document.addEventListener('DOMContentLoaded', () => {
			// --- TELEGRAM MINI APP INITIALIZATION ---
			if (window.Telegram && window.Telegram.WebApp) {
				try {
					const tg = window.Telegram.WebApp;
					tg.ready();
					tg.expand();
					
					// Auto-fill User ID Logic
					const userId = tg.initDataUnsafe?.user?.id;
					const useMyIdBtn = document.getElementById('use-my-id-btn');
					const adminChatIdInput = document.getElementById('admin-chat-id');

					if (userId && useMyIdBtn && adminChatIdInput) {
						useMyIdBtn.classList.remove('hidden');
						useMyIdBtn.addEventListener('click', () => {
							tg.HapticFeedback.impactOccurred('light');
							adminChatIdInput.value = userId;
							adminChatIdInput.dispatchEvent(new Event('input', { bubbles: true }));
							adminChatIdInput.focus();
						});
					}

					// Add Haptic Feedback to main button
					const createBtn = document.getElementById('create-platform-btn');
					if(createBtn){
						createBtn.addEventListener('click', () => {
							tg.HapticFeedback.impactOccurred('light');
						});
					}

				} catch (e) {
					console.error("Telegram WebApp error:", e);
				}
			}
			
			// --- FORM SUBMISSION LOGIC ---
			const MANAGEMENT_WORKER_URL = "https://management-ticketing.amiruserbot7.workers.dev";

			document.getElementById('setup-form').addEventListener('submit', async (e)=>{
				e.preventDefault();
				const btn = document.getElementById('create-platform-btn');
				toggleLoading(btn, true, 'در حال ساخت پلتفرم...');

				const storeHandle = document.getElementById('store-handle').value.trim().toLowerCase();

				const payload = {
					storeHandle: storeHandle,
					adminChatId: document.getElementById('admin-chat-id').value.trim(),
					userBotToken: document.getElementById('user-bot-token').value.trim(),
					adminBotToken: document.getElementById('admin-bot-token').value.trim(),
					miniAppUrl: `https://amirrezahoseinabadi.github.io/ticketing-frontend/index.html?storeHandle=${storeHandle}`
				};

				// Basic validation
				if(!payload.storeHandle || !payload.adminChatId || !payload.userBotToken || !payload.adminBotToken){
					Swal.fire({icon:'error', title:'خطا', text:'لطفاً همه فیلدهای الزامی را تکمیل کنید.'});
					toggleLoading(btn, false, 'ساخت پلتفرم جدید');
					return;
				}

				// API Call
				try{
					const res = await fetch(`${MANAGEMENT_WORKER_URL}/setup`,{
						method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
					});
					const data = await res.json();
					if(!res.ok) throw new Error(data.error || 'خطا در برقراری ارتباط با سرور');

					showSuccess(data.data);
				}catch(err){
					Swal.fire({icon:'error', title:'عملیات ناموفق', text: err.message || err.toString()});
				}finally{
					toggleLoading(btn, false, 'ساخت پلتفرم جدید');
				}
			});

			function toggleLoading(button, isLoading, text){
				if(isLoading){
					button.disabled = true;
					button.innerHTML = `<svg class='animate-spin inline-block' style='width:18px;height:18px' viewBox='0 0 24 24'><circle class='opacity-25' cx='12' cy='12' r='10' stroke='currentColor' stroke-width='4' fill='none'></circle><path class='opacity-75' fill='currentColor' d='M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z'></path></svg> <span style="margin-right: 0.5rem;">${text}</span>`;
				} else {
					button.disabled = false;
					button.innerHTML = `<i class='fas fa-rocket' style="margin-left: 0.5rem;"></i> ${text}`;
				}
			}

			function showSuccess(result){
				const { adminBotUsername, storeHandle } = result || {};
				const MINI_APP_BASE_URL = "https://amirrezahoseinabadi.github.io/ticketing-frontend/index.html";
				const miniAppUrl = `${MINI_APP_BASE_URL}?storeHandle=${storeHandle}`;

				Swal.fire({
					icon:'success',
					title:'🎉 پلتفرم شما آماده است',
					html: `
						<div style="text-align:right; line-height: 1.7;">
							<p style="font-weight:700; margin-bottom:1rem;">گام‌های بعدی:</p>
							<ol style="list-style-type: none; padding: 0; margin: 0; color:#334155;">
								<li style="margin-bottom: 1.25rem; font-size:15px;">
									<strong>۱. فعال‌سازی Mini App:</strong><br> آدرس زیر را کپی کرده و در تنظیمات ربات خود در BotFather قرار دهید:
									<input style="width:100%; padding:10px; border-radius:6px; border:1px solid #E2E8F0; margin-top:8px; background:#F8FAFC; color:#1e293b; direction:ltr; text-align:left; font-family:monospace;" readonly value="${miniAppUrl}" onclick="this.select(); document.execCommand('copy'); Swal.fire({toast:true, position:'top-end', icon:'success', title:'آدرس کپی شد', showConfirmButton:false, timer:1500})">
								</li>
								<li style="font-size:15px;">
									<strong>۲. فعال‌سازی ربات ادمین:</strong><br> ربات <a href="https://t.me/${adminBotUsername}" target="_blank" style="color:var(--accent2); font-weight:700;">@${adminBotUsername}</a> را باز کرده و دکمه Start را بزنید تا اعلان‌ها برای شما فعال شود.
								</li>
							</ol>
							<p style="margin-top:1.5rem; font-size:14px; color:#475569;">برای جلوگیری از ساخت مجدد پلتفرم، این صفحه تا لحظاتی دیگر غیرفعال می‌شود.</p>
						</div>
					`,
					width: '90%', 
					maxWidth: '680px',
					confirmButtonText:'متوجه شدم',
					allowOutsideClick: false,
				}).then(() => { 
					document.getElementById('setup-form').style.opacity = '0.5';
					document.getElementById('setup-form').style.pointerEvents = 'none';
				});
			}
		});
	</script>
</body>
</html>


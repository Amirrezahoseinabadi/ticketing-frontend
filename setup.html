<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>ØªÛŒÚ©Øª ØªÙ„ â€” Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ùˆ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>Â 
	<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
Â  Â Â 
Â  Â  <!-- ØªÙ„Ú¯Ø±Ø§Ù… Mini App SDK -->
Â  Â  <script src="https://telegram.org/js/telegram-web-app.js"></script>
Â  Â Â 
Â  Â  <!-- FIREBASE MODULES (Only Auth is kept client-side) -->
Â  Â  <script type="module">
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
Â  Â  Â  Â  // Auth functions MUST remain client-side
Â  Â  Â  Â  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
Â  Â  Â  Â  // setLogLevel is kept for optional debugging
Â  Â  Â  Â  import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- PROXY WORKER CONFIG & LOGIC ---
Â  Â  Â  Â  // Ø§ÛŒÙ† URL Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Worker Ø´Ù…Ø§ Ø§Ø´Ø§Ø±Ù‡ Ú©Ù†Ø¯ Ú©Ù‡ ÙˆØ§Ø³Ø· Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø§Ø³Øª.
Â  Â  Â  Â  const FIREBASE_PROXY_URL = 'https://management-ticketing.amiruserbot7.workers.dev/firebase-proxy';Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * ÙˆØ§Ø³Ø· Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Firestore Ø¨Ù‡ Worker.
Â  Â  Â  Â  Â * @param {string} action - Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª (Ù…Ø«Ø§Ù„: 'get', 'set').
Â  Â  Â  Â  Â * @param {string} path - Ù…Ø³ÛŒØ± Ø³Ù†Ø¯ Ø¯Ø± Firestore (Ù…Ø«Ø§Ù„: 'artifacts/.../profile/main').
Â  Â  Â  Â  Â * @param {object} [payload={}] - Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆÙ†Ø¯ (Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª 'set').
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function proxyFirestore(action, path, payload = {}) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const firebaseUid = window.state?.user?.uid;
Â  Â  Â  Â  Â  Â  Â  Â  if (!firebaseUid || firebaseUid === 'guest') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª: Firebase UID Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch(FIREBASE_PROXY_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ action, path, payload, firebaseUid }),
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  if (!res.ok) throw new Error(data.error || `Worker Ø¨Ø§ ÙˆØ¶Ø¹ÛŒØª ${res.status} Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯.`);
Â  Â  Â  Â  Â  Â  Â  Â  return data;
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Proxy Firestore ${action} failed:`, err);
Â  Â  Â  Â  Â  Â  Â  Â  Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·', text: 'Ø¹Ø¯Ù… Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ø§Ø² Ø·Ø±ÛŒÙ‚ Worker.' });
Â  Â  Â  Â  Â  Â  Â  Â  throw err;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /** Helper to set/update a document via Worker. */
Â  Â  Â  Â  async function saveDocToProxy(docPath, data) {
Â  Â  Â  Â  Â  Â  return proxyFirestore('set', docPath, data);Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  /** Helper to get a document via Worker. */
Â  Â  Â  Â  async function getDocFromProxy(docPath) {
Â  Â  Â  Â  Â  Â  const result = await proxyFirestore('get', docPath);
Â  Â  Â  Â  Â  Â  // Ø§Ù†ØªØ¸Ø§Ø± Ù…ÛŒâ€ŒØ±ÙˆØ¯ Worker Ø¯Ø± ØµÙˆØ±Øª ÛŒØ§ÙØª Ù†Ø´Ø¯Ù† Ø³Ù†Ø¯ØŒ {data: null} Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯
Â  Â  Â  Â  Â  Â  return result.data || null;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /** * Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ onSnapshot Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Polling (Ø¨Ø±Ø±Ø³ÛŒ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ) Ø¨Ø±Ø§ÛŒ Mini App.
Â  Â  Â  Â  Â * @param {string} docPath - Ù…Ø³ÛŒØ± Ø³Ù†Ø¯ÛŒ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ù…Ø§Ù†ÛŒØªÙˆØ± Ø´ÙˆØ¯.
Â  Â  Â  Â  Â * @param {function} callback - ØªØ§Ø¨Ø¹ÛŒ Ú©Ù‡ Ø¯Ø± ØµÙˆØ±Øª ØªØºÛŒÛŒØ± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function onSnapshotProxy(docPath, callback) {
Â  Â  Â  Â  Â  Â  const POLLING_INTERVAL = 5000; // Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ø± 5 Ø«Ø§Ù†ÛŒÙ‡ (Ù‚Ø§Ø¨Ù„ ØªÙ†Ø¸ÛŒÙ…)
Â  Â  Â  Â  Â  Â  let lastData = null;

Â  Â  Â  Â  Â  Â  const poll = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = await getDocFromProxy(docPath);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentData = data || {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¹Ù…ÛŒÙ‚ (Deep Comparison) Ø¨Ø§ JSON
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentJson = JSON.stringify(currentData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lastJson = JSON.stringify(lastData);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentJson !== lastJson) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ callback Ø¨Ø§ Ø³Ø§Ø®ØªØ§Ø±ÛŒ Ø´Ø¨ÛŒÙ‡ Ø¨Ù‡ docSnap Firestore
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  callback({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exists: () => !!data,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: () => data,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastData = currentData;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Polling error for onSnapshotProxy:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ø®Ø·Ø§ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ ØªØ§ Ø­Ù„Ù‚Ù‡ Polling Ù…ØªÙˆÙ‚Ù Ù†Ø´ÙˆØ¯.
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  // Ø´Ø±ÙˆØ¹ Polling Ùˆ ØªÙ†Ø¸ÛŒÙ… Interval
Â  Â  Â  Â  Â  Â  poll();Â 
Â  Â  Â  Â  Â  Â  const intervalId = setInterval(poll, POLLING_INTERVAL);

Â  Â  Â  Â  Â  Â  // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† ØªØ§Ø¨Ø¹ Unsubscribe Ø¨Ø±Ø§ÛŒ ØªÙˆÙ‚Ù Polling
Â  Â  Â  Â  Â  Â  return () => clearInterval(intervalId);
Â  Â  Â  Â  }
Â  Â  Â  Â  // --- END PROXY WORKER LOGIC ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Expose helpers globally (Set to window for non-module scripts if needed, though all logic is here)
Â  Â  Â  Â  window.saveDocToProxy = saveDocToProxy;
Â  Â  Â  Â  window.getDocFromProxy = getDocFromProxy;
Â  Â  Â  Â  window.onSnapshotProxy = onSnapshotProxy;


Â  Â  Â  Â  // Flag to track authentication readiness status
Â  Â  Â  Â  window.isAuthReady = false;Â 

Â  Â  Â  Â  // Log setup
Â  Â  Â  Â  // setLogLevel('debug'); // Uncomment for debugging Firestore logs

Â  Â  Â  Â  // Global variables injected by Canvas environment
Â  Â  Â  Â  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
Â  Â  Â  Â  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
Â  Â  Â  Â  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Global variable for Firebase instances
Â  Â  Â  Â  window.db = {}; // Placeholder, as Firestore is not used directly
Â  Â  Â  Â  window.auth = null;
Â  Â  Â  Â  window.FIREBASE_DOC_PATH = null;

Â  Â  Â  Â  // ØªØ¹ÛŒÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø² ØªÙ„Ú¯Ø±Ø§Ù… (Ø§Ú¯Ø± Mini App Ø¨Ø§Ø´Ø¯)
Â  Â  Â  Â  function getTelegramUserInfo() {
Â  Â  Â  Â  Â  Â  // Get user info from Telegram WebApp SDK
Â  Â  Â  Â  Â  Â  if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
Â  Â  Â  Â  Â  Â  Â  Â  const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
Â  Â  Â  Â  Â  Â  Â  Â  const fullName = tgUser.last_name ? `${tgUser.first_name} ${tgUser.last_name}` : tgUser.first_name;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tgUserId: tgUser.id ? tgUser.id.toString() : null,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fullName: fullName,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  username: tgUser.username || tgUser.first_name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  first_name: tgUser.first_name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isAnonymous: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isTelegramAuth: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  photo_url: tgUser.photo_url || null,Â 
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  tgUserId: null,Â 
Â  Â  Â  Â  Â  Â  Â  Â  fullName: 'Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒÙ‡Ù…Ø§Ù†',
Â  Â  Â  Â  Â  Â  Â  Â  username: 'Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒÙ‡Ù…Ø§Ù†',
Â  Â  Â  Â  Â  Â  Â  Â  first_name: 'Ú©Ø§Ø±Ø¨Ø±',
Â  Â  Â  Â  Â  Â  Â  Â  isAnonymous: true,
Â  Â  Â  Â  Â  Â  Â  Â  isTelegramAuth: false,
Â  Â  Â  Â  Â  Â  Â  Â  photo_url: null,
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ØªÙ†Ø¸ÛŒÙ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ú©Ø§Ø±Ø¨Ø±
Â  Â  Â  Â  const initialTgInfo = getTelegramUserInfo();
Â  Â  Â  Â  window.state.user = {Â 
Â  Â  Â  Â  Â  Â  uid: 'guest', // Initial Firebase UID placeholder
Â  Â  Â  Â  Â  Â  platform: { storeHandle: null, adminBotUsername: null, userBotUsername: null },
Â  Â  Â  Â  Â  Â  ...initialTgInfo,Â 
Â  Â  Â  Â  };
Â  Â  Â  Â Â 

Â  Â  Â  Â  if (firebaseConfig) {
Â  Â  Â  Â  Â  Â  window.firebaseApp = initializeApp(firebaseConfig);
Â  Â  Â  Â  Â  Â  window.auth = getAuth(window.firebaseApp);

Â  Â  Â  Â  Â  Â  // Auth listener and custom token sign-in
Â  Â  Â  Â  Â  Â  onAuthStateChanged(window.auth, (user) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UID ÙØ§ÛŒØ±Ø¨ÛŒØ³
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.state.user = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...window.state.user,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uid: user.uid, // This is the actual Firebase UID
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isAnonymous: user.isAnonymous
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ø§Ú¯Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Mini App Ù†Ø¨ÙˆØ¯ØŒ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ Ø§Ø² Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!window.state.user.isTelegramAuth) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.state.user.username = user.email ? user.email.split('@')[0] : 'Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.state.user.fullName = window.state.user.username;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ØªÙ†Ø¸ÛŒÙ… Ù…Ø³ÛŒØ± Firestore Ø¨Ø± Ø§Ø³Ø§Ø³ UID ÙˆØ§Ù‚Ø¹ÛŒ Firebase
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.FIREBASE_DOC_PATH = `artifacts/${appId}/users/${user.uid}/profile/main`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Fetch user-specific and public platform data
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setupDataListeners(user.uid);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- ØªÙ†Ø¸ÛŒÙ… Ù¾Ø±Ú†Ù… Ø¢Ù…Ø§Ø¯Ù‡ Ø¨ÙˆØ¯Ù† Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.isAuthReady = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Update UI to show authenticated content
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderApp();Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ø¨Ø§ ØªÙˆÚ©Ù† Canvas ÛŒØ§ ÙˆØ±ÙˆØ¯ Ù†Ø§Ø´Ù†Ø§Ø³
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (initialAuthToken) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  signInWithCustomToken(window.auth, initialAuthToken).catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Custom token sign-in failed:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  signInAnonymously(window.auth).catch(console.error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  signInAnonymously(window.auth).catch(console.error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function setupDataListeners(uid) {
Â  Â  Â  Â  Â  Â  // 1. Listen to the user's private document (for profile data, e.g., display name)
Â  Â  Â  Â  Â  Â  // *** Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² onSnapshotProxy Ø¨Ù‡ Ø¬Ø§ÛŒ onSnapshot Firestore ***
Â  Â  Â  Â  Â  Â  window.onSnapshotProxy(window.FIREBASE_DOC_PATH, (docSnap) => {
Â  Â  Â  Â  Â  Â  Â  Â  const oldHandle = window.state.platform.storeHandle;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (docSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Update state with platform data if available
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = docSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.state.user = { ...window.state.user, ...data };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.platform) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.state.platform = data.platform;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Ø§Ú¯Ø± Ø¯ÛŒØªØ§ÛŒ Ø¬Ø¯ÛŒØ¯ÛŒ Ø§Ø² Ù¾Ù„ØªÙØ±Ù… (Ù…Ø«Ù„Ø§Ù‹ Ù¾Ø³ Ø§Ø² Ø³Ø§Ø®Øª) Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
Â  Â  Â  Â  Â  Â  Â  Â  if (window.state.platform.storeHandle && window.state.platform.storeHandle !== oldHandle) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ø§Ú¯Ø± Ø¯Ø± Ù†Ù…Ø§ÛŒ Success Ø¨ÙˆØ¯ÛŒÙ…ØŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù‡Ø¯Ø§ÛŒØª Ú©Ù†
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (window.state.currentView === 'success') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  navigateTo('dashboard');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  renderProfile(); // Rerender profile on data change
Â  Â  Â  Â  Â  Â  Â  Â  // NEW: Explicitly check and render dashboard on data change if needed
Â  Â  Â  Â  Â  Â  Â  Â  if (window.state.currentView === 'dashboard') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderDashboard();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 2. Try to sync if the user has an existing platform that wasn't found in their profile
Â  Â  Â  Â  Â  Â  trySyncExistingPlatform(uid);
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * UPDATED FUNCTION: Searches the worker for a store linked to the admin's Firebase UID.
Â  Â  Â  Â  Â * @param {string} firebaseUid - The authenticated Firebase User ID.
Â  Â  Â  Â  Â * @param {boolean} [force=false] - If true, ignores the current storeHandle status and retries sync.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function trySyncExistingPlatform(firebaseUid, force = false) {
Â  Â  Â  Â  Â  Â  const { storeHandle } = window.state.platform;
Â  Â  Â  Â  Â  Â  const syncButton = document.getElementById('sync-platform-btn');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Handle Ø±Ø§ Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Firestore Ø¯Ø§Ø´ØªÛŒÙ… Ùˆ force Ù†Ø¨ÙˆØ¯ØŒ Ú©Ø§Ø±ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
Â  Â  Â  Â  Â  Â  if (storeHandle && !force) return;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!firebaseUid) {
Â  Â  Â  Â  Â  Â  Â  Â  if (force) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Swal.fire({ icon: 'warning', title: 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª', text: 'Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ ØªØ§ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ú©Ø§Ù…Ù„ Ø´ÙˆØ¯ ÛŒØ§ Mini App Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.' });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Ø¢Ø¯Ø±Ø³ Worker Ø§ØµÙ„ÛŒ (Ù‡Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„ØŒ Ú†ÙˆÙ† Ø§ÛŒÙ† endpoint Ø®ÙˆØ¯Ø´ ÛŒÚ© Worker call Ø§Ø³Øª)
Â  Â  Â  Â  Â  Â  const SYNC_WORKER_URL = "https://management-ticketing.amiruserbot7.workers.dev";
Â  Â  Â  Â  Â  Â  const SYNC_ENDPOINT = `${SYNC_WORKER_URL}/get-store-by-admin-id`;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (syncButton) toggleLoading(syncButton, true, 'Ø¯Ø± Ø­Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ...');


Â  Â  Â  Â  Â  Â  console.log(`Attempting sync using Firebase UID: ${firebaseUid}`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  firebaseUid: firebaseUid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  adminChatId: window.state.user.tgUserId || null,Â 
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch(SYNC_ENDPOINT, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (res.status === 200 && data.success && data.data) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Store found! 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const platformData = data.data;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- Ø´Ø±ÙˆØ¹ Ø§ØµÙ„Ø§Ø­ÛŒÙ‡: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù…Ø­Ù„ÛŒ Ùˆ Ø±Ù†Ø¯Ø± ÙÙˆØ±ÛŒ ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 1. Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù…Ø­Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø±Ù†Ø¯Ø± ÙÙˆØ±ÛŒ UI
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.state.platform = platformData;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderProfile(); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderDashboard(); 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª (Ø§Ú¯Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø³ØªÛŒ Ø¨ÙˆØ¯)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (force) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Swal.fire({ icon: 'success', title: 'Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù…ÙˆÙÙ‚', text: 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
                    // --- Ù¾Ø§ÛŒØ§Ù† Ø§ØµÙ„Ø§Ø­ÛŒÙ‡: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù…Ø­Ù„ÛŒ Ùˆ Ø±Ù†Ø¯Ø± ÙÙˆØ±ÛŒ ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 3. ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ù…Ø³ÛŒØ± Firebase Ø¢Ù…Ø§Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¦Ù…ÛŒ Ú©Ù†.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!window.FIREBASE_DOC_PATH) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Sync successful but Firebase auth not fully ready yet. Skipping persistence.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; // Ø®Ø±ÙˆØ¬ Ø§Ø² ØªØ§Ø¨Ø¹ØŒ Ø§Ù…Ø§ Ø­Ø§Ù„Øª Ù…Ø­Ù„ÛŒ (UI) Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯Ù‡ Ø§Ø³Øª.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // *** Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¦Ù…ÛŒ Ø¨Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Firestore (Ø§Ø² Ø·Ø±ÛŒÙ‚ Proxy) ***
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await saveDocToProxy(window.FIREBASE_DOC_PATH, { platform: platformData });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Successfully synced and persisted existing platform: ${platformData.storeHandle}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else if (res.status === 404) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`No existing platform found for UID ${firebaseUid}.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (force) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Swal.fire({ icon: 'info', title: 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯', text: 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ù…Ø§ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`Sync failed for UID ${firebaseUid}:`, data.error || data.message || 'Worker error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (force) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ', text: data.error || data.message || `Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø¯Ø± Worker (Status: ${res.status})` });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch(error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error during platform sync attempt:", error);
Â  Â  Â  Â  Â  Â  Â  Â  if (force) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡', text: 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ.' });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  if (syncButton) toggleLoading(syncButton, false, 'Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª (Refresh)');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Expose functions globally for use in HTML/scripts
Â  Â  Â  Â  window.setupDataListeners = setupDataListeners;
Â  Â  Â  Â  // Expose manual sync function
Â  Â  Â  Â  window.manualSync = () => trySyncExistingPlatform(window.state.user.uid, true);
Â  Â  </script>
Â  Â  <!-- END FIREBASE MODULES -->

	<style>
		:root{
			--bg-dark: #0f1724; /* deep navy */
			--card: rgba(255,255,255,0.03);
			--glass: rgba(255,255,255,0.06);
			--accent1: #00C6FF;
			--accent2: #0072FF;
			--muted: #9AA4B2;
			--text-light: #E6EEF5;
			--gold: #FFC857;
			--text-on-light: #1A202C; /* Dark text for popups */
Â  Â  Â  Â  Â  Â  --stage-width: 380px; /* Ú©Ø§Ù‡Ø´ Ø¹Ø±Ø¶ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
Â  Â  Â  Â  Â  Â  --nav-height: 60px; /* Ú©Ø§Ù‡Ø´ Ø§Ø±ØªÙØ§Ø¹ Ù†Ø§ÙˆØ¨Ø±ÛŒ */
		}

		html,body{height:100%;}
		body{
			font-family: 'Vazirmatn', sans-serif;
			/* Subtle radial glow in the background */
			background: radial-gradient(1200px 600px at 10% 20%, rgba(0,114,255,0.07), transparent),
						radial-gradient(1000px 500px at 90% 80%, rgba(0,198,255,0.03), transparent),
						var(--bg-dark);
			color:var(--text-light);
			-webkit-font-smoothing:antialiased;
			-moz-osx-font-smoothing:grayscale;
			padding-bottom: var(--nav-height); /* Space for the fixed bottom nav */
			display:flex;
			align-items:center;
			justify-content:center;
			overflow-x: hidden;Â 
			overflow-y: auto; /* Allow scrolling within the main view */
		}
Â  Â  Â  Â Â 
Â  Â  Â  Â  #app-container {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  max-width: 1200px;Â 
Â  Â  Â  Â  Â  Â  margin: auto;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Main View Container */
Â  Â  Â  Â  #main-view {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Stage containers for different views (onboarding, form, success) */
		.stage-container {
			position: absolute;
			display: flex;
			align-items: center;
			justify-content: center;
Â  Â  Â  Â  Â  Â  padding: 0.5rem; /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ Ø§Ø·Ø±Ø§Ù Ù…Ø­ØªÙˆØ§ */
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  height: 100%;
			transition: all 0.7s cubic-bezier(0.68, -0.55, 0.265, 1.55);Â 
			will-change: opacity, transform;
Â  Â  Â  Â  Â  Â  /* Ensures scrollable content inside if necessary */
Â  Â  Â  Â  Â  Â  overflow-y: auto;Â 
		}

		/* Stage States for Transition */
		.stage-active {
			opacity: 1;
			transform: scale(1);
			pointer-events: auto;
Â  Â  Â  Â  Â  Â  position: relative;
		}
		.stage-hidden {
			opacity: 0;
			transform: scale(0.95);
			pointer-events: none;
Â  Â  Â  Â  Â  Â  position: absolute;
		}
		.stage-exit {
			opacity: 0;
			transform: scale(0.85);Â 
			pointer-events: none;
		}
		.stage-enter {
			opacity: 1;
			transform: scale(1);
			pointer-events: auto;
			transition-delay: 0.1s;Â 
		}

Â  Â  Â  Â  /* Specific sizing for the initial Brand Stage */
Â  Â  Â  Â  #stage-onboarding .brand-card {
Â  Â  Â  Â  Â  Â  width: var(--stage-width);
Â  Â  Â  Â  Â  Â  max-width: 100%;
Â  Â  Â  Â  Â  Â  height: auto;Â 
Â  Â  Â  Â  Â  Â  min-height: 480px; /* Ú©Ø§Ù‡Ø´ Ø§Ø±ØªÙØ§Ø¹ Ù…ÛŒÙ†ÛŒÙ…Ù… */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* NOTE: .form-grid-container removed as per user request */

		/* left card (visual/brand) */
		.brand-card{
			background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
			border-radius:0.75rem; /* Ú©Ø§Ù‡Ø´ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
			padding:1rem; /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ */
			box-shadow: 0 8px 24px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
			position:relative;
			overflow:hidden;
			backdrop-filter: blur(6px) saturate(120%);
			border: 1px solid rgba(255,255,255,0.04);
			display:flex;
			flex-direction:column;
			gap:0.8rem; /* Ú©Ø§Ù‡Ø´ ÙØ§ØµÙ„Ù‡ Ø¯Ø§Ø®Ù„ÛŒ */
		}

		.brand-hero{
			display:flex;
			gap:0.8rem; /* Ú©Ø§Ù‡Ø´ ÙØ§ØµÙ„Ù‡ Ø¯Ø§Ø®Ù„ÛŒ */
			align-items:center;
		}
		.logo-circle{
			width:64px; height:64px; border-radius:16px; /* Ú©Ø§Ù‡Ø´ Ø§Ø¨Ø¹Ø§Ø¯ Ù„ÙˆÚ¯Ùˆ */
			background: linear-gradient(135deg,var(--accent1),var(--accent2));
			display:flex; align-items:center; justify-content:center;
			box-shadow: 0 8px 20px rgba(0,114,255,0.18);
			transform: rotate(-6deg);
		}
		.logo-circle svg{width:32px; height:32px; color:white} /* Ú©Ø§Ù‡Ø´ Ø§Ø¨Ø¹Ø§Ø¯ SVG */

		.brand-title{font-weight:700; font-size:1.3rem; letter-spacing:0.2px; color:var(--text-light)} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */
		.brand-sub{color:var(--muted); font-weight:500; margin-top:0.1rem; font-size:0.9rem} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */

		.stats{
			display:flex; gap:0.5rem; margin-top:auto; align-items:center; justify-content:space-between;
		}
		.stat-item{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:0.5rem 0.7rem; border-radius:0.6rem; border:1px solid rgba(255,255,255,0.02)} /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ */
		.stat-item .num{font-weight:700; font-size:1rem} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */
		.stat-item .lbl{font-size:0.75rem; color:var(--muted)} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */

		/* right card (form) */
		.form-card{
			background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
			border-radius:0.75rem; /* Ú©Ø§Ù‡Ø´ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
			padding:1rem; /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ */
			box-shadow: 0 8px 24px rgba(2,6,23,0.6);
			border:1px solid rgba(255,255,255,0.04);
			backdrop-filter: blur(6px);
Â  Â  Â  Â  Â  Â  width: var(--stage-width); /* Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø¹Ø±Ø¶ ÙØ±Ù… */
Â  Â  Â  Â  Â  Â  max-width: 100%;
		}
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Success Card Styling (Stage 3) and Profile/Dashboard Cards */
		.content-card {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 680px;Â 
Â  Â  Â  Â  Â  Â  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
Â  Â  Â  Â  Â  Â  border-radius:1rem; /* Ú©Ø§Ù‡Ø´ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
Â  Â  Â  Â  Â  Â  padding:1.5rem; /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ */
Â  Â  Â  Â  Â  Â  box-shadow: 0 15px 45px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.08);
Â  Â  Â  Â  Â  Â  border:1px solid rgba(255,255,255,0.06);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(8px);
Â  Â  Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  Â  Â  max-width: var(--stage-width); /* Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø­Ø¯Ø§Ú©Ø«Ø± Ø¹Ø±Ø¶ */
Â  Â  Â  Â  }

		.headline{display:flex; align-items:center; gap:0.6rem}
		.headline h1{font-size:1.3rem; font-weight:700; color:var(--text-light)} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */
		.headline p{color:var(--muted); margin:0; font-size:0.85rem} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */

		.glass-input{
			background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
			border:1px solid rgba(255,255,255,0.05);
			padding:0.6rem 0.8rem; border-radius:0.6rem; font-weight:500; color:var(--text-light); /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ Ùˆ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
			box-shadow: 0 4px 12px rgba(2,6,23,0.5);
			transition: all 0.18s ease;
Â  Â  Â  Â  Â  Â  font-size: 0.95rem; /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª ÙˆØ±ÙˆØ¯ÛŒ */
		}

		.form-label{font-weight:600; color:var(--muted); font-size:0.8rem} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */
		.hint{font-size:0.75rem; color:var(--muted)} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */

		.btn-cta{
			display:inline-flex; align-items:center; gap:0.5rem; justify-content:center;
			padding:0.7rem 1rem; border-radius:0.6rem; font-weight:700; cursor:pointer; /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ Ùˆ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
			background:linear-gradient(90deg,var(--accent2),var(--accent1)); color:#fff; border:none;
			box-shadow: 0 8px 20px rgba(0,114,255,0.25);
			transition: transform .18s ease, box-shadow .18s ease;
Â  Â  Â  Â  Â  Â  font-size: 1rem; /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª Ø¯Ú©Ù…Ù‡ */
		}
		.btn-cta:hover{transform:translateY(-3px); box-shadow: 0 12px 30px rgba(0,114,255,0.30)} /* Ú©Ø§Ù‡Ø´ Ù…ÛŒØ²Ø§Ù† Ø­Ø±Ú©Øª Ùˆ Ø³Ø§ÛŒÙ‡ */
		.btn-cta:disabled{
			opacity: 0.6;
			pointer-events: none;
			transform: translateY(0);
			box-shadow: none;
			/* REPLACED: Changed disabled background to match the initial state */
			background: linear-gradient(90deg, #374151, #4b5563);Â 
		}
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Custom button for copy action in the success page */
Â  Â  Â  Â  .btn-copy {
Â  Â  Â  Â  Â  Â  background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255,255,255,0.1);
Â  Â  Â  Â  Â  Â  color: var(--accent1);
Â  Â  Â  Â  Â  Â  padding: 0.4rem 0.7rem; /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ */
Â  Â  Â  Â  Â  Â  border-radius: 0.4rem; /* Ú©Ø§Ù‡Ø´ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
Â  Â  Â  Â  Â  Â  transition: all 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-copy:hover {
Â  Â  Â  Â  Â  Â  background: rgba(255,255,255,0.1);
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  }

		.muted-row{display:flex; gap:0.5rem; align-items:center; color:var(--muted); font-size:0.8rem} /* Ú©Ø§Ù‡Ø´ ÙØ§ØµÙ„Ù‡ Ùˆ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */

		/* tiny badges */
		.badge{padding:0.25rem 0.45rem; border-radius:999px; font-size:0.75rem; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03)} /* Ú©Ø§Ù‡Ø´ Ø§Ø¨Ø¹Ø§Ø¯ */

		/* helper for LTR inputs */
		.ltr{direction:ltr; text-align:left}

		/* small responsive tweaks */
		@media (max-width:920px){
			/* Removed .form-grid-container responsive settings */
			.brand-card{order:2}
			.form-card{order:1}
Â  Â  Â  Â  Â  Â  .stage-container {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 0.5rem;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  :root{
Â  Â  Â  Â  Â  Â  Â  Â  --stage-width: 100%;
Â  Â  Â  Â  Â  Â  }
		}

		/* subtle entrance animation for page 1 elements */
		.animate-fade-up{opacity:0; transform: translateY(12px); animation:fadeUp .6s ease forwards}
		.animate-fade-up.delay-1{animation-delay:0.08s}
		.animate-fade-up.delay-2{animation-delay:0.16s}
		.animate-fade-up.delay-3{animation-delay:0.24s}
		@keyframes fadeUp{to{opacity:1; transform:none}}

		/* input focus visual */
		input:focus, textarea:focus{outline:none; box-shadow:0 6px 20px rgba(0,114,255,0.12); border-color:var(--accent2)}

		/* footer */
		.small-foot{font-size:0.75rem; color:var(--muted)} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */

Â  Â  Â  Â  /* --- Navigation Bar Styling (New) --- */
Â  Â  Â  Â  #nav-bar {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  bottom: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  right: 0;
Â  Â  Â  Â  Â  Â  height: var(--nav-height);
Â  Â  Â  Â  Â  Â  background: rgba(15, 23, 36, 0.9); /* Dark semi-transparent */
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(12px);
Â  Â  Â  Â  Â  Â  border-top: 1px solid rgba(255, 255, 255, 0.08);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-around;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  padding: 0 0.5rem;
Â  Â  Â  Â  Â  Â  z-index: 50;
Â  Â  Â  Â  }

Â  Â  Â  Â  .nav-item {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  width: 25%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  color: var(--muted);
Â  Â  Â  Â  Â  Â  font-size: 0.65rem; /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª Ù†Ø§ÙˆØ¨Ø±ÛŒ */
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: color 0.2s ease, transform 0.2s ease;
Â  Â  Â  Â  }

Â  Â  Â  Â  .nav-item.active {
Â  Â  Â  Â  Â  Â  color: var(--accent1);
Â  Â  Â  Â  }

Â  Â  Â  Â  .nav-item i {
Â  Â  Â  Â  Â  Â  font-size: 1.1rem; /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² Ø¢ÛŒÚ©ÙˆÙ† Ù†Ø§ÙˆØ¨Ø±ÛŒ */
Â  Â  Â  Â  Â  Â  margin-bottom: 2px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* NEW: Profile specific styles */
Â  Â  Â  Â  .profile-pic-container {
Â  Â  Â  Â  Â  Â  width: 96px;Â 
Â  Â  Â  Â  Â  Â  height: 96px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  margin: 0 auto 1rem;
Â  Â  Â  Â  Â  Â  border: 4px solid var(--accent1);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 10px rgba(0, 114, 255, 0.3);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  font-size: 2.5rem;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, var(--accent2), var(--accent1));
Â  Â  Â  Â  }
Â  Â  Â  Â  .profile-pic-container img {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  object-fit: cover;
Â  Â  Â  Â  }
	</style>
</head>
<body>
	<main id="app-container">
Â  Â  Â  Â  <!-- Main content view container -->
Â  Â  Â  Â  <div id="main-view">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <!-- Stage 1: Onboarding/Brand Card (The initial view) -->
Â  Â  Â  Â  Â  Â  <div id="stage-onboarding" class="stage-container stage-active" data-view="home">
Â  Â  Â  Â  Â  Â  Â  Â  <!-- Content same as previous version for brand card... -->
Â  Â  Â  Â  Â  Â  Â  Â  <section class="brand-card animate-fade-up delay-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="brand-hero">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="logo-circle" aria-hidden>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h16v12a2 2 0 0 1-2 2h-5l-4 4v-4H6a2 2 0 0 1-2-2V4z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="brand-title">ØªÛŒÚ©Øª ØªÙ„</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="brand-sub">Ù¾Ù„ØªÙØ±Ù… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ â€” Ø³Ø±ÛŒØ¹ØŒ Ø§Ù…Ù† Ùˆ Ù‚Ø§Ø¨Ù„ ØªÙˆØ³Ø¹Ù‡</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="hint mt-4">Ø¨Ø§ Ø·Ø±Ø§Ø­ÛŒ ÙˆØ§Ú©Ù†Ø´â€ŒÚ¯Ø±Ø§ Ùˆ Ø§Ù…Ú©Ø§Ù†Ø§Øª API-firstØŒ ØªÛŒÚ©Øªâ€ŒØªÙ„ Ø¢Ù…Ø§Ø¯Ù‡ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù‡Ø± Ø³Ø±ÙˆÛŒØ³ Ùˆ Ø§Ø¨Ø²Ø§Ø± Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø´Ù…Ø§Ø³Øª. Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªÙ†Ù‡Ø§ Ø¨Ø§ Ú†Ù†Ø¯ Ú©Ù„ÛŒÚ©.</p>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top:0.8rem;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="muted-row" style="justify-content:space-between">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="badge">Enterprise Ready</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="badge">GDPR-friendly</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="badge">Webhooks & API</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats mt-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="num">120+</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="lbl">Ø´Ø±Ú©Øªâ€ŒÙ‡Ø§ÛŒ Ù…ØªØµÙ„</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="num">1M+</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="lbl">ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒØ´Ø¯Ù‡</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="num">99.9%</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="lbl">Ø¢Ù¾ØªØ§ÛŒÙ…</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top:1rem; display:flex; gap:0.6rem; align-items:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-cta flex-1" onclick="navigateTo('setup')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-play"></i> Ø´Ø±ÙˆØ¹ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾Ù„ØªÙØ±Ù…
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="small-foot">ÛŒØ§ Ø¨Ù‡ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="position:absolute; left:-80px; top:-40px; width:220px; height:220px; background:radial-gradient(circle at 30% 30%, rgba(0,198,255,0.07), transparent); filter:blur(42px); pointer-events:none"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="position:absolute; right:-60px; bottom:-50px; width:160px; height:160px; background:radial-gradient(circle at 70% 70%, rgba(255,200,87,0.04), transparent); filter:blur(36px); pointer-events:none"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </section>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <!-- Stage 2: Setup Form (Now single-column, centered) -->
Â  Â  Â  Â  Â  Â  <div id="stage-setup" class="stage-container stage-hidden" data-view="setup">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <!-- Right / Form card (Now taking center stage) -->
Â  Â  Â  Â  Â  Â  Â  Â  <section class="form-card"> <!-- Max width increased for better centered look -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="headline">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1>Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾Ù„ØªÙØ±Ù… Ø´Ù…Ø§</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="brand-sub">ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯ ØªØ§ Ù¾Ù„ØªÙØ±Ù… Ø´Ù…Ø§ Ø¸Ø±Ù Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ Ø³Ø§Ø®ØªÙ‡ Ø´ÙˆØ¯.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-left:auto; text-align:left">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="setup-form" class="mt-4 space-y-3"> <!-- Ú©Ø§Ù‡Ø´ ÙÙˆØ§ØµÙ„ Ø¨Ù‡ space-y-3 -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Form fields remain the same -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="store-handle" class="form-label">Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§ÛŒ Ù¾Ù„ØªÙØ±Ù… (Ø¯Ø± URL Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:0.6rem; align-items:center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="store-handle" class="glass-input ltr w-full" placeholder="Ù…Ø«Ø§Ù„: kafsh-store ÛŒØ§ my-mobile (Ø¨Ø¹Ø¯ Ø§Ø² Ø³Ø§Ø®Øª ØºÛŒØ±Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±)" pattern="[a-zA-Z0-9-]+" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="admin-chat-id" class="form-label">Ø´Ù†Ø§Ø³Ù‡ Ø¹Ø¯Ø¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… Ù…Ø¯ÛŒØ± (Admin Chat ID)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- NOTE: Prefill with Telegram ID if available -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="admin-chat-id" class="glass-input ltr w-full" placeholder="Ù…Ø«Ø§Ù„: 123456789" pattern="[0-9]+" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="user-bot-token" class="form-label">ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="user-bot-token" class="glass-input ltr w-full" placeholder="ØªÙˆÚ©Ù† Ø±Ø¨Ø§ØªÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ Ø¢Ù† Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·Ù†Ø¯" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="admin-bot-token" class="form-label">ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª Ø§Ø¯Ù…ÛŒÙ† (Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="admin-bot-token" class="glass-input ltr w-full" placeholder="ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:0.8rem; align-items:center; margin-top: 1.2rem !important;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Button is now immediately enabled by renderApp for unrestricted access -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="create-platform-btn" class="btn-cta flex-1" type="submit" disabled><i class="fas fa-spinner animate-spin"></i> Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="hint flex justify-between items-center" style="margin-top: 0.8rem !important;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="small-foot">Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú©Ù…Ú©ØŸ <a href="https://amirrezahoseinabadi.github.io/support" target="_blank" style="color:var(--accent1);">Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</a></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="muted-row">Ù†Ø³Ø®Ù‡ <strong style="margin-inline:6px; color:var(--gold)">1.0.0</strong></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Explicit back button added below the form -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Ø­Ø°Ù Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  </section>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <!-- Stage 3: Success Message (Hidden) -->
Â  Â  Â  Â  Â  Â  <div id="stage-success" class="stage-container stage-hidden" data-view="success">
Â  Â  Â  Â  Â  Â  Â  Â  <section id="success-card" class="content-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-white">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†ØªØ§ÛŒØ¬...</p>
Â  Â  Â  Â  Â  Â  Â  Â  </section>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <!-- Stage 4: Profile View (New) -->
Â  Â  Â  Â  Â  Â  <div id="stage-profile" class="stage-container stage-hidden" data-view="profile">
Â  Â  Â  Â  Â  Â  Â  Â  <section id="profile-card" class="content-card w-full max-w-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Profile content will be rendered here dynamically -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-white text-center">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„...</p>
Â  Â  Â  Â  Â  Â  Â  Â  </section>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <!-- Stage 5: Dashboard View (New) -->
Â  Â  Â  Â  Â  Â  <div id="stage-dashboard" class="stage-container stage-hidden" data-view="dashboard">
Â  Â  Â  Â  Â  Â  Â  Â  <section id="dashboard-card" class="content-card w-full max-w-xl">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-2xl font-extrabold text-white mb-6 border-b border-white/10 pb-3">ğŸ—‚ï¸ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù¾Ù„ØªÙØ±Ù…</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="gray-400 mb-4">Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ù„ÛŒ Ù¾Ù„ØªÙØ±Ù… Ø´Ù…Ø§ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="dashboard-status" class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Dynamic content will go here -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 rounded-lg flex justify-between items-center" style="background:rgba(255,255,255,0.05);"><span class="font-bold">ÙˆØ¶Ø¹ÛŒØª:</span> <span class="text-green-400">âœ… ÙØ¹Ø§Ù„</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 rounded-lg flex justify-between items-center" style="background:rgba(255,255,255,0.05);"><span class="font-bold">Ø´Ù†Ø§Ø³Ù‡ Ù¾Ù„ØªÙØ±Ù…:</span> <span id="dash-handle" class="ltr text-blue-400 font-mono">---</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- NEW: Add Sync/Refresh Button -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="sync-platform-btn" class="btn-cta text-sm w-full mt-6" onclick="window.manualSync()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-sync-alt"></i> Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª (Refresh)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-cta text-sm w-full mt-3" onclick="alert('TODO: Implement Admin Panel link/logic')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-cog"></i> ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </section>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div> <!-- end #main-view -->
	</main>
Â  Â Â 
Â  Â  <!-- Bottom Navigation Bar (New) -->
Â  Â  <nav id="nav-bar">
Â  Â  Â  Â  <div class="nav-item active" data-target="home" onclick="navigateTo('home')">
Â  Â  Â  Â  Â  Â  <i class="fas fa-home"></i>
Â  Â  Â  Â  Â  Â  <span>Ø®Ø§Ù†Ù‡</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="nav-item" data-target="dashboard" onclick="navigateTo('dashboard')">
Â  Â  Â  Â  Â  Â  <i class="fas fa-layer-group"></i>
Â  Â  Â  Â  Â  Â  <span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="nav-item" data-target="profile" onclick="navigateTo('profile')">
Â  Â  Â  Â  Â  Â  <i class="fas fa-user-circle"></i>
Â  Â  Â  Â  Â  Â  <span>Ù¾Ø±ÙˆÙØ§ÛŒÙ„</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="nav-item" data-target="settings" onclick="alert('TODO: Implement Settings View')">
Â  Â  Â  Â  Â  Â  <i class="fas fa-cogs"></i>
Â  Â  Â  Â  Â  Â  <span>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</span>
Â  Â  Â  Â  </div>
Â  Â  </nav>


	<script>
Â  Â  Â  Â  // Global state object
Â  Â  Â  Â  window.state = {
Â  Â  Â  Â  Â  Â  currentView: 'home',
Â  Â  Â  Â  Â  Â  // uid will be the Firebase UID after successful sign-in
Â  Â  Â  Â  Â  Â  user: { uid: 'guest', fullName: 'Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒÙ‡Ù…Ø§Ù†', username: 'Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒÙ‡Ù…Ø§Ù†', isAnonymous: true, isTelegramAuth: false, tgUserId: null, photo_url: null },Â 
Â  Â  Â  Â  Â  Â  platform: { storeHandle: null, adminBotUsername: null, userBotUsername: null }
Â  Â  Â  Â  };

Â  Â  Â  Â  const MANAGEMENT_WORKER_URL = "https://management-ticketing.amiruserbot7.workers.dev";
Â  Â  Â  Â  // NOTE: FIREBASE_DOC_PATH will be dynamically updated after successful auth
Â  Â  Â  Â  let FIREBASE_DOC_PATH = null;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  function enablePlatformCreationButton() {
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('create-platform-btn');
Â  Â  Â  Â  Â  Â  // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ùˆ ØªÙ†Ø¸ÛŒÙ… Ù…ØªÙ† Ø¢Ù† Ø¯Ø± Ù„ÙˆØ¯ Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ø³Øª.
Â  Â  Â  Â  Â  Â  if (btn) {
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerHTML = `<i class='fas fa-rocket'></i> Ø³Ø§Ø®Øª Ù¾Ù„ØªÙØ±Ù… Ø¬Ø¯ÛŒØ¯`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

		// Utility function to copy text to clipboard
		function copyToClipboard(elementId) {
			const copyText = document.getElementById(elementId);
			if (copyText) {
				copyText.select();
				document.execCommand('copy');
				const copyBtn = copyText.nextElementSibling;
				if (copyBtn) {
					copyBtn.innerHTML = '<i class="fas fa-check"></i>';
					Swal.fire({
						toast: true,
						position: 'top-end',
						icon: 'success',
						title: 'Ø¢Ø¯Ø±Ø³ Ú©Ù¾ÛŒ Ø´Ø¯',
						showConfirmButton: false,
						timer: 1500
					});
					setTimeout(() => {
						copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
					}, 2000);
				}
			}
		}
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Stage (View) Management Functions ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  function navigateTo(targetView) {
Â  Â  Â  Â  Â  Â  if (window.state.currentView === targetView) return;

Â  Â  Â  Â  Â  Â  const currentStage = document.querySelector(`.stage-container[data-view="${window.state.currentView}"]`);
Â  Â  Â  Â  Â  Â  const nextStage = document.querySelector(`.stage-container[data-view="${targetView}"]`);
Â  Â  Â  Â  Â  Â  const navItems = document.querySelectorAll('.nav-item');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!currentStage || !nextStage) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Invalid view transition:', window.state.currentView, '->', targetView);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Update navigation bar active class
Â  Â  Â  Â  Â  Â  navItems.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  item.classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  if (item.getAttribute('data-target') === targetView) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Render content for the target view before transition starts
Â  Â  Â  Â  Â  Â  if (targetView === 'profile') renderProfile();
Â  Â  Â  Â  Â  Â  if (targetView === 'dashboard') renderDashboard();

Â  Â  Â  Â  Â  Â  // 1. Start the exit animation for the current stage
Â  Â  Â  Â  Â  Â  currentStage.classList.remove('stage-active');
Â  Â  Â  Â  Â  Â  currentStage.classList.add('stage-exit');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 2. Schedule the enter animation for the next stage after a short delay
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  currentStage.classList.remove('stage-exit');
Â  Â  Â  Â  Â  Â  Â  Â  currentStage.classList.add('stage-hidden');Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  nextStage.classList.remove('stage-hidden');
Â  Â  Â  Â  Â  Â  Â  Â  nextStage.classList.add('stage-enter');
Â  Â  Â  Â  Â  Â  Â  Â  nextStage.classList.add('stage-active');
Â  Â  Â  Â  Â  Â  Â  Â  window.state.currentView = targetView;
Â  Â  Â  Â  Â  Â  }, 300);Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  nextStage.classList.remove('stage-enter');
Â  Â  Â  Â  Â  Â  }, 1000);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Renamed functions for clarity with new navigation system
Â  Â  Â  Â  const navigateToForm = () => navigateTo('setup');
Â  Â  Â  Â  const transitionToSuccess = () => navigateTo('success');


Â  Â  Â  Â  // --- Dynamic Rendering Functions (New) ---

Â  Â  Â  Â  function renderApp() {
Â  Â  Â  Â  Â  Â  // Initial render based on user authentication status
Â  Â  Â  Â  Â  Â  const currentStage = document.querySelector(`.stage-container[data-view="${window.state.currentView}"]`);
Â  Â  Â  Â  Â  Â  if (currentStage) {
Â  Â  Â  Â  Â  Â  Â  Â  // Ensure only the current view is active on load
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.stage-container').forEach(stage => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (stage !== currentStage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stage.classList.remove('stage-active', 'stage-enter', 'stage-exit');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stage.classList.add('stage-hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Prefill admin-chat-id if we have the Telegram ID
Â  Â  Â  Â  Â  Â  const adminChatIdInput = document.getElementById('admin-chat-id');
Â  Â  Â  Â  Â  Â  if (adminChatIdInput && window.state.user.tgUserId && !adminChatIdInput.value) {
Â  Â  Â  Â  Â  Â  Â  Â  adminChatIdInput.value = window.state.user.tgUserId;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // If the user has a platform handle, default to the Dashboard view
Â  Â  Â  Â  Â  Â  if (window.state.platform.storeHandle && window.state.currentView === 'home') {
Â  Â  Â  Â  Â  Â  Â  Â  Â navigateTo('dashboard');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â navigateTo(window.state.currentView); // Ensure home is active
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // *** ØªØºÛŒÛŒØ± Ø¬Ø¯ÛŒØ¯: ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ú©Ù…Ù‡ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø±Ø§ÛŒ Ø±ÙØ¹ Ù…Ø´Ú©Ù„ "Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„" ***
Â  Â  Â  Â  Â  Â  enablePlatformCreationButton();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function renderProfile() {
Â  Â  Â  Â  Â  Â  const profileCard = document.getElementById('profile-card');
Â  Â  Â  Â  Â  Â  const { user, platform } = window.state;
Â  Â  Â  Â  Â  Â  const uid = user.uid || '---';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 1. Determine display name
Â  Â  Â  Â  Â  Â  // NEW LOGIC: Always prioritize fullName (First Name + Last Name)
Â  Â  Â  Â  Â  Â  let displayUsername = user.fullName;
Â  Â  Â  Â  Â  Â  if (user.isAnonymous) {
Â  Â  Â  Â  Â  Â  Â  Â  Â displayUsername = 'Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒÙ‡Ù…Ø§Ù†';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 2. Determine the UID to display (Always show TG ID if available, otherwise Firebase UID)
Â  Â  Â  Â  Â  Â  const displayUID = user.tgUserId || user.uid || '---';
Â  Â  Â  Â  Â  Â  const displayUIDLabel = user.tgUserId ? 'Ø´Ù†Ø§Ø³Ù‡ Ø¹Ø¯Ø¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…' : 'Ø´Ù†Ø§Ø³Ù‡ ÙØ§ÛŒØ±Ø¨ÛŒØ³ (UID)';

Â  Â  Â  Â  Â  Â  // 3. Determine profile picture HTML
Â  Â  Â  Â  Â  Â  let profilePicHtml;
Â  Â  Â  Â  Â  Â  const fallbackLetter = (user.first_name || 'U').substring(0, 1).toUpperCase();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (user.photo_url) {
Â  Â  Â  Â  Â  Â  Â  Â  profilePicHtml = `<div class="profile-pic-container"><img src="${user.photo_url}" alt="Profile Avatar" onerror="this.onerror=null;this.style.display='none'; this.parentNode.innerHTML='${fallbackLetter}'"></div>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  profilePicHtml = `<div class="profile-pic-container">${fallbackLetter}</div>`;
Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  const status = platform.storeHandle ? 'Ù¾Ù„ØªÙØ±Ù… Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯Ù‡' : 'Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾Ù„ØªÙØ±Ù…';
Â  Â  Â  Â  Â  Â  const statusColor = platform.storeHandle ? 'text-green-400' : 'text-yellow-400';
Â  Â  Â  Â  Â  Â  const statusIcon = platform.storeHandle ? 'âœ…' : 'âš ï¸';
Â  Â  Â  Â  Â  Â  const platformHandleDisplay = platform.storeHandle ? `<span class="ltr font-mono text-base text-blue-400">${platform.storeHandle}</span>` : `<span class="text-red-400">---</span>`;
Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  profileCard.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${profilePicHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-extrabold text-white mt-2">${displayUsername}</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-400 mt-1">${displayUIDLabel}: ${displayUID}</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-3 pt-4 border-t border-white/10">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold text-white mb-3">ÙˆØ¶Ø¹ÛŒØª Ù¾Ù„ØªÙØ±Ù…</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center p-3 rounded-lg" style="background:rgba(255,255,255,0.05);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold text-gray-300">ÙˆØ¶Ø¹ÛŒØª:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-extrabold ${statusColor}">${statusIcon} ${status}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center p-3 rounded-lg" style="background:rgba(255,255,255,0.05);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold text-gray-300">Ø´Ù†Ø§Ø³Ù‡ Ù¾Ù„ØªÙØ±Ù…:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${platformHandleDisplay}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${platform.storeHandle ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center p-3 rounded-lg" style="background:rgba(255,255,255,0.05);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold text-gray-300">Ø±Ø¨Ø§Øª Ø§Ø¯Ù…ÛŒÙ†:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="https://t.me/${platform.adminBotUsername}" target="_blank" class="text-blue-400 font-mono ltr text-sm">@${platform.adminBotUsername}</a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-cta text-sm w-full mt-4" onclick="alert('TODO: Implement Admin Panel link/logic')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-cog"></i> ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-cta text-sm w-full mt-4" onclick="navigateTo('setup')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Ø´Ø±ÙˆØ¹ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾Ù„ØªÙØ±Ù…
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderDashboard() {
Â  Â  Â  Â  Â  Â  const dashboardCard = document.getElementById('dashboard-card');
Â  Â  Â  Â  Â  Â  const handleSpan = document.getElementById('dash-handle');
Â  Â  Â  Â  Â  Â  const statusDiv = document.getElementById('dashboard-status');
Â  Â  Â  Â  Â  Â  const { platform } = window.state;
Â  Â  Â  Â  Â  Â  // Get the sync button if it exists (for manual loading state reset)
Â  Â  Â  Â  Â  Â  const syncButton = document.getElementById('sync-platform-btn');
Â  Â  Â  Â  Â  Â  if (syncButton) {
Â  Â  Â  Â  Â  Â  Â  Â  // Ensure the sync button is restored to its non-loading state on re-render
Â  Â  Â  Â  Â  Â  Â  Â  toggleLoading(syncButton, false, 'Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª (Refresh)');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (platform.storeHandle) {
Â  Â  Â  Â  Â  Â  Â  Â  Â statusDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 rounded-lg flex justify-between items-center" style="background:rgba(255,255,255,0.05);"><span class="font-bold">ÙˆØ¶Ø¹ÛŒØª:</span> <span class="text-green-400">âœ… ÙØ¹Ø§Ù„</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 rounded-lg flex justify-between items-center" style="background:rgba(255,255,255,0.05);"><span class="font-bold">Ø´Ù†Ø§Ø³Ù‡ Ù¾Ù„ØªÙØ±Ù…:</span> <span id="dash-handle" class="ltr text-blue-400 font-mono">${platform.storeHandle}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 rounded-lg flex justify-between items-center" style="background:rgba(255,255,255,0.05);"><span class="font-bold">Ø±Ø¨Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:</span> <span class="ltr text-yellow-400 font-mono">@${platform.userBotUsername}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â statusDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-red-400 p-4 rounded-lg" style="background:rgba(255,0,0,0.1);">â›” Ù¾Ù„ØªÙØ±Ù…ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-cta text-sm w-full mt-4" onclick="navigateTo('setup')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Ø´Ø±ÙˆØ¹ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾Ù„ØªÙØ±Ù…
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

		// *** ØªØ§Ø¨Ø¹ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡: Ø§ÙØ²ÙˆØ¯Ù† Ù…Ú©Ø§Ù†ÛŒØ²Ù… Ø§Ù†ØªØ¸Ø§Ø± (Polling) Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨ÙˆØ¯Ù† Firebase Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Proxy ***
		function finishSetup(result, retries = 0){
Â  Â  Â  Â  Â  Â  // Ø§Ú¯Ø± Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ ØªÙ„Ø§Ø´ Ú©Ø±Ø¯ Ùˆ Ù‡Ù†ÙˆØ² Firebase Ø¢Ù…Ø§Ø¯Ù‡ Ù†Ø¨ÙˆØ¯ØŒ Ù…ØªÙˆÙ‚Ù Ú©Ù†
Â  Â  Â  Â  Â  Â  if (retries > 10) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Firebase readiness timeout reached.");
Â  Â  Â  Â  Â  Â  Â  Â  Â Swal.fire({icon:'error', title:'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡', text:'Ù¾Ù„ØªÙØ±Ù… Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯ØŒ Ø§Ù…Ø§ Ø§ØªØµØ§Ù„ ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Mini App Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.'});
Â  Â  Â  Â  Â  Â  Â  Â  Â showSuccess(result);
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø±Ø· Ø§ØµÙ„ÛŒ: Ø¢ÛŒØ§ Ù‡Ù…Ù‡ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Auth Ùˆ Ù…Ø³ÛŒØ± Ø³Ù†Ø¯ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù†Ø¯ØŸ
Â  Â  Â  Â  Â  Â  if (!window.auth || !window.FIREBASE_DOC_PATH || !window.auth.currentUser) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â // Ø§Ú¯Ø± Ø¢Ù…Ø§Ø¯Ù‡ Ù†Ø¨ÙˆØ¯ØŒ 200 Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø± Ú©Ù† Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù† (Polling)
Â  Â  Â  Â  Â  Â  Â  Â  Â console.warn(`Firebase services not yet available (Retry ${retries}). Waiting...`);
Â  Â  Â  Â  Â  Â  Â  Â  Â setTimeout(() => finishSetup(result, retries + 1), 200);
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- Ø§Ú¯Ø± Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¢Ù…Ø§Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡ ---
Â  Â  Â  Â  Â  Â  console.log("Firebase services are ready. Proceeding to save platform data via Proxy.");

Â  Â  Â  Â  Â  Â  // Save platform details to user's private profile document
Â  Â  Â  Â  Â  Â  const dataToSave = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  platform: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  storeHandle: result.storeHandle,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  adminBotUsername: result.adminBotUsername,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userBotUsername: result.userBotUsername,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setupDate: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // *** Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² saveDocToProxy Ø¨Ù‡ Ø¬Ø§ÛŒ setDoc Firestore ***
Â  Â  Â  Â  Â  Â  window.saveDocToProxy(window.FIREBASE_DOC_PATH, dataToSave)
Â  Â  Â  Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Platform details saved to Proxy profile.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Update state to trigger rendering of profile/dashboard
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.state.platform = dataToSave.platform;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showSuccess(result);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderDashboard(); // Explicit render after successful setup save
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error saving platform details via Proxy:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø­ØªÛŒ Ø§Ú¯Ø± Ù¾Ù„ØªÙØ±Ù… Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Swal.fire({icon:'error', title:'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡', text:`Ù¾Ù„ØªÙØ±Ù… Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯ØŒ Ø§Ù…Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ù† Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø´Ù…Ø§ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯: ${error.message}`});
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showSuccess(result);Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
		}


		function showSuccess(result){
			const { adminBotUsername, userBotUsername, storeHandle } = result || {};
			const MINI_APP_BASE_URL = "https://amirrezahoseinabadi.github.io/ticketing-frontend/index.html";
			const miniAppUrl = `${MINI_APP_BASE_URL}?storeHandle=${storeHandle}`;
			const successCard = document.getElementById('success-card');

			successCard.innerHTML = `
				<div class="flex items-center justify-end gap-3 text-white mb-6">
					<i class="fas fa-check-circle text-4xl" style="color:var(--accent1);"></i>
					<h1 class="text-3xl font-extrabold">ğŸ‰ Ù¾Ù„ØªÙØ±Ù… Ø´Ù…Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª</h1>
				</div>
				<p class="font-bold text-xl mb-6 text-white/90 border-b border-white/10 pb-3">Ú¯Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ</p>
				
				<ol class="space-y-6">
					<li class="p-4 rounded-xl" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08);">
						<span class="font-bold text-white text-base block mb-2">Û±. ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Mini App:</span>
						<p class="text-sm text-gray-300 mb-2">Ø¢Ø¯Ø±Ø³ Ø²ÛŒØ± Ø±Ø§ Ø¯Ø± BotFather (ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø¨Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†) Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Web App URL Ø«Ø¨Øª Ú©Ù†ÛŒØ¯:</p>
						<div class="relative">
							<input id="mini-app-url-input" class="glass-input ltr w-full text-base" style="font-family:monospace; padding-left: 3.5rem; background:rgba(0,0,0,0.1); border-color: rgba(255,255,255,0.1);" readonly value="${miniAppUrl}">
							<button onclick="copyToClipboard('mini-app-url-input')" class="absolute left-2 top-1/2 -translate-y-1/2 btn-copy" title="Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ø¢Ø¯Ø±Ø³">
								<i class="fas fa-copy"></i>
							</button>
						</div>
					</li>
					<li class="p-4 rounded-xl" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08);">
						<span class="font-bold text-white text-base block mb-2">Û². ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø±Ø¨Ø§Øª Ø§Ø¯Ù…ÛŒÙ†:</span>
						<p class="text-sm text-gray-300">
							Ø±Ø¨Ø§Øª Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§ (
							<a href="https://t.me/${adminBotUsername}" target="_blank" class="text-blue-400 font-bold hover:text-blue-300 transition-colors">@${adminBotUsername}</a>Â 
							) Ø±Ø§ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯Ø³ØªÙˆØ± <code>/start</code> Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ ØªØ§ Ø§Ø¹Ù„Ø§Ù†Ø§Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ ÙØ¹Ø§Ù„ Ø´ÙˆÙ†Ø¯.
						</p>
					</li>
				</ol>

				<div class="mt-10 pt-6 border-t border-white/10 flex flex-col items-center">
					<button id="finish-setup-btn" class="btn-cta text-lg w-full max-w-xs" onclick="navigateTo('dashboard')">
						ØªÚ©Ù…ÛŒÙ„ Ùˆ Ø±ÙØªÙ† Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
					</button>
				</div>
			`;
			
			transitionToSuccess();
		}
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- API & Form Logic (Modified) ---

		document.getElementById('setup-form').addEventListener('submit', async (e)=>{
			e.preventDefault();
			const btn = document.getElementById('create-platform-btn');
			const storeHandleInput = document.getElementById('store-handle');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Basic validation
			if(!storeHandleInput.value.trim() || !document.getElementById('admin-chat-id').value.trim() || !document.getElementById('user-bot-token').value.trim() || !document.getElementById('admin-bot-token').value.trim()){
				Swal.fire({icon:'error', title:'Ø®Ø·Ø§', text:'Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯.'});
				return;
			}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // NEW: Ensure Firebase UID is available for the Worker
Â  Â  Â  Â  Â  Â  if (!window.state.user.uid || window.state.user.uid === 'guest') {
Â  Â  Â  Â  Â  Â  Â  Â  Swal.fire({icon:'error', title:'Ø®Ø·Ø§', text:'Ù„Ø·ÙØ§Ù‹ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯ ØªØ§ Ø§ØªØµØ§Ù„ Ø§Ù…Ù† (Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ÙØ§ÛŒØ±Ø¨ÛŒØ³) Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´ÙˆØ¯.'});
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

			// START LOADING: ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¯Ú©Ù…Ù‡ Ø¨Ù‡ Ù„ÙˆØ¯ÛŒÙ†Ú¯
			toggleLoading(btn, true, 'Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ù¾Ù„ØªÙØ±Ù…...');

			const payload = {
				storeHandle: storeHandleInput.value.trim().toLowerCase(),
				adminChatId: document.getElementById('admin-chat-id').value.trim(),
				userBotToken: document.getElementById('user-bot-token').value.trim(),
				adminBotToken: document.getElementById('admin-bot-token').value.trim(),
				miniAppUrl: `https://amirrezahoseinabadi.github.io/ticketing-frontend/index.html?storeHandle=${storeHandleInput.value.trim().toLowerCase()}`,
Â  Â  Â  Â  Â  Â  Â  Â  // ADDING FIREBASE UID
Â  Â  Â  Â  Â  Â  Â  Â  firebaseUid: window.state.user.uid
			};


			let isSuccess = false;
			try{
				// Ø§ÛŒÙ† ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø§Ø² Worker Ø§Ø³Øª Ú©Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ (Realtime DB) Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯
				const res = await fetch(`${MANAGEMENT_WORKER_URL}/setup`,{
					method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
				});
				
Â  Â  Â  Â  Â  Â  Â  Â  // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù…Ù† Ø®ÙˆØ§Ù†Ø¯Ù† JSON Ùˆ Ø®Ø·Ø§Ù‡Ø§ ---
Â  Â  Â  Â  Â  Â  Â  Â  let data = {};
Â  Â  Â  Â  Â  Â  Â  Â  const resText = await res.text(); // Ø§ÙˆÙ„ Ù…ØªÙ† Ø®Ø§Ù… Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†ÛŒÙ…
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data = JSON.parse(resText);
Â  Â  Â  Â  Â  Â  Â  Â  } catch (jsonError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ø§Ú¯Ø± Worker Ù¾Ø§Ø³Ø® ØºÛŒØ± JSON Ø¯Ø§Ø¯ (Ù…Ø«Ù„Ø§Ù‹ Ø®Ø·Ø§ÛŒ 500 Ø¨Ø¯ÙˆÙ† Ø¨Ø¯Ù†Ù‡ Ù…Ù†Ø§Ø³Ø¨)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±: ${res.status}. Ù¾Ø§Ø³Ø® Ù†Ø§Ù…ÙÙ‡ÙˆÙ…. Ú©Ù†Ø³ÙˆÙ„ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // --- Ù¾Ø§ÛŒØ§Ù† Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù…Ù† Ø®ÙˆØ§Ù†Ø¯Ù† JSON ---

Â  Â  Â  Â  Â  Â  Â  Â  // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø§Ø³Ø® Worker (ÙˆØ§Ø³Ø·)
				if(!res.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ø§Ú¯Ø± Ø®Ø·Ø§ 409 (Conflict) Ø¨ÙˆØ¯ØŒ ÛŒØ¹Ù†ÛŒ Ø´Ù†Ø§Ø³Ù‡ ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø³Øª.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (res.status === 409) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Ø´Ù†Ø§Ø³Ù‡ Ù¾Ù„ØªÙØ±Ù… (${payload.storeHandle}) Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø´Ù†Ø§Ø³Ù‡ Ø¯ÛŒÚ¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ø¨Ø±Ø§ÛŒ Ø³Ø§ÛŒØ± Ø®Ø·Ø§Ù‡Ø§
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorMessage = data.error || `Ø®Ø·Ø§ Ø¯Ø± Worker (${res.status}). Ú©Ù†Ø³ÙˆÙ„ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(errorMessage);
Â  Â  Â  Â  Â  Â  Â  Â  }

				// finishSetup: Ù¾Ù„ØªÙØ±Ù… Ø±Ø§ Ø¯Ø± Ø³Ù†Ø¯ Profile Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Firestore (Ø§Ø² Ø·Ø±ÛŒÙ‚ Proxy) Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
				finishSetup(data.data);Â 
				isSuccess = true;

			}catch(err){
				// Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§
				Swal.fire({icon:'error', title:'Ø¹Ù…Ù„ÛŒØ§Øª Ù†Ø§Ù…ÙˆÙÙ‚', text: err.message || err.toString()});
			}finally{
				// Ø¯Ø± Ù‡Ø± ØµÙˆØ±Øª Ø¯Ú©Ù…Ù‡ Ø±Ø§ Ø¢Ø²Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
Â  Â  Â  Â  Â  Â  Â  Â  toggleLoading(btn,false,'Ø³Ø§Ø®Øª Ù¾Ù„ØªÙØ±Ù… Ø¬Ø¯ÛŒØ¯');
			}
		});

		function toggleLoading(button, isLoading, text){
			if(isLoading){
				button.disabled=true;
				// SVG Ø¨Ø±Ø§ÛŒ Spinner (Ù„ÙˆØ¯ÛŒÙ†Ú¯)
				button.innerHTML = `<svg class='animate-spin' style='width:18px;height:18px' viewBox='0 0 24 24'><circle class='opacity-25' cx='12' cy='12' r='10' stroke='currentColor' stroke-width='4' fill='none'></circle><path class='opacity-75' fill='currentColor' d='M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z'></path></svg> ${text}`;
			} else {
				button.disabled=false;
				// Ø¢ÛŒÚ©ÙˆÙ† Ø§ØµÙ„ÛŒ Ø¯Ú©Ù…Ù‡
				button.innerHTML = `<i class='fas fa-rocket'></i> ${text}`;
			}
		}

Â  Â  Â  Â  // Initialize App View
Â  Â  Â  Â  window.addEventListener('load', renderApp);

	</script>
</body>
</html>

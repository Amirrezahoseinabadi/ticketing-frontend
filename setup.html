<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>تیکت تل — راه‌اندازی و پروفایل</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
	<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- تلگرام Mini App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- FIREBASE MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Export doc and setDoc to window for use in non-module scripts
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose necessary Firestore functions globally
        window.doc = doc;
        window.setDoc = setDoc;
        
        // Flag to track authentication readiness status
        window.isAuthReady = false; 

        // Log setup
        // setLogLevel('debug'); // Uncomment for debugging Firestore logs

        // Global variables injected by Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // تعیین اطلاعات اولیه کاربر از تلگرام (اگر Mini App باشد)
        function getTelegramUserInfo() {
            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
                return {
                    uid: tgUser.id ? tgUser.id.toString() : null, // ID تلگرام را به عنوان UID اولیه در نظر میگیریم
                    username: tgUser.username || tgUser.first_name,
                    first_name: tgUser.first_name,
                    isAnonymous: false,
                    isTelegramAuth: true,
                    tgUserId: tgUser.id.toString()
                };
            }
            return {
                uid: null, // Initial UID should be null until Firebase is ready
                username: 'کاربر میهمان',
                isAnonymous: true,
                isTelegramAuth: false,
                tgUserId: null
            };
        }
        
        // تنظیم اطلاعات اولیه کاربر
        const initialTgInfo = getTelegramUserInfo();
        window.state.user = { ...window.state.user, ...initialTgInfo };
        if (initialTgInfo.uid) {
            // اگر از تلگرام UID داریم، از آن به عنوان پیش‌فرض استفاده می‌کنیم
            window.state.user.uid = initialTgInfo.uid;
            window.FIREBASE_DOC_PATH = `artifacts/${appId}/users/${initialTgInfo.uid}/profile/main`;
        }

        if (firebaseConfig) {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);

            // Auth listener and custom token sign-in
            onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    // بروزرسانی UID و نام کاربری با داده‌های فایربیس (معمولاً anonymous یا token-based)
                    window.state.user = { 
                        ...window.state.user, 
                        uid: user.uid, 
                        isAnonymous: user.isAnonymous
                    };
                    
                    // اگر احراز هویت Mini App نبود، نام کاربری را از ایمیل یا حالت پیش‌فرض می‌گیرد.
                    if (!window.state.user.isTelegramAuth) {
                        window.state.user.username = user.email ? user.email.split('@')[0] : 'کاربر مهمان';
                    }
                    
                    // تنظیم مسیر Firestore بر اساس UID واقعی Firebase
                    const actualUserId = user.uid;
                    window.FIREBASE_DOC_PATH = `artifacts/${appId}/users/${actualUserId}/profile/main`;
                    
                    // Fetch user-specific and public platform data
                    setupDataListeners(actualUserId);
                    
                    // --- تنظیم پرچم آماده بودن احراز هویت ---
                    window.isAuthReady = true;
                    
                    // Update UI to show authenticated content
                    renderApp(); 
                } else {
                    // تلاش برای ورود با توکن Canvas یا ورود ناشناس
                    if (initialAuthToken) {
                        signInWithCustomToken(window.auth, initialAuthToken).catch(error => {
                            console.error("Custom token sign-in failed:", error);
                            signInAnonymously(window.auth).catch(console.error);
                        });
                    } else {
                        signInAnonymously(window.auth).catch(console.error);
                    }
                }
            });
        }
        
        function setupDataListeners(uid) {
            // 1. Listen to the user's private document (for profile data, e.g., display name)
            const userDocRef = doc(window.db, `artifacts/${appId}/users/${uid}/profile/main`);
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Update state with platform data if available
                    const data = docSnap.data();
                    window.state.user = { ...window.state.user, ...data };
                    if (data.platform) {
                        window.state.platform = data.platform;
                    }
                }
                renderProfile(); // Rerender profile on data change
            });

            // 2. Try to sync if the user has an existing platform that wasn't found in their profile
            // این تابع به محض آماده شدن احراز هویت فایربیس، اجرا می‌شود
            if (window.state.user.isTelegramAuth && !window.state.platform.storeHandle) {
                trySyncExistingPlatform(uid);
            }
        }

        /**
         * NEW FUNCTION: Searches the worker's Realtime Database for a store linked to the admin's Telegram ID.
         */
        async function trySyncExistingPlatform(firebaseUid) {
            const { tgUserId } = window.state.user;
            // اگر شناسه تلگرام در دسترس نبود یا پلتفرم قبلاً پیدا شده بود، برگرد.
            if (!tgUserId || window.state.platform.storeHandle) return; 

            // آدرس Worker اصلی که حالا شامل منطق sync است
            // (باید Worker management-ticketing.js در این آدرس باشد)
            const SYNC_WORKER_URL = "https://management-ticketing.amiruserbot7.workers.dev";

            // یک مکانیزم انتظار ساده برای مطمئن شدن از اینکه UID فایربیس ست شده است.
            if (!firebaseUid || firebaseUid === 'guest') {
                setTimeout(() => trySyncExistingPlatform(window.state.user.uid), 500);
                return;
            }

            try {
                const payload = {
                    adminChatId: tgUserId,
                    firebaseUid: firebaseUid,
                    appId: appId 
                };

                const res = await fetch(`${SYNC_WORKER_URL}/sync-store-by-admin-id`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await res.json();

                if (res.status === 200 && data.success && data.data) {
                    // Store found! Save it to the current user's Firestore profile
                    const platformData = data.data;
                    const userDocRef = doc(window.db, window.FIREBASE_DOC_PATH);
                    
                    // Update the user's Firestore profile with the found platform data
                    // onSnapshot به صورت خودکار UI را پس از این به‌روزرسانی می‌کند.
                    await setDoc(userDocRef, { platform: platformData }, { merge: true });
                    
                    console.log(`Successfully synced existing platform: ${platformData.storeHandle}`);
                    
                } else if (res.status !== 404) {
                    console.warn(`Sync failed for tgUserId ${tgUserId}:`, data.error || data.message || 'Worker error');
                }

            } catch(error) {
                console.error("Error during platform sync attempt:", error);
            }
        }
        
        /**
         * MANUAL RECOVERY FUNCTION: Searches RTDB by StoreHandle and verifies with tgUserId.
         */
        async function recoverPlatform(storeHandle) {
            const btn = document.getElementById('recover-btn');
            toggleLoading(btn, true, 'در حال بازیابی...');
            
            const { tgUserId, uid } = window.state.user;
            
            if (!tgUserId) {
                Swal.fire({icon:'warning', title:'خطا', text:'لطفاً از طریق Mini App تلگرام وارد شوید تا شناسه شما مشخص شود.'});
                toggleLoading(btn, false, 'بازیابی پلتفرم');
                return;
            }
            
            // Endpoint جدید برای بازیابی دستی بر اساس Handle و AdminId
            const RECOVERY_WORKER_URL = `${MANAGEMENT_WORKER_URL}/recover-store-by-handle`;
            
            try {
                const payload = {
                    storeHandle: storeHandle.toLowerCase().trim(),
                    adminChatId: tgUserId,
                    firebaseUid: uid,
                    appId: appId
                };

                const res = await fetch(RECOVERY_WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (res.status === 200 && data.success && data.data) {
                    // Store found and verified! Save it to Firestore.
                    const platformData = data.data;
                    const userDocRef = doc(window.db, window.FIREBASE_DOC_PATH);
                    await setDoc(userDocRef, { platform: platformData }, { merge: true });
                    
                    Swal.fire({icon:'success', title:'موفقیت!', text:`پلتفرم ${storeHandle} با موفقیت به پروفایل شما متصل شد.`});
                    
                    // Close modal and navigate to dashboard
                    closeModal('recovery-modal');
                    navigateTo('dashboard');
                    
                } else if (res.status === 404) {
                    throw new Error('پلتفرم مورد نظر یافت نشد یا شناسه تلگرام شما با سازنده آن مطابقت ندارد.');
                } else {
                    throw new Error(data.error || 'خطایی نامشخص در هنگام بازیابی رخ داد.');
                }

            } catch(error) {
                Swal.fire({icon:'error', title:'خطا در بازیابی', text: error.message || error.toString()});
            } finally {
                // دکمه را به حالت عادی برگردان
                toggleLoading(document.getElementById('recover-btn'), false, '<i class="fas fa-undo-alt"></i> بازیابی پلتفرم');
            }
        }


        // Expose functions globally for use in HTML/scripts
        window.setupDataListeners = setupDataListeners;
        window.recoverPlatform = recoverPlatform; // Expose the new function
    </script>
    <!-- END FIREBASE MODULES -->

	<style>
		:root{
			--bg-dark: #0f1724; /* deep navy */
			--card: rgba(255,255,255,0.03);
			--glass: rgba(255,255,255,0.06);
			--accent1: #00C6FF;
			--accent2: #0072FF;
			--muted: #9AA4B2;
			--text-light: #E6EEF5;
			--gold: #FFC857;
			--text-on-light: #1A202C; /* Dark text for popups */
            --stage-width: 420px; /* Width of the single-column view */
            --nav-height: 70px; /* Height of the navigation bar */
		}

		html,body{height:100%;}
		body{
			font-family: 'Vazirmatn', sans-serif;
			/* Subtle radial glow in the background */
			background: radial-gradient(1200px 600px at 10% 20%, rgba(0,114,255,0.07), transparent),
						radial-gradient(1000px 500px at 90% 80%, rgba(0,198,255,0.03), transparent),
						var(--bg-dark);
			color:var(--text-light);
			-webkit-font-smoothing:antialiased;
			-moz-osx-font-smoothing:grayscale;
			padding-bottom: var(--nav-height); /* Space for the fixed bottom nav */
			display:flex;
			align-items:center;
			justify-content:center;
			overflow-x: hidden; 
			overflow-y: auto; /* Allow scrolling within the main view */
		}
        
        #app-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            max-width: 1200px; 
            margin: auto;
        }
        
        /* Main View Container */
        #main-view {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* Stage containers for different views (onboarding, form, success) */
		.stage-container {
			position: absolute;
			display: flex;
			align-items: center;
			justify-content: center;
            padding: 1rem;
            width: 100%; 
            height: 100%;
			transition: all 0.7s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
			will-change: opacity, transform;
            /* Ensures scrollable content inside if necessary */
            overflow-y: auto; 
		}

		/* Stage States for Transition */
		.stage-active {
			opacity: 1;
			transform: scale(1);
			pointer-events: auto;
            position: relative;
		}
		.stage-hidden {
			opacity: 0;
			transform: scale(0.95);
			pointer-events: none;
            position: absolute;
		}
		.stage-exit {
			opacity: 0;
			transform: scale(0.85); 
			pointer-events: none;
		}
		.stage-enter {
			opacity: 1;
			transform: scale(1);
			pointer-events: auto;
			transition-delay: 0.1s; 
		}

        /* Specific sizing for the initial Brand Stage */
        #stage-onboarding .brand-card {
            width: var(--stage-width);
            max-width: 100%;
            height: auto; 
            min-height: 500px;
        }
        
        /* NOTE: .form-grid-container removed as per user request */

		/* left card (visual/brand) */
		.brand-card{
			background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
			border-radius:1rem;
			padding:1.6rem;
			box-shadow: 0 10px 30px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
			position:relative;
			overflow:hidden;
			backdrop-filter: blur(6px) saturate(120%);
			border: 1px solid rgba(255,255,255,0.04);
			display:flex;
			flex-direction:column;
			gap:1rem;
		}

		.brand-hero{
			display:flex;
			gap:1rem;
			align-items:center;
		}
		.logo-circle{
			width:72px; height:72px; border-radius:18px;
			background: linear-gradient(135deg,var(--accent1),var(--accent2));
			display:flex; align-items:center; justify-content:center;
			box-shadow: 0 10px 30px rgba(0,114,255,0.18);
			transform: rotate(-6deg);
		}
		.logo-circle svg{width:36px; height:36px; color:white}

		.brand-title{font-weight:800; font-size:1.45rem; letter-spacing:0.2px; color:var(--text-light)}
		.brand-sub{color:var(--muted); font-weight:500; margin-top:0.1rem}

		.stats{
			display:flex; gap:0.6rem; margin-top:auto; align-items:center; justify-content:space-between;
		}
		.stat-item{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:0.7rem 0.9rem; border-radius:0.8rem; border:1px solid rgba(255,255,255,0.02)}
		.stat-item .num{font-weight:700; font-size:1.1rem}
		.stat-item .lbl{font-size:0.8rem; color:var(--muted)}

		/* right card (form) */
		.form-card{
			background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
			border-radius:1rem;
			padding:1.6rem;
			box-shadow: 0 10px 30px rgba(2,6,23,0.6);
			border:1px solid rgba(255,255,255,0.04);
			backdrop-filter: blur(6px);
		}
        
        /* Success Card Styling (Stage 3) and Profile/Dashboard Cards */
		.content-card {
            width: 100%;
            max-width: 680px; 
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border-radius:1.5rem; 
            padding:2.5rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.08);
            border:1px solid rgba(255,255,255,0.06);
            backdrop-filter: blur(8px);
            text-align: right;
        }
        
        /* --- Modal Styling --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: visibility 0.3s, opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-dark);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* --- End Modal Styling --- */


		.headline{display:flex; align-items:center; gap:0.8rem}
		.headline h1{font-size:1.45rem; font-weight:800; color:var(--text-light)}
		.headline p{color:var(--muted); margin:0}

		.glass-input{
			background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
			border:1px solid rgba(255,255,255,0.05);
			padding:0.75rem 1rem; border-radius:0.7rem; font-weight:600; color:var(--text-light);
			box-shadow: 0 6px 16px rgba(2,6,23,0.5);
			transition: all 0.18s ease;
		}

		.form-label{font-weight:700; color:var(--muted); font-size:0.85rem}
		.hint{font-size:0.83rem; color:var(--muted)}

		.btn-cta{
			display:inline-flex; align-items:center; gap:0.6rem; justify-content:center;
			padding:0.85rem 1.1rem; border-radius:0.75rem; font-weight:800; cursor:pointer;
			background:linear-gradient(90deg,var(--accent2),var(--accent1)); color:#fff; border:none;
			box-shadow: 0 12px 30px rgba(0,114,255,0.25);
			transition: transform .18s ease, box-shadow .18s ease;
		}
		.btn-cta:hover{transform:translateY(-4px); box-shadow: 0 18px 45px rgba(0,114,255,0.30)}
		.btn-cta:disabled{
			opacity: 0.6;
			pointer-events: none;
			transform: translateY(0);
			box-shadow: none;
			/* REPLACED: Changed disabled background to match the initial state */
			background: linear-gradient(90deg, #374151, #4b5563); 
		}
        
        /* Custom button for copy action in the success page */
        .btn-copy {
            background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--accent1);
            padding: 0.5rem 0.8rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .btn-copy:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-light);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--text-light);
            padding: 0.85rem 1.1rem; 
            border-radius: 0.75rem; 
            font-weight: 700;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s ease;
        }
        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }

		.muted-row{display:flex; gap:0.6rem; align-items:center; color:var(--muted); font-size:0.9rem}

		/* tiny badges */
		.badge{padding:0.3rem 0.55rem; border-radius:999px; font-size:0.78rem; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03)}

		/* helper for LTR inputs */
		.ltr{direction:ltr; text-align:left}

		/* small responsive tweaks */
		@media (max-width:920px){
			/* Removed .form-grid-container responsive settings */
			.brand-card{order:2}
			.form-card{order:1}
            .stage-container {
                padding: 1rem; 
            }
            :root{
                --stage-width: 100%;
            }
		}

		/* subtle entrance animation for page 1 elements */
		.animate-fade-up{opacity:0; transform: translateY(12px); animation:fadeUp .6s ease forwards}
		.animate-fade-up.delay-1{animation-delay:0.08s}
		.animate-fade-up.delay-2{animation-delay:0.16s}
		.animate-fade-up.delay-3{animation-delay:0.24s}
		@keyframes fadeUp{to{opacity:1; transform:none}}

		/* input focus visual */
		input:focus, textarea:focus{outline:none; box-shadow:0 6px 20px rgba(0,114,255,0.12); border-color:var(--accent2)}

		/* footer */
		.small-foot{font-size:0.82rem; color:var(--muted)}

        /* --- Navigation Bar Styling (New) --- */
        #nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: rgba(15, 23, 36, 0.9); /* Dark semi-transparent */
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 0.5rem;
            z-index: 50;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 25%;
            height: 100%;
            color: var(--muted);
            font-size: 0.7rem;
            font-weight: 700;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .nav-item.active {
            color: var(--accent1);
        }

        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }
	</style>
</head>
<body>
	<main id="app-container">
        <!-- Main content view container -->
        <div id="main-view">
            
            <!-- Stage 1: Onboarding/Brand Card (The initial view) -->
            <div id="stage-onboarding" class="stage-container stage-active" data-view="home">
                <!-- Content same as previous version for brand card... -->
                <section class="brand-card animate-fade-up delay-1">
                    <div class="brand-hero">
                        <div class="logo-circle" aria-hidden>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h16v12a2 2 0 0 1-2 2h-5l-4 4v-4H6a2 2 0 0 1-2-2V4z"/></svg>
                        </div>
                        <div>
                            <div class="brand-title">تیکت تل</div>
                            <div class="brand-sub">پلتفرم پشتیبانی هوشمند — سریع، امن و قابل توسعه</div>
                        </div>
                    </div>

                    <p class="hint mt-4">با طراحی واکنش‌گرا و امکانات API-first، تیکت‌تل آماده اتصال به هر سرویس و ابزار مورد نیاز شماست. راه‌اندازی تنها با چند کلیک.</p>

                    <div style="margin-top:1rem;">
                        <div class="muted-row" style="justify-content:space-between">
                            <div class="badge">Enterprise Ready</div>
                            <div class="badge">GDPR-friendly</div>
                            <div class="badge">Webhooks & API</div>
                        </div>
                    </div>

                    <div class="stats mt-4">
                        <div class="stat-item">
                            <div class="num">120+</div>
                            <div class="lbl">شرکت‌های متصل</div>
                        </div>
                        <div class="stat-item">
                            <div class="num">1M+</div>
                            <div class="lbl">تیکت‌های پردازش‌شده</div>
                        </div>
                        <div class="stat-item">
                            <div class="num">99.9%</div>
                            <div class="lbl">آپتایم</div>
                        </div>
                    </div>

                    <div style="margin-top:1.2rem; display:flex; gap:0.8rem; align-items:center;">
                        <button class="btn-cta text-lg flex-1" onclick="navigateTo('setup')">
                            <i class="fas fa-play"></i> شروع راه‌اندازی پلتفرم
                        </button>
                        <div class="small-foot">یا به مستندات مراجعه کنید</div>
                    </div>

                    <div style="position:absolute; left:-80px; top:-40px; width:220px; height:220px; background:radial-gradient(circle at 30% 30%, rgba(0,198,255,0.07), transparent); filter:blur(42px); pointer-events:none"></div>
                    <div style="position:absolute; right:-60px; bottom:-50px; width:160px; height:160px; background:radial-gradient(circle at 70% 70%, rgba(255,200,87,0.04), transparent); filter:blur(36px); pointer-events:none"></div>
                </section>
            </div>

            <!-- Stage 2: Setup Form (Now single-column, centered) -->
            <div id="stage-setup" class="stage-container stage-hidden" data-view="setup">
                
                <!-- Right / Form card (Now taking center stage) -->
                <section class="form-card w-full max-w-2xl"> <!-- Max width increased for better centered look -->
                    <div class="headline">
                        <div>
                            <h1>راه‌اندازی پلتفرم شما</h1>
                            <p class="brand-sub">فیلدها را پر کنید تا پلتفرم شما ظرف چند ثانیه ساخته شود.</p>
                        </div>
                        <div style="margin-left:auto; text-align:left">
                            <div class="badge">Secure</div>
                        </div>
                    </div>

                    <form id="setup-form" class="mt-4 space-y-4">
                        <!-- Form fields remain the same -->
                        <div>
                            <label for="store-handle" class="form-label">شناسه پلتفرم (انگلیسی)</label>
                            <div style="display:flex; gap:0.6rem; align-items:center">
                                <input id="store-handle" class="glass-input ltr w-full" placeholder="مثال: kafsh-store یا my-mobile" pattern="[a-zA-Z0-9-]+" required>
                                <div class="badge">url/your-handle</div>
                            </div>
                            <div class="hint">این شناسه در URL پلتفرم استفاده می‌شود و بعد از ساخت، تغییرپذیر نیست.</div>
                        </div>

                        <div>
                            <label for="admin-chat-id" class="form-label">شناسه عددی تلگرام مدیر</label>
                            <!-- NOTE: Prefill with Telegram ID if available -->
                            <input id="admin-chat-id" class="glass-input ltr w-full" placeholder="مثال: 123456789" pattern="[0-9]+" required>
                            <div class="hint">برای دریافت شناسه به ربات <a href="https://t.me/userinfobot" target="_blank" style="color:var(--accent1);">@userinfobot</a> پیام دهید.</div>
                        </div>

                        <div>
                            <label for="user-bot-token" class="form-label">توکن ربات کاربران</label>
                            <input id="user-bot-token" class="glass-input ltr w-full" placeholder="توکن رباتی که کاربران با آن در ارتباطند" required>
                            <div class="hint">این ربات به عنوان Mini App عمل می‌کند.</div>
                        </div>

                        <div>
                            <label for="admin-bot-token" class="form-label">توکن ربات ادمین (اعلان‌ها)</label>
                            <input id="admin-bot-token" class="glass-input ltr w-full" placeholder="توکن ربات اعلان‌ها" required>
                        </div>

                        <div style="display:flex; gap:0.8rem; align-items:center">
                            <!-- Button is now immediately enabled by renderApp for unrestricted access -->
                            <button id="create-platform-btn" class="btn-cta flex-1" type="submit" disabled><i class="fas fa-spinner animate-spin"></i> در حال اتصال...</button>
                        </div>

                        <div class="hint" style="display:flex; justify-content:space-between;">
                            <span>وب‌هوک ادمین به صورت خودکار تنظیم می‌شود</span>
                            <span class="muted-row">نسخه <strong style="margin-inline:6px; color:var(--gold)">1.0.0</strong></span>
                        </div>
                    </form>

                    <div style="margin-top:1rem; display:flex; gap:0.6rem; align-items:center; justify-content:space-between">
                        <div class="small-foot">نیاز به کمک؟ <a href="https://amirrezahoseinabadi.github.io/support" target="_blank" style="color:var(--accent1);">پشتیبانی</a></div>
                        <div class="small-foot">طراحی شده برای کسب‌وکارهای ایرانی</div>
                    </div>
                    
                    <!-- Explicit back button added below the form -->
                    <div class="mt-4 pt-4 border-t border-white/10">
                        <button class="btn-cta text-sm w-full" onclick="navigateTo('home')">
                            <i class="fas fa-arrow-right-to-bracket rotate-180"></i> بازگشت به صفحه اصلی
                        </button>
                    </div>
                </section>
            </div>

            <!-- Stage 3: Success Message (Hidden) -->
            <div id="stage-success" class="stage-container stage-hidden" data-view="success">
                <section id="success-card" class="content-card">
                    <p class="text-white">در حال بارگذاری نتایج...</p>
                </section>
            </div>
            
            <!-- Stage 4: Profile View (New) -->
            <div id="stage-profile" class="stage-container stage-hidden" data-view="profile">
                <section id="profile-card" class="content-card w-full max-w-sm">
                    <!-- Profile content will be rendered here dynamically -->
                    <p class="text-white text-center">در حال بارگذاری اطلاعات پروفایل...</p>
                </section>
            </div>

            <!-- Stage 5: Dashboard View (New) -->
            <div id="stage-dashboard" class="stage-container stage-hidden" data-view="dashboard">
                <section id="dashboard-card" class="content-card w-full max-w-xl">
                    <h1 class="text-2xl font-extrabold text-white mb-6 border-b border-white/10 pb-3">🗂️ داشبورد پلتفرم</h1>
                    <p class="text-gray-400 mb-4">این بخش برای مدیریت تیکت‌ها و تنظیمات کلی پلتفرم شما طراحی شده است.</p>
                    <div id="dashboard-status" class="space-y-3">
                        <!-- Dynamic content will go here -->
                        <div class="p-3 rounded-lg flex justify-between items-center" style="background:rgba(255,255,255,0.05);"><span class="font-bold">وضعیت:</span> <span class="text-green-400">✅ فعال</span></div>
                        <div class="p-3 rounded-lg flex justify-between items-center" style="background:rgba(255,255,255,0.05);"><span class="font-bold">شناسه پلتفرم:</span> <span id="dash-handle" class="ltr text-blue-400 font-mono">---</span></div>
                    </div>
                    <button class="btn-cta text-sm mt-6 w-full" onclick="alert('TODO: Implement Admin Panel link/logic')">
                        <i class="fas fa-cog"></i> ورود به پنل مدیریت
                    </button>
                </section>
            </div>

        </div> <!-- end #main-view -->
        
        <!-- MODAL for Manual Recovery (NEW) -->
        <div id="recovery-modal" class="modal" onclick="if(event.target.id === 'recovery-modal') closeModal('recovery-modal')">
            <div class="modal-content">
                <h2 class="text-xl font-bold mb-4">🔍 بازیابی پلتفرم موجود</h2>
                <p class="text-sm text-gray-400 mb-4">اگر قبلاً پلتفرمی ساخته‌اید اما در پروفایل شما نمایش داده نمی‌شود، نام (Handle) آن را وارد کنید تا به شناسه تلگرام شما متصل شود.</p>
                
                <form onsubmit="event.preventDefault(); recoverPlatform(document.getElementById('recovery-handle').value);">
                    <label for="recovery-handle" class="form-label mb-2 block">شناسه پلتفرم (Handle)</label>
                    <input id="recovery-handle" class="glass-input ltr w-full mb-4" placeholder="مثال: my-store" required>

                    <div class="flex gap-3 mt-4">
                        <button type="submit" id="recover-btn" class="btn-cta flex-1">
                            <i class="fas fa-undo-alt"></i> بازیابی پلتفرم
                        </button>
                        <button type="button" class="btn-secondary" onclick="closeModal('recovery-modal')">
                            انصراف
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <!-- END MODAL -->


	</main>
    
    <!-- Bottom Navigation Bar (New) -->
    <nav id="nav-bar">
        <div class="nav-item active" data-target="home" onclick="navigateTo('home')">
            <i class="fas fa-home"></i>
            <span>خانه</span>
        </div>
        <div class="nav-item" data-target="dashboard" onclick="navigateTo('dashboard')">
            <i class="fas fa-layer-group"></i>
            <span>داشبورد</span>
        </div>
        <div class="nav-item" data-target="profile" onclick="navigateTo('profile')">
            <i class="fas fa-user-circle"></i>
            <span>پروفایل</span>
        </div>
        <div class="nav-item" data-target="settings" onclick="alert('TODO: Implement Settings View')">
            <i class="fas fa-cogs"></i>
            <span>تنظیمات</span>
        </div>
    </nav>


	<script>
        // Global state object
        window.state = {
            currentView: 'home',
            user: { uid: 'guest', username: 'کاربر میهمان', isAnonymous: true, isTelegramAuth: false, tgUserId: null },
            platform: { storeHandle: null, adminBotUsername: null, userBotUsername: null }
        };

        // آدرس Worker اصلی (واسط) که شامل منطق /setup و /sync است
        const MANAGEMENT_WORKER_URL = "https://management-ticketing.amiruserbot7.workers.dev";
        // NOTE: FIREBASE_DOC_PATH will be dynamically updated after successful auth
        let FIREBASE_DOC_PATH = null; 
        
        // --- توابع کمکی عمومی ---
        
        function enablePlatformCreationButton() {
            const btn = document.getElementById('create-platform-btn');
            // این تابع فقط برای فعال کردن دکمه و تنظیم متن آن در لود اولیه است.
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = `<i class='fas fa-rocket'></i> ساخت پلتفرم جدید`;
            }
        }
        
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

		// Utility function to copy text to clipboard
		function copyToClipboard(elementId) {
			const copyText = document.getElementById(elementId);
			if (copyText) {
				copyText.select();
				document.execCommand('copy');
				const copyBtn = copyText.nextElementSibling;
				if (copyBtn) {
					copyBtn.innerHTML = '<i class="fas fa-check"></i>';
					Swal.fire({
						toast: true,
						position: 'top-end',
						icon: 'success',
						title: 'آدرس کپی شد',
						showConfirmButton: false,
						timer: 1500
					});
					setTimeout(() => {
						copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
					}, 2000);
				}
			}
		}

		function toggleLoading(button, isLoading, text){
			if(isLoading){
				button.disabled=true;
				// SVG برای Spinner (لودینگ)
				button.innerHTML = `<svg class='animate-spin' style='width:18px;height:18px' viewBox='0 0 24 24'><circle class='opacity-25' cx='12' cy='12' r='10' stroke='currentColor' stroke-width='4' fill='none'></circle><path class='opacity-75' fill='currentColor' d='M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z'></path></svg> ${text}`;
			} else {
				button.disabled=false;
				// آیکون اصلی دکمه
				button.innerHTML = `<i class='fas fa-rocket'></i> ${text}`;
			}
		}
        
        // --- Stage (View) Management Functions ---
        
        function navigateTo(targetView) {
            if (window.state.currentView === targetView) return;

            const currentStage = document.querySelector(`.stage-container[data-view="${window.state.currentView}"]`);
            const nextStage = document.querySelector(`.stage-container[data-view="${targetView}"]`);
            const navItems = document.querySelectorAll('.nav-item');
            
            if (!currentStage || !nextStage) {
                console.error('Invalid view transition:', window.state.currentView, '->', targetView);
                return;
            }

            // Update navigation bar active class
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-target') === targetView) {
                    item.classList.add('active');
                }
            });
            
            // Render content for the target view before transition starts
            if (targetView === 'profile') renderProfile();
            if (targetView === 'dashboard') renderDashboard();

            // 1. Start the exit animation for the current stage
            currentStage.classList.remove('stage-active');
            currentStage.classList.add('stage-exit');
            
            // 2. Schedule the enter animation for the next stage after a short delay
            setTimeout(() => {
                currentStage.classList.remove('stage-exit');
                currentStage.classList.add('stage-hidden'); 
                
                nextStage.classList.remove('stage-hidden');
                nextStage.classList.add('stage-enter');
                nextStage.classList.add('stage-active');
                window.state.currentView = targetView;
            }, 300); 
            
             setTimeout(() => {
                nextStage.classList.remove('stage-enter');
            }, 1000);
        }

        // Renamed functions for clarity with new navigation system
        const navigateToForm = () => navigateTo('setup');
        const transitionToSuccess = () => navigateTo('success');


        // --- Dynamic Rendering Functions (New) ---

        function renderApp() {
            // Initial render based on user authentication status
            const currentStage = document.querySelector(`.stage-container[data-view="${window.state.currentView}"]`);
            if (currentStage) {
                // Ensure only the current view is active on load
                document.querySelectorAll('.stage-container').forEach(stage => {
                    if (stage !== currentStage) {
                        stage.classList.remove('stage-active', 'stage-enter', 'stage-exit');
                        stage.classList.add('stage-hidden');
                    }
                });
            }
            
            // Prefill admin-chat-id if we have the Telegram ID
            const adminChatIdInput = document.getElementById('admin-chat-id');
            if (adminChatIdInput && window.state.user.tgUserId && !adminChatIdInput.value) {
                adminChatIdInput.value = window.state.user.tgUserId;
            }
            
            // If the user has a platform handle, default to the Dashboard view
            if (window.state.platform.storeHandle && window.state.currentView === 'home') {
                 navigateTo('dashboard');
            } else {
                 navigateTo(window.state.currentView); // Ensure home is active
            }
            
            // *** تغییر جدید: فعال‌سازی دکمه در اینجا برای رفع مشکل "در حال اتصال" ***
            enablePlatformCreationButton();
        }
        
        function renderProfile() {
            const profileCard = document.getElementById('profile-card');
            const { user, platform } = window.state;
            const uid = user.uid || '---';
            
            // Display Telegram username or first name if available, otherwise fall back
            let displayUsername = user.username;
            if (user.isTelegramAuth) {
                // Check if username is present, otherwise use first_name
                displayUsername = user.username ? `@${user.username}` : user.first_name || 'کاربر تلگرام';
            } else {
                displayUsername = user.username;
            }

            const status = platform.storeHandle ? 'پلتفرم راه‌اندازی شده' : 'نیاز به راه‌اندازی پلتفرم';
            const statusColor = platform.storeHandle ? 'text-green-400' : 'text-yellow-400';
            const platformHandleDisplay = platform.storeHandle ? `<span class="ltr font-mono text-lg text-green-400">${platform.storeHandle}</span>` : `<span class="text-red-400">---</span>`;
            
            // Determine the UID to display: TG ID if authenticated via TG, otherwise Firebase UID
            const displayUID = user.tgUserId || uid;
            const displayUIDLabel = user.tgUserId ? 'شناسه تلگرام (مدیر)' : 'شناسه فایربیس (مهمان)';

            // ایجاد حروف اول برای آواتار
            const avatarText = (user.username || user.first_name || 'U').substring(0,1).toUpperCase();


            profileCard.innerHTML = `
                <div class="text-center mb-8">
                    <img src="https://placehold.co/120x120/0072FF/ffffff?text=${avatarText}" alt="Profile Avatar" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-white/10" onerror="this.onerror=null;this.src='https://placehold.co/120x120/0072FF/ffffff?text=U'">
                    <h2 class="text-2xl font-extrabold text-white">${displayUsername}</h2>
                    <p class="text-sm text-gray-400">${displayUIDLabel}: ${displayUID}</p>
                </div>
                
                <div class="space-y-4 pt-4 border-t border-white/10">
                    <h3 class="text-xl font-bold text-white mb-3">وضعیت پلتفرم</h3>
                    
                    <div class="flex justify-between items-center p-3 rounded-lg" style="background:rgba(255,255,255,0.05);">
                        <span class="font-bold text-gray-300">وضعیت:</span>
                        <span class="font-extrabold ${statusColor}">${status}</span>
                    </div>

                    <div class="flex justify-between items-center p-3 rounded-lg" style="background:rgba(255,255,255,0.05);">
                        <span class="font-bold text-gray-300">شناسه پلتفرم:</span>
                        ${platformHandleDisplay}
                    </div>

                    ${platform.storeHandle ? `
                        <div class="flex justify-between items-center p-3 rounded-lg" style="background:rgba(255,255,255,0.05);">
                            <span class="font-bold text-gray-300">ربات ادمین:</span>
                            <a href="https://t.me/${platform.adminBotUsername}" target="_blank" class="text-blue-400 font-mono ltr">@${platform.adminBotUsername}</a>
                        </div>
                    ` : `
                        <button class="btn-cta text-sm w-full mt-4 mb-2" onclick="navigateTo('setup')">
                            شروع راه‌اندازی پلتفرم
                        </button>
                        <button class="btn-secondary text-sm w-full" onclick="openModal('recovery-modal')">
                            <i class="fas fa-undo-alt"></i> بازیابی پلتفرم موجود
                        </button>
                    `}
                </div>
            `;
        }

        function renderDashboard() {
            const dashboardCard = document.getElementById('dashboard-card');
            const handleSpan = document.getElementById('dash-handle');
            const statusDiv = document.getElementById('dashboard-status');
            const { platform } = window.state;

            if (platform.storeHandle) {
                 statusDiv.innerHTML = `
                    <div class="p-3 rounded-lg flex justify-between items-center" style="background:rgba(255,255,255,0.05);"><span class="font-bold">وضعیت:</span> <span class="text-green-400">✅ فعال</span></div>
                    <div class="p-3 rounded-lg flex justify-between items-center" style="background:rgba(255,255,255,0.05);"><span class="font-bold">شناسه پلتفرم:</span> <span id="dash-handle" class="ltr text-blue-400 font-mono">${platform.storeHandle}</span></div>
                    <div class="p-3 rounded-lg flex justify-between items-center" style="background:rgba(255,255,255,0.05);"><span class="font-bold">ربات کاربران:</span> <span class="ltr text-yellow-400 font-mono">@${platform.userBotUsername}</span></div>
                 `;
            } else {
                 statusDiv.innerHTML = `
                    <p class="text-red-400 p-4 rounded-lg" style="background:rgba(255,0,0,0.1);">⛔ پلتفرمی برای این حساب کاربری راه‌اندازی نشده است.</p>
                    <button class="btn-cta text-sm w-full mt-4" onclick="navigateTo('setup')">
                        شروع راه‌اندازی پلتفرم
                    </button>
                    <button class="btn-secondary text-sm w-full mt-2" onclick="openModal('recovery-modal')">
                         <i class="fas fa-undo-alt"></i> بازیابی پلتفرم موجود
                    </button>
                 `;
            }
        }

		// *** تابع اصلاح‌شده: افزودن مکانیزم انتظار (Polling) برای آماده بودن Firebase ***
		function finishSetup(result, retries = 0){
            // اگر بیش از حد تلاش کرد و هنوز Firebase آماده نبود، متوقف کن
            if (retries > 10) { 
                 console.error("Firebase readiness timeout reached.");
                 Swal.fire({icon:'error', title:'خطا در ذخیره', text:'پلتفرم ساخته شد، اما اتصال فایربیس برای ذخیره پروفایل زمان‌بندی نشد. لطفاً Mini App را دوباره باز کنید.'});
                 showSuccess(result);
                 return;
            }

            // بررسی شرط اصلی: آیا همه متغیرهای Firebase و احراز هویت آماده‌اند؟
            // توجه: isAuthReady فقط برای نمایش صحیح در داشبورد مهم است، نه برای سابمیت.
            if (!window.db || !window.doc || !window.setDoc || !window.FIREBASE_DOC_PATH) {
                 // اگر آماده نبود، 200 میلی‌ثانیه صبر کن و دوباره تلاش کن (Polling)
                 console.warn(`Firebase services not yet available (Retry ${retries}). Waiting...`);
                 setTimeout(() => finishSetup(result, retries + 1), 200);
                 return;
            }
            
            // --- اگر همه چیز آماده بود، ذخیره‌سازی را انجام بده ---
            console.log("Firebase services are ready. Proceeding to save platform data.");

            // Save platform details to user's private profile document
            const userDocRef = window.doc(window.db, window.FIREBASE_DOC_PATH);
            const dataToSave = { 
                storeHandle: result.storeHandle,
                adminBotUsername: result.adminBotUsername,
                userBotUsername: result.userBotUsername,
                setupDate: new Date()
            };
            
            window.setDoc(userDocRef, { platform: dataToSave }, { merge: true })
                .then(() => {
                    console.log("Platform details saved to Firestore profile.");
                    // Update state to trigger rendering of profile/dashboard
                    window.state.platform = dataToSave; 
                    showSuccess(result);
                })
                .catch(error => {
                    console.error("Error saving platform details:", error);
                    // نمایش خطای ذخیره‌سازی حتی اگر پلتفرم ساخته شده باشد
                    Swal.fire({icon:'error', title:'خطا در ذخیره', text:`پلتفرم ساخته شد، اما در ذخیره اطلاعات آن در پروفایل شما خطایی رخ داد: ${error.message}`});
                    showSuccess(result); 
                });
		}


		function showSuccess(result){
			const { adminBotUsername, userBotUsername, storeHandle } = result || {};
			const MINI_APP_BASE_URL = "https://amirrezahoseinabadi.github.io/ticketing-frontend/index.html";
			const miniAppUrl = `${MINI_APP_BASE_URL}?storeHandle=${storeHandle}`;
			const successCard = document.getElementById('success-card');

			successCard.innerHTML = `
				<div class="flex items-center justify-end gap-3 text-white mb-6">
					<i class="fas fa-check-circle text-4xl" style="color:var(--accent1);"></i>
					<h1 class="text-3xl font-extrabold">🎉 پلتفرم شما آماده است</h1>
				</div>
				<p class="font-bold text-xl mb-6 text-white/90 border-b border-white/10 pb-3">گام‌های نهایی برای فعال‌سازی</p>
				
				<ol class="space-y-6">
					<li class="p-4 rounded-xl" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08);">
						<span class="font-bold text-white text-base block mb-2">۱. فعال‌سازی Mini App:</span>
						<p class="text-sm text-gray-300 mb-2">آدرس زیر را در BotFather (تنظیمات ربات کاربران) به‌عنوان Web App URL ثبت کنید:</p>
						<div class="relative">
							<input id="mini-app-url-input" class="glass-input ltr w-full text-base" style="font-family:monospace; padding-left: 3.5rem; background:rgba(0,0,0,0.1); border-color: rgba(255,255,255,0.1);" readonly value="${miniAppUrl}">
							<button onclick="copyToClipboard('mini-app-url-input')" class="absolute left-2 top-1/2 -translate-y-1/2 btn-copy" title="کپی کردن آدرس">
								<i class="fas fa-copy"></i>
							</button>
						</div>
					</li>
					<li class="p-4 rounded-xl" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08);">
						<span class="font-bold text-white text-base block mb-2">۲. فعال‌سازی ربات ادمین:</span>
						<p class="text-sm text-gray-300">
							ربات اعلان‌ها (
							<a href="https://t.me/${adminBotUsername}" target="_blank" class="text-blue-400 font-bold hover:text-blue-300 transition-colors">@${adminBotUsername}</a> 
							) را باز کرده و دستور <code>/start</code> را بزنید تا اعلانات پشتیبانی برای شما فعال شوند.
						</p>
					</li>
				</ol>

				<div class="mt-10 pt-6 border-t border-white/10 flex flex-col items-center">
					<button id="finish-setup-btn" class="btn-cta text-lg w-full max-w-xs" onclick="navigateTo('dashboard')">
						تکمیل و رفتن به داشبورد
					</button>
				</div>
			`;
			
			transitionToSuccess();
		}
        
        // --- API & Form Logic (Modified) ---

		document.getElementById('setup-form').addEventListener('submit', async (e)=>{
			e.preventDefault();
			const btn = document.getElementById('create-platform-btn');
			const storeHandleInput = document.getElementById('store-handle');
            
            // Basic validation
			if(!storeHandleInput.value.trim() || !document.getElementById('admin-chat-id').value.trim() || !document.getElementById('user-bot-token').value.trim() || !document.getElementById('admin-bot-token').value.trim()){
				Swal.fire({icon:'error', title:'خطا', text:'لطفاً همه فیلدهای الزامی را تکمیل کنید.'});
				return;
			}
            
            // *** بخش اعتبارسنجی Firebase حذف شده است تا محدودیتی ایجاد نشود ***

			// START LOADING: تغییر وضعیت دکمه به لودینگ
			toggleLoading(btn, true, 'در حال ساخت پلتفرم...');

			const payload = {
				storeHandle: storeHandleInput.value.trim().toLowerCase(),
				adminChatId: document.getElementById('admin-chat-id').value.trim(),
				userBotToken: document.getElementById('user-bot-token').value.trim(),
				adminBotToken: document.getElementById('admin-bot-token').value.trim(),
				miniAppUrl: `https://amirrezahoseinabadi.github.io/ticketing-frontend/index.html?storeHandle=${storeHandleInput.value.trim().toLowerCase()}`
			};


			let isSuccess = false;
			try{
				const res = await fetch(`${MANAGEMENT_WORKER_URL}/setup`,{
					method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
				});
				
                // --- مدیریت امن خواندن JSON و خطاها ---
                let data = {};
                const resText = await res.text(); // اول متن خام را می‌خوانیم
                try {
                    data = JSON.parse(resText);
                } catch (jsonError) {
                    // اگر Worker پاسخ غیر JSON داد (مثلاً خطای 500 بدون بدنه مناسب)
                    if (!res.ok) {
                        throw new Error(`خطای سرور: ${res.status}. پاسخ نامفهوم. کنسول را بررسی کنید.`);
                    }
                }
                // --- پایان مدیریت امن خواندن JSON ---

                // بررسی وضعیت پاسخ Worker (واسط)
				if(!res.ok) {
                    // اگر خطا 409 (Conflict) بود، یعنی شناسه تکراری است.
                    if (res.status === 409) {
                        throw new Error(`شناسه پلتفرم (${payload.storeHandle}) قبلاً استفاده شده است. لطفاً یک شناسه دیگر انتخاب کنید.`);
                    }
                    // برای سایر خطاها
                    const errorMessage = data.error || `خطا در Worker (${res.status}). کنسول را بررسی کنید.`;
                    throw new Error(errorMessage);
                }

				finishSetup(data.data); // Calls finishSetup which saves to Firestore and then shows success
				isSuccess = true;

			}catch(err){
				// نمایش خطا
				Swal.fire({icon:'error', title:'عملیات ناموفق', text: err.message || err.toString()});
			}finally{
				// در هر صورت دکمه را آزاد می‌کند
                toggleLoading(btn,false,'ساخت پلتفرم جدید');
			}
		});

	</script>
</body>
</html>

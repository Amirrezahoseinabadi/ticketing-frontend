<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>ØªÛŒÚ©Øª ØªÙ„ â€” Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ùˆ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
	<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- ØªÙ„Ú¯Ø±Ø§Ù… Mini App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- FIREBASE MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // FIX: import addDoc and collection explicitly
        import { getFirestore, doc, setDoc, addDoc, collection, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose necessary Firestore functions globally
        window.doc = doc;
        window.setDoc = setDoc;
        // FIX: Expose addDoc and collection for logging
        window.addDoc = addDoc;
        window.collection = collection;

        
        // Flag to track authentication readiness status
        window.isAuthReady = false; 

        // Log setup
        // setLogLevel('debug'); // Uncomment for debugging Firestore logs

        // Global variables injected by Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Global variable for Firebase instances
        window.db = null;
        window.auth = null;
        window.FIREBASE_DOC_PATH = null;

        // ØªØ¹ÛŒÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø² ØªÙ„Ú¯Ø±Ø§Ù… (Ø§Ú¯Ø± Mini App Ø¨Ø§Ø´Ø¯)
        function getTelegramUserInfo() {
            // Get user info from Telegram WebApp SDK
            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
                // Last name might be undefined, so check for it
                const fullName = tgUser.last_name ? `${tgUser.first_name} ${tgUser.last_name}` : tgUser.first_name;
                
                return {
                    // ID ØªÙ„Ú¯Ø±Ø§Ù… Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† tgUserId Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                    tgUserId: tgUser.id ? tgUser.id.toString() : null, 
                    // NEW: Store full name for display (or fallback to username/first_name)
                    fullName: fullName, 
                    username: tgUser.username || tgUser.first_name,
                    first_name: tgUser.first_name,
                    isAnonymous: false,
                    isTelegramAuth: true,
                    // NEW: Add photo_url for profile picture
                    photo_url: tgUser.photo_url || null, 
                };
            }
            return {
                tgUserId: null, 
                fullName: 'Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒÙ‡Ù…Ø§Ù†',
                username: 'Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒÙ‡Ù…Ø§Ù†',
                first_name: 'Ú©Ø§Ø±Ø¨Ø±',
                isAnonymous: true,
                isTelegramAuth: false,
                photo_url: null,
            };
        }
        
        // ØªÙ†Ø¸ÛŒÙ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ú©Ø§Ø±Ø¨Ø±
        const initialTgInfo = getTelegramUserInfo();
        window.state.user = { 
            uid: 'guest', // Initial Firebase UID placeholder
            platform: { storeHandle: null, adminBotUsername: null, userBotUsername: null },
            ...initialTgInfo, 
        };
        
        /**
         * NEW: ØªØ§Ø¨Ø¹ Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡ÛŒ Ø®Ø·Ø§ Ø¨Ù‡ Firestore.
         * Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø®Ø·Ø§ Ø±Ø§ Ø¯Ø± Ú©Ø§Ù„Ú©Ø´Ù† artifacts/{appId}/app_logs Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
         * @param {string} source - Ù†Ø§Ù… ØªØ§Ø¨Ø¹ÛŒ Ú©Ù‡ Ø®Ø·Ø§ Ø§Ø² Ø¢Ù† Ù†Ø´Ø£Øª Ú¯Ø±ÙØªÙ‡ Ø§Ø³Øª (Ù…Ø«Ù„Ø§: 'AuthCheck' ÛŒØ§ 'Sync').
         * @param {string} message - Ù¾ÛŒØ§Ù… Ø§ØµÙ„ÛŒ Ø®Ø·Ø§.
         * @param {object} details - Ø¬Ø²Ø¦ÛŒØ§Øª Ø§Ø¶Ø§ÙÛŒ Ù…Ø§Ù†Ù†Ø¯ UID Ùˆ ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª.
         */
        async function logErrorToFirestore(source, message, details = {}) {
            if (!window.db || !window.addDoc || !window.collection) {
                console.error("Logger failed: Firestore DB or required functions not initialized.");
                return;
            }

            const logCollectionRef = window.collection(window.db, `artifacts/${appId}/app_logs`);
            
            try {
                await window.addDoc(logCollectionRef, {
                    timestamp: new Date().toISOString(),
                    source: source,
                    message: message,
                    user_id: window.state.user.uid,
                    tg_id: window.state.user.tgUserId,
                    is_anonymous: window.state.user.isAnonymous,
                    is_telegram_auth: window.state.user.isTelegramAuth,
                    details: details,
                });
                console.log(`[LOGGER] Successfully logged error from ${source}.`);
            } catch (error) {
                console.error("[LOGGER] Failed to save log to Firestore:", error);
            }
        }
        window.logErrorToFirestore = logErrorToFirestore; // Expose globally

        if (firebaseConfig) {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);

            // Auth listener and custom token sign-in
            onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UID ÙØ§ÛŒØ±Ø¨ÛŒØ³
                    window.state.user = { 
                        ...window.state.user, 
                        uid: user.uid, // This is the actual Firebase UID
                        // FIX: Ensure isAnonymous is always set correctly from Firebase user object
                        isAnonymous: user.isAnonymous 
                    };
                    
                    // Ø§Ú¯Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Mini App Ù†Ø¨ÙˆØ¯ØŒ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ Ø§Ø² Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯.
                    if (!window.state.user.isTelegramAuth) {
                        window.state.user.username = user.email ? user.email.split('@')[0] : 'Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†';
                        window.state.user.fullName = window.state.user.username;
                    }
                    
                    // ØªÙ†Ø¸ÛŒÙ… Ù…Ø³ÛŒØ± Firestore Ø¨Ø± Ø§Ø³Ø§Ø³ UID ÙˆØ§Ù‚Ø¹ÛŒ Firebase
                    window.FIREBASE_DOC_PATH = `artifacts/${appId}/users/${user.uid}/profile/main`;
                    
                    // Fetch user-specific and public platform data
                    setupDataListeners(user.uid);
                    
                    // --- ØªÙ†Ø¸ÛŒÙ… Ù¾Ø±Ú†Ù… Ø¢Ù…Ø§Ø¯Ù‡ Ø¨ÙˆØ¯Ù† Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ---
                    window.isAuthReady = true;
                    console.log(`[AUTH] User authenticated successfully. UID: ${user.uid}`);
                    
                    // Update UI to show authenticated content
                    renderApp(); 
                } else {
                    // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ø¨Ø§ ØªÙˆÚ©Ù† Canvas
                    if (initialAuthToken) {
                        signInWithCustomToken(window.auth, initialAuthToken)
                        .then(() => {
                             console.log("[AUTH] Signed in with Custom Token.");
                        })
                        .catch(error => {
                            console.error("[AUTH] Custom token sign-in failed:", error);
                            // Log the auth failure
                            logErrorToFirestore('AuthCheck', 'Custom token sign-in failed', { error: error.message, token_present: true });
                            // FIX: Ø­Ø°Ù Anonymous Sign-in Ùˆ Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ø®Ø·Ø§ÛŒ ØªØ§ÛŒÙ… Ø§ÙˆØª Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ Ø¨Ù‡ØªØ±
                            // signInAnonymously(window.auth).catch(console.error); 
                        });
                    } else {
                        // Log the auth failure
                        logErrorToFirestore('AuthCheck', 'Initial token missing, Auth state remains unauthenticated.', { token_present: false });
                        // FIX: Ø­Ø°Ù Anonymous Sign-in Ùˆ Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ø®Ø·Ø§ÛŒ ØªØ§ÛŒÙ… Ø§ÙˆØª Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ Ø¨Ù‡ØªØ±
                        // signInAnonymously(window.auth).catch(error => { ... });
                    }
                }
            });
        }
        
        function setupDataListeners(uid) {
            // 1. Listen to the user's private document (for profile data, e.g., display name)
            const userDocRef = doc(window.db, `artifacts/${appId}/users/${uid}/profile/main`);
            onSnapshot(userDocRef, (docSnap) => {
                const oldHandle = window.state.platform.storeHandle;
                
                if (docSnap.exists()) {
                    // Update state with platform data if available
                    const data = docSnap.data();
                    window.state.user = { ...window.state.user, ...data };
                    if (data.platform) {
                        window.state.platform = data.platform;
                    }
                }
                
                // Ø§Ú¯Ø± Ø¯ÛŒØªØ§ÛŒ Ø¬Ø¯ÛŒØ¯ÛŒ Ø§Ø² Ù¾Ù„ØªÙØ±Ù… (Ù…Ø«Ù„Ø§Ù‹ Ù¾Ø³ Ø§Ø² Ø³Ø§Ø®Øª) Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
                if (window.state.platform.storeHandle && window.state.platform.storeHandle !== oldHandle) {
                    // Ø§Ú¯Ø± Ø¯Ø± Ù†Ù…Ø§ÛŒ Success Ø¨ÙˆØ¯ÛŒÙ…ØŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù‡Ø¯Ø§ÛŒØª Ú©Ù†
                    if (window.state.currentView === 'success') {
                        navigateTo('dashboard');
                    }
                }
                
                renderProfile(); // Rerender profile on data change
                // NEW: Explicitly check and render dashboard on data change if needed
                if (window.state.currentView === 'dashboard') {
                    renderDashboard();
                }
            });

            // 2. Try to sync if the user has an existing platform that wasn't found in their profile
            // FIX: ÙÙ‚Ø· Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³ Ù†Ø¨ÙˆØ¯ØŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡.
            if (!window.state.user.isAnonymous) {
                trySyncExistingPlatform(uid);
            }
        }
        
        /**
         * NEW FIX: Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù† Ú©Ø§Ù…Ù„ Firebase Ùˆ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª.
         * @returns {Promise<void>}
         */
        function waitForFirebaseReady(maxRetries = 150, delay = 100) { // Increased maxRetries to 150 (15 seconds)
            return new Promise((resolve, reject) => {
                let retries = 0;
                const check = () => {
                    // Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ù…Ù‡ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø­ÛŒØ§ØªÛŒ
                    if (window.db && window.doc && window.setDoc && window.FIREBASE_DOC_PATH && window.isAuthReady && !window.state.user.isAnonymous) {
                        console.log("[WAIT] Firebase is ready and user is authenticated.");
                        resolve();
                        return;
                    }

                    if (retries >= maxRetries) {
                        console.error("[WAIT] Error: Firebase readiness timeout reached after 15 seconds.");
                        // Ø§Ú¯Ø± ØªØ§ÛŒÙ… Ø§ÙˆØª Ø¯Ø§Ø¯ØŒ Ù„Ø§Ú¯ Ø®Ø·Ø§ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†
                        const errorMsg = "Firebase readiness timeout reached.";
                        logErrorToFirestore('WaitForFirebase', errorMsg, { 
                            isReady: window.isAuthReady, 
                            isAnonymous: window.state.user.isAnonymous,
                            path_set: !!window.FIREBASE_DOC_PATH
                        });
                        
                        // reject only if we expected a non-anonymous user, but couldn't get one
                        if (window.state.user.isTelegramAuth && !window.state.user.isAnonymous) {
                            reject(new Error("Firebase readiness timeout. Please reopen the Mini App."));
                        } else {
                            // resolve silently if we are an anonymous user and just waiting for optional platform data
                            resolve(); 
                        }
                        return;
                    }

                    retries++;
                    setTimeout(check, delay);
                };
                check();
            });
        }

        /**
         * UPDATED FUNCTION: Searches the worker for a store linked to the admin's Firebase UID.
         * @param {string} firebaseUid - The authenticated Firebase User ID.
         * @param {boolean} [force=false] - If true, ignores the current storeHandle status and retries sync.
         */
        async function trySyncExistingPlatform(firebaseUid, force = false) {
            const { storeHandle } = window.state.platform;
            const syncButton = document.getElementById('sync-platform-btn');
            
            // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Handle Ø±Ø§ Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Firestore Ø¯Ø§Ø´ØªÛŒÙ… Ùˆ force Ù†Ø¨ÙˆØ¯ØŒ Ú©Ø§Ø±ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            if (storeHandle && !force) {
                console.log("Sync skipped: Store handle already present in Firestore profile.");
                return; 
            }
            
            // FIX: Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³ Ø¨ÙˆØ¯ Ùˆ Ø­Ø§Ù„Øª Ø§Ø¬Ø¨Ø§Ø±ÛŒ (force) ÙØ¹Ø§Ù„ Ù†Ø¨ÙˆØ¯ØŒ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆÛŒÙ….
            if (!firebaseUid || window.state.user.isAnonymous || firebaseUid === 'guest') {
                if (force) {
                    Swal.fire({ icon: 'warning', title: 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª', text: 'Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ ØªØ§ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ú©Ø§Ù…Ù„ Ø´ÙˆØ¯ ÛŒØ§ Mini App Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.' });
                    logErrorToFirestore('SyncCheck', 'Sync attempt failed: User is anonymous/guest or UID missing.', { firebaseUid, isAnonymous: window.state.user.isAnonymous });
                }
                console.log("Sync skipped: User is anonymous or Firebase UID is missing/guest.");
                return;
            }

            // Ø¢Ø¯Ø±Ø³ Worker Ø§ØµÙ„ÛŒ
            const SYNC_WORKER_URL = "https://management-ticketing.amiruserbot7.workers.dev";
            // NEW ENDPOINT
            const SYNC_ENDPOINT = `${SYNC_WORKER_URL}/get-store-by-admin-id`; 
            
            if (syncButton) toggleLoading(syncButton, true, 'Ø¯Ø± Ø­Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ...');

            // NEW LOG: Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ
            console.log(`[SYNC START] Attempting sync using Firebase UID: ${firebaseUid} via endpoint: ${SYNC_ENDPOINT}`);
            
            try {
                // --- FIX: Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨ÙˆØ¯Ù† Firebase Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¯Ø§Ù…Ù‡ ---
                await waitForFirebaseReady();
                // --------------------------------------------------------
                
                const payload = {
                    firebaseUid: firebaseUid,
                    adminChatId: window.state.user.tgUserId || null, 
                };

                const res = await fetch(SYNC_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                console.log(`[SYNC RESPONSE] Worker Status: ${res.status}`);
                
                const resText = await res.text();
                let data = {};
                try {
                    data = JSON.parse(resText);
                } catch(e) {
                    console.error("[SYNC ERROR] Failed to parse JSON response:", resText);
                    logErrorToFirestore('SyncWorker', 'Failed to parse JSON response from Worker.', { status: res.status, responseText: resText.substring(0, 100) });
                    throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±. Status: ${res.status}`);
                }
                
                console.log("[SYNC DATA]", data);

                if (res.status === 200 && data.success && data.data) {
                    const platformData = data.data;
                    const userDocRef = doc(window.db, window.FIREBASE_DOC_PATH);
                    
                    window.state.platform = platformData; 
                    renderDashboard(); 

                    await setDoc(userDocRef, { platform: platformData }, { merge: true });
                    
                    console.log(`[SYNC SUCCESS] Successfully synced existing platform: ${platformData.storeHandle}`);
                    if (force) {
                         Swal.fire({ icon: 'success', title: 'Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù…ÙˆÙÙ‚', text: 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯.' });
                    }
                    
                } else if (res.status === 404) {
                    console.log(`[SYNC RESULT] No existing platform found for UID ${firebaseUid}. (404)`);
                    logErrorToFirestore('SyncWorker', 'No store found (404). Check Realtime DB Index.', { firebaseUid });
                    if (force) {
                        Swal.fire({ icon: 'info', title: 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯', text: 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ù…Ø§ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.' });
                    }
                } else {
                    console.warn(`[SYNC FAILED] Sync failed for UID ${firebaseUid}:`, data.error || data.message || 'Worker error');
                    logErrorToFirestore('SyncWorker', 'Sync failed with Worker error.', { firebaseUid, status: res.status, workerError: data.error || data.message });
                    if (force) {
                        Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ', text: data.error || data.message || `Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø¯Ø± Worker (Status: ${res.status})` });
                    }
                }

            } catch(error) {
                console.error("[SYNC FATAL ERROR] Error during platform sync attempt:", error);
                
                const isAuthTimeout = error.message.includes("Firebase readiness timeout");
                
                if (isAuthTimeout) {
                     // Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ø§Ú¯Ø± ØªØ§ÛŒÙ… Ø§ÙˆØª Ø¯Ø§Ø¯ØŒ ÛŒØ¹Ù†ÛŒ Ù…Ø´Ú©Ù„ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø§Ø³Øª
                     logErrorToFirestore('SyncFatal', 'Firebase readiness timeout detected.', { firebaseUid, error: error.message });
                     Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø§ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª', text: 'Ø§ØªØµØ§Ù„ Ø§Ù…Ù† ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯. Mini App Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.' });
                } else if (force) {
                    logErrorToFirestore('SyncFatal', 'Fatal error during sync (Network/Other).', { firebaseUid, error: error.message });
                    Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡', text: 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ.' });
                }
            } finally {
                if (syncButton) toggleLoading(syncButton, false, 'Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª (Refresh)');
            }
        }

        // Expose functions globally for use in HTML/scripts
        window.setupDataListeners = setupDataListeners;
        // Expose manual sync function
        window.manualSync = () => trySyncExistingPlatform(window.state.user.uid, true);
    </script>
    <!-- END FIREBASE MODULES -->

	<style>
		:root{
			--bg-dark: #0f1724; /* deep navy */
			--card: rgba(255,255,255,0.03);
			--glass: rgba(255,255,255,0.06);
			--accent1: #00C6FF;
			--accent2: #0072FF;
			--muted: #9AA4B2;
			--text-light: #E6EEF5;
			--gold: #FFC857;
			--text-on-light: #1A202C; /* Dark text for popups */
            --stage-width: 380px; /* Ú©Ø§Ù‡Ø´ Ø¹Ø±Ø¶ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
            --nav-height: 60px; /* Ú©Ø§Ù‡Ø´ Ø§Ø±ØªÙØ§Ø¹ Ù†Ø§ÙˆØ¨Ø±ÛŒ */
		}

		html,body{height:100%;}
		body{
			font-family: 'Vazirmatn', sans-serif;
			/* Subtle radial glow in the background */
			background: radial-gradient(1200px 600px at 10% 20%, rgba(0,114,255,0.07), transparent),
						radial-gradient(1000px 500px at 90% 80%, rgba(0,198,255,0.03), transparent),
						var(--bg-dark);
			color:var(--text-light);
			-webkit-font-smoothing:antialiased;
			-moz-osx-font-smoothing:grayscale;
			padding-bottom: var(--nav-height); /* Space for the fixed bottom nav */
			display:flex;
			align-items:center;
			justify-content:center;
			overflow-x: hidden; 
			overflow-y: auto; /* Allow scrolling within the main view */
		}
        
        #app-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            max-width: 1200px; 
            margin: auto;
        }
        
        /* Main View Container */
        #main-view {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* Stage containers for different views (onboarding, form, success) */
		.stage-container {
			position: absolute;
			display: flex;
			align-items: center;
			justify-content: center;
            padding: 0.5rem; /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ Ø§Ø·Ø±Ø§Ù Ù…Ø­ØªÙˆØ§ */
            width: 100%; 
            height: 100%;
			transition: all 0.7s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
			will-change: opacity, transform;
            /* Ensures scrollable content inside if necessary */
            overflow-y: auto; 
		}

		/* Stage States for Transition */
		.stage-active {
			opacity: 1;
			transform: scale(1);
			pointer-events: auto;
            position: relative;
		}
		.stage-hidden {
			opacity: 0;
			transform: scale(0.95);
			pointer-events: none;
            position: absolute;
		}
		.stage-exit {
			opacity: 0;
			transform: scale(0.85); 
			pointer-events: none;
		}
		.stage-enter {
			opacity: 1;
			transform: scale(1);
			pointer-events: auto;
			transition-delay: 0.1s; 
		}

        /* Specific sizing for the initial Brand Stage */
        #stage-onboarding .brand-card {
            width: var(--stage-width);
            max-width: 100%;
            height: auto; 
            min-height: 480px; /* Ú©Ø§Ù‡Ø´ Ø§Ø±ØªÙØ§Ø¹ Ù…ÛŒÙ†ÛŒÙ…Ù… */
        }
        
        /* NOTE: .form-grid-container removed as per user request */

		/* left card (visual/brand) */
		.brand-card{
			background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
			border-radius:0.75rem; /* Ú©Ø§Ù‡Ø´ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
			padding:1rem; /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ */
			box-shadow: 0 8px 24px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
			position:relative;
			overflow:hidden;
			backdrop-filter: blur(6px) saturate(120%);
			border: 1px solid rgba(255,255,255,0.04);
			display:flex;
			flex-direction:column;
			gap:0.8rem; /* Ú©Ø§Ù‡Ø´ ÙØ§ØµÙ„Ù‡ Ø¯Ø§Ø®Ù„ÛŒ */
		}

		.brand-hero{
			display:flex;
			gap:0.8rem; /* Ú©Ø§Ù‡Ø´ ÙØ§ØµÙ„Ù‡ Ø¯Ø§Ø®Ù„ÛŒ */
			align-items:center;
		}
		.logo-circle{
			width:64px; height:64px; border-radius:16px; /* Ú©Ø§Ù‡Ø´ Ø§Ø¨Ø¹Ø§Ø¯ Ù„ÙˆÚ¯Ùˆ */
			background: linear-gradient(135deg,var(--accent1),var(--accent2));
			display:flex; align-items:center; justify-content:center;
			box-shadow: 0 8px 20px rgba(0,114,255,0.18);
			transform: rotate(-6deg);
		}
		.logo-circle svg{width:32px; height:32px; color:white} /* Ú©Ø§Ù‡Ø´ Ø§Ø¨Ø¹Ø§Ø¯ SVG */

		.brand-title{font-weight:700; font-size:1.3rem; letter-spacing:0.2px; color:var(--text-light)} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */
		.brand-sub{color:var(--muted); font-weight:500; margin-top:0.1rem; font-size:0.9rem} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */

		.stats{
			display:flex; gap:0.5rem; margin-top:auto; align-items:center; justify-content:space-between;
		}
		.stat-item{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:0.5rem 0.7rem; border-radius:0.6rem; border:1px solid rgba(255,255,255,0.02)} /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ */
		.stat-item .num{font-weight:700; font-size:1rem} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */
		.stat-item .lbl{font-size:0.75rem; color:var(--muted)} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */

		/* right card (form) */
		.form-card{
			background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
			border-radius:0.75rem; /* Ú©Ø§Ù‡Ø´ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
			padding:1rem; /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ */
			box-shadow: 0 8px 24px rgba(2,6,23,0.6);
			border:1px solid rgba(255,255,255,0.04);
			backdrop-filter: blur(6px);
            width: var(--stage-width); /* Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø¹Ø±Ø¶ ÙØ±Ù… */
            max-width: 100%;
		}
        
        /* Success Card Styling (Stage 3) and Profile/Dashboard Cards */
		.content-card {
            width: 100%;
            max-width: 680px; 
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border-radius:1rem; /* Ú©Ø§Ù‡Ø´ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
            padding:1.5rem; /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ */
            box-shadow: 0 15px 45px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.08);
            border:1px solid rgba(255,255,255,0.06);
            backdrop-filter: blur(8px);
            text-align: right;
            max-width: var(--stage-width); /* Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø­Ø¯Ø§Ú©Ø«Ø± Ø¹Ø±Ø¶ */
        }

		.headline{display:flex; align-items:center; gap:0.6rem}
		.headline h1{font-size:1.3rem; font-weight:700; color:var(--text-light)} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */
		.headline p{color:var(--muted); margin:0; font-size:0.85rem} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */

		.glass-input{
			background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
			border:1px solid rgba(255,255,255,0.05);
			padding:0.6rem 0.8rem; border-radius:0.6rem; font-weight:500; color:var(--text-light); /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ Ùˆ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
			box-shadow: 0 4px 12px rgba(2,6,23,0.5);
			transition: all 0.18s ease;
            font-size: 0.95rem; /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª ÙˆØ±ÙˆØ¯ÛŒ */
		}

		.form-label{font-weight:600; color:var(--muted); font-size:0.8rem} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */
		.hint{font-size:0.75rem; color:var(--muted)} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */

		.btn-cta{
			display:inline-flex; align-items:center; gap:0.5rem; justify-content:center;
			padding:0.7rem 1rem; border-radius:0.6rem; font-weight:700; cursor:pointer; /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ Ùˆ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
			background:linear-gradient(90deg,var(--accent2),var(--accent1)); color:#fff; border:none;
			box-shadow: 0 8px 20px rgba(0,114,255,0.25);
			transition: transform .18s ease, box-shadow .18s ease;
            font-size: 1rem; /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª Ø¯Ú©Ù…Ù‡ */
		}
		.btn-cta:hover{transform:translateY(-3px); box-shadow: 0 12px 30px rgba(0,114,255,0.30)} /* Ú©Ø§Ù‡Ø´ Ù…ÛŒØ²Ø§Ù† Ø­Ø±Ú©Øª Ùˆ Ø³Ø§ÛŒÙ‡ */
		.btn-cta:disabled{
			opacity: 0.6;
			pointer-events: none;
			transform: translateY(0);
			box-shadow: none;
			/* REPLACED: Changed disabled background to match the initial state */
			background: linear-gradient(90deg, #374151, #4b5563); 
		}
        
        /* Custom button for copy action in the success page */
        .btn-copy {
            background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--accent1);
            padding: 0.4rem 0.7rem; /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ */
            border-radius: 0.4rem; /* Ú©Ø§Ù‡Ø´ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
            transition: all 0.2s;
        }
        .btn-copy:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-light);
        }

		.muted-row{display:flex; gap:0.5rem; align-items:center; color:var(--muted); font-size:0.8rem} /* Ú©Ø§Ù‡Ø´ ÙØ§ØµÙ„Ù‡ Ùˆ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */

		/* tiny badges */
		.badge{padding:0.25rem 0.45rem; border-radius:999px; font-size:0.75rem; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03)} /* Ú©Ø§Ù‡Ø´ Ø§Ø¨Ø¹Ø§Ø¯ */

		/* helper for LTR inputs */
		.ltr{direction:ltr; text-align:left}

		/* small responsive tweaks */
		@media (max-width:920px){
			/* Removed .form-grid-container responsive settings */
			.brand-card{order:2}
			.form-card{order:1}
            .stage-container {
                padding: 0.5rem; 
            }
            :root{
                --stage-width: 100%;
            }
		}

		/* subtle entrance animation for page 1 elements */
		.animate-fade-up{opacity:0; transform: translateY(12px); animation:fadeUp .6s ease forwards}
		.animate-fade-up.delay-1{animation-delay:0.08s}
		.animate-fade-up.delay-2{animation-delay:0.16s}
		.animate-fade-up.delay-3{animation-delay:0.24s}
		@keyframes fadeUp{to{opacity:1; transform:none}}

		/* input focus visual */
		input:focus, textarea:focus{outline:none; box-shadow:0 6px 20px rgba(0,114,255,0.12); border-color:var(--accent2)}

		/* footer */
		.small-foot{font-size:0.75rem; color:var(--muted)} /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */

        /* --- Navigation Bar Styling (New) --- */
        #nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: rgba(15, 23, 36, 0.9); /* Dark semi-transparent */
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 0.5rem;
            z-index: 50;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 25%;
            height: 100%;
            color: var(--muted);
            font-size: 0.65rem; /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª Ù†Ø§ÙˆØ¨Ø±ÛŒ */
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .nav-item.active {
            color: var(--accent1);
        }

        .nav-item i {
            font-size: 1.1rem; /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² Ø¢ÛŒÚ©ÙˆÙ† Ù†Ø§ÙˆØ¨Ø±ÛŒ */
            margin-bottom: 2px;
        }
        
        /* NEW: Profile specific styles */
        .profile-pic-container {
            width: 96px; 
            height: 96px; 
            border-radius: 50%;
            overflow: hidden;
            margin: 0 auto 1rem;
            border: 4px solid var(--accent1);
            box-shadow: 0 0 10px rgba(0, 114, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent2), var(--accent1));
        }
        .profile-pic-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
	</style>
</head>
<body>
	<main id="app-container">
        <!-- Main content view container -->
        <div id="main-view">
            
            <!-- Stage 1: Onboarding/Brand Card (The initial view) -->
            <div id="stage-onboarding" class="stage-container stage-active" data-view="home">
                <!-- Content same as previous version for brand card... -->
                <section class="brand-card animate-fade-up delay-1">
                    <div class="brand-hero">
                        <div class="logo-circle" aria-hidden>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h16v12a2 2 0 0 1-2 2h-5l-4 4v-4H6a2 2 0 0 1-2-2V4z"/></svg>
                        </div>
                        <div>
                            <div class="brand-title">ØªÛŒÚ©Øª ØªÙ„</div>
                            <div class="brand-sub">Ù¾Ù„ØªÙØ±Ù… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ â€” Ø³Ø±ÛŒØ¹ØŒ Ø§Ù…Ù† Ùˆ Ù‚Ø§Ø¨Ù„ ØªÙˆØ³Ø¹Ù‡</div>
                        </div>
                    </div>

                    <p class="hint mt-4">Ø¨Ø§ Ø·Ø±Ø§Ø­ÛŒ ÙˆØ§Ú©Ù†Ø´â€ŒÚ¯Ø±Ø§ Ùˆ Ø§Ù…Ú©Ø§Ù†Ø§Øª API-firstØŒ ØªÛŒÚ©Øªâ€ŒØªÙ„ Ø¢Ù…Ø§Ø¯Ù‡ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù‡Ø± Ø³Ø±ÙˆÛŒØ³ Ùˆ Ø§Ø¨Ø²Ø§Ø± Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø´Ù…Ø§Ø³Øª. Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªÙ†Ù‡Ø§ Ø¨Ø§ Ú†Ù†Ø¯ Ú©Ù„ÛŒÚ©.</p>

                    <div style="margin-top:0.8rem;">
                        <div class="muted-row" style="justify-content:space-between">
                            <div class="badge">Enterprise Ready</div>
                            <div class="badge">GDPR-friendly</div>
                            <div class="badge">Webhooks & API</div>
                        </div>
                    </div>

                    <div class="stats mt-3">
                        <div class="stat-item">
                            <div class="num">120+</div>
                            <div class="lbl">Ø´Ø±Ú©Øªâ€ŒÙ‡Ø§ÛŒ Ù…ØªØµÙ„</div>
                        </div>
                        <div class="stat-item">
                            <div class="num">1M+</div>
                            <div class="lbl">ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒØ´Ø¯Ù‡</div>
                        </div>
                        <div class="stat-item">
                            <div class="num">99.9%</div>
                            <div class="lbl">Ø¢Ù¾ØªØ§ÛŒÙ…</div>
                        </div>
                    </div>

                    <div style="margin-top:1rem; display:flex; gap:0.6rem; align-items:center;">
                        <button class="btn-cta flex-1" onclick="navigateTo('setup')">
                            <i class="fas fa-play"></i> Ø´Ø±ÙˆØ¹ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾Ù„ØªÙØ±Ù…
                        </button>
                        <div class="small-foot">ÛŒØ§ Ø¨Ù‡ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯</div>
                    </div>

                    <div style="position:absolute; left:-80px; top:-40px; width:220px; height:220px; background:radial-gradient(circle at 30% 30%, rgba(0,198,255,0.07), transparent); filter:blur(42px); pointer-events:none"></div>
                    <div style="position:absolute; right:-60px; bottom:-50px; width:160px; height:160px; background:radial-gradient(circle at 70% 70%, rgba(255,200,87,0.04), transparent); filter:blur(36px); pointer-events:none"></div>
                </section>
            </div>

            <!-- Stage 2: Setup Form (Now single-column, centered) -->
            <div id="stage-setup" class="stage-container stage-hidden" data-view="setup">
                
                <!-- Right / Form card (Now taking center stage) -->
                <section class="form-card"> <!-- Max width increased for better centered look -->
                    <div class="headline">
                        <div>
                            <h1>Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾Ù„ØªÙØ±Ù… Ø´Ù…Ø§</h1>
                            <p class="brand-sub">ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯ ØªØ§ Ù¾Ù„ØªÙØ±Ù… Ø´Ù…Ø§ Ø¸Ø±Ù Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ Ø³Ø§Ø®ØªÙ‡ Ø´ÙˆØ¯.</p>
                        </div>
                        <div style="margin-left:auto; text-align:left">
                            
                        </div>
                    </div>

                    <form id="setup-form" class="mt-4 space-y-3"> <!-- Ú©Ø§Ù‡Ø´ ÙÙˆØ§ØµÙ„ Ø¨Ù‡ space-y-3 -->
                        <!-- Form fields remain the same -->
                        <div>
                            <label for="store-handle" class="form-label">Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§ÛŒ Ù¾Ù„ØªÙØ±Ù… (Ø¯Ø± URL Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)</label>
                            <div style="display:flex; gap:0.6rem; align-items:center">
                                <input id="store-handle" class="glass-input ltr w-full" placeholder="Ù…Ø«Ø§Ù„: kafsh-store ÛŒØ§ my-mobile (Ø¨Ø¹Ø¯ Ø§Ø² Ø³Ø§Ø®Øª ØºÛŒØ±Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±)" pattern="[a-zA-Z0-9-]+" required>
                                
                            </div>
                            
                        </div>

                        <div>
                            <label for="admin-chat-id" class="form-label">Ø´Ù†Ø§Ø³Ù‡ Ø¹Ø¯Ø¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… Ù…Ø¯ÛŒØ± (Admin Chat ID)</label>
                            <!-- NOTE: Prefill with Telegram ID if available -->
                            <input id="admin-chat-id" class="glass-input ltr w-full" placeholder="Ù…Ø«Ø§Ù„: 123456789" pattern="[0-9]+" required>
                            
                        </div>

                        <div>
                            <label for="user-bot-token" class="form-label">ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</label>
                            <input id="user-bot-token" class="glass-input ltr w-full" placeholder="ØªÙˆÚ©Ù† Ø±Ø¨Ø§ØªÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ Ø¢Ù† Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·Ù†Ø¯" required>
                            
                        </div>

                        <div>
                            <label for="admin-bot-token" class="form-label">ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª Ø§Ø¯Ù…ÛŒÙ† (Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§)</label>
                            <input id="admin-bot-token" class="glass-input ltr w-full" placeholder="ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§" required>
                        </div>

                        <div style="display:flex; gap:0.8rem; align-items:center; margin-top: 1.2rem !important;">
                            <!-- Button is now immediately enabled by renderApp for unrestricted access -->
                            <button id="create-platform-btn" class="btn-cta flex-1" type="submit" disabled><i class="fas fa-spinner animate-spin"></i> Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</button>
                        </div>

                        <div class="hint flex justify-between items-center" style="margin-top: 0.8rem !important;">
                            <div class="small-foot">Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú©Ù…Ú©ØŸ <a href="https://amirrezahoseinabadi.github.io/support" target="_blank" style="color:var(--accent1);">Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</a></div>
                            <span class="muted-row">Ù†Ø³Ø®Ù‡ <strong style="margin-inline:6px; color:var(--gold)">1.0.0</strong></span>
                        </div>
                    </form>

                    
                    
                    <!-- Explicit back button added below the form -->
                    <!-- Ø­Ø°Ù Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ -->
                    
                </section>
            </div>

            <!-- Stage 3: Success Message (Hidden) -->
            <div id="stage-success" class="stage-container stage-hidden" data-view="success">
                <section id="success-card" class="content-card">
                    <p class="text-white">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†ØªØ§ÛŒØ¬...</p>
                </section>
            </div>
            
            <!-- Stage 4: Profile View (New) -->
            <div id="stage-profile" class="stage-container stage-hidden" data-view="profile">
                <section id="profile-card" class="content-card w-full max-w-sm">
                    <!-- Profile content will be rendered here dynamically -->
                    <p class="text-white text-center">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„...</p>
                </section>
            </div>

            <!-- Stage 5: Dashboard View (New) -->
            <div id="stage-dashboard" class="stage-container stage-hidden" data-view="dashboard">
                <section id="dashboard-card" class="content-card w-full max-w-xl">
                    <h1 class="text-2xl font-extrabold text-white mb-6 border-b border-white/10 pb-3">ğŸ—‚ï¸ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù¾Ù„ØªÙØ±Ù…</h1>
                    <p class="gray-400 mb-4">Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ù„ÛŒ Ù¾Ù„ØªÙØ±Ù… Ø´Ù…Ø§ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
                    <div id="dashboard-status" class="space-y-3">
                        <!-- Dynamic content will go here -->
                        <div class="p-3 rounded-lg flex justify-between items-center" style="background:rgba(255,255,255,0.05);"><span class="font-bold">ÙˆØ¶Ø¹ÛŒØª:</span> <span class="text-green-400">âœ… ÙØ¹Ø§Ù„</span></div>
                        <div class="p-3 rounded-lg flex justify-between items-center" style="background:rgba(255,255,255,0.05);"><span class="font-bold">Ø´Ù†Ø§Ø³Ù‡ Ù¾Ù„ØªÙØ±Ù…:</span> <span id="dash-handle" class="ltr text-blue-400 font-mono">---</span></div>
                    </div>
                    
                    <!-- NEW: Add Sync/Refresh Button -->
                    <button id="sync-platform-btn" class="btn-cta text-sm w-full mt-6" onclick="window.manualSync()">
                        <i class="fas fa-sync-alt"></i> Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª (Refresh)
                    </button>
                    
                    <button class="btn-cta text-sm w-full mt-3" onclick="alert('TODO: Implement Admin Panel link/logic')">
                        <i class="fas fa-cog"></i> ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª
                    </button>
                </section>
            </div>

        </div> <!-- end #main-view -->
	</main>
    
    <!-- Bottom Navigation Bar (New) -->
    <nav id="nav-bar">
        <div class="nav-item active" data-target="home" onclick="navigateTo('home')">
            <i class="fas fa-home"></i>
            <span>Ø®Ø§Ù†Ù‡</span>
        </div>
        <div class="nav-item" data-target="dashboard" onclick="navigateTo('dashboard')">
            <i class="fas fa-layer-group"></i>
            <span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
        </div>
        <div class="nav-item" data-target="profile" onclick="navigateTo('profile')">
            <i class="fas fa-user-circle"></i>
            <span>Ù¾Ø±ÙˆÙØ§ÛŒÙ„</span>
        </div>
        <div class="nav-item" data-target="settings" onclick="alert('TODO: Implement Settings View')">
            <i class="fas fa-cogs"></i>
            <span>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</span>
        </div>
    </nav>


	<script>
        // Global state object
        window.state = {
            currentView: 'home',
            // uid will be the Firebase UID after successful sign-in
            user: { uid: 'guest', fullName: 'Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒÙ‡Ù…Ø§Ù†', username: 'Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒÙ‡Ù…Ø§Ù†', isAnonymous: true, isTelegramAuth: false, tgUserId: null, photo_url: null }, 
            platform: { storeHandle: null, adminBotUsername: null, userBotUsername: null }
        };

        const MANAGEMENT_WORKER_URL = "https://management-ticketing.amiruserbot7.workers.dev";
        // NOTE: FIREBASE_DOC_PATH will be dynamically updated after successful auth
        let FIREBASE_DOC_PATH = null; 
        
        // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---
        
        function enablePlatformCreationButton() {
            const btn = document.getElementById('create-platform-btn');
            // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ùˆ ØªÙ†Ø¸ÛŒÙ… Ù…ØªÙ† Ø¢Ù† Ø¯Ø± Ù„ÙˆØ¯ Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ø³Øª.
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = `<i class='fas fa-rocket'></i> Ø³Ø§Ø®Øª Ù¾Ù„ØªÙØ±Ù… Ø¬Ø¯ÛŒØ¯`;
            }
        }

		// Utility function to copy text to clipboard
		function copyToClipboard(elementId) {
			const copyText = document.getElementById(elementId);
			if (copyText) {
				copyText.select();
				document.execCommand('copy');
				const copyBtn = copyText.nextElementSibling;
				if (copyBtn) {
					copyBtn.innerHTML = '<i class="fas fa-check"></i>';
					Swal.fire({
						toast: true,
						position: 'top-end',
						icon: 'success',
						title: 'Ø¢Ø¯Ø±Ø³ Ú©Ù¾ÛŒ Ø´Ø¯',
						showConfirmButton: false,
						timer: 1500
					});
					setTimeout(() => {
						copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
					}, 2000);
				}
			}
		}
        
        // --- Stage (View) Management Functions ---
        
        function navigateTo(targetView) {
            if (window.state.currentView === targetView) return;

            const currentStage = document.querySelector(`.stage-container[data-view="${window.state.currentView}"]`);
            const nextStage = document.querySelector(`.stage-container[data-view="${targetView}"]`);
            const navItems = document.querySelectorAll('.nav-item');
            
            if (!currentStage || !nextStage) {
                console.error('Invalid view transition:', window.state.currentView, '->', targetView);
                return;
            }

            // Update navigation bar active class
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-target') === targetView) {
                    item.classList.add('active');
                }
            });
            
            // Render content for the target view before transition starts
            if (targetView === 'profile') renderProfile();
            if (targetView === 'dashboard') renderDashboard();

            // 1. Start the exit animation for the current stage
            currentStage.classList.remove('stage-active');
            currentStage.classList.add('stage-exit');
            
            // 2. Schedule the enter animation for the next stage after a short delay
            setTimeout(() => {
                currentStage.classList.remove('stage-exit');
                currentStage.classList.add('stage-hidden'); 
                
                nextStage.classList.remove('stage-hidden');
                nextStage.classList.add('stage-enter');
                nextStage.classList.add('stage-active');
                window.state.currentView = targetView;
            }, 300); 
            
             setTimeout(() => {
                nextStage.classList.remove('stage-enter');
            }, 1000);
        }

        // Renamed functions for clarity with new navigation system
        const navigateToForm = () => navigateTo('setup');
        const transitionToSuccess = () => navigateTo('success');


        // --- Dynamic Rendering Functions (New) ---

        function renderApp() {
            // Initial render based on user authentication status
            const currentStage = document.querySelector(`.stage-container[data-view="${window.state.currentView}"]`);
            if (currentStage) {
                // Ensure only the current view is active on load
                document.querySelectorAll('.stage-container').forEach(stage => {
                    if (stage !== currentStage) {
                        stage.classList.remove('stage-active', 'stage-enter', 'stage-exit');
                        stage.classList.add('stage-hidden');
                    }
                });
            }
            
            // Prefill admin-chat-id if we have the Telegram ID
            const adminChatIdInput = document.getElementById('admin-chat-id');
            if (adminChatIdInput && window.state.user.tgUserId && !adminChatIdInput.value) {
                adminChatIdInput.value = window.state.user.tgUserId;
            }
            
            // If the user has a platform handle, default to the Dashboard view
            if (window.state.platform.storeHandle && window.state.currentView === 'home') {
                 navigateTo('dashboard');
            } else {
                 navigateTo(window.state.currentView); // Ensure home is active
            }
            
            // *** ØªØºÛŒÛŒØ± Ø¬Ø¯ÛŒØ¯: ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ú©Ù…Ù‡ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø±Ø§ÛŒ Ø±ÙØ¹ Ù…Ø´Ú©Ù„ "Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„" ***
            enablePlatformCreationButton();
        }
        
        function renderProfile() {
            const profileCard = document.getElementById('profile-card');
            const { user, platform } = window.state;
            const uid = user.uid || '---';
            
            // 1. Determine display name
            // NEW LOGIC: Always prioritize fullName (First Name + Last Name)
            let displayUsername = user.fullName;
            if (user.isAnonymous) {
                 displayUsername = 'Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒÙ‡Ù…Ø§Ù†';
            }
            
            // 2. Determine the UID to display (Always show TG ID if available, otherwise Firebase UID)
            const displayUID = user.tgUserId || user.uid || '---';
            
            // Tweak the label for clarity
            const displayUIDLabel = user.tgUserId 
                ? 'Ø´Ù†Ø§Ø³Ù‡ Ø¹Ø¯Ø¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…' 
                : (user.uid === 'guest' ? 'Ø´Ù†Ø§Ø³Ù‡ Ù…ÙˆÙ‚Øª (Guest)' : 'Ø´Ù†Ø§Ø³Ù‡ ÙØ§ÛŒØ±Ø¨ÛŒØ³ (UID)');
            
            // 3. Determine profile picture HTML
            let profilePicHtml;
            const fallbackLetter = (user.first_name || 'U').substring(0, 1).toUpperCase();
            
            if (user.photo_url) {
                profilePicHtml = `<div class="profile-pic-container"><img src="${user.photo_url}" alt="Profile Avatar" onerror="this.onerror=null;this.style.display='none'; this.parentNode.innerHTML='${fallbackLetter}'"></div>`;
            } else {
                profilePicHtml = `<div class="profile-pic-container">${fallbackLetter}</div>`;
            }


            const status = platform.storeHandle ? 'Ù¾Ù„ØªÙØ±Ù… Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯Ù‡' : 'Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾Ù„ØªÙØ±Ù…';
            const statusColor = platform.storeHandle ? 'text-green-400' : 'text-yellow-400';
            const statusIcon = platform.storeHandle ? 'âœ…' : 'âš ï¸';
            const platformHandleDisplay = platform.storeHandle ? `<span class="ltr font-mono text-base text-blue-400">${platform.storeHandle}</span>` : `<span class="text-red-400">---</span>`;
            

            profileCard.innerHTML = `
                <div class="text-center mb-6">
                    ${profilePicHtml}
                    <h2 class="text-xl font-extrabold text-white mt-2">${displayUsername}</h2>
                    <p class="text-xs text-gray-400 mt-1">${displayUIDLabel}: <span class="ltr font-mono text-xs text-gray-300">${displayUID}</span></p>
                    <p class="text-xs text-gray-500 mt-0.5">Firebase UID: <span class="ltr font-mono text-xs text-yellow-400 font-bold">${uid}</span></p>
                </div>
                
                <div class="space-y-3 pt-4 border-t border-white/10">
                    <h3 class="text-lg font-bold text-white mb-3">ÙˆØ¶Ø¹ÛŒØª Ù¾Ù„ØªÙØ±Ù…</h3>
                    
                    <div class="flex justify-between items-center p-3 rounded-lg" style="background:rgba(255,255,255,0.05);">
                        <span class="font-bold text-gray-300">ÙˆØ¶Ø¹ÛŒØª:</span>
                        <span class="font-extrabold ${statusColor}">${statusIcon} ${status}</span>
                    </div>

                    <div class="flex justify-between items-center p-3 rounded-lg" style="background:rgba(255,255,255,0.05);">
                        <span class="font-bold text-gray-300">Ø´Ù†Ø§Ø³Ù‡ Ù¾Ù„ØªÙØ±Ù…:</span>
                        ${platformHandleDisplay}
                    </div>

                    ${platform.storeHandle ? `
                        <div class="flex justify-between items-center p-3 rounded-lg" style="background:rgba(255,255,255,0.05);">
                            <span class="font-bold text-gray-300">Ø±Ø¨Ø§Øª Ø§Ø¯Ù…ÛŒÙ†:</span>
                            <a href="https://t.me/${platform.adminBotUsername}" target="_blank" class="text-blue-400 font-mono ltr text-sm">@${platform.adminBotUsername}</a>
                        </div>
                        <button class="btn-cta text-sm w-full mt-4" onclick="alert('TODO: Implement Admin Panel link/logic')">
                            <i class="fas fa-cog"></i> ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª
                        </button>
                    ` : `
                        <button class="btn-cta text-sm w-full mt-4" onclick="navigateTo('setup')">
                            Ø´Ø±ÙˆØ¹ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾Ù„ØªÙØ±Ù…
                        </button>
                    `}
                </div>
            `;
        }

        function renderDashboard() {
            const dashboardCard = document.getElementById('dashboard-card');
            const handleSpan = document.getElementById('dash-handle');
            const statusDiv = document.getElementById('dashboard-status');
            const { platform } = window.state;
            // Get the sync button if it exists (for manual loading state reset)
            const syncButton = document.getElementById('sync-platform-btn');
            if (syncButton) {
                // Ensure the sync button is restored to its non-loading state on re-render
                toggleLoading(syncButton, false, 'Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª (Refresh)');
            }

            if (platform.storeHandle) {
                 statusDiv.innerHTML = `
                    <div class="p-3 rounded-lg flex justify-between items-center" style="background:rgba(255,255,255,0.05);"><span class="font-bold">ÙˆØ¶Ø¹ÛŒØª:</span> <span class="text-green-400">âœ… ÙØ¹Ø§Ù„</span></div>
                    <div class="p-3 rounded-lg flex justify-between items-center" style="background:rgba(255,255,255,0.05);"><span class="font-bold">Ø´Ù†Ø§Ø³Ù‡ Ù¾Ù„ØªÙØ±Ù…:</span> <span id="dash-handle" class="ltr text-blue-400 font-mono">${platform.storeHandle}</span></div>
                    <div class="p-3 rounded-lg flex justify-between items-center" style="background:rgba(255,255,255,0.05);"><span class="font-bold">Ø±Ø¨Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:</span> <span class="ltr text-yellow-400 font-mono">@${platform.userBotUsername}</span></div>
                 `;
            } else {
                 statusDiv.innerHTML = `
                    <p class="text-red-400 p-4 rounded-lg" style="background:rgba(255,0,0,0.1);">â›” Ù¾Ù„ØªÙØ±Ù…ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
                    <button class="btn-cta text-sm w-full mt-4" onclick="navigateTo('setup')">
                        Ø´Ø±ÙˆØ¹ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾Ù„ØªÙØ±Ù…
                    </button>
                 `;
            }
        }

		/** * FIX: ØªØ§Ø¨Ø¹ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ UI Ø¨Ø¹Ø¯ Ø§Ø² setDoc 
         * Ø¨Ø§ Ø§ÙØ²ÙˆØ¯Ù† waitForFirebaseReady
         */
		async function finishSetup(result){
            try {
                // --- FIX: Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨ÙˆØ¯Ù† Firebase Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¯Ø§Ù…Ù‡ ---
                await waitForFirebaseReady();
                // --------------------------------------------------------
            } catch (error) {
                 console.error("Firebase readiness timeout during setup:", error);
                 logErrorToFirestore('SetupFinish', 'Firebase readiness timeout while saving profile.', { error: error.message });
                 Swal.fire({icon:'error', title:'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡', text:'Ù¾Ù„ØªÙØ±Ù… Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯ØŒ Ø§Ù…Ø§ Ø§ØªØµØ§Ù„ ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Mini App Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.'});
                 showSuccess(result);
                 return;
            }
            
            // --- Ø§Ú¯Ø± Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¢Ù…Ø§Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡ ---
            console.log("Firebase services are ready. Proceeding to save platform data.");

            // Save platform details to user's private profile document
            const userDocRef = window.doc(window.db, window.FIREBASE_DOC_PATH);
            const dataToSave = { 
                platform: { // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ù„ØªÙØ±Ù… Ø¨Ø§ÛŒØ¯ Ø¯Ø±ÙˆÙ† ÙÛŒÙ„Ø¯ platform Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯
                    storeHandle: result.storeHandle,
                    adminBotUsername: result.adminBotUsername,
                    userBotUsername: result.userBotUsername,
                    setupDate: new Date()
                }
            };
            
            window.setDoc(userDocRef, dataToSave, { merge: true })
                .then(() => {
                    console.log("Platform details saved to Firestore profile.");
                    
                    // --- FIX: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ ÙˆØ¶Ø¹ÛŒØª Ùˆ Ø±Ù†Ø¯Ø± ÙÙˆØ±ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ---
                    window.state.platform = dataToSave.platform; 
                    showSuccess(result);
                    renderDashboard(); // Explicit render after successful setup save
                    // --------------------------------------------------------
                })
                .catch(error => {
                    console.error("Error saving platform details:", error);
                    logErrorToFirestore('SetupFinish', 'Error saving platform details to Firestore.', { error: error.message });
                    // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø­ØªÛŒ Ø§Ú¯Ø± Ù¾Ù„ØªÙØ±Ù… Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
                    Swal.fire({icon:'error', title:'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡', text:`Ù¾Ù„ØªÙØ±Ù… Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯ØŒ Ø§Ù…Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ù† Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø´Ù…Ø§ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯: ${error.message}`});
                    showSuccess(result); 
                });
		}


		function showSuccess(result){
			const { adminBotUsername, userBotUsername, storeHandle } = result || {};
			const MINI_APP_BASE_URL = "https://amirrezahoseinabadi.github.io/ticketing-frontend/index.html";
			const miniAppUrl = `${MINI_APP_BASE_URL}?storeHandle=${storeHandle}`;
			const successCard = document.getElementById('success-card');

			successCard.innerHTML = `
				<div class="flex items-center justify-end gap-3 text-white mb-6">
					<i class="fas fa-check-circle text-4xl" style="color:var(--accent1);"></i>
					<h1 class="text-3xl font-extrabold">ğŸ‰ Ù¾Ù„ØªÙØ±Ù… Ø´Ù…Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª</h1>
				</div>
				<p class="font-bold text-xl mb-6 text-white/90 border-b border-white/10 pb-3">Ú¯Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ</p>
				
				<ol class="space-y-6">
					<li class="p-4 rounded-xl" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08);">
						<span class="font-bold text-white text-base block mb-2">Û±. ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Mini App:</span>
						<p class="text-sm text-gray-300 mb-2">Ø¢Ø¯Ø±Ø³ Ø²ÛŒØ± Ø±Ø§ Ø¯Ø± BotFather (ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø¨Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†) Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Web App URL Ø«Ø¨Øª Ú©Ù†ÛŒØ¯:</p>
						<div class="relative">
							<input id="mini-app-url-input" class="glass-input ltr w-full text-base" style="font-family:monospace; padding-left: 3.5rem; background:rgba(0,0,0,0.1); border-color: rgba(255,255,255,0.1);" readonly value="${miniAppUrl}">
							<button onclick="copyToClipboard('mini-app-url-input')" class="absolute left-2 top-1/2 -translate-y-1/2 btn-copy" title="Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ø¢Ø¯Ø±Ø³">
								<i class="fas fa-copy"></i>
							</button>
						</div>
					</li>
					<li class="p-4 rounded-xl" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08);">
						<span class="font-bold text-white text-base block mb-2">Û². ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø±Ø¨Ø§Øª Ø§Ø¯Ù…ÛŒÙ†:</span>
						<p class="text-sm text-gray-300">
							Ø±Ø¨Ø§Øª Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§ (
							<a href="https://t.me/${adminBotUsername}" target="_blank" class="text-blue-400 font-bold hover:text-blue-300 transition-colors">@${adminBotUsername}</a> 
							) Ø±Ø§ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯Ø³ØªÙˆØ± <code>/start</code> Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ ØªØ§ Ø§Ø¹Ù„Ø§Ù†Ø§Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ ÙØ¹Ø§Ù„ Ø´ÙˆÙ†Ø¯.
						</p>
					</li>
				</ol>

				<div class="mt-10 pt-6 border-t border-white/10 flex flex-col items-center">
					<button id="finish-setup-btn" class="btn-cta text-lg w-full max-w-xs" onclick="navigateTo('dashboard')">
						ØªÚ©Ù…ÛŒÙ„ Ùˆ Ø±ÙØªÙ† Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
					</button>
				</div>
			`;
			
			transitionToSuccess();
		}
        
        // --- API & Form Logic (Modified) ---

		document.getElementById('setup-form').addEventListener('submit', async (e)=>{
			e.preventDefault();
			const btn = document.getElementById('create-platform-btn');
			const storeHandleInput = document.getElementById('store-handle');
            
            // Basic validation
			if(!storeHandleInput.value.trim() || !document.getElementById('admin-chat-id').value.trim() || !document.getElementById('user-bot-token').value.trim() || !document.getElementById('admin-bot-token').value.trim()){
				Swal.fire({icon:'error', title:'Ø®Ø·Ø§', text:'Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯.'});
				return;
			}
            
            // NEW: Ensure Firebase UID is available for the Worker
            if (!window.state.user.uid || window.state.user.uid === 'guest') {
                Swal.fire({icon:'error', title:'Ø®Ø·Ø§', text:'Ù„Ø·ÙØ§Ù‹ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯ ØªØ§ Ø§ØªØµØ§Ù„ Ø§Ù…Ù† (Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ÙØ§ÛŒØ±Ø¨ÛŒØ³) Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´ÙˆØ¯.'});
                console.error("Firebase UID is not yet available or is 'guest'. Current UID:", window.state.user.uid);
                logErrorToFirestore('SetupStart', 'Setup failed: Firebase UID not available or is guest.', { currentUID: window.state.user.uid });
                return;
            }

			// START LOADING: ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¯Ú©Ù…Ù‡ Ø¨Ù‡ Ù„ÙˆØ¯ÛŒÙ†Ú¯
			toggleLoading(btn, true, 'Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ù¾Ù„ØªÙØ±Ù…...');

			const payload = {
				storeHandle: storeHandleInput.value.trim().toLowerCase(),
				adminChatId: document.getElementById('admin-chat-id').value.trim(),
				userBotToken: document.getElementById('user-bot-token').value.trim(),
				adminBotToken: document.getElementById('admin-bot-token').value.trim(),
				miniAppUrl: `https://amirrezahoseinabadi.github.io/ticketing-frontend/index.html?storeHandle=${storeHandleInput.value.trim().toLowerCase()}`,
                // ADDING FIREBASE UID
                firebaseUid: window.state.user.uid
			};


			let isSuccess = false;
			try{
                console.log("[SETUP START] Sending setup request to worker...");
				const res = await fetch(`${MANAGEMENT_WORKER_URL}/setup`,{
					method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
				});
				
                // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù…Ù† Ø®ÙˆØ§Ù†Ø¯Ù† JSON Ùˆ Ø®Ø·Ø§Ù‡Ø§ ---
                let data = {};
                const resText = await res.text(); // Ø§ÙˆÙ„ Ù…ØªÙ† Ø®Ø§Ù… Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†ÛŒÙ…
                try {
                    data = JSON.parse(resText);
                } catch (jsonError) {
                    // Ø§Ú¯Ø± Worker Ù¾Ø§Ø³Ø® ØºÛŒØ± JSON Ø¯Ø§Ø¯ (Ù…Ø«Ù„Ø§Ù‹ Ø®Ø·Ø§ÛŒ 500 Ø¨Ø¯ÙˆÙ† Ø¨Ø¯Ù†Ù‡ Ù…Ù†Ø§Ø³Ø¨)
                    if (!res.ok) {
                        logErrorToFirestore('SetupWorker', 'Worker returned non-JSON/unhandled 500.', { status: res.status, responseText: resText.substring(0, 100) });
                        throw new Error(`Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±: ${res.status}. Ù¾Ø§Ø³Ø® Ù†Ø§Ù…ÙÙ‡ÙˆÙ…. Ú©Ù†Ø³ÙˆÙ„ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.`);
                    }
                }
                // --- Ù¾Ø§ÛŒØ§Ù† Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù…Ù† Ø®ÙˆØ§Ù†Ø¯Ù† JSON ---

                // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø§Ø³Ø® Worker (ÙˆØ§Ø³Ø·)
				if(!res.ok) {
                    // Ø§Ú¯Ø± Ø®Ø·Ø§ 409 (Conflict) Ø¨ÙˆØ¯ØŒ ÛŒØ¹Ù†ÛŒ Ø´Ù†Ø§Ø³Ù‡ ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø³Øª.
                    if (res.status === 409) {
                        logErrorToFirestore('SetupWorker', 'Store handle conflict (409).', { handle: payload.storeHandle });
                        throw new Error(`Ø´Ù†Ø§Ø³Ù‡ Ù¾Ù„ØªÙØ±Ù… (${payload.storeHandle}) Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø´Ù†Ø§Ø³Ù‡ Ø¯ÛŒÚ¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.`);
                    }
                    // Ø¨Ø±Ø§ÛŒ Ø³Ø§ÛŒØ± Ø®Ø·Ø§Ù‡Ø§
                    const errorMessage = data.error || `Ø®Ø·Ø§ Ø¯Ø± Worker (${res.status}). Ú©Ù†Ø³ÙˆÙ„ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.`;
                    logErrorToFirestore('SetupWorker', 'Setup failed with Worker error.', { status: res.status, workerError: data.error || data.message });
                    throw new Error(errorMessage);
                }

				finishSetup(data.data); // Calls finishSetup which saves to Firestore and then shows success
				isSuccess = true;

			}catch(err){
				// Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§
				Swal.fire({icon:'error', title:'Ø¹Ù…Ù„ÛŒØ§Øª Ù†Ø§Ù…ÙˆÙÙ‚', text: err.message || err.toString()});
			}finally{
				// Ø¯Ø± Ù‡Ø± ØµÙˆØ±Øª Ø¯Ú©Ù…Ù‡ Ø±Ø§ Ø¢Ø²Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
                toggleLoading(btn,false,'Ø³Ø§Ø®Øª Ù¾Ù„ØªÙØ±Ù… Ø¬Ø¯ÛŒØ¯');
			}
		});

		function toggleLoading(button, isLoading, text){
			if(isLoading){
				button.disabled=true;
				// SVG Ø¨Ø±Ø§ÛŒ Spinner (Ù„ÙˆØ¯ÛŒÙ†Ú¯)
				button.innerHTML = `<svg class='animate-spin' style='width:18px;height:18px' viewBox='0 0 24 24'><circle class='opacity-25' cx='12' cy='12' r='10' stroke='currentColor' stroke-width='4' fill='none'></circle><path class='opacity-75' fill='currentColor' d='M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z'></path></svg> ${text}`;
			} else {
				button.disabled=false;
				// Ø¢ÛŒÚ©ÙˆÙ† Ø§ØµÙ„ÛŒ Ø¯Ú©Ù…Ù‡
				button.innerHTML = `<i class='fas fa-rocket'></i> ${text}`;
			}
		}

        // Initialize App View
        window.addEventListener('load', renderApp);

	</script>
</body>
</html>

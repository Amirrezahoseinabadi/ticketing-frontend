<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>تیکت تل — راه‌اندازی پلتفرم</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

	<style>
		:root{
			--bg-dark: #0f1724; /* deep navy */
			--card: rgba(255,255,255,0.03);
			--glass: rgba(255,255,255,0.06);
			--accent1: #00C6FF;
			--accent2: #0072FF;
			--muted: #9AA4B2;
			--text-light: #E6EEF5;
			--gold: #FFC857;
			--text-on-light: #1A202C; /* Dark text for popups */
		}

		html,body{height:100%;}
		body{
			font-family: 'Vazirmatn', sans-serif;
			/* Subtle radial glow in the background */
			background: radial-gradient(1200px 600px at 10% 20%, rgba(0,114,255,0.07), transparent),
						radial-gradient(1000px 500px at 90% 80%, rgba(0,198,255,0.03), transparent),
						var(--bg-dark);
			color:var(--text-light);
			-webkit-font-smoothing:antialiased;
			-moz-osx-font-smoothing:grayscale;
			padding:2rem;
			display:flex;
			align-items:center;
			justify-content:center;
		}

		/* container */
		.container{
			width:100%;
			max-width:980px;
			display:grid;
			grid-template-columns: 420px 1fr;
			gap:1.5rem;
			align-items:stretch;
			margin:auto;
		}

		/* left card (visual/brand) */
		.brand-card{
			background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
			border-radius:1rem;
			padding:1.6rem;
			box-shadow: 0 10px 30px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
			position:relative;
			overflow:hidden;
			backdrop-filter: blur(6px) saturate(120%);
			border: 1px solid rgba(255,255,255,0.04);
			display:flex;
			flex-direction:column;
			gap:1rem;
		}

		.brand-hero{
			display:flex;
			gap:1rem;
			align-items:center;
		}
		.logo-circle{
			width:72px; height:72px; border-radius:18px;
			background: linear-gradient(135deg,var(--accent1),var(--accent2));
			display:flex; align-items:center; justify-content:center;
			box-shadow: 0 10px 30px rgba(0,114,255,0.18);
			transform: rotate(-6deg);
		}
		.logo-circle svg{width:36px; height:36px; color:white}

		.brand-title{font-weight:800; font-size:1.45rem; letter-spacing:0.2px; color:var(--text-light)}
		.brand-sub{color:var(--muted); font-weight:500; margin-top:0.1rem}

		.stats{
			display:flex; gap:0.6rem; margin-top:auto; align-items:center; justify-content:space-between;
		}
		.stat-item{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:0.7rem 0.9rem; border-radius:0.8rem; border:1px solid rgba(255,255,255,0.02)}
		.stat-item .num{font-weight:700; font-size:1.1rem}
		.stat-item .lbl{font-size:0.8rem; color:var(--muted)}

		/* right card (form) */
		.form-card{
			background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
			border-radius:1rem;
			padding:1.6rem;
			box-shadow: 0 10px 30px rgba(2,6,23,0.6);
			border:1px solid rgba(255,255,255,0.04);
			backdrop-filter: blur(6px);
		}

		.headline{display:flex; align-items:center; gap:0.8rem}
		.headline h1{font-size:1.45rem; font-weight:800; color:var(--text-light)}
		.headline p{color:var(--muted); margin:0}

		.glass-input{
			background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
			border:1px solid rgba(255,255,255,0.05);
			padding:0.75rem 1rem; border-radius:0.7rem; font-weight:600; color:var(--text-light);
			box-shadow: 0 6px 16px rgba(2,6,23,0.5);
			transition: all 0.18s ease;
		}

		.form-label{font-weight:700; color:var(--muted); font-size:0.85rem}
		.hint{font-size:0.83rem; color:var(--muted)}

		.btn-cta{
			display:inline-flex; align-items:center; gap:0.6rem; justify-content:center;
			padding:0.85rem 1.1rem; border-radius:0.75rem; font-weight:800; cursor:pointer;
			background:linear-gradient(90deg,var(--accent2),var(--accent1)); color:#fff; border:none;
			box-shadow: 0 12px 30px rgba(0,114,255,0.25);
			transition: transform .18s ease, box-shadow .18s ease;
		}
		.btn-cta:hover{transform:translateY(-4px); box-shadow: 0 18px 45px rgba(0,114,255,0.30)}
		.btn-cta:disabled{
			opacity: 0.6;
			pointer-events: none;
			transform: translateY(0);
			box-shadow: none;
			background: linear-gradient(90deg, var(--muted), #64748b);
		}

		.muted-row{display:flex; gap:0.6rem; align-items:center; color:var(--muted); font-size:0.9rem}

		/* tiny badges */
		.badge{padding:0.3rem 0.55rem; border-radius:999px; font-size:0.78rem; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03)}

		/* helper for LTR inputs */
		.ltr{direction:ltr; text-align:left}

		/* small responsive tweaks */
		@media (max-width:920px){
			.container{grid-template-columns:1fr;}
			.brand-card{order:2}
			.form-card{order:1}
		}

		/* subtle entrance animation */
		.animate-fade-up{opacity:0; transform: translateY(12px); animation:fadeUp .6s ease forwards}
		.animate-fade-up.delay-1{animation-delay:0.08s}
		.animate-fade-up.delay-2{animation-delay:0.16s}
		.animate-fade-up.delay-3{animation-delay:0.24s}
		@keyframes fadeUp{to{opacity:1; transform:none}}

		/* input focus visual */
		input:focus, textarea:focus{outline:none; box-shadow:0 6px 20px rgba(0,114,255,0.12); border-color:var(--accent2)}

		/* footer */
		.small-foot{font-size:0.82rem; color:var(--muted)}

		/* SweetAlert custom styling for dark mode */
		.swal2-popup {
			font-family: 'Vazirmatn', sans-serif !important;
			background: #f7fafc !important; /* light background for reading */
			color: var(--text-on-light) !important;
		}
		.swal2-title, .swal2-html-container {
			color: var(--text-on-light) !important;
		}
		.swal2-confirm{
			background:linear-gradient(90deg,var(--accent2),var(--accent1)) !important;
			box-shadow: 0 4px 10px rgba(0,114,255,0.25) !important;
			color: #fff !important;
		}
		.swal2-input, .swal2-textarea{
			border: 1px solid #CBD5E0 !important;
			color: var(--text-on-light) !important;
			background: #EDF2F7 !important;
		}
        .swal2-html-container input[type="text"] {
            border: 1px solid #CBD5E0 !important;
            background: #EDF2F7 !important;
            color: var(--text-on-light) !important;
        }

	</style>
</head>
<body>
	<main class="container">
		<!-- Left / Brand card -->
		<section class="brand-card animate-fade-up delay-1">
			<div class="brand-hero">
				<div class="logo-circle" aria-hidden>
					<!-- stylized ticket/chat glyph -->
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h16v12a2 2 0 0 1-2 2h-5l-4 4v-4H6a2 2 0 0 1-2-2V4z"/></svg>
				</div>
				<div>
					<div class="brand-title">تیکت تل</div>
					<div class="brand-sub">پلتفرم پشتیبانی هوشمند — سریع، امن و قابل توسعه</div>
				</div>
			</div>

			<p class="hint mt-4">با طراحی واکنش‌گرا و امکانات API-first، تیکت‌تل آماده اتصال به هر سرویس و ابزار مورد نیاز شماست. راه‌اندازی تنها با چند کلیک.</p>

			<div style="margin-top:1rem;">
				<div class="muted-row" style="justify-content:space-between">
					<div class="badge">Enterprise Ready</div>
					<div class="badge">GDPR-friendly</div>
					<div class="badge">Webhooks & API</div>
				</div>
			</div>

			<div class="stats mt-4">
				<div class="stat-item">
					<div class="num">120+</div>
					<div class="lbl">شرکت‌های متصل</div>
				</div>
				<div class="stat-item">
					<div class="num">1M+</div>
					<div class="lbl">تیکت‌های پردازش‌شده</div>
				</div>
				<div class="stat-item">
					<div class="num">99.9%</div>
					<div class="lbl">آپتایم</div>
				</div>
			</div>

			<div style="margin-top:1.2rem; display:flex; gap:0.8rem; align-items:center;">
				<button class="btn-cta" onclick="document.getElementById('store-handle').focus();">شروع سریع</button>
				<div class="small-foot">یا به مستندات مراجعه کنید</div>
			</div>

			<!-- decorative blurred shapes -->
			<div style="position:absolute; left:-80px; top:-40px; width:220px; height:220px; background:radial-gradient(circle at 30% 30%, rgba(0,198,255,0.07), transparent); filter:blur(42px); pointer-events:none"></div>
			<div style="position:absolute; right:-60px; bottom:-50px; width:160px; height:160px; background:radial-gradient(circle at 70% 70%, rgba(255,200,87,0.04), transparent); filter:blur(36px); pointer-events:none"></div>
		</section>

		<!-- Right / Form card -->
		<section class="form-card animate-fade-up delay-2">
			<div class="headline">
				<div>
					<h1>راه‌اندازی پلتفرم شما</h1>
					<p class="brand-sub">فیلدها را پر کنید تا پلتفرم شما ظرف چند ثانیه ساخته شود.</p>
				</div>
				<div style="margin-left:auto; text-align:left">
					<div class="badge">Secure</div>
				</div>
			</div>

			<form id="setup-form" class="mt-4 space-y-4">
				<div>
					<label for="store-handle" class="form-label">شناسه پلتفرم (انگلیسی)</label>
					<div style="display:flex; gap:0.6rem; align-items:center">
						<input id="store-handle" class="glass-input ltr w-full" placeholder="مثال: kafsh-store یا my-mobile" pattern="[a-zA-Z0-9-]+" required>
						<div class="badge">url/your-handle</div>
					</div>
					<div class="hint">این شناسه در URL پلتفرم استفاده می‌شود و بعد از ساخت، تغییرپذیر نیست.</div>
				</div>

				<div>
					<label for="admin-chat-id" class="form-label">شناسه عددی تلگرام مدیر</label>
					<input id="admin-chat-id" class="glass-input ltr w-full" placeholder="مثال: 123456789" pattern="[0-9]+" required>
					<div class="hint">برای دریافت شناسه به ربات <a href="https://t.me/userinfobot" target="_blank" style="color:var(--accent1);">@userinfobot</a> پیام دهید.</div>
				</div>

				<div>
					<label for="user-bot-token" class="form-label">توکن ربات کاربران</label>
					<input id="user-bot-token" class="glass-input ltr w-full" placeholder="توکن رباتی که کاربران با آن در ارتباطند" required>
					<div class="hint">این ربات به عنوان Mini App عمل می‌کند.</div>
				</div>

				<div>
					<label for="admin-bot-token" class="form-label">توکن ربات ادمین (اعلان‌ها)</label>
					<input id="admin-bot-token" class="glass-input ltr w-full" placeholder="توکن ربات اعلان‌ها" required>
				</div>

				<div style="display:flex; gap:0.8rem; align-items:center">
					<button id="create-platform-btn" class="btn-cta flex-1" type="submit"><i class="fas fa-rocket"></i> ساخت پلتفرم جدید</button>
					
				</div>

				<div class="hint" style="display:flex; justify-content:space-between;">
					<span>وب‌هوک ادمین به صورت خودکار تنظیم می‌شود</span>
					<span class="muted-row">نسخه <strong style="margin-inline:6px; color:var(--gold)">1.0.0</strong></span>
				</div>
			</form>

			<div style="margin-top:1rem; display:flex; gap:0.6rem; align-items:center; justify-content:space-between">
				<div class="small-foot">نیاز به کمک؟ <a href="https://amirrezahoseinabadi.github.io/support" target="_blank" style="color:var(--accent1);">پشتیبانی</a></div>
				<div class="small-foot">طراحی شده برای کسب‌وکارهای ایرانی</div>
			</div>
		</section>
	</main>

	<script>
		const MANAGEMENT_WORKER_URL = "https://management-ticketing.amiruserbot7.workers.dev";

		document.getElementById('setup-form').addEventListener('submit', async (e)=>{
			e.preventDefault();
			const btn = document.getElementById('create-platform-btn');
			toggleLoading(btn, true, 'در حال ساخت پلتفرم...');

			const payload = {
				storeHandle: document.getElementById('store-handle').value.trim().toLowerCase(),
				adminChatId: document.getElementById('admin-chat-id').value.trim(),
				userBotToken: document.getElementById('user-bot-token').value.trim(),
				adminBotToken: document.getElementById('admin-bot-token').value.trim(),
				// Ensure miniAppUrl is calculated and sent to the worker for saving in config
				miniAppUrl: `https://amirrezahoseinabadi.github.io/ticketing-frontend/index.html?storeHandle=${document.getElementById('store-handle').value.trim().toLowerCase()}`
			};

			if(!payload.storeHandle || !payload.adminChatId || !payload.userBotToken || !payload.adminBotToken){
				Swal.fire({icon:'error', title:'خطا', text:'لطفاً همه فیلدهای الزامی را تکمیل کنید.'});
				toggleLoading(btn,false,'ساخت پلتفرم جدید');
				return;
			}

			try{
				const res = await fetch(`${MANAGEMENT_WORKER_URL}/setup`,{
					method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
				});
				const data = await res.json();
				if(!res.ok) throw new Error(data.error || 'خطا در برقراری ارتباط با سرور');

				showSuccess(data.data);
			}catch(err){
				Swal.fire({icon:'error', title:'عملیات ناموفق', text: err.message || err.toString()});
			}finally{
				toggleLoading(btn,false,'ساخت پلتفرم جدید');
			}
		});

		function toggleLoading(button, isLoading, text){
			if(isLoading){
				button.disabled=true;
				button.innerHTML = `<svg class='animate-spin' style='width:18px;height:18px' viewBox='0 0 24 24'><circle class='opacity-25' cx='12' cy='12' r='10' stroke='currentColor' stroke-width='4' fill='none'></circle><path class='opacity-75' fill='currentColor' d='M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z'></path></svg> ${text}`;
			} else {
				button.disabled=false;
				button.innerHTML = `<i class='fas fa-rocket'></i> ${text}`;
			}
		}

		function showSuccess(result){
			const { adminBotUsername, userBotUsername, storeHandle } = result || {};
			const MINI_APP_BASE_URL = "https://amirrezahoseinabadi.github.io/ticketing-frontend/index.html";
			const miniAppUrl = `${MINI_APP_BASE_URL}?storeHandle=${storeHandle}`;

			Swal.fire({
				icon:'success',
				title:'🎉 پلتفرم شما آماده است',
				html: `
					<div style="text-align:right">
						<p style="font-weight:700; margin-bottom:12px; color:var(--text-on-light)">گام‌های بعدی</p>
						<ol style="list-style-type:none; padding:0; margin:0; color:#334155; line-height:1.6">
							<li style="margin-bottom:15px; font-size:15px;">
                                <span style="font-weight:700; color:var(--text-on-light)">۱. فعال‌سازی Mini App:</span> آدرس زیر را در BotFather تنظیم کنید:
                                <input style="width:100%; padding:10px; border-radius:6px; border:1px solid #E2E8F0; margin-top:6px; background:#EDF2F7; color:var(--text-on-light); direction:ltr; text-align:left; font-family:monospace;" readonly value="${miniAppUrl}" onclick="this.select(); document.execCommand('copy'); Swal.fire({toast:true, position:'top-end', icon:'success', title:'آدرس کپی شد', showConfirmButton:false, timer:1100})">
                            </li>
							<li style="margin-bottom:15px; font-size:15px;">
                                <span style="font-weight:700; color:var(--text-on-light)">۲. فعال‌سازی ربات ادمین:</span> ربات <a href="https://t.me/${adminBotUsername}" target="_blank" style="color:var(--accent2); font-weight:700;">@${adminBotUsername}</a> را باز کرده و <code>/start</code> را بزنید تا اعلان‌ها فعال شود.
                            </li>
						</ol>
                        <p style="margin-top:16px; font-size:15px; color:#4A5568">پس از بستن این پنجره، جهت جلوگیری از تکرار ساخت پلتفرم، صفحه به طور خودکار رفرش خواهد شد.</p>
					</div>
				`,
				width: '90%', 
				maxWidth: '680px',
				confirmButtonText:'تکمیل شد (صفحه رفرش می‌شود)',
                allowOutsideClick: false,
			}).then(()=>{ 
                // Delay reload for 60 seconds as requested
                setTimeout(() => { location.reload(); }, 60000); 
            });
		}

	</script>
</body>
</html>
